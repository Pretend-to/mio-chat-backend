# Nginx configuration for ai.krumio.com
# Place the following map in your global `http { ... }` block once.

map $http_accept_encoding $enc {
    "~br"   br;
    "~gzip" gzip;
    default "";
}

# --- ai.krumio.com ---
server {
    listen 443 ssl;
    server_name ai.krumio.com;
    ssl_certificate     /etc/letsencrypt/live/ai.krumio.com-0005/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ai.krumio.com-0005/privkey.pem;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:3080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Accept-Encoding $http_accept_encoding;
        proxy_cache off;
        proxy_buffering off;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2|map)$ {
        proxy_pass http://127.0.0.1:3080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Accept-Encoding $http_accept_encoding;

        proxy_cache_key "$scheme$host$request_uri$enc";
        proxy_cache my_cache;
        proxy_cache_valid 200 304 7d;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;

        add_header Vary Accept-Encoding always;
        add_header X-Cache-Status $upstream_cache_status;
        expires 7d;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:3080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Accept-Encoding $http_accept_encoding;

        proxy_cache my_cache;
        proxy_cache_valid 200 304 2m;
        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status $upstream_cache_status;
    }

    location /socket.io {
        proxy_pass http://127.0.0.1:3080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache off;
        proxy_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        add_header X-Cache-Status $upstream_cache_status;
    }
}
