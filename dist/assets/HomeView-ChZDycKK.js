import{_ as S,r as _,o as d,c as l,a as s,w as y,v as x,F as g,b as P,n as w,t as u,d as k,e as v,f as B,g as $,h as I,p as C,i as T,j as c,k as b,l as R,m as A}from"./index-BmylxrHC.js";const W={data(){return{show:!1,presetsList:[],recommendPresets:[],recentPresets:[],localPresets:[],systemPresets:[],searchPresets:[],systemShownNum:0,recommendShownNum:0,keyWord:"",activeTypeIndex:0,buttonTranslate:0,avaliablePresetTypes:["推荐","最近","本地","系统"],moreSystemPresets:!0,moreRecommendPresets:!0,observer:null}},computed:{showPresetsLoader(){return this.activeTypeIndex==3?this.moreSystemPresets:this.activeTypeIndex==0?this.moreRecommendPresets:!1},shownPrestsList(){return this.keyWord?this.searchPresets:this.activeTypeIndex===2?this.localPresets:this.activeTypeIndex===1?this.recentPresets:this.activeTypeIndex===0?this.recommendPresets:this.activeTypeIndex===3?this.systemPresets:null}},methods:{async addBot(e){this.strogeAddHistory(e),this.$emit("addBot",e),console.log(e)},strogeAddHistory(e){const t=this.recentPresets.find(a=>a.name===e.name);t&&this.recentPresets.splice(this.recentPresets.indexOf(t),1),this.recentPresets.unshift(e),this.recentPresets.length>6&&this.recentPresets.pop(),localStorage.setItem("addHistory",JSON.stringify(this.recentPresets))},getAddHistory(){const e=localStorage.getItem("addHistory");e&&(this.recentPresets=JSON.parse(e))},async changeShownType(e){this.activeTypeIndex=e,this.buttonTranslate=`${49.6*e}px`,await this.loadSpecificType()},close(){this.$emit("close")},async loadSpecificType(){const e=this.avaliablePresetTypes[this.activeTypeIndex];this.presetsList=await this.getPresetList(e)},async getPresetList(e){if(e==="系统")return await this.loadSystemPresets();if(e==="推荐")return await this.loadRecommendedPresets();if(e==="最近")return this.recentPresets;if(e==="本地")return this.localPresets},async loadRecommendedPresets(){const e=await fetch(`/api/openai/presets?type=recommended&start=${this.recommendShownNum}`).then(t=>t.json());for(let t=0;t<e.data.length;t++)this.recommendPresets.push(e.data[t]);return this.recommendShownNum+=e.data.length,e.data.length<9&&(this.moreRecommendPresets=!1),this.recommendPresets},async loadSystemPresets(){const e=await fetch(`/api/openai/presets?type=system&start=${this.systemShownNum}`).then(t=>t.json());for(let t=0;t<e.data.length;t++)this.systemPresets.push(e.data[t]);return this.systemShownNum+=e.data.length,e.data.length<9&&(this.moreSystemPresets=!1),this.systemPresets},async loadSerachPresets(){const e=async()=>{const t=await fetch(`/api/openai/presets?type=search&keyword=${this.keyWord}`).then(a=>a.json());this.searchPresets=t.data};this.searchTimer&&clearTimeout(this.searchTimer),this.searchTimer=setTimeout(()=>{e()},500)},loadMoreData(){this.showPresetsLoader&&this.activeTypeIndex===3?this.loadSystemPresets():this.showPresetsLoader&&this.activeTypeIndex===0&&this.loadRecommendedPresets()},handleScroll(){const e=this.$refs.loader;if(!e)return;const t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)&&this.loadMoreData()}},mounted(){if(this.getAddHistory(),"IntersectionObserver"in window){const e=a=>{a.forEach(h=>{h.isIntersecting&&this.loadMoreData()})};this.observer=new IntersectionObserver(e);const t=this.$refs.loader;t&&this.observer.observe(t)}else window.addEventListener("scroll",this.handleScroll)},beforeUnmount(){this.observer?this.observer.disconnect():window.removeEventListener("scroll",this.handleScroll)}},m=e=>(C("data-v-ac99ef6d"),e=e(),T(),e),N={class:"add-contactor"},z={class:"head"},M=m(()=>s("div",{class:"title"},"添加机器人",-1)),O={class:"body"},E={class:"search"},H=m(()=>s("i",{class:"iconfont sousuo listicon"},null,-1)),D={class:"info"},V={class:"presets-types"},F=["onClick"],j={key:0,class:"presets-list"},U={class:"preset-avatar"},X={class:"preset-info"},J={class:"preset-name"},q=["title"],G={ref:"loader",class:"loading"},K=m(()=>s("div",null,null,-1)),Q=m(()=>s("div",null,null,-1)),Y=m(()=>s("div",null,null,-1)),Z=m(()=>s("div",null,null,-1)),ee=m(()=>s("div",null,null,-1)),te=[K,Q,Y,Z,ee],se={key:1,class:"empty-list"},oe=m(()=>s("div",{class:"options"},null,-1));function ie(e,t,a,h,n,o){const p=_("el-button"),i=_("el-empty");return d(),l("div",N,[s("div",z,[M,s("div",{class:"close-icon",onClick:t[0]||(t[0]=(...r)=>o.close&&o.close(...r))},"✕")]),s("div",O,[s("div",E,[H,y(s("input",{type:"text",placeholder:"输入搜索关键词",onInput:t[1]||(t[1]=(...r)=>o.loadSerachPresets&&o.loadSerachPresets(...r)),"onUpdate:modelValue":t[2]||(t[2]=r=>n.keyWord=r)},null,544),[[x,n.keyWord]])]),s("div",D,[s("header",V,[(d(!0),l(g,null,P(n.avaliablePresetTypes,(r,f)=>(d(),l("nav",{key:f,onClick:L=>o.changeShownType(f),class:w(n.activeTypeIndex===f?"active":"")},u(r),11,F))),128))]),s("div",{style:k({left:n.buttonTranslate}),class:"slide-button"},null,4),o.shownPrestsList.length>0||[0,3].includes(n.activeTypeIndex)?(d(),l("div",j,[(d(!0),l(g,null,P(o.shownPrestsList,(r,f)=>(d(),l("div",{class:"presets-item",key:f},[s("div",U,u(r.name.slice(0,2)),1),s("div",X,[s("div",J,u(r.name),1),s("div",{title:r.opening,class:"preset-description"},u(r.opening),9,q)]),v(p,{onClick:L=>o.addBot(r)},{default:B(()=>[$("添加")]),_:2},1032,["onClick"])]))),128)),y(s("div",G,te,512),[[I,o.showPresetsLoader]])])):(d(),l("div",se,[v(i,{"image-size":200})]))]),oe])])}const ne=S(W,[["render",ie],["__scopeId","data-v-ac99ef6d"]]),ae={data(){let e=c.getContactors();return{onPhone:c.onPhone,contactorList:e,showAddOptions:!1,showAddWindow:!1}},methods:{genBotByPreset(){this.showAddOptions=!1,this.showAddWindow=!0},showChat(e){this.$route.name=="blank"||this.$route.name=="chat_view"?this.$router.push({name:"chat_view",params:{id:e}}):this.$route.name=="contactors"||this.$route.name=="profile_view"?this.$router.push({name:"profile_view",params:{id:e}}):this.$router.replace({name:"chat_view",params:{id:e}})},getId(e){let t=this.$route.params.id,a=e.id;return t==a?"active":e.priority==0?"important":""},async genBlankBot(){const e={...b.openaiDefaultConfig},t={id:this.genFakeId(),title:e.default_model,avatarPolicy:0,namePolicy:2,priority:1,options:e};console.log(t),this.showAddOptions=!1,await c.addConcator("openai",t),this.addReactiveListener()},startResize(e){this.isResizing=!0,this.startX=e.clientX,this.startWidth=this.$refs.friendlists.offsetWidth,document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.stopResize)},resize(e){if(this.isResizing){let t=this.startWidth+(e.clientX-this.startX);const a=500,h=176;t=t>a?a:t<h?h:t,this.$refs.friendlists.style.flexBasis=t+"px"}},stopResize(){this.isResizing=!1,document.removeEventListener("mousemove",this.resize),document.removeEventListener("mouseup",this.stopResize)},genFakeId(){const t=`1${Math.floor(1e3+Math.random()*9e3)}`;if(this.id){const a=Math.floor(1e3+Math.random()*9e3),h=`${this.id}${a}`;return parseInt(h)}else return parseInt(t)},addPresetContactor(e){console.log(e);const t={id:this.genFakeId(),namePolicy:1,avatarPolicy:0,name:e.name,title:e.title,priority:1,options:{...b.openaiDefaultConfig,model:e.recommendedModel??c.default_model,opening:e.opening,history:e.history,textWrapper:e.textWrapper,tools:e.tools,enable_tool_call:!!e.tools}};c.addConcator("openai",t),this.addReactiveListener()},addReactiveListener(){this.contactorList.map(e=>{e.on("updateMessageSummary",()=>{e.lastMessageSummary=e.getLastMessageSummary()})})}},components:{AddContactor:ne},computed:{sortedList(){return[...this.contactorList].sort((e,t)=>t.priority-e.priority==-1?1:t.lastUpdate-e.lastUpdate)}},mounted(){this.addReactiveListener()},beforeCreate(){c.getContactors().length==0&&c.on("loaded",()=>{this.contactorList=c.getContactors()},!1)}},re=e=>(C("data-v-3528ac81"),e=e(),T(),e),de={class:"upsidebar",id:"friends"},le=re(()=>s("div",{class:"search"},[s("i",{class:"iconfont sousuo listicon"}),s("input",{type:"text",id:"tosearch",placeholder:"搜索"})],-1)),ce={class:"bu-add"},he={class:"people"},me=["onClick","id"],ue=["src","alt"],pe={class:"info"},fe={class:"name"},ve={class:"msginfo",id:"time"},_e={class:"msginfo",id:"msgctt"};function ye(e,t,a,h,n,o){const p=_("AddContactor");return d(),l("div",{id:"friendlists",ref:"friendlists",class:w(n.onPhone?"mobile":"")},[s("div",de,[le,s("div",ce,[s("button",{id:"addcont",onClick:t[0]||(t[0]=i=>n.showAddOptions=!n.showAddOptions)}," + "),y(s("div",{style:k({left:n.onPhone?"-6rem":"0px"}),id:"add-options"},[s("ul",null,[s("li",null,[s("button",{onClick:t[1]||(t[1]=(...i)=>o.genBlankBot&&o.genBlankBot(...i))},"新建空白Bot")]),s("li",null,[s("button",{onClick:t[2]||(t[2]=(...i)=>o.genBotByPreset&&o.genBotByPreset(...i))},"从预设新建Bot")])])],4),[[I,n.showAddOptions]])])]),s("div",he,[(d(!0),l(g,null,P(o.sortedList,(i,r)=>(d(),l("div",{onClick:f=>o.showChat(i.id),key:r,class:"lists",id:o.getId(i)},[s("div",{class:w(["avatar",i.avatarPolicy==1?"custom":"model"])},[s("img",{src:i.avatar,alt:i.name},null,8,ue)],2),s("div",pe,[s("div",fe,u(i.name),1),s("div",ve,u(i.getLastTime()),1),s("div",_e,u(i.lastMessageSummary),1)])],8,me))),128))]),s("div",{class:"resizer",onMousedown:t[3]||(t[3]=(...i)=>o.startResize&&o.startResize(...i))},null,32),n.showAddWindow?(d(),R(p,{key:0,onClose:t[4]||(t[4]=i=>n.showAddWindow=!1),onAddBot:o.addPresetContactor},null,8,["onAddBot"])):A("",!0)],2)}const ge=S(ae,[["render",ye],["__scopeId","data-v-3528ac81"]]),Pe={data(){return{onPhone:c.onPhone,client:c,pagePath:this.$route.path}},components:{friendlist:ge},methods:{},mounted(){},computed:{},watch:{$route:function(e){this.pagePath=e.path}}},we={key:0,id:"main"},Se={key:1,id:"main-mobile"},be={key:2,id:"main-mobile",class:"mobile-chat"};function ke(e,t,a,h,n,o){const p=_("friendlist"),i=_("router-view");return n.onPhone?n.pagePath==="/"?(d(),l("div",Se,[v(p)])):(d(),l("div",be,[v(i)])):(d(),l("div",we,[v(p),v(i)]))}const Ce=S(Pe,[["render",ke]]);export{Ce as default};
