import{r as e,c as t,a,n as s,o as i,b as o,F as l,d as n,t as r,e as c,f as d,g as u,w as p,v as h,h as m,i as g,j as f,T as v,k as y,l as w,m as b,p as C,u as _,q as k,s as S,x,y as L,z as M,A as T,B as A,C as O,D as P,E}from"./vendor_vue-CSrYp3NK.js";import{R as I,_ as $}from"./vendor_editor_preview-z3gkd-VO.js";import{l as V,W as U}from"./vendor_misc-BTiB9Zt4.js";import{s as D,l as R,E as j,u as N,a as B,r as q,p as z,v as H,h as F,b as G,d as W}from"./vendor_element_plus-CMcTUEOy.js";import{l as J}from"./vendor_socketio-3UEp_BzY.js";class Y{constructor(){this.events={}}on(e,t,a=!0){a&&this.off(e),this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){this.events[e]&&this.events[e].forEach(e=>{e(t)})}off(e){this.events[e]&&delete this.events[e]}}function K(e){let t="";const a="0123456789";for(let s=0;s<e;s++)t+=a.charAt(Math.floor(10*Math.random()));return t}function X(e){let t="";const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<e;s++)t+=a.charAt(Math.floor(62*Math.random()));return t}class Q extends Y{constructor(e,t){super(),this.available=null,this.url=this.getURL(),this.socket=null,this.code=t,this.id=e,this.requests=[],this.pendingRequests=new Set}getURL(){return new URL(window.location.href).host}initEventListeners(){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("connect_error"),this.socket.off("message"),this.socket.on("connect",()=>this.handleConnect()),this.socket.on("disconnect",e=>this.handleDisconnect(e)),this.socket.on("connect_error",e=>this.handleConnectError(e)),this.socket.on("message",e=>this.messageHandler(e)))}handleConnect(){this.available=!0,this.hasAttemptedPollingFallback=!1,this.isAttemptingWebSocket=!1;this.socket.io}handleDisconnect(e){this.available=!1}handleConnectError(e){this.emit("connect_error",e),this.isAttemptingWebSocket&&!this.hasAttemptedPollingFallback?(this.hasAttemptedPollingFallback=!0,this.isAttemptingWebSocket=!1,this.socket&&(this.socket.disconnect(),this.socket=null),setTimeout(()=>{this._connectWithTransport(["polling"])},500)):(this.isAttemptingWebSocket,this.available=!1)}_connectWithTransport(e){this.socket&&this.socket.disconnect(),this.socket=J(this.url,{path:"/socket.io",transports:e,auth:{id:this.id,token:this.code},reconnection:!0,reconnectionAttempts:Infinity,reconnectionDelay:2e3,reconnectionDelayMax:1e4,timeout:15e3,forceNew:!0}),this.initEventListeners()}async connect(){this.socket&&this.socket.connected||(this.isAttemptingWebSocket=!0,this.hasAttemptedPollingFallback=!1,this._connectWithTransport(["websocket"]))}disconnect(){this.socket&&(this.socket.disconnect(),this.available=!1)}messageHandler(e){try{const t=JSON.parse(e);"llm"===t.protocol&&(this.emit(t.request_id,t),this.emit("llm_message",t)),"onebot"===t.protocol?this.emit("onebot_message",t):"system"===t.protocol&&("login"===t.type&&this.emit("connect",t.data),this.emit("system_message",t)),this.emit(t.request_id,t),this.pendingRequests.delete(t.request_id)}catch(t){}}sendMessage(e){if(!this.socket||!this.socket.connected)return this.pendingRequests.delete(e.request_id),Promise.reject(new Error("Socket not connected"));if(this.pendingRequests.has(e.request_id))return Promise.reject(new Error(`Duplicate request_id: ${e.request_id}`));this.pendingRequests.add(e.request_id);try{return this.socket.emit("message",JSON.stringify(e)),Promise.resolve()}catch(t){return this.pendingRequests.delete(e.request_id),Promise.reject(t)}}fetch(e,t){return new Promise((a,s)=>{const i=e.split("/").filter(Boolean),o={request_id:X(16),protocol:i[1],type:i[2],id:i[3],data:t,metaData:{contactorId:this.id}},l=new Promise((e,t)=>{setTimeout(()=>{this.pendingRequests.delete(o.request_id),t("timeout")},6e4)}),n=new Promise(e=>{this.on(o.request_id,t=>{this.pendingRequests.delete(o.request_id),e(t.data)})});Promise.race([l,n]).then(a).catch(s).finally(()=>{this.off(o.request_id)}),this.sendMessage(o)})}streamCompletions(e,t){const a={request_id:X(16),protocol:"llm",type:"completions",data:e,metaData:t};this.sendMessage(a)}}class Z extends Y{constructor(){super()}async fetch(e,t){return await fe.socket.fetch(e,t)}}class ee extends Z{constructor(){super()}convertMessage(e){e.message.forEach((t,a)=>{if("image"===t.type){const s=t.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.message[a].data.file=s}else"nodes"===t.type&&t.data.messages.forEach(e=>{if("image"===e.type){const t=e.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.data.file=t}})});const t=e.message.filter(e=>"reply"===e.type),a=e.message.filter(e=>"reply"!==e.type);t.length>0&&a.unshift(t[0]);return{role:"other",time:(new Date).getTime(),content:a,id:e.message_id,status:"completed"}}async send(e,t){return(await this.fetch(`/api/onebot/message/${e}`,t)).message_id}}class te extends Z{constructor(e){super(),this.id=e.id}convertMessage(e){return{...{role:"other",time:(new Date).getTime(),content:[{type:"blank",data:{}}],status:"pending",id:K(16)},...e}}async getMessagesSummary(e){const t=`请你根据以下对话的内容\n${JSON.stringify(e)}\n，总结出一个简短的对话主题,你的回答必须只包含对话主题，不要包含任何其他内容，包括句号。`,a=ge.getLLMDefaultConfig();a.base.stream=!1;const s={settings:a,messages:[{role:"user",content:t}]},i=await this.fetch("/api/llm/completions",s),{content:o}=i;return o||"未命名会话"}handleMessageEvent(e){const t=e.data,a=t.metaData.messageId;delete t.metaData;const s=(e,t)=>{this.emit(e,{...t,messageId:a})};if("update"===e.message){const t={reasoningContent:e=>s("updateReasoning",{reasoning_content:e}),content:e=>s("updateMessage",{chunk:e}),toolCall:e=>s("updateToolCall",{tool_call:e})},a=e.data,i=t[a.type];i&&i(a.content)}else if(["complete","failed"].includes(e.message)){const t={complete:()=>s("completeMessage",{}),failed:()=>s("failedMessage",{error:e.data})}[e.message];t&&t()}}async send(e,t,a){a=ge.getVerifiedLLMConfig(a);const s={contactorId:this.id,messageId:t},i={settings:a,messages:e};if(!fe.socket)throw new Error("WebSocket connection not established.");fe.socket.streamCompletions(i,s)}}const ae="https://registry.npmmirror.com/@lobehub/icons-static-svg/latest/files/icons",se={OpenAI:"openai.svg",Cohere:"cohere-color.svg",Anthropic:"claude-color.svg",Google:"gemini-color.svg","X.AI":"grok.svg",DeepSeek:"deepseek-color.svg","智谱清言":"zhipu-color.svg","豆包":"doubao-color.svg","月之暗面 (kimi)":"moonshot.svg","科大讯飞":"spark-color.svg","通义千问":"qwen-color.svg","腾讯混元":"hunyuan-color.svg"};function ie(e){const t=function(e){return{openai:"openai.svg",gemini:"gemini-color.svg",vertex:"gemini-color.svg",onebot:"openai.svg"}[e]||"openai.svg"}(e);return`${ae}/${t}`}const oe=["MODEL","CUSTOM"],le=["MODEL","CUSTOM","SUMMARY"];class ne extends Y{constructor(e,t){super(),this.platform=e,this.id=t.id,this.namePolicy=t.namePolicy||0,this.avatarPolicy=t.avatarPolicy||0,this.title=t.title,this.name=t.name,this.avatar=t.avatar,this.priority=t.priority,this.firstMessageIndex=t.firstMessageIndex||0,this.messageChain=t.messageChain||[],this.active=!1,this.lastUpdate=t.lastUpdate||Date.now(),this.createTime=t.createTime||Date.now(),this.lastMessageSummary=this.getLastMessageSummary(),this.options=this.loadOptions(t.options),this.kernel="onebot"===e?new ee(t):new te(t),"openai"===e&&this.enableOpenaiListener()}toJSON(){return{platform:this.platform,id:this.id,options:this.options,namePolicy:this.namePolicy,avatarPolicy:this.avatarPolicy,title:this.title,name:this.name,avatar:this.avatar,priority:this.priority,messageChain:this.messageChain,active:this.active,lastUpdate:this.lastUpdate,createTime:this.createTime,lastMessageSummary:this.lastMessageSummary,firstMessageIndex:this.firstMessageIndex}}enableOpenaiListener(){this.kernel.on("updateReasoning",e=>{const{reasoning_content:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;const i=s.content.findIndex(e=>"reason"===e.type),o={type:"reason",data:{text:t,startTime:(new Date).getTime(),endTime:0}};-1!==i?(o.data.text=s.content[i].data.text+t,o.data.startTime=s.content[i].data.startTime,s.content[i]=o):"blank"===s.content[0].type?s.content[0]=o:s.content.push(o),this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("updateMessage",e=>{const{chunk:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;s.content.forEach(e=>{"reason"!=e.type||e.data.endTime||(e.data.endTime=(new Date).getTime())});const i=s.content[s.content.length-1],o=["blank","text"].includes(i.type),l={type:"text",data:{text:("text"==i.type?i.data.text:"").concat(t)}};o?s.content[s.content.length-1]=l:s.content.push(l),this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("updateToolCall",e=>{const{tool_call:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;const i=s.content[s.content.length-1],o={type:"tool_call",data:t};if("blank"==i.type)s.content[0]=o;else{const e=s.content.find(e=>e.data.id==t.id);if(e){const a=JSON.parse(JSON.stringify(e));a.data.action=t.action,a.data.result=t.result,"pending"==t.action&&(a.data.parameters+=t.parameters);const i=s.content.indexOf(e);s.content[i]=a}else s.content.push(o)}this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("completeMessage",e=>{this.updateLastUpdate();const t=e.messageId,a=this.getMessageById(t);a&&(a.status="completed",this.emit("updateMessageSummary"),this.emit("completeMessage",{messageId:t}))}),this.kernel.on("failedMessage",e=>{if("string"==typeof e.error)try{e.error.message=JSON.parse(e.error.message)}catch(i){}const t=JSON.stringify(e.error,null,2);this.updateLastUpdate();const a=e.messageId,s=this.getMessageById(a);if(s){const e={type:"text",data:{text:"Error : LLM 响应失败！\n```json\n "+t+"\n```"}};s.content.some(e=>"blank"===e.type)?s.content[0]=e:s.content.push(e),s.status="completed",this.emit("updateMessageSummary"),this.emit("completeMessage",{messageId:a})}})}handleLLMMessageEvent(e){this.kernel.handleMessageEvent(e)}loadOptions(e){return"openai"===this.platform?ge.getVerifiedLLMConfig(e):e||{}}async send(e){await this.kernel.send(e)}_getFilePrompt(e){return"\n以下是用户上传的文件：\n"+e.join("\n")}_getImagePrompt(e){return"\n以下是用户所上传的图片链接：\n"+e.map(e=>e.content).join("\n")}_getValidOpenaiMessage(e=this.firstMessageIndex,t=this.messageChain.length,a=this.options.base.max_messages_num){const s=this.messageChain.slice(e,t).slice(-a).filter(e=>"mio_system"!=e.role).map(e=>{const t=[],a=[],s=[];if(e.content.forEach(i=>{const o="tool_call"==i.type?"tool":"user"==e.role?"user":"assistant",l={role:o,content:"none",_content_type:void 0};"tool"==o?(l.role="assistant",l.content=null,l.tool_calls=[{id:i.data.id,function:{name:i.data.name,arguments:i.data.parameters},type:"function"}],s.push({...l}),delete l.tool_calls,l.role="tool",l.content=JSON.stringify(i.data.result),l.tool_call_id=i.data.id,l.name=i.data.name,s.push({...l}),l.role=o):"user"!=o&&"assistant"!=o||("image"==i.type?(l.content=i.data.file,l._content_type="image",s.push(l),a.push(i.data.file.content)):"text"==i.type?(l.content=i.data.text,l._content_type="text",s.push(l)):"file"==i.type&&t.push(i.data.file))}),t.length>0){0==s.filter(e=>"text"==e._content_type).length&&s.push({role:"user",content:this._getFilePrompt(t),_content_type:"text"})}return s});let i=[];s.forEach(e=>{const t=e.filter(e=>"text"==e._content_type),a=e.filter(e=>"image"==e._content_type),s=e.filter(e=>"file"==e._content_type),o=s.length>0?this._getFilePrompt(s):"",l=a.length>0?this._getImagePrompt(a):"";let n=null;t.length>0&&a.length>0&&"user"==a[0].role&&(n={role:"user",content:[...a.map(e=>({type:"image_url",image_url:{url:e.content}})),...t.map(e=>({type:"text",text:e.content+o+l}))]}),n?.content.length==e.length?i.push(n):(e.forEach(e=>{delete e._content_type}),i.push(...e))});const o=this.options.presetSettings.history;return o&&(i=o.concat(i)),i}updateMessageSummary(){this.lastMessageSummary=this.getLastMessageSummary()}getBaseUserContainer(){return{role:"user",time:(new Date).getTime(),status:"completed",id:K(16),content:[]}}async webSend(e,t=!0){if(this.updateLastUpdate(),this.messageChain.push(e),this.updateMessageSummary(),t)try{if("onebot"==this.platform){return await this.kernel.send(this.id,e.content)}{const e=this._getValidOpenaiMessage(),t=K(16);return await this.kernel.send(e,t,this.options),this.revMessage({id:t}),K(16)}}catch(a){throw a}}insertMessage(e,t){this.messageChain.splice(t,0,e),this.updateMessageSummary()}async retryMessage(e){const t=this.getMessageById(e);if(t){t.content=[{type:"blank"}],this.updateLastUpdate();const a=this.messageChain.indexOf(t),s=this._getValidOpenaiMessage(0,a);return this.kernel.send(s,e,this.options),!0}}as;revMessage(e){this.updateLastUpdate();const t=this.kernel.convertMessage(e);return this.active?this.emit("revMessage",t):this.messageChain.push(t),this.emit("updateMessageSummary"),t}delMessage(e){for(let t=0;t<this.messageChain.length;t++)if(this.messageChain[t].id===e&&"other"===this.messageChain[t].role)return this.active?this.emit("delMessage",t):this.acting.messageChain.splice(t,1),this.makeSystemMessage(`${this.name}撤回了一条消息`),!0;return!1}makeSystemMessage(e){const t={role:"mio_system",time:(new Date).getTime(),id:(new Date).getTime(),content:[{type:"text",data:{text:e}}]};this.active?this.emit("revMessage",t):this.messageChain.push(t)}getLastTime(){const e=this.messageChain[this.messageChain.length-1];if(!e)return"";const t=(new Date).getTime(),a=new Date(e.time),s=t-a.getTime();if(s<864e5){this.toinit=!1;return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}if(s<1728e5)return"昨天";if(s<6048e5){return`星期${["日","一","二","三","四","五","六"][a.getDay()]}`}return`${a.getFullYear()}/${(a.getMonth()+1).toString().padStart(2,"0")}/${a.getDate().toString().padStart(2,"0")}`}getShownTime(e){const t=(new Date).getTime()-e;if(t<864e5){return`${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<1728e5){return`昨天${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<6048e5){const t=["日","一","二","三","四","五","六"],a=new Date(e).getDay(),s=new Date(e).getHours().toString().padStart(2,"0"),i=new Date(e).getMinutes().toString().padStart(2,"0");return`星期${t[a]}${s}:${i}`}return`${new Date(e).getFullYear()}/${(new Date(e).getMonth()+1).toString().padStart(2,"0")}/${new Date(e).getDate().toString().padStart(2,"0")} ${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}getLastMessageSummary(e){let t=e||this.messageChain[this.messageChain.length-1];return t?(t=JSON.parse(JSON.stringify(t)),"node"===t.type&&(t=t.data),(e=>{switch(e.type){case"text":case"reason":return e.data.text;case"image":return"[图片]";case"record":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"tool_call":return`[调用工具] ${e.data.name}`;case"blank":return"正在思考中...";case"reply":return"";case"nodes":return"[转发消息]";default:return"[未知消息类型] "+e.type}})(t.content?t.content[0]:t)):""}updateFirstMessage(){this.firstMessageIndex=this.messageChain.length}updateLastUpdate(){this.lastUpdate=(new Date).getTime()}getMessageById(e){return this.messageChain.find(t=>t.id===e)}loadAvatar(){let e="/static/avatar/miobot.png";if("MODEL"==oe[this.avatarPolicy]){const t=this.options.base.model;e=ne.getAvatarByModel(t)}else"CUSTOM"==oe[this.avatarPolicy]&&(e=this.avatar);return"openai"==this.platform&&(this.title=this.options.base.model),this.avatar=e,e}async loadName(){let e=this.name??"未命名 Bot";if("MODEL"==le[this.namePolicy]){e=this.options.model}else"CUSTOM"==le[this.namePolicy]?e=this.name:"SUMMARY"==le[this.namePolicy]&&(this.messageChain.length<2?e="新建的 Bot":2!=this.messageChain.length&&this.messageChain.length%6!=0||(e=await this.getMessagesSummary()));return this.name=e,e}getMessagesSummary(){return"openai"==this.platform?this.kernel.getMessagesSummary(this._getValidOpenaiMessage().slice(-4)):"仅支持 OpenAI Chat Bot"}static getAvatarByModel(e){return function(e){return Object.keys(se).includes(e)?`${ae}/${se[e]}`:`${ae}/openai.svg`}(ge.getModelOwner(e))}}function re(e,t){let a;return function(...s){clearTimeout(a),a=setTimeout(()=>{e.apply(this,s)},t)}}function ce(e){let t=!1,a="";return navigator.share?(t=!0,a="分享成功",navigator.share({title:"从Mio Chat分享",url:e}).then(()=>{}).catch(e=>{t=!1,a="分享失败"})):navigator.clipboard&&(t=!0,a="链接已复制到剪贴板",navigator.clipboard.writeText(e).then(()=>{}).catch(e=>{t=!1,a="复制失败"})),{success:t,message:a}}function de(e){return new Worker("/assets/fileUpload-Di8XL5pf.js",{name:e?.name})}V.config({name:"mio-chat"});const ue={AUTO:"AUTO",ANY:"ANY",NONE:"NONE"},pe={NONE:"BLOCK_NONE",LOW:"BLOCK_ONLY_HIGH",MEDIUM:"BLOCK_MEDIUM_AND_ABOVE",HIGH:"BLOCK_LOW_AND_ABOVE",DEFAULT:"BLOCK_NONE"},he={HARASSMENT:"HARM_CATEGORY_HARASSMENT",HATE_SPEECH:"HARM_CATEGORY_HATE_SPEECH",SEXUALLY_EXPLICIT:"HARM_CATEGORY_SEXUALLY_EXPLICIT",DANGEROUS_CONTENT:"HARM_CATEGORY_DANGEROUS_CONTENT"},me="app_config_v1";const ge=new class{constructor(){this.localPresets=[],this.toolsConfig={},this.llmTools=[],this.onebotConfig=null,this.llmModels={},this.safetyConfig={},this.baseConfig={},this.LLMDefaultConfig={},this.baseConfigCallback=null,this._loadStrogeConfig(),this.initSafetyConfig(),this.initLLMDefaultConfig(),this.loadllmTools().catch(e=>{}),this.loadonebotConfig().catch(e=>{}),this._getLocalStorage(me)||this._saveStrogeConfig()}_setLocalStorage(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(a){}}_getLocalStorage(e){try{const t=localStorage.getItem(e);return null==t?null:JSON.parse(t)}catch(t){return localStorage.removeItem(e),null}}_saveStrogeConfig(){const e={localPresets:this.localPresets,toolsConfig:this.toolsConfig,llmTools:this.llmTools,onebotConfig:this.onebotConfig,llmModels:this.llmModels,baseConfig:this.baseConfig,safetyConfig:this.safetyConfig,LLMDefaultConfig:this.LLMDefaultConfig};this._setLocalStorage(me,e)}_loadStrogeConfig(){const e=this._getLocalStorage(me);e&&(this.localPresets=e.localPresets??[],this.toolsConfig=e.toolsConfig??{},this.llmTools=e.llmTools??[],this.onebotConfig=e.onebotConfig??null,this.llmModels=e.llmModels??{},this.baseConfig=e.baseConfig??{},this.safetyConfig=e.safetyConfig??{},this.LLMDefaultConfig=e.LLMDefaultConfig??{})}_mergeDefaultsRecursive(e,t){if(!e||"object"!=typeof e||!t||"object"!=typeof t)return e;for(const a in e)Object.prototype.hasOwnProperty.call(e,a)&&(a in t||delete e[a]);for(const a in t)if(Object.prototype.hasOwnProperty.call(t,a)){const s=t[a],i=e[a];a in e?"object"!=typeof s||null===s||Array.isArray(s)||"object"!=typeof i||null===i||Array.isArray(i)||this._mergeDefaultsRecursive(i,s):"object"!=typeof s||null===s||Array.isArray(s)?Array.isArray(s)?e[a]=[...s]:e[a]=s:e[a]=this._mergeDefaultsRecursive({},s)}return e}initSafetyConfig(){const e=Object.values(he);let t=!1;this.safetyConfig&&"object"==typeof this.safetyConfig||(this.safetyConfig={},t=!0);for(const a of e)a in this.safetyConfig||(this.safetyConfig[a]=pe.DEFAULT,t=!0)}initLLMDefaultConfig(){const e=this.baseConfig?.llm_providers?.[0],t=e?.displayName??"openai",a={provider:t,base:{model:this.getDefaultModel(t)??"gpt-4o-mini",max_messages_num:10,stream:!0},chatParams:{temperature:1,top_p:1,frequency_penalty:0,presence_penalty:0,reasoning_effort:-1},toolCallSettings:{mode:ue.AUTO,tools:[]},presetSettings:{opening:"",history:[]},extraSettings:{gemini:{imageGeneration:!1,internalTools:{google_search:!1,code_execution:!1,url_context:!1},safetySettings:{[he.HARASSMENT]:pe.DEFAULT,[he.HATE_SPEECH]:pe.DEFAULT,[he.SEXUALLY_EXPLICIT]:pe.DEFAULT,[he.DANGEROUS_CONTENT]:pe.DEFAULT}}}};this.LLMDefaultConfig&&"object"==typeof this.LLMDefaultConfig||(this.LLMDefaultConfig={}),this.LLMDefaultConfig=this._mergeDefaultsRecursive(this.LLMDefaultConfig,a)}getBaseConfig(){return this.baseConfig}setBaseConfig(e){this.baseConfig={...e};const{llm_providers:t=[],default_model:a={}}=this.baseConfig;if(t.length>0){const e=t[0]?.displayName;this.updateLLMDefaultConfig(null,{provider:e});let s=t[0]?.default_model;!s&&a[e]&&(s=a[e]),s&&this.updateLLMDefaultConfig("base",{model:s})}if(this._saveStrogeConfig(),this.baseConfigCallback)try{this.baseConfigCallback(this.baseConfig)}catch(s){}}setBaseConfigCallback(e){this.baseConfigCallback=e}updateBaseConfig(e){const t={...this.baseConfig,...e};this.setBaseConfig(t)}getLLMProviders(){return(this.baseConfig?.llm_providers??[]).map(e=>({value:e.displayName,label:e.displayName,adapterType:e.adapterType}))}getProviderAdapterType(e){const t=(this.baseConfig?.llm_providers??[]).find(t=>t.displayName===e);return t?t.adapterType:null}getDefaultModel(e){const t=(this.baseConfig?.llm_providers||[]).find(t=>t.displayName===e);return t?.default_model?t.default_model:this.baseConfig?.default_model?.[e]}getToolCallModes(){return Object.entries(ue).map(([e,t])=>({value:t,label:e}))}getLlmModels(e){return e?this.llmModels?.[e]??[]:this.llmModels??{}}setLlmModels(e){this.llmModels=e,this._saveStrogeConfig()}getDefaultLLMModel(){const e=this.baseConfig?.llm_providers||[],t={};return e.forEach(e=>{e.displayName&&e.default_model&&(t[e.displayName]=e.default_model)}),0===Object.keys(t).length&&this.baseConfig?.default_model?this.baseConfig.default_model:t}isModelAvailable(e,t){return(this.llmModels?.[e]??[]).some(e=>e.models.includes(t))}getModelOwner(e){for(const t in this.llmModels){const a=(this.llmModels[t]??[]).find(t=>t.models.includes(e));if(a)return a.owner}}getSafetySettingsParams(){return pe}getSafetyConfig(){return this.safetyConfig}setSafetyConfig(e){this.safetyConfig={...e},this.updateLLMDefaultConfig("safetySettings",{...this.safetyConfig})}updateLLMDefaultConfig(e,t){let a=!1;if(e&&this.LLMDefaultConfig[e]&&"object"==typeof this.LLMDefaultConfig[e]){const s=JSON.stringify(this.LLMDefaultConfig[e]);this.LLMDefaultConfig[e]={...this.LLMDefaultConfig[e],...t},JSON.stringify(this.LLMDefaultConfig[e])!==s&&(a=!0)}else{if(e)return;{const e={...this.LLMDefaultConfig};this.LLMDefaultConfig={...this.LLMDefaultConfig,...t},JSON.stringify(e)!==JSON.stringify(this.LLMDefaultConfig)&&(a=!0)}}a&&this._saveStrogeConfig()}getLLMDefaultConfig(e){if(!this.LLMDefaultConfig||"object"!=typeof this.LLMDefaultConfig)return{};let t;try{t=JSON.parse(JSON.stringify(this.LLMDefaultConfig))}catch(a){return{}}if(e&&e!==t.provider){const a=this.getDefaultModel(e);a&&(t.provider=e,t.base.model=a)}return t}getValidTools(e){if(!e||!Array.isArray(e))return[];const t=new Set;"object"==typeof this.llmTools&&null!==this.llmTools&&Object.values(this.llmTools).forEach(e=>{e&&"object"==typeof e&&Object.keys(e).forEach(e=>t.add(e))});const a=e.filter(e=>t.has(e));if(a.length<e.length){e.filter(e=>!t.has(e))}return a}getVerifiedLLMConfig(e){if(!e||"object"!=typeof e)return e;let t=JSON.parse(JSON.stringify(e));return this._mergeDefaultsRecursive(t,this.LLMDefaultConfig),t.toolCallSettings&&Array.isArray(t.toolCallSettings.tools)?t.toolCallSettings.tools=this.getValidTools(t.toolCallSettings.tools):t.toolCallSettings&&(t.toolCallSettings.tools=[]),t}async loadllmTools(){try{const e=await fetch("/api/openai/tools");if(!e.ok)throw new Error(`请求 LLM 工具失败: ${e.status} ${e.statusText}`);const t=await e.json();t&&t.data&&t.data.tools?this.llmTools=t.data.tools:this.llmTools=[]}catch(e){}}async loadonebotConfig(){try{const e=await fetch("/api/onebot/plugins");if(!e.ok)throw new Error(`请求 OneBot 配置失败: ${e.status} ${e.statusText}`);const t=await e.json();t&&t.data&&t.data.options?(this.onebotConfig=t.data.options,this._saveStrogeConfig()):this.onebotConfig=null}catch(e){}}},fe=new class extends Y{constructor(e){super(),this.inited=!1,this.id=null,this.code=null,this.isConnected=!1,this.contactList=[],this.socket=null,this.qq=null,this.bot_qq=null,this.avatar=null,this.onPhone=null,this.title="Mio",this.name="user",this.config=e,this.setLocalStorage=re(this.setLocalStorage.bind(this),500)}async preInit(){const e=this.config.getBaseConfig();0===Object.keys(e).length?await this.loadOriginBaseInfo():(this.loadOriginBaseInfo(),this.loadBaseInfo(e));const t=await this.getLocalStorage();t&&this.loadLocalStorage(t),this.inited=!0,this.emit("loaded")}genDefaultConctor(e){if(e.onebot_enabled){const e={id:this.genFakeId(),name:"OneBot",namePolicy:1,avatarPolicy:1,avatar:`/p/qava?q=${this.bot_qq}`,title:"云崽",priority:0,options:{},lastUpdate:-Infinity};this.addConcator("onebot",e)}const t=this.config.getLLMDefaultConfig(),a=[];for(const i in this.config.llmTools)a.push(...Object.keys(this.config.llmTools[i]));t.toolCallSettings.tools=a;const s={id:this.genFakeId(),name:"MioBot",avatar:"/p/ava/miobot.png",namePolicy:1,avatarPolicy:1,title:"chat",priority:0,lastUpdate:-Infinity,options:t};this.addConcator("openai",s)}async addConcator(t,a){const s=new ne(t,a);s.loadName(),s.loadAvatar();return e(this.contactList).push(s),await this.setLocalStorage(),s}rmContactor(t){const a=e(this.contactList),s=a.findIndex(e=>e.id==t);-1!=s&&(a.splice(s,1),this.setLocalStorage())}async loadOriginalContactors(e){const t=`/api/share?id=${e}`;let a=null;try{const e=await fetch(t),s=await e.json();return 0==s.code&&(a=s.data.contactor,this.getContactor(a.id)||this.addConcator(a.platform,a),!0)}catch(s){return!1}}async shareContactor(e){const t=await this.setOriginalContactor(e);return t||null}async setOriginalContactor(e){const t={contactor:this.getContactor(e)};try{const e=await fetch("/api/share/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(0==a.code)return a.data}catch(a){return null}}async reset(){V.clear(),localStorage.clear();try{await this.resetCache()}catch(e){}return!0}async resetCache(){try{navigator.serviceWorker.controller&&await new Promise((e,t)=>{const a=new MessageChannel;a.port1.onmessage=a=>{"IDB_CACHE_CLEARED"===a.data.type?e():"IDB_CACHE_CLEAR_FAILED"===a.data.type?t(a.data.error):t(new Error("Unknown message from Service Worker"))},a.port1.onerror=e=>{t(e)},navigator.serviceWorker.controller.postMessage({type:"CLEAR_IDB_CACHE"},[a.port2])});const t=await navigator.serviceWorker.getRegistrations();if(t&&t.length>0)for(const a of t)try{await a.unregister()}catch(e){}return!0}catch(e){throw e}}everLogin(){return!!localStorage.getItem("everLogin")}setEverLogin(){localStorage.setItem("everLogin",!0)}async init(){await this.preInit(),this.everLogin()&&(this.isConnected=!1,this.login(this.code))}getContactors(){return this.contactList}getContactor(e,t=null){return t?this.contactList.find(e=>"onebot"==e.platform):this.contactList.find(t=>t.id==e)}genFakeId(){const e=Date.now().toString().slice(-6);return Math.floor(100*Math.random()).toString().padStart(4,"1")+e}async getLocalStorage(){const e=await V.getItem("client");if(e){return JSON.parse(e)}return this.id=this.genFakeId(),this.code=null,null}loadLocalStorage(e){this.id=e.id,this.code=e.code,e.contactList&&0!=e.contactList.length?this.contactList=e.contactList.map(e=>new ne(e.platform,e)):this.contactList=[]}async setLocalStorage(){const e={id:this.id,code:this.code,contactList:this.contactList};await V.setItem("client",JSON.stringify(e))}async login(e){return this.code=e,new Promise((e,t)=>{const a=new Q(this.id,this.code);a.on("connect",async t=>{this.isConnected=!0,this.socket=a,this.config.setLlmModels(t.models),this.addMsgListener(),0==this.contactList.length&&this.genDefaultConctor(t),this.setEverLogin(),this.setLocalStorage(),e(t)}),a.on("connect_error",e=>{this.isConnected=!1,t(e.message)}),a.connect()})}addMsgListener(){this.socket.on("onebot_message",e=>{const t=e.data,a=t.id,s=t.content,i=t.type;if("message"==i){const e=this.getContactor(a,1e4);e&&(e.revMessage(s),this.setLocalStorage())}else if("del_msg"==i){const e=this.contactList.filter(e=>"onebot"==e.platform);for(const t of e){if(t.delMessage(s.message_id)){this.setLocalStorage();break}}}}),this.socket.on("llm_message",e=>{const t=e.data,{metaData:a}=t;if(a.contactorId){const t=this.getContactor(a.contactorId);t&&t.handleLLMMessageEvent(e)}}),this.socket.on("system_message",e=>{try{if(e&&"models_updated"===e.type&&e.data){const{providers:a,models:s,default_model:i}=e.data;if(s&&this.config&&"function"==typeof this.config.setLlmModels&&this.config.setLlmModels(s),a&&this.config&&"function"==typeof this.config.updateBaseConfig)try{a.some(e=>void 0!==e.default_model)?this.config.updateBaseConfig({llm_providers:a}):this.config.updateBaseConfig({llm_providers:a,default_model:i})}catch(t){}return void this.emit("models_updated",{providers:a,models:s})}}catch(t){}})}async logout(){this.isConnected=!1,this.socket.disconnect(),this.socket=null,this.setLocalStorage()}async loadOriginBaseInfo(){const e=await fetch("/api/base_info"),{data:t}=await e.json();return this.config.setBaseConfig(t),this.loadBaseInfo(t),t}loadBaseInfo(e){this.admin_qq=e.admin_qq,this.bot_qq=e.bot_qq,this.avatar=`/p/qava?q=${this.admin_qq}`;const t=this.getContactor(null,1e4);t&&(t.avatar=`/p/qava?q=${this.bot_qq}`)}async uploadFile(e,t={}){const{isImage:a=!1,onProgress:s=null}=t;if(a||"string"==typeof e&&e.startsWith("data:"))return this.uploadImage(e);const i=e;return new Promise((e,t)=>{const a=1048576;let o=null;const l=async(e,t,a)=>new Promise((l,n)=>{const r=new FormData;r.append("file",e),r.append("md5",o),r.append("chunkIndex",t),r.append("totalChunks",a),r.append("filename",i.name);const c=new XMLHttpRequest;c.open("POST","/api/upload/chunk",!0),s&&(c.upload.onprogress=e=>{if(e.lengthComputable){const i=e.loaded/e.total,o=100*(t/a+1/a*i);s(Math.round(o))}}),c.onload=()=>{c.status>=200&&c.status<300?l():n(c.statusText)},c.onerror=()=>{n("Network Error")},c.send(r)}),n=async()=>{if(!i||!o)return t({error:"Invalid file or missing hash"});const s=Math.ceil(i.size/a);try{for(let e=0;e<s;e++){const t=e*a,o=Math.min(t+a,i.size),n=i.slice(t,o);await l(n,e,s)}await(async a=>{try{const t=await fetch("/api/upload/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({totalChunks:a,md5:o,filename:i.name})});if(!t.ok)throw new Error(`HTTP error ${t.status}`);const s=await t.json();e(s)}catch(s){t({error:`Finalization error: ${s.message}`})}})(s)}catch(n){t({error:`Upload error: ${n}`})}},r=new de;r.postMessage({file:i,chunkSize:a}),r.onmessage=e=>{e.data.hash?(o=e.data.hash,n()):e.data.error&&(t({error:e.data.error}),r.terminate())},r.onerror=e=>{t({error:`Worker error: ${e.message}`}),r.terminate()}})}async uploadImage(e){try{const t=await fetch("/api/upload/image",{method:"POST",body:e});if(!t.ok)throw new Error(`HTTP error ${t.status}`);return await t.json()}catch(t){throw t}}async _convertBlobToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}}(ge);fe.init();const ve=(e,t)=>{const a=e.__vccOpts||e;for(const[s,i]of t)a[s]=i;return a},ye="chat",we="profile",be="settings",Ce="none",_e={id:"sidebar"},ke={class:"admin-avatar"},Se=["src"],xe={id:"side",class:"options"},Le={class:"up-half"},Me={class:"down-half"};const Te=ve({data:()=>({processedImage:"/p/qava?q=1099834705",activePage:Ce}),computed:{isChatActive(){return this.activePage===ye},isProfileActive(){return this.activePage===we}},watch:{$route:{handler(e){this.activePage=this.getPageStatusFromRoute(e)},immediate:!0}},mounted(){this.activePage=this.getPageStatusFromRoute();const e=fe.admin_qq;e?this.loadAvatar(e):fe.on("loaded",()=>{const e=fe.admin_qq;this.loadAvatar(e)},!1)},methods:{processImage:async e=>new Promise((t,a)=>{const s=document.createElement("canvas"),i=s.getContext("2d"),o=new Image;o.src=e,o.onload=()=>{s.width=o.width,s.height=o.height,i.drawImage(o,0,0);let e=.8*o.width,a=.86*o.height,l=5/24*o.width;i.beginPath(),i.arc(e,a,l,0,2*Math.PI,!0),i.clip(),i.clearRect(0,0,o.width,o.height),s.toBlob(e=>{const a=URL.createObjectURL(e);t(a)},"image/png")},o.onerror=e=>{a(e)}}),async toChat(){this.activePage=ye,this.$router.push({name:"blank"})},async toProfile(){this.activePage=we,this.$router.push({name:"contactors"})},async toConfig(){this.activePage=be,this.$router.push({name:"settings"})},async loadAvatar(e){const t=`/p/qava?q=${e}`;try{this.processedImage=await this.processImage(t)}catch(a){}},getPageStatusFromRoute(e=this.$route){return"/"===e.path||e.path.includes("/chat/")?ye:"/contactors"===e.path||e.path.includes("/profile/")?we:"/settings"===e.path?be:Ce}}},[["render",function(e,o,l,n,r,c){return i(),t("div",_e,[a("div",ke,[o[3]||(o[3]=a("div",{class:"status"},null,-1)),a("img",{src:r.processedImage,alt:"admin-avatar"},null,8,Se)]),a("div",xe,[a("div",Le,[a("div",{class:s(["icon-back",{active:c.isChatActive}])},[a("div",{id:"chatting",onClick:o[0]||(o[0]=(...e)=>c.toChat&&c.toChat(...e))},o[4]||(o[4]=[a("i",{class:"iconfont chat"},null,-1)]))],2),a("div",{class:s(["icon-back",{active:c.isProfileActive}])},[a("div",{id:"editing",onClick:o[1]||(o[1]=(...e)=>c.toProfile&&c.toProfile(...e))},o[5]||(o[5]=[a("i",{class:"iconfont user"},null,-1)]))],2)]),a("div",Me,[o[7]||(o[7]=a("a",{href:"https://github.com/Pretend-to/mio-chat-backend",target:"_blank",class:"side-icon"},[a("i",{class:"iconfont github"})],-1)),a("div",{class:"side-icon",onClick:o[2]||(o[2]=(...e)=>c.toConfig&&c.toConfig(...e))},o[6]||(o[6]=[a("i",{class:"iconfont menu"},null,-1)]))])])])}],["__scopeId","data-v-550699fc"]]);let Ae=null;const Oe=ve({props:{fullScreen:{type:Boolean,default:!1}},emits:["set-screen","close"],data:()=>({preview:!1,isTauri:!(!window.__TAURI__&&!window.__TAURI_INTERNALS__)}),created(){"true"===new URLSearchParams(window.location.search).get("preview")&&(this.preview=!0),this.isTauri&&(Ae=new U("main"))},methods:{waiting(){this.$message?this.$message({message:"此功能尚未开放",type:"warning"}):alert("此功能尚未开放")},async getMainWindow(){try{return Ae||null}catch(e){return null}},async minimizeWindow(){if(this.isTauri)if(Ae)try{await Ae.minimize()}catch(e){this.waiting()}else this.waiting();else this.$emit("close")},configFullScreen(e){this.isTauri?(async()=>{if(Ae)try{e?await Ae.maximize():await Ae.unmaximize(),this.$emit("set-screen",e)}catch(t){this.waiting()}else this.waiting()})():this.$emit("set-screen",e)},async closeWindow(){if(this.isTauri)if(Ae)try{await Ae.close()}catch(e){this.waiting()}else this.waiting();else this.$emit("close")}}},[["render",function(e,o,l,n,r,c){return i(),t("ul",{class:s({"window-controls":!0,fullscreen:l.fullScreen,preview:r.preview}),"data-tauri-drag-region":"true"},[a("li",{class:"button","data-tauri-drag-region":"",onClick:o[0]||(o[0]=(...e)=>c.minimizeWindow&&c.minimizeWindow(...e))},o[4]||(o[4]=[a("span",{class:"window-min"},"—",-1)])),l.fullScreen?(i(),t("li",{key:0,class:"button","data-tauri-drag-region":"",onClick:o[1]||(o[1]=e=>c.configFullScreen(!1))},o[5]||(o[5]=[a("span",{class:"window-inmax"},[a("i",{class:"iconfont chuangkouhua"})],-1)]))):(i(),t("li",{key:1,class:"button","data-tauri-drag-region":"",onClick:o[2]||(o[2]=e=>c.configFullScreen(!0))},o[6]||(o[6]=[a("span",{class:"window-max"},"▢",-1)]))),a("li",{id:"close",class:"button","data-tauri-drag-region":"",onClick:o[3]||(o[3]=(...e)=>c.closeWindow&&c.closeWindow(...e))},o[7]||(o[7]=[a("span",{class:"window-close"},"×",-1)]))],2)}],["__scopeId","data-v-a5e279e7"]]),Pe={id:"forward-msg-body"},Ee={id:"forward-msg-foot"},Ie={class:"forward-msg-head"},$e={class:"body"},Ve={key:0,id:"other",class:"message-body"},Ue={class:"avatar"},De=["src","alt"],Re={class:"msg"},je={class:"wholename"},Ne={class:"title"},Be={class:"name"};const qe=ve({name:"ForwardMsg",components:{MdRenderer:I,displayButtons:Oe},props:{messages:{type:Array,default:()=>[]},contactor:{type:Object,default:()=>{}}},data:()=>({showBox:!1,onPhone:!1,mioPlugins:[{plugin:$}]}),created(){this.onPhone=window.innerWidth<600,fe.on("device-change",e=>{this.onPhone="mobile"==e},!1)}},[["render",function(e,p,h,m,g,f){const v=d("displayButtons"),y=d("MdRenderer"),w=d("ForwardMsg",!0);return i(),t(l,null,[a("div",{id:"forward-msg-preview",class:s(g.onPhone?"on-phone":""),onClick:p[0]||(p[0]=e=>g.showBox=!0)},[p[2]||(p[2]=a("div",{id:"forward-msg-head"},"转发的聊天消息",-1)),a("div",Pe,[(i(!0),t(l,null,n(h.messages.slice(0,2),(e,a)=>(i(),t("div",{id:"forward-msg-summary",key:a},r(h.contactor.name)+": "+r(h.contactor.getLastMessageSummary(e)),1))),128))]),a("div",Ee,"查看"+r(h.messages.length)+"条转发消息",1)],2),g.showBox?(i(),t("div",{key:0,id:"forward-msg-box",class:s(g.onPhone?"on-phone":"")},[a("div",Ie,[p[3]||(p[3]=a("div",{class:"forward-msg-title"},"转发的聊天消息",-1)),c(v,{class:"cfg-btns",onClose:p[1]||(p[1]=e=>g.showBox=!1)})]),a("div",$e,[(i(!0),t(l,null,n(h.messages,(s,c)=>(i(),t("div",{key:c,class:"message-container"},["node"===s.type?(i(),t("div",Ve,[a("div",Ue,[a("img",{src:`/p/qava/?q=${s.data.uin}`,alt:s.data.name},null,8,De)]),a("div",Re,[a("div",je,[a("div",Ne,r(h.contactor.title),1),a("div",Be,r(s.data.name),1)]),(i(!0),t(l,null,n(s.data.content,(s,o)=>(i(),t("div",{key:o,class:"content"},[a("div",null,["text"===s.type?(i(),u(y,{key:0,md:s.data.text,theme:"github","markdown-it-options":{breaks:!0}},null,8,["md"])):"image"===e.element.type?(i(),u(y,{md:`![image](${e.element.data.file})`,key:e.element.data.file,"custom-plugins":g.mioPlugins,theme:"github"},null,8,["md","custom-plugins"])):"nodes"===s.type?(i(),u(w,{key:2,contactor:e.activeContactor,messages:s.data.messages},null,8,["contactor","messages"])):(i(),u(y,{key:3,md:`尚未支持的消息类型：${s.type}`},null,8,["md"]))])]))),128))])])):o("",!0)]))),128))])],2)):o("",!0)],64)}],["__scopeId","data-v-fc326327"]]),ze={class:"input-bar"},He={class:"options"},Fe={class:"bu-emoji"},Ge={class:"bu-emoji"},We={class:"ho-emoji"},Je={class:"bu-emoji"},Ye={class:"bu-emoji"},Ke={class:"bu-emoji"},Xe={class:"bu-emoji"},Qe={class:"input-box"},Ze={class:"input-content"};const et=ve({props:{activeContactor:{type:Object,required:!0}},emits:["toButtom","cleanHistory","cleanScreen","setModel","stroge"],data:()=>({selectedOption:null,cursorPosition:[],showemoji:!1,openaiModels:null,onebotPresets:[],host:"",uploaded:{files:[],images:[]},isPasting:!1}),computed:{extraOptions(){return"openai"==this.activeContactor.platform?this.openaiModels:this.onebotPresets}},watch:{"$route.params.id"(){this.loadSelected()}},created(){this.loadSelected(),this.debouncedAdjustHeight=re(this.adjustTextareaHeight,100)},mounted(){this.textareaRef=this.$refs.textarea,this.textareaRef.addEventListener("input",this.debouncedAdjustHeight),this.handleDragOver=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#e0e0e0"},this.handleDragLeave=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1"},this.handleDrop=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1";const t=e.dataTransfer.files;t.length>0&&this.handleDroppedFile(t[0])},this.textareaRef.addEventListener("dragover",this.handleDragOver),this.textareaRef.addEventListener("dragleave",this.handleDragLeave),this.textareaRef.addEventListener("drop",this.handleDrop),this.textareaRef.addEventListener("paste",this.handlePaste),this.host=window.location.origin,this.onebotPresets=ge.onebotConfig.textwraper.options},unmounted(){this.textareaRef.removeEventListener("input",this.adjustTextareaHeight),this.textareaRef.removeEventListener("dragover",this.handleDragOver),this.textareaRef.removeEventListener("dragleave",this.handleDragLeave),this.textareaRef.removeEventListener("drop",this.handleDrop),this.textareaRef.removeEventListener("paste",this.handlePaste),this.textareaRef=null},methods:{unsupportedTip(){this.$message.warning("功能暂未开放")},hasInput(){const e=this.textareaRef?.innerText.trim(),t=this.textareaRef?.querySelector("img");return e||t},handleDroppedFile(e){e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadFile(e)},textToHtml:e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/  /g,"&nbsp;&nbsp;").replace(/\n/g,"<br>"),insertHtmlAtCursor(e){const t=window.getSelection();if(!t||0===t.rangeCount)return this.textareaRef.innerHTML+=e,void this.setCursorToEnd(this.textareaRef);const a=t.getRangeAt(0);a.deleteContents();const s=document.createElement("div");s.innerHTML=e;const i=document.createDocumentFragment();for(;s.firstChild;)i.appendChild(s.firstChild);a.insertNode(i),a.collapse(!1),t.removeAllRanges(),t.addRange(a)},handlePaste(e){e.preventDefault();const t=e.clipboardData||window.clipboardData,a=t.items;let s="";const i=[];for(let o=0;o<a.length;o++){const e=a[o];-1!==e.type.indexOf("image")?i.push(e.getAsFile()):"text/plain"===e.type&&(s+=t.getData("text/plain"))}if(s){const e=this.textToHtml(s);this.insertHtmlAtCursor(e)}i.length&&(this.$message.info(`检测到 ${i.length} 张图片，正在处理...`),setTimeout(()=>{this.processImageQueue(i)},0))},getemoji(e){const t=e.detail.unicode;this.insertHtmlAtCursor(this.textToHtml(t)),this.ctrlEmojiPanel()},setCursorToEnd(e){e.focus();const t=window.getSelection(),a=document.createRange();a.selectNodeContents(e),a.collapse(!1),t.removeAllRanges(),t.addRange(a)},async processImageQueue(e){for(const t of e)await this.handleUploadImage(t),await new Promise(e=>setTimeout(e,0))},handleUploadImage(e){return new Promise(t=>{const a=5242880,s=new Image,i=URL.createObjectURL(e);s.src=i,s.onload=()=>{URL.revokeObjectURL(i);const o=e.type.toLowerCase();if("image/gif"===o){if(e.size>a)return this.$message.error("GIF 图片不能超过 5MB"),void t();const s=new FormData;return s.append("image",e,e.name),void fe.uploadImage(s).then(t=>{const a=t.data.url;this.uploaded.images.push(a),this.insertImageToTextarea(a,e.name),this.$message.success("上传 GIF 成功")}).catch(()=>this.$message.error("上传 GIF 失败")).finally(t)}const l=document.createElement("canvas"),n=l.getContext("2d");let r,c;l.width=s.width,l.height=s.height,n.drawImage(s,0,0),"image/png"===o?r="image/png":"image/webp"===o?(r="image/webp",c=.7):(r="image/jpeg",c=.7),l.toBlob(s=>{if(!s)return this.$message.error("图片压缩失败"),void t();if(s.size>a)return this.$message.error("压缩后仍超过 5MB，请选小点的图片"),void t();const i=new FormData;i.append("image",s,e.name),fe.uploadImage(i).then(t=>{const a=t.data.url;this.uploaded.images.push(a),this.insertImageToTextarea(a,e.name),this.$message.success("上传图片成功")}).catch(()=>this.$message.error("上传失败")).finally(t)},r,c)}})},ctrlEmojiPanel(){this.showemoji=!this.showemoji;this.textareaRef.focus()},uploadFile(e){if(e instanceof File)return void this.handleFileUpload(e);const t=document.createElement("input");t.type="file",t.accept=["docx","txt","pdf","pptx","xlsx","png","jpg","jpeg","webp"].map(e=>`.${e}`).join(",");const a=async e=>{t.removeEventListener("change",a);const s=e.target.files[0];s&&this.handleFileUpload(s)};t.addEventListener("change",a),t.click()},handleFileUpload(e){e.size>52428800?this.$message.error("文件大小超过50MB，无法上传"):(this.$message.info("文件上传中..."),e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadDocumentFile(e))},async uploadDocumentFile(e){try{const t=await fe.uploadFile(e);this.$message.success("文件上传成功");const a=`${t.data.url}?size=${e.size}&name=${e.name}`,s=this.activeContactor.getBaseUserContainer();s.content.push({type:"file",data:{file:this.host+a}}),this.activeContactor.webSend(s,!1)}catch(t){this.$message.error("文件上传失败，请稍后再试")}this.$emit("stroge"),this.$emit("toButtom")},insertImageToTextarea(e,t){const a=document.createElement("img");a.src=e,a.alt=t,a.style.maxWidth="10rem",a.style.maxHeight="10rem";const s=document.createRange();s.selectNodeContents(this.textareaRef),s.collapse(!1);const i=window.getSelection();i.removeAllRanges(),i.addRange(s);const o=s.createContextualFragment(`<span>${a.outerHTML}</span>`);s.insertNode(o),setTimeout(()=>{const e=document.createRange();e.selectNodeContents(this.textareaRef),e.collapse(!1);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)},0)},initLLMExtraOptions(){const e=fe.config.getLlmModels();this.openaiModels=Object.entries(e).map(([e,t])=>({value:e,label:e,children:t.map(e=>({value:e.owner,label:e.owner,children:e.models.map(e=>({value:e,label:e}))}))}))},getOpenaiModelArray:e=>[fe.config.getModelOwner(e),e],wrapText(e){const t=this.getOnebotPreset();if(!this.selectedOption||!t)return e;return t.replace("{xxx}",e)},getOnebotPreset(){const e=this.onebotPresets.reduce((e=[],t)=>[...e,...t.children??[t]],[]).find(e=>e.value==this.selectedOption)?.preset;return e},loadSelected(){"onebot"===this.activeContactor.platform?this.activeContactor.preset&&(this.selectedOption=this.activeContactor.preset):(this.initLLMExtraOptions(),this.selectedOption=this.activeContactor.options.base.model)},adjustTextareaHeight(){const e=this.textareaRef;e.style.height="auto",e.style.height=e.scrollHeight+"px"},getWraperName(){const e=this.getOnebotPreset();return"onebot"===this.activeContactor.platform&&e&&this.selectedOption?e.replace("#","").replace("{xxx}",""):""},updateCursorPosition(){const e=window.getSelection();if(e&&e.rangeCount>0){const t=e.getRangeAt(0);this.cursorPosition[0]=t.startOffset,this.cursorPosition[1]=t.endOffset}},presend(){this.textareaRef.focus();const e=this.textareaRef.querySelectorAll("img"),t=Array.from(e).map(e=>e.src);let a=this.getSafeText(this.textareaRef.innerText);const s="onebot"===this.activeContactor.platform?this.wrapText(a):a;this.textareaRef.innerHTML="",this.adjustTextareaHeight();const i=this.activeContactor.getBaseUserContainer();return s.trim()&&i.content.push({type:"text",data:{text:s}}),t.forEach(e=>{i.content.unshift({type:"image",data:{file:e}})}),this.repliedMessageId&&i.content.push({type:"reply",data:{id:this.repliedMessageId}}),i},async send(){if(!this.hasInput())return;this.$emit("toButtom");const e=this.presend();try{const t=await this.activeContactor.webSend(e);e.id=t,this.$emit("stroge"),this.uploaded.images=[],this.uploaded.files=[]}catch(t){this.$message.error("发送消息失败")}},getSafeText:e=>e,cleanScreen(){this.$emit("cleanScreen")},currentChange(e,t){if(3===t.level){if(!t.parent||!t.parent.parent)return;const a=[t.parent.parent.data.value,t.parent.data.value,e.value];this.$message({message:"已切换到 "+a[2]+" 模型",type:"success"});const s=a[0];s!==this.activeContactor.options?.provider&&this.$message({message:"已切换到 "+s+" 协议",type:"success"}),this.$emit("setModel",a)}else 2===t.level&&"onebot"===this.activeContactor.platform&&this.getOnebotPreset()&&!this.getOnebotPreset().includes("xxx")&&this.send()},handleKeyDown(e){"Enter"===e.key&&(e.ctrlKey?this.hasInput()?this.send():this.$message({message:"不能发送空消息",type:"warning"}):document.execCommand("insertHTML",!1,"\n")),setTimeout(()=>{this.updateCursorPosition()},0)}}},[["render",function(e,s,o,l,n,u){const f=d("el-tree-select"),v=d("el-popconfirm");return i(),t("div",ze,[a("div",He,[a("div",Fe,[p(a("emoji-picker",{ref:"emojiPicker",onEmojiClick:s[0]||(s[0]=(...e)=>u.getemoji&&u.getemoji(...e))},null,544),[[h,n.showemoji]]),s[10]||(s[10]=a("p",{class:"ho-emoji"},"表情",-1)),a("i",{class:"iconfont smile",onClick:s[1]||(s[1]=m((...e)=>u.ctrlEmojiPanel&&u.ctrlEmojiPanel(...e),["prevent"]))})]),a("div",Ge,[a("p",We,r("openai"==o.activeContactor.platform?"模型选择":"工具选择"),1),c(f,{id:"wraper-selector",modelValue:n.selectedOption,"onUpdate:modelValue":s[2]||(s[2]=e=>n.selectedOption=e),data:u.extraOptions,accordion:"",placement:"top-start",onNodeClick:u.currentChange},null,8,["modelValue","data","onNodeClick"]),s[11]||(s[11]=a("i",{class:"iconfont robot"},null,-1))]),a("div",Je,[s[12]||(s[12]=a("p",{class:"ho-emoji"},"重置人格",-1)),a("i",{class:"iconfont reset",onClick:s[3]||(s[3]=t=>e.$emit("cleanHistory"))})]),a("div",Ye,[s[13]||(s[13]=a("p",{class:"ho-emoji"},"上传",-1)),a("i",{class:"iconfont upload",onClick:s[4]||(s[4]=(...e)=>u.uploadFile&&u.uploadFile(...e))})]),a("div",Ke,[s[15]||(s[15]=a("p",{class:"ho-emoji"},"清除记录",-1)),c(v,{class:"box-item",title:"此操作不可撤销","confirm-button-text":"确定","cancel-button-text":"取消",placement:"top",onConfirm:s[5]||(s[5]=t=>e.$emit("cleanScreen"))},{reference:g(()=>s[14]||(s[14]=[a("i",{class:"iconfont shanchu"},null,-1)])),_:1})]),a("div",Xe,[s[16]||(s[16]=a("p",{class:"ho-emoji"},"更多",-1)),a("i",{class:"iconfont more",onClick:s[6]||(s[6]=(...e)=>u.unsupportedTip&&u.unsupportedTip(...e))})])]),a("div",Qe,[a("div",Ze,[a("div",{ref:"textarea",class:"input-area",contenteditable:"true",onKeydown:s[7]||(s[7]=(...e)=>u.handleKeyDown&&u.handleKeyDown(...e)),onClick:s[8]||(s[8]=(...e)=>u.updateCursorPosition&&u.updateCursorPosition(...e))},null,544)]),a("button",{id:"sendButton",onClick:s[9]||(s[9]=m((...e)=>u.send&&u.send(...e),["prevent"]))}," 发送"+r(u.getWraperName()?` | ${u.getWraperName()}`:""),1)])])}],["__scopeId","data-v-1b641cbc"]]),tt={class:"file-block"},at={class:"file-block-icon"},st={key:0},it={class:"file-block-text"},ot=["title"],lt={class:"file-info"};const nt=ve({props:{fileUrl:{type:String,required:!0}},data:()=>({file_name:"",file_type:"",formated_file_size:""}),computed:{iconClass(){const e=this.file_type.toLowerCase();return"pdf"===e?"file-icon-pdf":["xls","xlsx","csv"].includes(e)?"file-icon-spreadsheet":["doc","docx"].includes(e)?"file-icon-word":["ppt","pptx"].includes(e)?"file-icon-ppt":"file-icon-other"}},created(){const e=this.fileUrl.split("?"),t=new URLSearchParams(e[1]),a=t.get("size");this.file_name=t.get("name"),this.formated_file_size=this.formatFileSize(a);const s=e[0].split(".");this.file_type=s[s.length-1]},methods:{formatFileSize(e){let t=0;for(;e>=1024;)e/=1024,t++;return e.toFixed(2)+" "+["B","KB","MB"][t]}}},[["render",function(e,l,n,c,d,u){return i(),t("div",tt,[a("div",at,[a("div",{class:s(["file-icon",u.iconClass])},[d.file_type?(i(),t("span",st,r(d.file_type.toUpperCase()),1)):o("",!0)],2)]),a("div",it,[a("div",{class:"file-name",title:d.file_name},r(d.file_name),9,ot),a("div",lt,r(d.file_type.toUpperCase())+", "+r(d.formated_file_size),1)])])}],["__scopeId","data-v-f2fa73bf"]]),rt={class:"tool-call-bar"},ct={class:"status-icon"},dt={key:0,class:"call-success-icon"},ut={key:1,class:"call-fail-icon"},pt={key:2,class:"call-pend-icon"},ht={class:"tool-info"},mt={class:"tool-name"},gt={class:"tool-status"},ft={class:"extra-info"},vt={class:"extra-detail"},yt={class:"detail-params"},wt={class:"detail-title"},bt={class:"detail-content"},Ct={class:"detail-result"},_t={class:"detail-title"},kt={class:"detail-content"};const St=ve({props:{toolCall:{type:Object,required:!0}},data:()=>({showExtraInfo:!1,teleportStyle:{},openUp:!1}),computed:{toolCallSuccess(){return"finished"===this.toolCall.action&&!this.toolCall?.result?.error},toolCallFail(){return"finished"===this.toolCall.action&&this.toolCall?.result?.error},call_status(){return"started"==this.toolCall.action?"开始运行":"pending"==this.toolCall.action?"函数构建中":"running"==this.toolCall.action?"函数运行中":this.toolCallSuccess?"函数运行成功":this.toolCallFail?"函数运行失败":"未知状态"}},mounted(){},methods:{async copyToClipboard(e){try{await navigator.clipboard.writeText(e),this.$message&&this.$message({message:"已复制到剪贴板",type:"success"})}catch(t){this.$message&&this.$message({message:"复制失败",type:"error"})}},copyParameters(){const e=this.toolCall.parameters,t="string"==typeof e?e:JSON.stringify(e,null,2);this.copyToClipboard(t)},copyResult(){const e=this.toolCall.result,t="string"==typeof e?e:JSON.stringify(e,null,2);this.copyToClipboard(t)},toggleExtraInfo(e){this.showExtraInfo=!this.showExtraInfo,this.showExtraInfo?(this.positionTeleport(),window.addEventListener("resize",this.positionTeleport),document.addEventListener("click",this.onDocClick)):(window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick))},onDocClick(e){const t=this.$el,a=this.$refs.teleportContent;t&&!t.contains(e.target)&&a&&!a.contains(e.target)&&(this.showExtraInfo=!1,window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick))},positionTeleport(){const e=this.$el;if(!e)return;const t=e.getBoundingClientRect(),a=Math.max(8,t.left),s=t.bottom+8;this.teleportStyle={position:"fixed",top:s+"px",left:a+"px",minWidth:t.width+"px",zIndex:1e4},this.$nextTick(()=>{const e=this.$refs.teleportContent;if(!e)return;const i=e.getBoundingClientRect(),o=i.height,l=i.width;let n=a;if(n+l+8>window.innerWidth&&(n=Math.max(8,window.innerWidth-l-8)),t.bottom+o+12>window.innerHeight){const e=t.top-o-8;this.openUp=!0,this.teleportStyle={position:"fixed",top:e+"px",left:n+"px",minWidth:t.width+"px",zIndex:1e4}}else this.openUp=!1,this.teleportStyle={position:"fixed",top:s+"px",left:n+"px",minWidth:t.width+"px",zIndex:1e4}})}},beforeUnmount(){window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick)}},[["render",function(e,l,n,c,d,p){return i(),t("div",rt,[a("div",ct,[p.toolCallSuccess?(i(),t("span",dt,l[4]||(l[4]=[a("div",{class:"checkmark-container"},[a("svg",{class:"checkmark",viewBox:"0 0 52 36",xmlns:"http://www.w3.org/2000/svg"},[a("polyline",{points:"1 20 15 36 51 1"})])],-1)]))):p.toolCallFail?(i(),t("span",ut,"❌")):(i(),t("span",pt))]),a("div",ht,[a("div",null,[a("span",mt,r(n.toolCall.name.split("_mid_")[0]),1)]),a("div",gt,r(p.call_status),1)]),a("div",ft,[a("button",{ref:"show-extra-info",class:s({active:d.showExtraInfo,"extra-info-button":!0}),onClick:l[0]||(l[0]=(...e)=>p.toggleExtraInfo&&p.toggleExtraInfo(...e))},l[5]||(l[5]=[a("svg",{t:"1731677922196",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5948",width:"16",height:"16"},[a("path",{d:"M778.965749 128.759549l-383.064442 383.063419 388.097062 388.096039-0.070608 0.033769c12.709463 13.137205 20.529569 31.024597 20.529569 50.731428 0 40.376593-32.736589 73.112158-73.115228 73.112158-19.705807 0-37.591153-7.819083-50.730405-20.528546l-0.034792 0.035816L241.890654 564.622498l0.035816-0.035816c-13.779841-13.281491-22.3838-31.915897-22.3838-52.585659 0-0.071631 0-0.106424 0-0.178055 0-0.072655 0-0.10847 0-0.144286 0-20.669762 8.603959-39.341007 22.3838-52.622498l-0.035816-0.034792L680.573835 20.337187l0.180102 0.179079c13.139252-12.5662 30.950919-20.313651 50.587142-20.313651 40.378639 0 73.115228 32.736589 73.115228 73.114205C804.455283 95.485725 794.567076 115.334795 778.965749 128.759549z","p-id":"5949"})],-1)]),2)]),(i(),u(v,{to:"body"},[d.showExtraInfo?(i(),t("div",{key:0,ref:"teleportContent",class:s(["extra-info-bar",{active:d.showExtraInfo,upward:d.openUp}]),style:f(d.teleportStyle),onClick:l[3]||(l[3]=m(()=>{},["stop"]))},[a("div",vt,[a("div",yt,[a("div",wt,[l[7]||(l[7]=a("span",null,"参数",-1)),a("button",{class:"copy-btn",onClick:l[1]||(l[1]=(...e)=>p.copyParameters&&p.copyParameters(...e)),title:"复制参数"},l[6]||(l[6]=[a("i",{class:"iconfont fuzhi",title:"复制参数"},null,-1)]))]),a("div",bt,r(n.toolCall.parameters),1)]),a("div",Ct,[a("div",_t,[l[9]||(l[9]=a("span",null,"返回值",-1)),a("button",{class:"copy-btn",onClick:l[2]||(l[2]=(...e)=>p.copyResult&&p.copyResult(...e)),title:"复制返回值"},l[8]||(l[8]=[a("i",{class:"iconfont fuzhi",title:"复制返回值"},null,-1)]))]),a("div",kt,r(n.toolCall.result),1)])])],6)):o("",!0)]))])}],["__scopeId","data-v-40160f25"]]),xt={class:"reason-block"},Lt={class:"head-bar"},Mt={class:"reason-info"};const Tt=ve({props:{content:{required:!0,type:String,default:""},startTime:{required:!0,type:Number},endTime:{required:!1,type:Number,default:0}},data:()=>({show:!0,maxHeight:"auto"}),computed:{getReasonInfo(){if(this.endTime){return`已深度思考（耗时 ${((this.endTime-this.startTime)/1e3).toFixed(2)} 秒）`}return"正在深度思考......"}},mounted(){this.updateMaxHeight()},updated(){this.updateMaxHeight()},methods:{toggleShow(){this.show=!this.show,this.updateMaxHeight()},updateMaxHeight(){this.show?this.maxHeight=this.$refs.reasonContent.scrollHeight+20+"px":this.maxHeight="0px"}}},[["render",function(e,o,l,n,c,d){return i(),t("div",xt,[a("div",Lt,[a("div",Mt,r(d.getReasonInfo),1),a("button",{class:s({active:c.show,"extra-info-button":!0}),onClick:o[0]||(o[0]=(...e)=>d.toggleShow&&d.toggleShow(...e))},o[1]||(o[1]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)]),a("div",{ref:"reasonContent",class:"reason-content",style:f({"max-height":c.maxHeight})},r(l.content),5)])}],["__scopeId","data-v-81bd691d"]]);const At=ve({name:"MessageMenu",props:{type:{type:String,default:"message"},message:{type:Object,default:()=>({})},seletedText:{type:String,default:""},seletedImage:{type:String,default:""}},data:()=>({isUp:!1}),emits:["close","message-option"],methods:{updateArrow(){const e=this.$el;if(!e)return;const t=e.style&&e.style.bottom&&""!==e.style.bottom;this.isUp=!!t},onWindowResize(){this.updateArrow()},async copySeletedImage(){this.$emit("close");try{await this.copyImageToClipboard(this.seletedImage)}catch(e){}},async saveSeletedImage(){this.$emit("close");try{await this.downloadImage(this.seletedImage)}catch(e){}},copyText(){let e="";this.message.content.forEach(t=>{"text"===t.type?e+=t.data.text:"image"===t.type&&(e+=`\n![图片](${t.data.file})`)}),this.copyTextToClipboard(e),this.$emit("close")},copySeletedText(){this.copyTextToClipboard(this.seletedText),this.$emit("close")},retryMessage(){this.$emit("message-option","retry"),this.$emit("close")},replyMessage(){this.$emit("message-option","reply"),this.$emit("close")},deleteMessage(){this.$emit("message-option","delete"),this.$emit("close")},enterChat(){this.$emit("message-option","enter"),this.$emit("close")},togglePriority(){this.$emit("message-option","priority"),this.$emit("close")},shareBot(){this.$emit("message-option","share"),this.$emit("close")},deleteBot(){this.$emit("message-option","delete"),this.$emit("close")},async copyTextToClipboard(e){let t;try{t=document.createElement("textarea"),t.style.position="absolute",t.style.left="-9999px",t.value=e,document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),await document.execCommand("copy"),this.$message({message:"复制成功",type:"success"})}catch(a){this.$message({message:"复制失败",type:"error"})}finally{document.body.removeChild(t)}},async copyImageToClipboard(e){try{const t=await fetch(e);if(!t.ok)throw new Error("网络错误，无法获取图片");const a=await t.blob(),s=new Image,i=URL.createObjectURL(a);s.onload=async()=>{const e=document.createElement("canvas");e.width=s.width,e.height=s.height;e.getContext("2d").drawImage(s,0,0);const t=await new Promise(t=>{e.toBlob(t,"image/png")});if(t){const e=new ClipboardItem({"image/png":t});await navigator.clipboard.write([e]),this.$message({message:"图片已复制到剪贴板",type:"success"})}else this.$message({message:"转换为 PNG 失败",type:"error"});URL.revokeObjectURL(i)},s.onerror=()=>{this.$message({message:"加载图片失败",type:"error"}),URL.revokeObjectURL(i)},s.src=i}catch(t){this.$message({message:"复制图片失败",type:"error"})}},async downloadImage(e){try{const t=document.createElement("a");t.href=e,t.download="image.png",t.click()}catch(t){this.$message({message:"保存图片失败",type:"error"})}}},mounted(){this.$nextTick(()=>{this.updateArrow()}),window.addEventListener("resize",this.onWindowResize)},updated(){this.$nextTick(()=>{this.updateArrow()})},beforeUnmount(){window.removeEventListener("resize",this.onWindowResize)}},[["render",function(e,n,c,d,u,p){return i(),t("div",{id:"message-menu",class:s({"expand-up":u.isUp,"expand-down":!u.isUp})},["friend"===c.type?(i(),t(l,{key:0},[a("div",{onClick:n[0]||(n[0]=m((...e)=>p.enterChat&&p.enterChat(...e),["stop"]))},n[11]||(n[11]=[a("i",{class:"iconfont chat"},null,-1),a("span",null,"进入对话",-1)])),a("div",{onClick:n[1]||(n[1]=m((...e)=>p.togglePriority&&p.togglePriority(...e),["stop"]))},[n[12]||(n[12]=a("i",{class:"iconfont star"},null,-1)),a("span",null,r(0===c.message.priority?"取消置顶":"置顶"),1)]),a("div",{onClick:n[2]||(n[2]=m((...e)=>p.shareBot&&p.shareBot(...e),["stop"]))},n[13]||(n[13]=[a("i",{class:"iconfont icon-share"},null,-1),a("span",null,"分享",-1)])),a("div",{onClick:n[3]||(n[3]=m((...e)=>p.deleteBot&&p.deleteBot(...e),["stop"]))},n[14]||(n[14]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除",-1)]))],64)):(i(),t(l,{key:1},[c.seletedText?(i(),t("div",{key:0,onClick:n[4]||(n[4]=m((...e)=>p.copySeletedText&&p.copySeletedText(...e),["stop"]))},n[15]||(n[15]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制选中",-1)]))):o("",!0),a("div",{onClick:n[5]||(n[5]=m((...e)=>p.copyText&&p.copyText(...e),["stop"]))},n[16]||(n[16]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制消息",-1)])),c.seletedImage?(i(),t("div",{key:1,onClick:n[6]||(n[6]=m((...e)=>p.copySeletedImage&&p.copySeletedImage(...e),["stop"]))},n[17]||(n[17]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制图片",-1)]))):o("",!0),c.seletedImage?(i(),t("div",{key:2,onClick:n[7]||(n[7]=m((...e)=>p.saveSeletedImage&&p.saveSeletedImage(...e),["stop"]))},n[18]||(n[18]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"保存图片",-1)]))):o("",!0),a("div",{onClick:n[8]||(n[8]=m((...e)=>p.retryMessage&&p.retryMessage(...e),["stop"]))},n[19]||(n[19]=[a("i",{class:"iconfont reset"},null,-1),a("span",null,"重试消息",-1)])),a("div",{onClick:n[9]||(n[9]=m((...e)=>p.replyMessage&&p.replyMessage(...e),["stop"]))},n[20]||(n[20]=[a("i",{class:"iconfont yinyong"},null,-1),a("span",null,"引用消息",-1)])),a("div",{onClick:n[10]||(n[10]=m((...e)=>p.deleteMessage&&p.deleteMessage(...e),["stop"]))},n[21]||(n[21]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除消息",-1)]))],64))],2)}],["__scopeId","data-v-35b3fda4"]]),Ot={class:"add-contactor-body mobile"},Pt={class:"tabs mobile"},Et=["onClick"],It={class:"tab-content mobile"},$t={class:"adapters-view"},Vt={class:"search"},Ut=["src"],Dt={class:"adapter-info"},Rt={class:"adapter-header"},jt={class:"adapter-name"},Nt={class:"adapter-desc"},Bt={class:"presets-view"},qt={class:"search"},zt={class:"info"},Ht={class:"presets-types mobile"},Ft=["onClick"],Gt={key:0,class:"preset-avatar custom"},Wt=["src"],Jt={key:1,class:"preset-avatar model"},Yt=["src"],Kt={key:2,class:"preset-avatar"},Xt={class:"preset-info"},Qt={class:"preset-name"},Zt=["title"],ea={key:0,class:"loading"},ta={key:1,class:"empty-list"},aa={class:"share-code-view"},sa={class:"share-input-container"},ia={class:"add-contactor-body"},oa={class:"tabs"},la=["onClick"],na={class:"tab-content"},ra={class:"adapters-view"},ca={class:"search"},da=["src"],ua={class:"adapter-info"},pa={class:"adapter-header"},ha={class:"adapter-name"},ma={class:"adapter-desc"},ga={class:"presets-view"},fa={class:"search"},va={class:"info"},ya={class:"presets-types"},wa=["onClick"],ba={key:0,class:"preset-avatar custom"},Ca=["src"],_a={key:1,class:"preset-avatar model"},ka=["src"],Sa={key:2,class:"preset-avatar"},xa={class:"preset-info"},La={class:"preset-name"},Ma=["title"],Ta={key:0,class:"loading"},Aa={key:1,class:"empty-list"},Oa={class:"share-code-view"},Pa={class:"share-input-container"},Ea={__name:"AddContactor",props:{show:{type:Boolean,default:!1}},emits:["addBot","close","add-by-provider","add-by-share-code","update:show"],setup(e,{emit:v}){const x=v,L=k(),M=["推荐","最近","本地","系统"],T=["适配器","预设","分享码"],A=y(0),O=y(""),P=y(""),E=y([]),I=y([]),$=y([]),V=y([]),U=y([]),N=y(0),B=y(0),q=y(""),z=y(0),H=y("4px"),F=y(!0),G=y(!0),W=y(!1),J=w(()=>3===z.value?F.value:0===z.value&&G.value),Y=w(()=>q.value?U.value:2===z.value?$.value:1===z.value?I.value:0===z.value?E.value:3===z.value?V.value:[]),K=w(()=>ge.getLLMProviders()),X=w(()=>{if(!O.value.trim())return K.value;const e=O.value.toLowerCase();return K.value.filter(t=>t.value.toLowerCase().includes(e)||t.label.toLowerCase().includes(e)||t.adapterType.toLowerCase().includes(e))}),Q=()=>{W.value=window.innerWidth<=768},Z=()=>{ee()},ee=()=>{x("close")},te=e=>{x("add-by-provider",e.value),j.success(`正在创建 ${e.label} Bot...`),ee()},ae=e=>({openai:"OpenAI GPT 系列模型",gemini:"Google Gemini 模型",vertex:"Google Vertex AI 平台",onebot:"OneBot 协议 (QQ, etc.)"}[e]||"大语言模型适配器"),se=e=>({openai:"primary",gemini:"success",vertex:"warning",onebot:"info"}[e]||"info"),oe=e=>({openai:"#f0f9ff",gemini:"#f0f7ff",vertex:"#fffbeb",onebot:"#f0f4ff"}[e]||"#f5f5f5"),le=()=>{if(!P.value.trim())return void j.warning("请输入分享码");const e=P.value.trim();if(/^\d+$/.test(e))return L.push(`/s/${e}`),void ee();try{const t=new URL(e),a=window.location.host;if(t.host===a){return t.pathname.match(/^\/s\/(\d+)$/)?(L.push(t.pathname),void ee()):void j.error("链接格式不正确，应为 /s/数字")}return void j.error("链接域名与当前网站不一致")}catch(t){return void j.error("请输入有效的分享码或分享链接")}},re=e=>{ce(e),x("addBot",e),j.success("添加成功")},ce=e=>{const t=I.value.find(t=>t.name===e.name);t&&I.value.splice(I.value.indexOf(t),1),I.value.unshift(e),I.value.length>20&&I.value.pop(),localStorage.setItem("recent-presets",JSON.stringify(I.value))},de=async()=>{if(q.value){z.value=-1;const e=await fetch(`/api/openai/presets?type=search&keyword=${q.value}`).then(e=>e.json());U.value=e.data||[]}else z.value=0,pe(0)},ue=async()=>{if(3===z.value&&0===V.value.length){const e=await fetch(`/api/openai/presets?type=system&start=${N.value}&limit=20`).then(e=>e.json());V.value=e.data||[],N.value+=V.value.length,(!e.data||e.data.length<20)&&(F.value=!1)}else if(0===z.value&&0===E.value.length){const e=await fetch(`/api/openai/presets?type=recommended&start=${B.value}&limit=20`).then(e=>e.json());E.value=e.data||[],B.value+=E.value.length,(!e.data||e.data.length<20)&&(G.value=!1)}},pe=e=>{z.value=e,H.value=`calc(${25*e}% + 4px)`,ue()},he=({scrollTop:e})=>{const t=document.querySelector(".presets-list .el-scrollbar__wrap");if(!t||!J.value)return;t.scrollHeight-e-t.clientHeight<100&&(async()=>{if(3===z.value&&F.value){const e=(await fetch(`/api/openai/presets?type=system&start=${N.value}&limit=20`).then(e=>e.json())).data||[];e.length>0&&(V.value=[...V.value,...e],N.value+=e.length),e.length<20&&(F.value=!1)}else if(0===z.value&&G.value){const e=(await fetch(`/api/openai/presets?type=recommended&start=${B.value}&limit=20`).then(e=>e.json())).data||[];e.length>0&&(E.value=[...E.value,...e],B.value+=e.length),e.length<20&&(G.value=!1)}})()};return b(async()=>{Q(),window.addEventListener("resize",Q),(()=>{const e=localStorage.getItem("recent-presets");e&&(I.value=JSON.parse(e));const t=localStorage.getItem("local-presets");t&&($.value=JSON.parse(t))})(),await ue()}),C(()=>{window.removeEventListener("resize",Q)}),(v,y)=>{const w=d("el-input"),b=d("el-tag"),C=d("el-button"),k=d("el-empty"),x=d("el-scrollbar"),L=d("el-icon"),E=d("el-dialog");return W.value?(i(),t("div",{key:0,class:s(["mobile-fullscreen-overlay",{show:e.show}]),onClick:Z},[a("div",{class:s(["mobile-container",{show:e.show}]),onClick:y[3]||(y[3]=m(()=>{},["stop"]))},[a("div",{class:"mobile-header"},[y[10]||(y[10]=a("div",{class:"mobile-title"},"添加机器人",-1)),a("button",{class:"mobile-close-btn",onClick:ee},y[9]||(y[9]=[a("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none"},[a("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)]))]),a("div",Ot,[a("div",Pt,[(i(),t(l,null,n(T,(e,t)=>a("div",{key:t,class:s(["tab-item",{active:A.value===t}]),onClick:e=>A.value=t},r(e),11,Et)),64))]),a("div",It,[p(a("div",$t,[a("div",Vt,[c(w,{modelValue:O.value,"onUpdate:modelValue":y[0]||(y[0]=e=>O.value=e),placeholder:"搜索适配器...","prefix-icon":_(D),clearable:""},null,8,["modelValue","prefix-icon"])]),c(x,{class:"adapters-list"},{default:g(()=>[(i(!0),t(l,null,n(X.value,(e,s)=>(i(),t("div",{key:s,class:"adapter-item mobile"},[a("div",{class:"adapter-icon",style:f({backgroundColor:oe(e.adapterType)})},[a("img",{src:_(ie)(e.adapterType),class:"adapter-icon-img"},null,8,Ut)],4),a("div",Dt,[a("div",Rt,[c(b,{size:"small",type:se(e.adapterType),effect:"plain",round:""},{default:g(()=>[S(r(e.adapterType),1)]),_:2},1032,["type"]),a("div",jt,r(e.label),1)]),a("div",Nt,r(ae(e.adapterType)),1)]),c(C,{type:"primary",size:"small",onClick:t=>te(e)},{default:g(()=>y[11]||(y[11]=[S("添加")])),_:2},1032,["onClick"])]))),128)),0===X.value.length?(i(),u(k,{key:0,description:"未找到相关适配器"})):o("",!0)]),_:1})],512),[[h,0===A.value]]),p(a("div",Bt,[a("div",qt,[c(w,{modelValue:q.value,"onUpdate:modelValue":y[1]||(y[1]=e=>q.value=e),placeholder:"输入搜索关键词","prefix-icon":_(D),clearable:"",onInput:de},null,8,["modelValue","prefix-icon"])]),a("div",zt,[a("header",Ht,[a("div",{style:f({left:H.value}),class:"slide-button"},null,4),(i(),t(l,null,n(M,(e,t)=>a("nav",{key:t,class:s(z.value===t?"active":""),onClick:e=>pe(t)},r(e),11,Ft)),64))]),Y.value.length>0||[0,3].includes(z.value)?(i(),u(x,{key:0,class:"presets-list",onScroll:he},{default:g(()=>[(i(!0),t(l,null,n(Y.value,(e,s)=>(i(),t("div",{key:s,class:"presets-item mobile"},[e.avatar?(i(),t("div",Gt,[a("img",{src:e.avatar},null,8,Wt)])):e.model?(i(),t("div",Jt,[a("img",{src:_(ne).getAvatarByModel(e.model)},null,8,Yt)])):(i(),t("div",Kt,r(e.name.slice(0,2)),1)),a("div",Xt,[a("div",Qt,r(e.name),1),a("div",{title:e.opening,class:"preset-description"},r(e.opening),9,Zt)]),c(C,{onClick:t=>re(e)},{default:g(()=>y[12]||(y[12]=[S("添加")])),_:2},1032,["onClick"])]))),128)),J.value?(i(),t("div",ea,[c(L,{class:"is-loading"},{default:g(()=>[c(_(R))]),_:1}),y[13]||(y[13]=a("span",{style:{"margin-left":"8px"}},"加载中...",-1))])):o("",!0)]),_:1})):(i(),t("div",ta,[c(k,{"image-size":120})]))])],512),[[h,1===A.value]]),p(a("div",aa,[a("div",sa,[y[15]||(y[15]=a("div",{class:"input-label"},"输入分享码或分享链接",-1)),c(w,{modelValue:P.value,"onUpdate:modelValue":y[2]||(y[2]=e=>P.value=e),placeholder:"粘贴分享码或链接...",clearable:"",class:"share-input"},null,8,["modelValue"]),c(C,{type:"primary",disabled:!P.value.trim(),onClick:le,style:{width:"100%","margin-top":"16px"}},{default:g(()=>y[14]||(y[14]=[S(" 加载 Bot ")])),_:1},8,["disabled"])])],512),[[h,2===A.value]])])])],2)],2)):(i(),u(E,{key:1,"model-value":e.show,title:"添加机器人",width:"500px",class:"add-contactor-dialog","onUpdate:modelValue":y[7]||(y[7]=e=>v.$emit("update:show",e)),onClose:y[8]||(y[8]=e=>v.$emit("close"))},{default:g(()=>[a("div",ia,[a("div",oa,[(i(),t(l,null,n(T,(e,t)=>a("div",{key:t,class:s(["tab-item",{active:A.value===t}]),onClick:e=>A.value=t},r(e),11,la)),64))]),a("div",na,[p(a("div",ra,[a("div",ca,[c(w,{modelValue:O.value,"onUpdate:modelValue":y[4]||(y[4]=e=>O.value=e),placeholder:"搜索适配器...","prefix-icon":_(D),clearable:""},null,8,["modelValue","prefix-icon"])]),c(x,{class:"adapters-list"},{default:g(()=>[(i(!0),t(l,null,n(X.value,(e,s)=>(i(),t("div",{key:s,class:"adapter-item"},[a("div",{class:"adapter-icon",style:f({backgroundColor:oe(e.adapterType)})},[a("img",{src:_(ie)(e.adapterType),class:"adapter-icon-img"},null,8,da)],4),a("div",ua,[a("div",pa,[c(b,{size:"small",type:se(e.adapterType),effect:"plain",round:""},{default:g(()=>[S(r(e.adapterType),1)]),_:2},1032,["type"]),a("div",ha,r(e.label),1)]),a("div",ma,r(ae(e.adapterType)),1)]),c(C,{type:"primary",size:"small",onClick:t=>te(e)},{default:g(()=>y[16]||(y[16]=[S("添加")])),_:2},1032,["onClick"])]))),128)),0===X.value.length?(i(),u(k,{key:0,description:"未找到相关适配器"})):o("",!0)]),_:1})],512),[[h,0===A.value]]),p(a("div",ga,[a("div",fa,[c(w,{modelValue:q.value,"onUpdate:modelValue":y[5]||(y[5]=e=>q.value=e),placeholder:"输入搜索关键词","prefix-icon":_(D),clearable:"",onInput:de},null,8,["modelValue","prefix-icon"])]),a("div",va,[a("header",ya,[a("div",{style:f({left:H.value}),class:"slide-button"},null,4),(i(),t(l,null,n(M,(e,t)=>a("nav",{key:t,class:s(z.value===t?"active":""),onClick:e=>pe(t)},r(e),11,wa)),64))]),Y.value.length>0||[0,3].includes(z.value)?(i(),u(x,{key:0,class:"presets-list",onScroll:he},{default:g(()=>[(i(!0),t(l,null,n(Y.value,(e,s)=>(i(),t("div",{key:s,class:"presets-item"},[e.avatar?(i(),t("div",ba,[a("img",{src:e.avatar},null,8,Ca)])):e.model?(i(),t("div",_a,[a("img",{src:_(ne).getAvatarByModel(e.model)},null,8,ka)])):(i(),t("div",Sa,r(e.name.slice(0,2)),1)),a("div",xa,[a("div",La,r(e.name),1),a("div",{title:e.opening,class:"preset-description"},r(e.opening),9,Ma)]),c(C,{onClick:t=>re(e)},{default:g(()=>y[17]||(y[17]=[S("添加")])),_:2},1032,["onClick"])]))),128)),J.value?(i(),t("div",Ta,[c(L,{class:"is-loading"},{default:g(()=>[c(_(R))]),_:1}),y[18]||(y[18]=a("span",{style:{"margin-left":"8px"}},"加载中...",-1))])):o("",!0)]),_:1})):(i(),t("div",Aa,[c(k,{"image-size":120})]))])],512),[[h,1===A.value]]),p(a("div",Oa,[a("div",Pa,[y[20]||(y[20]=a("div",{class:"input-label"},"输入分享码或分享链接",-1)),c(w,{modelValue:P.value,"onUpdate:modelValue":y[6]||(y[6]=e=>P.value=e),placeholder:"粘贴分享码或链接...",clearable:"",class:"share-input"},null,8,["modelValue"]),c(C,{type:"primary",disabled:!P.value.trim(),onClick:le,style:{width:"100%","margin-top":"16px"}},{default:g(()=>y[19]||(y[19]=[S(" 加载 Bot ")])),_:1},8,["disabled"])])],512),[[h,2===A.value]])])])]),_:1},8,["model-value"]))}}},Ia={id:"friendlists",ref:"friendlists"},$a={id:"friends",class:"upsidebar"},Va={class:"bu-add"},Ua={class:"people"},Da=["id","onClick","onContextmenu"],Ra=["src","alt"],ja={class:"info"},Na={class:"name"},Ba={id:"time",class:"msginfo"},qa={id:"msgctt",class:"msginfo"};const za=ve({components:{AddContactor:ve(Ea,[["__scopeId","data-v-3218009c"]]),ContextMenu:At},data:()=>({contactorList:[],showAddWindow:!1,showMenu:!1,menuX:0,menuY:0,selectedFriend:null}),computed:{sortedList(){return[...this.contactorList].sort((e,t)=>t.priority<e.priority?1:t.lastUpdate-e.lastUpdate)},avaliableProvideres:()=>ge.getLLMProviders().map(e=>e.value)},created(){0==fe.getContactors().length?fe.on("loaded",()=>{this.contactorList=fe.getContactors(),this.addReactiveListener()},!1):(this.contactorList=fe.getContactors(),this.addReactiveListener())},methods:{genBotByShareCode(){this.showAddWindow=!1,this.$emit("open-share-code-window")},openAddWindow(){this.showAddWindow=!0},showChat(e){"blank"==this.$route.name||"chat_view"==this.$route.name?this.$router.push({name:"chat_view",params:{id:e}}):"contactors"==this.$route.name||"profile_view"==this.$route.name?this.$router.push({name:"profile_view",params:{id:e}}):this.$router.replace({name:"chat_view",params:{id:e}})},getId(e){return this.$route.params.id==e.id?"active":0==e.priority?"important":""},async genBotByProvider(e){const t=ge.getLLMDefaultConfig(e),a={id:this.genFakeId(),title:t.base.model,avatarPolicy:0,namePolicy:2,priority:1,options:t};await fe.addConcator("openai",a),this.addReactiveListener()},startResize(e){this.isResizing=!0,this.startX=e.clientX,this.startWidth=this.$refs.friendlists.offsetWidth,document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.stopResize)},resize(e){if(this.isResizing){let t=this.startWidth+(e.clientX-this.startX);const a=document.documentElement.style.fontSize?parseFloat(document.documentElement.style.fontSize):16,s=20*a,i=12*a;t=t>s?s:t<i?i:t,this.$refs.friendlists.style.minWidth=t+"px",this.$refs.friendlists.style.maxWidth=t+"px"}},stopResize(){this.isResizing=!1,document.removeEventListener("mousemove",this.resize),document.removeEventListener("mouseup",this.stopResize)},genFakeId:()=>fe.genFakeId(),mergeOptions(e){const t=ge.getLLMDefaultConfig();if(e.history&&(t.presetSettings.history=e.history),e.tools?.length>0&&(t.toolCallSettings.tools=ge.getValidTools(e.tools)),e.opening&&(t.presetSettings.opening=e.opening),e.model){const a=ge.getLLMProviders().map(e=>e.value).find(t=>ge.isModelAvailable(t,e.model));a?(t.provider=a,t.base.model=e.model):(t.base.model=e.model,this.$message({message:"预设模型不存在, 已使用默认模型",type:"error"}))}return t},async addPresetContactor(e){const t={id:this.genFakeId(),namePolicy:1,avatarPolicy:e.avatar?1:0,avatar:e.avatar?e.avatar:void 0,name:e.name,title:e.title,priority:1,options:this.mergeOptions(e)};await fe.addConcator("openai",t),this.addReactiveListener()},showFriendContextMenu(e,t){this.selectedFriend=t,this.menuX=e.clientX,this.menuY=e.clientY,this.showMenu=!0;const a=()=>{this.showMenu=!1,document.removeEventListener("click",a)};document.addEventListener("click",a)},async handleFriendOption(e){switch(e){case"enter":this.showChat(this.selectedFriend.id);break;case"priority":this.selectedFriend.priority=0===this.selectedFriend.priority?1:0,fe.setLocalStorage();break;case"share":{const e=await fe.shareContactor(this.selectedFriend.id);if(e&&e.shareUrl){const{shareUrl:t}=e,{success:a,message:s}=ce(t);a?this.$message({message:s,type:"success"}):this.$message({message:s,type:"error"})}break}case"delete":{let e;e=this.contactorList.findIndex(e=>e.id===this.selectedFriend.id),-1!==e&&(this.contactorList.splice(e,1),fe.setLocalStorage());break}}this.showMenu=!1},addReactiveListener(){this.contactorList.map(e=>{e.on("updateMessageSummary",()=>{e.lastMessageSummary=e.getLastMessageSummary(),this.$forceUpdate()})})}}},[["render",function(e,p,h,g,v,y){const w=d("AddContactor"),b=d("ContextMenu");return i(),t("div",Ia,[a("div",$a,[p[6]||(p[6]=a("div",{class:"search"},[a("i",{class:"iconfont sousuo listicon"}),a("input",{id:"main-search",type:"text",placeholder:"搜索"})],-1)),a("div",Va,[a("button",{id:"addcont",title:"Add Bot",onClick:p[0]||(p[0]=(...e)=>y.openAddWindow&&y.openAddWindow(...e))},p[5]||(p[5]=[a("i",{class:"iconfont add"},null,-1)]))])]),a("div",Ua,[(i(!0),t(l,null,n(y.sortedList,(e,o)=>(i(),t("div",{id:y.getId(e),key:o,class:"lists",onClick:t=>y.showChat(e.id),onContextmenu:m(t=>y.showFriendContextMenu(t,e),["prevent"])},[a("div",{class:s(["avatar",1==e.avatarPolicy?"custom":"model"])},[a("img",{src:e.avatar,alt:e.name},null,8,Ra)],2),a("div",ja,[a("div",Na,r(e.name),1),a("div",Ba,r(e.getLastTime()),1),a("div",qa,r(e.lastMessageSummary),1)])],40,Da))),128))]),a("div",{class:"resizer",onMousedown:p[1]||(p[1]=(...e)=>y.startResize&&y.startResize(...e))},null,32),c(w,{show:v.showAddWindow,"onUpdate:show":p[2]||(p[2]=e=>v.showAddWindow=e),onClose:p[3]||(p[3]=e=>v.showAddWindow=!1),onAddBot:y.addPresetContactor,onAddByProvider:y.genBotByProvider,onAddByShareCode:y.genBotByShareCode},null,8,["show","onAddBot","onAddByProvider","onAddByShareCode"]),v.showMenu?(i(),u(b,{key:0,type:"friend",message:v.selectedFriend,style:f({top:v.menuY+"px"}),onMessageOption:y.handleFriendOption,onClose:p[4]||(p[4]=e=>v.showMenu=!1)},null,8,["message","style","onMessageOption"])):o("",!0)],512)}],["__scopeId","data-v-76346cff"]]),Ha={class:"presets-list"},Fa={class:"preset-message-block"},Ga=["onMouseover"],Wa={key:0,class:"avatar-emoji"},Ja=["onBlur"],Ya={class:"messages-buttons"};const Ka={class:"settings-container"},Xa={key:0,class:"openai-settings"},Qa={class:"settings-block"},Za={class:"block-content"},es={class:"block-content-item"},ts={class:"item-content"},as={class:"item-title"},ss={class:"item-content"},is={class:"settings-block"},os={class:"block-content"},ls={class:"block-content-item"},ns={class:"item-content"},rs={class:"block-content-item",style:{overflow:"hidden"}},cs={class:"settings-block"},ds={class:"block-content"},us={class:"block-content-item"},ps={class:"item-content"},hs={class:"item-title"},ms={class:"item-content"},gs=["onClick"],fs={class:"item-hidden-content plugin-tools-container"},vs=["title"],ys={class:"item-title"},ws={class:"item-content"},bs={key:1,class:"settings-block"},Cs={class:"block-content"},_s={class:"block-content-item"},ks={class:"item-content"},Ss={class:"block-content-item"},xs={class:"item-content"},Ls={class:"block-content-item",style:{overflow:"hidden"}},Ms={id:"internal-tools-settings",class:"sub-items"},Ts={class:"item-title"},As={class:"item-content"},Os={class:"block-content-item"},Ps={class:"item-content"},Es={class:"block-content-item",style:{overflow:"hidden"}},Is={id:"safety-settings",class:"sub-items"},$s={class:"item-title"},Vs={class:"item-content"};const Us=ve({name:"ContactorSettings",components:{PresetsList:ve({props:{presetsHistory:{type:Array,default:()=>[]}},emits:["updatePresets"],data(){return{presetMessages:[...this.presetsHistory],hoveredIndex:void 0}},watch:{presetsHistory(e){this.presetMessages=[...e]}},methods:{delPresetMessage(){this.presetMessages.splice(this.hoveredIndex,1),this.$emit("updatePresets",this.presetMessages)},addPresetMessage(e){"system"==e&&this.presetMessages.length>0?this.$message.warning("系统消息必须是第一条消息"):(this.presetMessages.push({role:e,content:""}),this.$emit("updatePresets",this.presetMessages))},getMessageAvatar:e=>"assistant"==e?"🤖":"system"==e?"⚙️":"👤",handleMessageUpdate(e){this.presetMessages[e].content=this.$refs[`message-${e}`][0].innerText,this.$emit("updatePresets",this.presetMessages)}}},[["render",function(e,s,o,u,p,h){const m=d("el-button");return i(),t("div",Ha,[(i(!0),t(l,null,n(p.presetMessages,(e,o)=>(i(),t("div",{key:o,class:"preset-message"},[a("div",Fa,[a("div",{class:"message-avatar",onMouseover:e=>p.hoveredIndex=o,onMouseleave:s[1]||(s[1]=e=>p.hoveredIndex=null)},[p.hoveredIndex!=o?(i(),t("div",Wa,r(h.getMessageAvatar(e.role)),1)):(i(),t("div",{key:1,title:"删除消息",class:"avatar-emoji hovered",onClick:s[0]||(s[0]=(...e)=>h.delPresetMessage&&h.delPresetMessage(...e))}," 🗑️ "))],40,Ga),a("div",{ref_for:!0,ref:`message-${o}`,class:"message-content",contenteditable:"true",onBlur:e=>h.handleMessageUpdate(o)},r(p.presetMessages[o].content),41,Ja)])]))),128)),a("div",Ya,[c(m,{title:"添加系统消息",plain:"",onClick:s[2]||(s[2]=e=>h.addPresetMessage("system"))},{default:g(()=>s[5]||(s[5]=[S("➕ ⚙️")])),_:1}),c(m,{title:"添加助手消息",plain:"",onClick:s[3]||(s[3]=e=>h.addPresetMessage("assistant"))},{default:g(()=>s[6]||(s[6]=[S("➕ 🤖")])),_:1}),c(m,{title:"添加用户消息",plain:"",onClick:s[4]||(s[4]=e=>h.addPresetMessage("user"))},{default:g(()=>s[7]||(s[7]=[S("➕ 👤")])),_:1})])])}],["__scopeId","data-v-88c48edc"]])},props:{modelValue:{type:Object,required:!0},activeContactorPlatform:{type:String,required:!0},llmProvidersList:{type:Array,required:!0},toolCallModesList:{type:Array,required:!0},allLlmToolsData:{type:Array,required:!0},safetySettingsParams:{type:Object,required:!0},safetySimpleValueOptions:{type:Array,required:!0},presetsHistoryData:{type:Array,default:()=>[]}},emits:["update:modelValue","provider-changed","update-presets"],data(){return{localLlmProvider:this.modelValue.provider,localLlmGeneralKeys:{},localLlmToolCallMode:this.modelValue.toolCallSettings?.mode,localAllLLMTools:JSON.parse(JSON.stringify(this.allLlmToolsData)),localGeminiExtraSettings:JSON.parse(JSON.stringify(this.modelValue.extraSettings.gemini)),localGeminiSafetySettings:{},showPresetsDetail:!1,showInternalTools:!1,showSafetySettings:!1,sliderTypes:{a:{min:0,max:2,step:.1},b:{min:0,max:1,step:.1},c:{min:-2,max:2,step:.1},d:{min:-1,max:3,step:1,formatter:e=>({"-1":"默认",0:"关闭思考",1:"基础思考",2:"均衡思考",3:"深度思考"}[e])}}}},computed:{isGeminiAdapter(){const e=ge.getProviderAdapterType(this.localLlmProvider);return["gemini","vertex"].includes(e)}},watch:{modelValue:{handler(e){this.localLlmProvider=e.provider,this.localLlmToolCallMode=e.toolCallSettings?.mode,this.localGeminiExtraSettings=JSON.parse(JSON.stringify(e.extraSettings.gemini)),this.initializeSettings()},deep:!0},allLlmToolsData:{handler(e){this.localAllLLMTools=JSON.parse(JSON.stringify(e)),this.updateEnabledTools()},deep:!0}},created(){this.initializeSettings()},methods:{initializeSettings(){this.localLlmGeneralKeys={...this.modelValue.base,...this.modelValue.chatParams};const e=ge.getProviderAdapterType(this.localLlmProvider);["gemini","vertex"].includes(e)&&(this.localGeminiSafetySettings=this.safeSimplify(this.localGeminiExtraSettings.safetySettings)),this.updateEnabledTools()},updateEnabledTools(){const e=this.modelValue.toolCallSettings?.tools||[];this.localAllLLMTools=this.localAllLLMTools.map(t=>({...t,tools:t.tools.map(t=>({...t,enabled:e.includes(t.name)}))}))},getShownKey:e=>({mode:"工具调用",model:"模型",max_messages_num:"最大历史消息数",stream:"流式响应",reasoning_effort:"思考强度",temperature:"温度",top_p:"核采样",frequency_penalty:"重复惩罚度",presence_penalty:"话题新鲜度",HARM_CATEGORY_HARASSMENT:"骚扰",HARM_CATEGORY_HATE_SPEECH:"仇恨言论",HARM_CATEGORY_SEXUALLY_EXPLICIT:"色情",HARM_CATEGORY_DANGEROUS_CONTENT:"危险内容",HARM_CATEGORY_CIVIC_INTEGRITY:"公民诚信",imageGeneration:"图像生成",google_search:"联网搜索",code_execution:"代码执行",url_context:"网页解析"}[e]||e),emitUpdate(){const e=JSON.parse(JSON.stringify(this.modelValue)),{model:t,stream:a,max_messages_num:s,temperature:i,top_p:o,frequency_penalty:l,presence_penalty:n,reasoning_effort:r}=this.localLlmGeneralKeys;e.base={model:t,max_messages_num:s,stream:a},e.chatParams={temperature:i,top_p:o,frequency_penalty:l,presence_penalty:n,reasoning_effort:r},e.provider=this.localLlmProvider,e.toolCallSettings||(e.toolCallSettings={}),e.toolCallSettings.mode=this.localLlmToolCallMode;const c=this.localAllLLMTools.flatMap(e=>e.tools.filter(e=>e.enabled).map(e=>e.name));e.toolCallSettings.tools=c,e.extraSettings||(e.extraSettings={}),e.extraSettings.gemini||(e.extraSettings.gemini={internalTools:{},safetySettings:{}}),e.extraSettings.gemini=JSON.parse(JSON.stringify(this.localGeminiExtraSettings)),this.$emit("update:modelValue",e)},updateGeneralSettings(){this.emitUpdate()},handleProviderChange(e){this.localLlmProvider=e;const t=ge.getDefaultModel(e);t&&(this.localLlmGeneralKeys.model=t),this.emitUpdate(),this.$emit("provider-changed",e);const a=ge.getProviderAdapterType(e);["gemini","vertex"].includes(a)&&(this.localGeminiSafetySettings=this.safeSimplify(this.localGeminiExtraSettings.safetySettings))},handleUpdatePresets(e){this.$emit("update-presets",e)},handleToolCallModeChange(){this.emitUpdate()},handleToolEnableChange(){this.emitUpdate()},handleGeminiSettingsChange(){this.emitUpdate()},safeSimplify(e){const t={},a=new Map,s=this.safetySettingsParams;return Object.keys(s).forEach(e=>{a.set(s[e],e)}),Object.keys(e||{}).forEach(s=>{t[s]=a.get(e[s])}),t},handleSafetySettingChange(e){const t=this.localGeminiSafetySettings[e],a=this.safetySettingsParams[t];this.localGeminiExtraSettings.safetySettings||(this.localGeminiExtraSettings.safetySettings={}),this.localGeminiExtraSettings.safetySettings[e]=a,this.emitUpdate()}}},[["render",function(e,m,f,v,y,w){const b=d("el-option"),C=d("el-select"),_=d("el-input"),k=d("el-input-number"),S=d("el-switch"),L=d("el-slider"),M=d("PresetsList");return i(),t("div",Ka,["openai"==f.activeContactorPlatform?(i(),t("div",Xa,[a("div",Qa,[m[7]||(m[7]=a("div",{class:"block-title"},"LLM 基本配置",-1)),a("div",Za,[a("div",es,[m[6]||(m[6]=a("div",{class:"item-title"},"来源渠道",-1)),a("div",ts,[c(C,{modelValue:y.localLlmProvider,"onUpdate:modelValue":m[0]||(m[0]=e=>y.localLlmProvider=e),style:{width:"10rem"},onChange:w.handleProviderChange},{default:g(()=>[(i(!0),t(l,null,n(f.llmProvidersList,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])])]),(i(!0),t(l,null,n(y.localLlmGeneralKeys,(e,s)=>(i(),t("div",{key:s,class:"block-content-item"},[a("div",as,r(w.getShownKey(s)),1),a("div",ss,["model"===s?(i(),u(_,{key:0,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):"max_messages_num"===s?(i(),u(k,{key:1,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,min:1,step:1,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):["stream"].includes(s)?(i(),u(S,{key:2,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):["temperature"].includes(s)?(i(),u(L,{key:3,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.a.step,min:y.sliderTypes.a.min,max:y.sliderTypes.a.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["top_p"].includes(s)?(i(),u(L,{key:4,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.b.step,min:y.sliderTypes.b.min,max:y.sliderTypes.b.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["frequency_penalty","presence_penalty"].includes(s)?(i(),u(L,{key:5,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.c.step,min:y.sliderTypes.c.min,max:y.sliderTypes.c.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["reasoning_effort"].includes(s)?(i(),u(L,{key:6,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.d.step,min:y.sliderTypes.d.min,max:y.sliderTypes.d.max,"format-tooltip":y.sliderTypes.d.formatter,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","format-tooltip","onChange"])):o("",!0)])]))),128))])]),a("div",is,[m[10]||(m[10]=a("div",{class:"block-title"},"LLM 预设配置",-1)),a("div",os,[a("div",ls,[m[9]||(m[9]=a("div",{class:"item-title"},"预设历史记录",-1)),a("div",ns,[a("button",{class:s({active:y.showPresetsDetail,"extra-info-button":!0}),onClick:m[1]||(m[1]=e=>y.showPresetsDetail=!y.showPresetsDetail)},m[8]||(m[8]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(x,{name:"expand-slide"},{default:g(()=>[p(a("div",rs,[c(M,{"presets-history":f.presetsHistoryData,onUpdatePresets:w.handleUpdatePresets},null,8,["presets-history","onUpdatePresets"])],512),[[h,y.showPresetsDetail]])]),_:1})])]),a("div",cs,[m[13]||(m[13]=a("div",{class:"block-title"},"LLM 工具调用配置",-1)),a("div",ds,[a("div",us,[m[11]||(m[11]=a("div",{class:"item-title"},"工具调用模式",-1)),a("div",ps,[c(C,{modelValue:y.localLlmToolCallMode,"onUpdate:modelValue":m[2]||(m[2]=e=>y.localLlmToolCallMode=e),placeholder:"AUTO",style:{width:"10rem"},onChange:w.handleToolCallModeChange},{default:g(()=>[(i(!0),t(l,null,n(f.toolCallModesList,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])])]),(i(!0),t(l,null,n(y.localAllLLMTools,(e,o)=>(i(),t("div",{key:o,class:"block-content-item parent-item"},[a("div",hs,r(e.name),1),a("div",ms,[a("button",{class:s({active:!e.collapsed,"extra-info-button":!0}),onClick:t=>e.collapsed=!e.collapsed},m[12]||(m[12]=[a("i",{class:"iconfont icon-return"},null,-1)]),10,gs)]),c(x,{name:"expand-slide"},{default:g(()=>[p(a("div",fs,[(i(!0),t(l,null,n(e.tools,(e,s)=>(i(),t("div",{key:s,class:"block-content-item child-item",title:e.description},[a("div",ys,r(e.name.split("_mid_")[0]),1),a("div",ws,[c(S,{modelValue:e.enabled,"onUpdate:modelValue":t=>e.enabled=t,onChange:w.handleToolEnableChange},null,8,["modelValue","onUpdate:modelValue","onChange"])])],8,vs))),128))],512),[[h,!e.collapsed]])]),_:2},1024)]))),128))])])])):o("",!0),w.isGeminiAdapter?(i(),t("div",bs,[m[19]||(m[19]=a("div",{class:"block-title"},"Gemini 额外设置",-1)),a("div",Cs,[a("div",_s,[m[14]||(m[14]=a("div",{class:"item-title"},"图像生成",-1)),a("div",ks,[c(S,{modelValue:y.localGeminiExtraSettings.imageGeneration,"onUpdate:modelValue":m[3]||(m[3]=e=>y.localGeminiExtraSettings.imageGeneration=e),onChange:w.handleGeminiSettingsChange},null,8,["modelValue","onChange"])])]),a("div",Ss,[m[16]||(m[16]=a("div",{class:"item-title"},"内置工具",-1)),a("div",xs,[a("button",{class:s({active:y.showInternalTools,"extra-info-button":!0}),onClick:m[4]||(m[4]=e=>y.showInternalTools=!y.showInternalTools)},m[15]||(m[15]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(x,{name:"expand-slide"},{default:g(()=>[p(a("div",Ls,[a("ul",Ms,[(i(!0),t(l,null,n(y.localGeminiExtraSettings.internalTools,(e,s)=>(i(),t("li",{key:s,class:"block-content-item child-item"},[a("div",Ts,r(w.getShownKey(s)),1),a("div",As,[c(S,{modelValue:y.localGeminiExtraSettings.internalTools[s],"onUpdate:modelValue":e=>y.localGeminiExtraSettings.internalTools[s]=e,onChange:w.handleGeminiSettingsChange},null,8,["modelValue","onUpdate:modelValue","onChange"])])]))),128))])],512),[[h,y.showInternalTools]])]),_:1}),a("div",Os,[m[18]||(m[18]=a("div",{class:"item-title"},"过滤等级设置",-1)),a("div",Ps,[a("button",{class:s({active:y.showSafetySettings,"extra-info-button":!0}),onClick:m[5]||(m[5]=e=>y.showSafetySettings=!y.showSafetySettings)},m[17]||(m[17]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(x,{name:"expand-slide"},{default:g(()=>[p(a("div",Es,[a("ul",Is,[(i(!0),t(l,null,n(y.localGeminiSafetySettings,(e,s)=>(i(),t("li",{key:s,class:"block-content-item child-item"},[a("div",$s,r(w.getShownKey(s)),1),a("div",Vs,[c(C,{modelValue:y.localGeminiSafetySettings[s],"onUpdate:modelValue":e=>y.localGeminiSafetySettings[s]=e,style:{width:"10rem"},onChange:e=>w.handleSafetySettingChange(s)},{default:g(()=>[(i(!0),t(l,null,n(f.safetySimpleValueOptions,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])]))),128))])],512),[[h,y.showSafetySettings]])]),_:1})])])):o("",!0)])}]]),Ds={class:"error-boundary"},Rs={key:0,class:"error-container"},js={class:"error-details"},Ns=ve({__name:"ErrorBoundary",props:{fallbackTitle:{type:String,default:"出现错误"},fallbackMessage:{type:String,default:"加载此页面时发生错误，请稍后重试"},showDetails:{type:Boolean,default:!0},onError:{type:Function,default:null}},setup(e){const s=e,l=k(),n=y(!1),m=y(""),f=y(""),v=y(""),w=y(!1);L((e,t,a)=>(n.value=!0,m.value=s.fallbackTitle,f.value=e.message||s.fallbackMessage,v.value=e.stack||"",s.onError&&s.onError(e,t,a),!1));const b=()=>{n.value=!1,m.value="",f.value="",v.value="",w.value=!1,l.go(0)},C=()=>{window.history.length>1?l.back():l.push("/settings")};return(s,l)=>{const y=d("el-button"),_=d("el-space"),k=d("el-result"),x=d("el-card"),L=d("el-collapse-transition");return i(),t("div",Ds,[n.value?(i(),t("div",Rs,[c(k,{icon:"error",title:m.value,"sub-title":f.value},{extra:g(()=>[c(_,null,{default:g(()=>[c(y,{type:"primary",onClick:b},{default:g(()=>l[1]||(l[1]=[S(" 重新加载 ")])),_:1}),c(y,{onClick:C},{default:g(()=>l[2]||(l[2]=[S(" 返回 ")])),_:1}),e.showDetails?(i(),u(y,{key:0,text:"",onClick:l[0]||(l[0]=e=>w.value=!w.value)},{default:g(()=>[S(r(w.value?"隐藏":"查看")+"详细信息 ",1)]),_:1})):o("",!0)]),_:1})]),_:1},8,["title","sub-title"]),c(L,null,{default:g(()=>[p(a("div",js,[c(x,null,{header:g(()=>l[3]||(l[3]=[a("span",null,"错误详情",-1)])),default:g(()=>[a("pre",null,r(v.value),1)]),_:1})],512),[[h,w.value&&v.value]])]),_:1})])):M(s.$slots,"default",{key:1},void 0,!0)])}}},[["__scopeId","data-v-5bde4aa5"]]);const Bs=new class{constructor(){this.adminCode="",this._initialized=!1}init(){this._initialized||(this.adminCode=localStorage.getItem("admin_code")||"",this._initialized=!0)}setAdminCode(e){this.adminCode=e,localStorage.setItem("admin_code",e)}async request(e,t={}){this._initialized||this.init();const a={"X-Admin-Code":this.adminCode,"Content-Type":"application/json",...t.headers};try{const s=await fetch(e,{...t,headers:a}),i=await s.json();if(!s.ok)throw 401!==s.status&&403!==s.status||("UNAUTHORIZED"===i.error||"FORBIDDEN"===i.error||i.message?.includes("认证")||i.message?.includes("权限")||i.message?.includes("访问码"))&&(this.adminCode="",localStorage.removeItem("admin_code")),new Error(i.message||i.error||"请求失败");if(0!==i.code&&void 0!==i.code)throw new Error(i.message||"请求失败");return i}catch(s){throw s}}async getConfig(){return this.request("/api/config")}async getConfigSection(e){return this.request(`/api/config/${e}`)}async updateConfig(e){return this.request("/api/config",{method:"PUT",body:JSON.stringify(e)})}async updateConfigSection(e,t){return this.request(`/api/config/${e}`,{method:"PUT",body:JSON.stringify(t)})}async addAdapter(e,t){return this.request(`/api/config/llm/${e}`,{method:"POST",body:JSON.stringify(t)})}async updateAdapter(e,t,a){return this.request(`/api/config/llm/${e}/${t}`,{method:"PUT",body:JSON.stringify(a)})}async deleteAdapter(e,t){return this.request(`/api/config/llm/${e}/${t}`,{method:"DELETE"})}async batchDeleteAdapters(e){const t=[...e].sort((e,t)=>t.index-e.index),a=[];for(const i of t)try{const e=await this.deleteAdapter(i.type,i.index);a.push({success:!0,adapter:i,result:e})}catch(s){a.push({success:!1,adapter:i,error:s.message})}return a}async refreshAllModels(){return this.request("/api/config/refresh-models",{method:"POST"})}async refreshAdapterModels(e,t){return this.request(`/api/config/llm/${e}/${t}/refresh-models`,{method:"POST"})}async validateConfig(e){return this.request("/api/config/validate",{method:"POST",body:JSON.stringify(e)})}async resetConfig(){return this.request("/api/config/reset",{method:"POST"})}async exportConfig(e="mio-chat-config.json"){const t=(await this.getConfig()).data,a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=e,i.click(),URL.revokeObjectURL(s)}async importConfig(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=e=>{try{const a=JSON.parse(e.target.result);t(a)}catch{a(new Error("无效的 JSON 文件"))}},s.onerror=()=>{a(new Error("文件读取失败"))},s.readAsText(e)})}},qs=new class{constructor(e){this.configAPI=e}async listPlugins(){return this.configAPI.request("/api/plugins")}async getPluginDetail(e){return this.configAPI.request(`/api/plugins/${e}`)}async getPluginConfig(e){return this.configAPI.request(`/api/plugins/${e}/config`)}async updatePluginConfig(e,t){return this.configAPI.request(`/api/plugins/${e}/config`,{method:"PUT",body:JSON.stringify(t)})}async getPluginTools(e){return this.configAPI.request(`/api/plugins/${e}/tools`)}async debugTool(e,t,a,s=null){return this.configAPI.request(`/api/plugins/${e}/tools/${t}/debug`,{method:"POST",body:JSON.stringify({parameters:a,user:s})})}async reloadPlugin(e){return this.configAPI.request(`/api/plugins/${e}/reload`,{method:"POST"})}async reloadAllPlugins(){return this.configAPI.request("/api/plugins/reload-all",{method:"POST"})}async togglePlugin(e,t){return this.configAPI.request(`/api/plugins/${e}/toggle`,{method:"POST",body:JSON.stringify({enabled:t})})}}(Bs),zs=T("config",()=>{const e=y(null),t=y({openai:[],gemini:[],vertex:[]}),a=y({}),s=y(!1),i=y(!1),o=y(localStorage.getItem("admin_code")||""),l=y([]),n=w(()=>{const e=[];return Object.entries(t.value).forEach(([t,a])=>{a.forEach((a,s)=>{a.enable&&e.push({type:t,index:s,...a})})}),e}),r=w(()=>Object.values(t.value).reduce((e,t)=>e+t.length,0)),c=w(()=>{let e=0;return Object.values(t.value).forEach(t=>{t.forEach(t=>{t.enable&&e++})}),e}),d=w(()=>{let e=0;return Object.values(a.value).forEach(t=>{Array.isArray(t)&&t.forEach(t=>{t.models&&Array.isArray(t.models)&&(e+=t.models.length)})}),e}),u=w(()=>!!o.value);function p(){o.value="",localStorage.removeItem("admin_code"),Bs.adminCode=""}async function h(){s.value=!0;try{const s=await Bs.getConfig();return e.value=s.data,t.value=s.data.llm_adapters||{openai:[],gemini:[],vertex:[]},a.value=s.data.models||{},s.data}catch(i){throw(i.message.includes("验证码")||i.message.includes("访问被拒绝"))&&p(),i}finally{s.value=!1}}async function m(e,s,i){try{const o=await Bs.updateAdapter(e,s,i);return o.data.llm_adapters&&(t.value=o.data.llm_adapters),o.data.models&&(a.value=o.data.models),o.data}catch(o){throw o}}return{config:e,adapters:t,models:a,loading:s,needRestart:i,adminCode:o,selectedAdapters:l,enabledAdapters:n,totalAdapters:r,enabledAdaptersCount:c,totalModelsCount:d,isAuthenticated:u,setAdminCode:function(e){o.value=e,Bs.setAdminCode(e)},clearAdminCode:p,fetchConfig:h,fetchConfigSection:async function(t){try{const a=await Bs.getConfigSection(t);return e.value&&(e.value[t]=a.data),a.data}catch(a){throw a}},updateConfig:async function(e){try{const t=await Bs.updateConfig(e);return i.value=!0,await h(),t.data}catch(t){throw t}},updateConfigSection:async function(t,a){try{const s=await Bs.updateConfigSection(t,a);return e.value&&(e.value[t]=a),"llm_adapters"!==t&&(i.value=!0),s.data}catch(s){throw s}},addAdapter:async function(e,t){try{const s=await Bs.addAdapter(e,t);return await h(),a.value=s.data.models||{},s.data}catch(s){throw s}},updateAdapter:m,deleteAdapter:async function(e,s){try{const i=await Bs.deleteAdapter(e,s);return t.value[e]&&t.value[e].splice(s,1),a.value=i.data.models||{},i.data}catch(i){throw i}},batchDeleteAdapters:async function(e){try{const t=await Bs.batchDeleteAdapters(e);return await h(),t}catch(t){throw t}},batchToggleAdapters:async function(e,a){const s=[];for(const o of e)try{const e={...t.value[o.type][o.index],enable:a};await m(o.type,o.index,e),s.push({success:!0,adapter:o})}catch(i){s.push({success:!1,adapter:o,error:i.message})}return s},refreshAllModels:async function(){try{const e=await Bs.refreshAllModels();return a.value=e.data.models||{},e.data}catch(e){throw e}},refreshAdapterModels:async function(e,t){try{const s=await Bs.refreshAdapterModels(e,t);return a.value=s.data.models||{},s.data}catch(s){throw s}},validateConfig:async function(e){try{return(await Bs.validateConfig(e)).data}catch(t){throw t}},resetConfig:async function(){try{const e=await Bs.resetConfig();return i.value=!0,await h(),e.data}catch(e){throw e}},exportConfig:async function(e){try{await Bs.exportConfig(e)}catch(t){throw t}},importConfig:async function(e){try{return await Bs.importConfig(e)}catch(t){throw t}},toggleAdapterSelection:function(e,t){const a=`${e}-${t}`,s=l.value.findIndex(e=>`${e.type}-${e.index}`===a);s>-1?l.value.splice(s,1):l.value.push({type:e,index:t})},clearAdapterSelection:function(){l.value=[]},isAdapterSelected:function(e,t){const a=`${e}-${t}`;return l.value.some(e=>`${e.type}-${e.index}`===a)}}}),Hs={class:"dialog-content"},Fs={class:"config-compare-dialog"},Gs={key:0,class:"upload-section"},Ws={key:1,class:"compare-result"},Js={class:"result-header"},Ys={key:0,class:"diff-stats"},Ks={key:1,class:"diff-details"},Xs={key:0,class:"no-changes"},Qs={key:1,class:"changes-list"},Zs={class:"change-path"},ei={class:"change-values"},ti={key:0,class:"old-value"},ai={key:1,class:"new-value"},si={class:"label"},ii={class:"config-section-compare"},oi={key:0,class:"no-changes"},li={key:1,class:"diff-table"},ni={class:"config-section-compare"},ri={key:0,class:"no-changes"},ci={key:1,class:"diff-table"},di={class:"config-section-compare"},ui={key:0,class:"no-changes"},pi={key:1,class:"diff-table"},hi={class:"dialog-footer"},mi=ve({__name:"ConfigCompare",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(e,{emit:p}){const h=e,m=p,f=zs(),v=y(h.modelValue),b=y(null),C=y("adapters");A(()=>h.modelValue,e=>{v.value=e,e||(b.value=null)}),A(v,e=>{m("update:modelValue",e)});const k=w(()=>f.config||{}),x=w(()=>{if(!b.value)return{};const e={openai:[],gemini:[],vertex:[]};return["openai","gemini","vertex"].forEach(t=>{const a=k.value.adapters?.[t]||[],s=b.value.adapters?.[t]||[],i=Math.max(a.length,s.length);for(let o=0;o<i;o++){const i=a[o],l=s[o];if(!i&&l)e[t].push({type:"added",path:`实例 ${o+1}`,newValue:l});else if(i&&!l)e[t].push({type:"removed",path:`实例 ${o+1}`,oldValue:i});else if(i&&l){new Set([...Object.keys(i),...Object.keys(l)]).forEach(a=>{JSON.stringify(i[a])!==JSON.stringify(l[a])&&e[t].push({type:"modified",path:`实例 ${o+1} - ${a}`,oldValue:i[a],newValue:l[a]})})}}}),e}),L=w(()=>{let e=0,t=0,a=0;return Object.values(x.value).forEach(s=>{s.forEach(s=>{"added"===s.type?e++:"modified"===s.type?t++:"removed"===s.type&&a++})}),{added:e,modified:t,removed:a}}),M=w(()=>L.value.added>0||L.value.modified>0||L.value.removed>0),T=w(()=>V(k.value.server,b.value?.server)),O=w(()=>T.value.length>0),P=w(()=>V(k.value.web,b.value?.web)),E=w(()=>P.value.length>0),I=w(()=>V(k.value.onebot,b.value?.onebot)),$=w(()=>I.value.length>0),V=(e,t)=>{const a=[];return new Set([...Object.keys(e||{}),...Object.keys(t||{})]).forEach(s=>{const i=e?.[s],o=t?.[s];JSON.stringify(i)!==JSON.stringify(o)&&a.push({key:s,currentValue:U(i),compareValue:U(o)})}),a},U=e=>void 0===e?"-":"object"==typeof e?JSON.stringify(e):String(e),D=e=>({openai:"OpenAI",gemini:"Gemini",vertex:"Vertex AI"}[e]||e),R=e=>({added:"success",modified:"warning",removed:"danger"}[e]||""),q=e=>({added:"新增",modified:"修改",removed:"删除"}[e]||e),z=e=>"object"==typeof e?JSON.stringify(e,null,2):String(e),H=async e=>{try{const t=await e.text(),a=JSON.parse(t),s=await f.validateConfig(a);if(!s.valid)return j.error("配置文件格式无效："+s.errors.join(", ")),!1;b.value=a,j.success("配置文件加载成功")}catch(t){j.error("加载配置文件失败："+t.message)}return!1},F=()=>{b.value=null,C.value="adapters"},G=()=>{v.value=!1},W=async()=>{try{await B.confirm("确定要应用对比配置吗？这将覆盖当前配置。","确认应用",{confirmButtonText:"应用",cancelButtonText:"取消",type:"warning"}),await f.updateConfig(b.value),j.success("配置已应用，请重启服务使配置生效"),G(),await f.fetchConfig()}catch(e){"cancel"!==e&&j.error("应用配置失败："+e.message)}};return(e,p)=>{const h=d("el-icon"),m=d("el-upload"),f=d("el-tag"),y=d("el-button"),w=d("el-descriptions-item"),k=d("el-descriptions"),A=d("el-tab-pane"),V=d("el-table-column"),U=d("el-table"),j=d("el-tabs"),B=d("el-empty"),J=d("el-dialog");return i(),u(J,{modelValue:v.value,"onUpdate:modelValue":p[1]||(p[1]=e=>v.value=e),title:"配置对比",width:"900px","close-on-click-modal":!1,onClose:G,class:"config-dialog"},{footer:g(()=>[a("div",hi,[c(y,{onClick:G},{default:g(()=>p[6]||(p[6]=[S("关闭")])),_:1}),b.value&&M.value?(i(),u(y,{key:0,type:"primary",onClick:W},{default:g(()=>p[7]||(p[7]=[S(" 应用对比配置 ")])),_:1})):o("",!0)])]),default:g(()=>[a("div",Hs,[a("div",Fs,[b.value?(i(),t("div",Ws,[a("div",Js,[c(f,{type:M.value?"warning":"success",size:"large"},{default:g(()=>[S(r(M.value?"发现差异":"配置相同"),1)]),_:1},8,["type"]),c(y,{onClick:F},{default:g(()=>p[4]||(p[4]=[S("重新选择")])),_:1})]),M.value?(i(),t("div",Ys,[c(k,{column:3,border:""},{default:g(()=>[c(w,{label:"新增项"},{default:g(()=>[c(f,{type:"success"},{default:g(()=>[S(r(L.value.added),1)]),_:1})]),_:1}),c(w,{label:"修改项"},{default:g(()=>[c(f,{type:"warning"},{default:g(()=>[S(r(L.value.modified),1)]),_:1})]),_:1}),c(w,{label:"删除项"},{default:g(()=>[c(f,{type:"danger"},{default:g(()=>[S(r(L.value.removed),1)]),_:1})]),_:1})]),_:1})])):o("",!0),M.value?(i(),t("div",Ks,[c(j,{modelValue:C.value,"onUpdate:modelValue":p[0]||(p[0]=e=>C.value=e)},{default:g(()=>[c(A,{label:"LLM 适配器",name:"adapters"},{default:g(()=>[(i(!0),t(l,null,n(x.value,(e,d)=>(i(),t("div",{class:"diff-section",key:d},[a("h4",null,r(D(d)),1),0===e.length?(i(),t("div",Xs," 无变化 ")):(i(),t("div",Qs,[(i(!0),t(l,null,n(e,(e,l)=>(i(),t("div",{key:l,class:s(["change-item",e.type])},[c(f,{type:R(e.type),size:"small"},{default:g(()=>[S(r(q(e.type)),1)]),_:2},1032,["type"]),a("span",Zs,r(e.path),1),a("div",ei,["added"!==e.type?(i(),t("div",ti,[p[5]||(p[5]=a("span",{class:"label"},"当前:",-1)),a("code",null,r(z(e.oldValue)),1)])):o("",!0),"removed"!==e.type?(i(),t("div",ai,[a("span",si,r("added"===e.type?"新增":"修改为")+":",1),a("code",null,r(z(e.newValue)),1)])):o("",!0)])],2))),128))]))]))),128))]),_:1}),c(A,{label:"服务器配置",name:"server"},{default:g(()=>[a("div",ii,[O.value?(i(),t("div",li,[c(U,{data:T.value,border:""},{default:g(()=>[c(V,{prop:"key",label:"配置项",width:"200"}),c(V,{label:"当前值"},{default:g(({row:e})=>[a("code",null,r(e.currentValue),1)]),_:1}),c(V,{label:"对比值"},{default:g(({row:e})=>[a("code",null,r(e.compareValue),1)]),_:1})]),_:1},8,["data"])])):(i(),t("div",oi,"无变化"))])]),_:1}),c(A,{label:"Web 配置",name:"web"},{default:g(()=>[a("div",ni,[E.value?(i(),t("div",ci,[c(U,{data:P.value,border:""},{default:g(()=>[c(V,{prop:"key",label:"配置项",width:"200"}),c(V,{label:"当前值"},{default:g(({row:e})=>[a("code",null,r(e.currentValue),1)]),_:1}),c(V,{label:"对比值"},{default:g(({row:e})=>[a("code",null,r(e.compareValue),1)]),_:1})]),_:1},8,["data"])])):(i(),t("div",ri,"无变化"))])]),_:1}),c(A,{label:"OneBot 配置",name:"onebot"},{default:g(()=>[a("div",di,[$.value?(i(),t("div",pi,[c(U,{data:I.value,border:""},{default:g(()=>[c(V,{prop:"key",label:"配置项",width:"200"}),c(V,{label:"当前值"},{default:g(({row:e})=>[a("code",null,r(e.currentValue),1)]),_:1}),c(V,{label:"对比值"},{default:g(({row:e})=>[a("code",null,r(e.compareValue),1)]),_:1})]),_:1},8,["data"])])):(i(),t("div",ui,"无变化"))])]),_:1})]),_:1},8,["modelValue"])])):(i(),u(B,{key:2,description:"配置完全相同"}))])):(i(),t("div",Gs,[c(m,{drag:"","before-upload":H,"show-file-list":!1,accept:".json"},{tip:g(()=>p[2]||(p[2]=[a("div",{class:"el-upload__tip"}," 上传 JSON 格式的配置文件以与当前配置进行对比 ",-1)])),default:g(()=>[c(h,{class:"el-icon--upload"},{default:g(()=>[c(_(N))]),_:1}),p[3]||(p[3]=a("div",{class:"el-upload__text"},[S(" 拖拽配置文件到此处，或 "),a("em",null,"点击上传")],-1))]),_:1})]))])])]),_:1},8,["modelValue"])}}},[["__scopeId","data-v-e2aa9622"]]),gi={key:0,class:"skeleton-adapter-card"},fi={key:1,class:"skeleton-stat-card"},vi={key:2,class:"skeleton-list"},yi={key:3,class:"skeleton-default"},wi=ve({__name:"LoadingSkeleton",props:{type:{type:String,default:"default",validator:e=>["adapter-card","stat-card","list","default"].includes(e)},count:{type:Number,default:3},isCard:{type:Boolean,default:!1}},setup:e=>(o,r)=>(i(),t("div",{class:s(["loading-skeleton",{card:e.isCard}])},["adapter-card"===e.type?(i(),t("div",gi,r[0]||(r[0]=[O('<div class="skeleton-header" data-v-1c3500cc><div class="skeleton-checkbox" data-v-1c3500cc></div><div class="skeleton-title" data-v-1c3500cc></div><div class="skeleton-tag" data-v-1c3500cc></div></div><div class="skeleton-content" data-v-1c3500cc><div class="skeleton-line short" data-v-1c3500cc></div><div class="skeleton-line medium" data-v-1c3500cc></div><div class="skeleton-line long" data-v-1c3500cc></div></div><div class="skeleton-actions" data-v-1c3500cc><div class="skeleton-button" data-v-1c3500cc></div><div class="skeleton-button" data-v-1c3500cc></div><div class="skeleton-button" data-v-1c3500cc></div></div>',3)]))):"stat-card"===e.type?(i(),t("div",fi,r[1]||(r[1]=[a("div",{class:"skeleton-icon"},null,-1),a("div",{class:"skeleton-stat-content"},[a("div",{class:"skeleton-value"}),a("div",{class:"skeleton-label"})],-1)]))):"list"===e.type?(i(),t("div",vi,[(i(!0),t(l,null,n(e.count,e=>(i(),t("div",{key:e,class:"skeleton-list-item"},r[2]||(r[2]=[a("div",{class:"skeleton-line"},null,-1)])))),128))])):(i(),t("div",yi,r[3]||(r[3]=[a("div",{class:"skeleton-line"},null,-1),a("div",{class:"skeleton-line"},null,-1),a("div",{class:"skeleton-line short"},null,-1)])))],2))},[["__scopeId","data-v-1c3500cc"]]),bi={class:"model-selector"},Ci={class:"model-input-wrapper"},_i={class:"form-item-tip"},ki={class:"keyword-input-wrapper"},Si={class:"keyword-tags"},xi={class:"preview-title"},Li={class:"preview-models"},Mi={key:0,style:{color:"#909399","font-size":"12px"}},Ti=ve({__name:"ModelSelector",props:{modelValue:{type:Object,default:()=>({default:"",guest:{keywords:[],full_name:[]}})},availableModels:{type:Array,default:()=>[]},showDefault:{type:Boolean,default:!0},showFetchButton:{type:Boolean,default:!1},fetchingModels:{type:Boolean,default:!1}},emits:["update:modelValue","fetch-models"],setup(e,{emit:s}){const p=e,h=s,m=y(""),f=()=>{h("fetch-models")},v=w(()=>{const e=p.modelValue.guest?.keywords||[],t=p.modelValue.guest?.full_name||[],a=new Set(t);return e.forEach(e=>{p.availableModels.forEach(t=>{t.toLowerCase().includes(e.toLowerCase())&&a.add(t)})}),Array.from(a)}),b=e=>{h("update:modelValue",{...p.modelValue,default:e})},C=()=>{const e=m.value.trim();if(!e)return;const t=p.modelValue.guest?.keywords||[];t.includes(e)||h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,keywords:[...t,e]}}),m.value=""},k=e=>{h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,full_name:e}})};return(s,y)=>{const w=d("el-option"),x=d("el-select"),L=d("el-button"),M=d("el-form-item"),T=d("el-divider"),A=d("el-tag"),O=d("el-input"),E=d("el-alert");return i(),t("div",bi,[e.showDefault?(i(),u(M,{key:0,label:"默认模型",required:""},{extra:g(()=>[a("span",_i,r(e.availableModels.length>0?"为所有用户设置的默认模型":"暂无模型列表，请先获取或手动输入"),1)]),default:g(()=>[a("div",Ci,[c(x,{"model-value":e.modelValue.default,"onUpdate:modelValue":b,filterable:"","allow-create":"","default-first-option":"",placeholder:"请选择或输入默认模型",class:"model-select"},{default:g(()=>[(i(!0),t(l,null,n(e.availableModels,e=>(i(),u(w,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["model-value"]),e.showFetchButton?(i(),u(L,{key:0,type:"primary",icon:_(q),loading:e.fetchingModels,onClick:f,class:"fetch-button"},{default:g(()=>y[1]||(y[1]=[S(" 获取模型 ")])),_:1},8,["icon","loading"])):o("",!0)])]),_:1})):o("",!0),c(T,{"content-position":"left"},{default:g(()=>y[2]||(y[2]=[S("访客模型配置")])),_:1}),c(M,{label:"关键词匹配"},{extra:g(()=>y[4]||(y[4]=[a("span",{class:"form-item-tip"}," 访客可使用包含这些关键词的模型（如：gpt、4o、flash） ",-1)])),default:g(()=>[a("div",ki,[a("div",Si,[(i(!0),t(l,null,n(e.modelValue.guest?.keywords||[],e=>(i(),u(A,{key:e,closable:"",onClose:t=>(e=>{const t=p.modelValue.guest?.keywords||[];h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,keywords:t.filter(t=>t!==e)}})})(e),size:"default"},{default:g(()=>[S(r(e),1)]),_:2},1032,["onClose"]))),128))]),c(O,{modelValue:m.value,"onUpdate:modelValue":y[0]||(y[0]=e=>m.value=e),onKeyup:P(C,["enter"]),placeholder:"输入关键词后按回车添加",size:"default",clearable:"",style:{"margin-top":"8px"}},{append:g(()=>[c(L,{icon:_(z),onClick:C,class:"input-append-button"},{default:g(()=>y[3]||(y[3]=[S("添加")])),_:1},8,["icon"])]),_:1},8,["modelValue"])])]),_:1}),c(M,{label:"完整名称"},{extra:g(()=>y[5]||(y[5]=[a("span",{class:"form-item-tip"},"访客可使用的具体模型列表",-1)])),default:g(()=>[c(x,{"model-value":e.modelValue.guest?.full_name||[],"onUpdate:modelValue":k,multiple:"",filterable:"",placeholder:"选择访客可用的模型",style:{width:"100%"}},{default:g(()=>[(i(!0),t(l,null,n(e.availableModels,e=>(i(),u(w,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["model-value"])]),_:1}),v.value.length>0?(i(),u(E,{key:1,type:"info",closable:!1,"show-icon":"",style:{"margin-top":"16px"}},{title:g(()=>[a("div",xi,[y[6]||(y[6]=S(" 访客可用模型预览 ")),c(A,{size:"small"},{default:g(()=>[S(r(v.value.length)+" 个",1)]),_:1})])]),default:g(()=>[a("div",Li,[(i(!0),t(l,null,n(v.value.slice(0,10),e=>(i(),u(A,{key:e,size:"small",style:{margin:"4px"}},{default:g(()=>[S(r(e),1)]),_:2},1024))),128)),v.value.length>10?(i(),t("span",Mi," 等 "+r(v.value.length)+" 个模型 ",1)):o("",!0)])]),_:1})):o("",!0)])}}},[["__scopeId","data-v-07f09388"]]),Ai={class:"dialog-content"},Oi={class:"dialog-footer"},Pi=ve({__name:"AdapterEditor",props:{visible:{type:Boolean,default:!1},mode:{type:String,default:"add",validator:e=>["add","edit"].includes(e)},type:{type:String,required:!0},adapter:{type:Object,default:null},index:{type:Number,default:-1}},emits:["close","submit"],setup(e,{emit:s}){const n=e,p=s,h=zs(),m=y(null),f=y(!1),v=y(!1),b=y("json"),C=y(!1),k=y([]),x=y({name:"",enable:!0,api_key:"",base_url:"",region:"us-central1",service_account_json:"",models:[],default_model:"",guest_models:{keywords:[],full_name:[]}}),L=y(null),M=y({default:"",guest:{keywords:[],full_name:[]}}),T=w(()=>`${"add"===n.mode?"添加":"编辑"} ${(e=>{const t={openai:"OpenAI",gemini:"Gemini",vertex:"Vertex AI"};return t[e]?t[e]:e?e.charAt(0).toUpperCase()+e.slice(1):"适配器"})(n.type)} 适配器实例`),O=w(()=>{if(k.value.length>0)return k.value;const e=new Set,t=h.models[n.type];return Array.isArray(t)&&t.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(t=>e.add(t))}),x.value.models&&x.value.models.length>0&&x.value.models.forEach(t=>e.add(t)),e.size>0?Array.from(e).sort():"openai"===n.type?["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"]:"gemini"===n.type?["gemini-2.0-flash","gemini-1.5-pro","gemini-1.5-flash"]:"vertex"===n.type?x.value.models.length>0?x.value.models:["gemini-2.0-flash-001","claude-3-5-sonnet-v2@20241022"]:"deepseek"===n.type?["deepseek-chat","deepseek-coder"]:"anthropic"===n.type?["claude-3-5-sonnet-20241022","claude-3-5-haiku-20241022","claude-3-opus-20240229"]:[]}),P=w(()=>{if(!x.value.service_account_json)return"";try{const e=JSON.parse(x.value.service_account_json);return`项目: ${e.project_id}\n客户端邮箱: ${e.client_email}`}catch{return"已上传 JSON 文件"}}),E=w(()=>{const e={name:[],enable:[]};return"vertex"!==n.type&&(e.api_key=[{required:!0,message:"请输入 API Key",trigger:"blur"},{min:10,message:"API Key 长度不足",trigger:"blur"}],e.base_url=[{required:!0,message:"请输入 Base URL",trigger:"blur"},{type:"url",message:"请输入有效的 URL",trigger:"blur",transform:e=>e&&(e.startsWith("http://")||e.startsWith("https://"))?e:`https://${e}`}]),"vertex"===n.type&&(e.region=[{required:!0,message:"请选择区域",trigger:"change"}],e.service_account_json=[{required:!0,message:"请提供服务账号 JSON",trigger:"blur"},{validator:(e,t,a)=>{try{JSON.parse(t),a()}catch{a(new Error("JSON 格式不正确"))}},trigger:"blur"}]),e}),I=e=>{const t=new FileReader;return t.onload=e=>{try{const t=e.target.result;JSON.parse(t),x.value.service_account_json=t,j.success("JSON 文件上传成功")}catch(t){j.error("JSON 文件格式不正确")}},t.readAsText(e),!1},$=async()=>{if("vertex"!==n.type){if(!x.value.api_key)return void j.warning("请先填写 API Key");if(!x.value.base_url)return void j.warning("请先填写 Base URL")}else if("vertex"===n.type){if(!x.value.region)return void j.warning("请先选择区域");if(!x.value.service_account_json)return void j.warning("请先提供服务账号 JSON")}C.value=!0;try{const e={};"vertex"===n.type?(e.region=x.value.region,e.service_account_json=x.value.service_account_json,x.value.models&&x.value.models.length>0&&(e.models=x.value.models)):(e.api_key=x.value.api_key,e.base_url=x.value.base_url);const t=await Bs.request(`/api/config/llm/${n.type}/test-models`,{method:"POST",body:JSON.stringify(e)});if(t.data&&t.data.models){const e=[];Array.isArray(t.data.models)&&t.data.models.forEach(t=>{t.models&&Array.isArray(t.models)&&e.push(...t.models)}),k.value=[...new Set(e)].sort(),k.value.length>0?j.success(`成功获取 ${k.value.length} 个模型`):j.warning("获取模型列表为空")}else j.warning("获取模型列表为空")}catch(e){j.error("获取模型失败："+e.message)}finally{C.value=!1}},V=async()=>{try{let e;if(await m.value.validate(),"add"===n.mode)e={...x.value,default_model:M.value.default,guest_models:M.value.guest},"vertex"!==n.type?(delete e.region,delete e.service_account_json,delete e.models):(delete e.api_key,delete e.base_url);else{e={};const t=["name","enable","api_key","base_url","region","service_account_json","models"];for(const a of t)if(!("api_key"===a&&x.value[a]?.startsWith("***")||"service_account_json"===a&&x.value[a]?.startsWith("***")||JSON.stringify(x.value[a])===JSON.stringify(L.value?.[a]))){if("vertex"!==n.type&&["region","service_account_json","models"].includes(a))continue;if("vertex"===n.type&&["api_key","base_url"].includes(a))continue;e[a]=x.value[a]}JSON.stringify(M.value.default)!==JSON.stringify(L.value?.default_model)&&(e.default_model=M.value.default),JSON.stringify(M.value.guest)!==JSON.stringify(L.value?.guest_models)&&(e.guest_models=M.value.guest)}v.value=!0,await p("submit",{type:n.type,index:n.index,data:e,mode:n.mode}),U()}catch(e){"cancel"!==e&&j.error("表单验证失败，请检查输入")}finally{v.value=!1}},U=()=>{p("close"),setTimeout(()=>{m.value?.resetFields(),f.value=!1,k.value=[]},300)};return A(()=>n.visible,e=>{e&&(()=>{if("edit"===n.mode&&n.adapter)x.value={...n.adapter},M.value={default:n.adapter.default_model||"",guest:n.adapter.guest_models||{keywords:[],full_name:[]}},L.value=JSON.parse(JSON.stringify(n.adapter));else{const e={openai:{base_url:"https://api.openai.com/v1"},gemini:{base_url:"https://generativelanguage.googleapis.com/v1beta"},vertex:{region:"us-central1",models:[]}},t={api_key:"",base_url:""};x.value={name:"",enable:!0,..."vertex"===n.type?e.vertex:e[n.type]||{},..."vertex"!==n.type?t:{},default_model:"",guest_models:{keywords:[],full_name:[]}},M.value={default:"",guest:{keywords:[],full_name:[]}}}})()},{immediate:!0}),(s,n)=>{const p=d("el-divider"),h=d("el-input"),y=d("el-form-item"),w=d("el-switch"),k=d("el-button"),L=d("el-option"),A=d("el-select"),D=d("el-radio"),R=d("el-radio-group"),j=d("el-icon"),B=d("el-upload"),q=d("el-form"),z=d("el-dialog");return i(),u(z,{"model-value":e.visible,title:T.value,onClose:U,width:"700px","close-on-click-modal":!1,class:"form-dialog adapter-editor-dialog"},{footer:g(()=>[a("div",Oi,[c(k,{onClick:U},{default:g(()=>n[19]||(n[19]=[S("取消")])),_:1}),c(k,{type:"primary",loading:v.value,onClick:V},{default:g(()=>[S(r("add"===e.mode?"保存并测试连接":"保存"),1)]),_:1},8,["loading"])])]),default:g(()=>[a("div",Ai,[c(q,{ref_key:"formRef",ref:m,model:x.value,rules:E.value,"label-width":"120px","label-position":"left"},{default:g(()=>[c(p,{"content-position":"left"},{default:g(()=>n[10]||(n[10]=[S("基本信息")])),_:1}),c(y,{label:"实例名称",prop:"name"},{default:g(()=>[c(h,{modelValue:x.value.name,"onUpdate:modelValue":n[0]||(n[0]=e=>x.value.name=e),placeholder:"留空自动生成",clearable:""},null,8,["modelValue"])]),_:1}),c(y,{label:"启用状态"},{default:g(()=>[c(w,{modelValue:x.value.enable,"onUpdate:modelValue":n[1]||(n[1]=e=>x.value.enable=e),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),"vertex"!==e.type?(i(),t(l,{key:0},[c(p,{"content-position":"left"},{default:g(()=>n[11]||(n[11]=[S("认证信息")])),_:1}),c(y,{label:"API Key",prop:"api_key"},{default:g(()=>[c(h,{modelValue:x.value.api_key,"onUpdate:modelValue":n[3]||(n[3]=e=>x.value.api_key=e),type:f.value?"text":"password",placeholder:"请输入 API Key",clearable:""},{append:g(()=>[c(k,{icon:f.value?_(H):_(F),onClick:n[2]||(n[2]=e=>f.value=!f.value),class:"input-append-button"},null,8,["icon"])]),_:1},8,["modelValue","type"])]),_:1}),c(y,{label:"Base URL",prop:"base_url"},{default:g(()=>[c(h,{modelValue:x.value.base_url,"onUpdate:modelValue":n[4]||(n[4]=e=>x.value.base_url=e),placeholder:"API 基础 URL",clearable:""},null,8,["modelValue"])]),_:1})],64)):o("",!0),"vertex"===e.type?(i(),t(l,{key:1},[c(p,{"content-position":"left"},{default:g(()=>n[12]||(n[12]=[S("认证信息")])),_:1}),c(y,{label:"区域",prop:"region"},{default:g(()=>[c(A,{modelValue:x.value.region,"onUpdate:modelValue":n[5]||(n[5]=e=>x.value.region=e),placeholder:"选择 Vertex AI 区域",filterable:"",style:{width:"100%"}},{default:g(()=>[c(L,{label:"us-central1 (美国中部)",value:"us-central1"}),c(L,{label:"us-east4 (美国东部)",value:"us-east4"}),c(L,{label:"asia-northeast1 (日本东京)",value:"asia-northeast1"}),c(L,{label:"asia-southeast1 (新加坡)",value:"asia-southeast1"}),c(L,{label:"europe-west4 (荷兰)",value:"europe-west4"}),c(L,{label:"europe-west1 (比利时)",value:"europe-west1"})]),_:1},8,["modelValue"])]),_:1}),c(y,{label:"认证方式"},{default:g(()=>[c(R,{modelValue:b.value,"onUpdate:modelValue":n[6]||(n[6]=e=>b.value=e)},{default:g(()=>[c(D,{value:"json"},{default:g(()=>n[13]||(n[13]=[S("粘贴 JSON")])),_:1}),c(D,{value:"file"},{default:g(()=>n[14]||(n[14]=[S("上传文件")])),_:1})]),_:1},8,["modelValue"])]),_:1}),"json"===b.value?(i(),u(y,{key:0,label:"服务账号 JSON",prop:"service_account_json"},{default:g(()=>[c(h,{modelValue:x.value.service_account_json,"onUpdate:modelValue":n[7]||(n[7]=e=>x.value.service_account_json=e),type:"textarea",rows:6,placeholder:'{"type": "service_account", "project_id": "...", ...}'},null,8,["modelValue"])]),_:1})):o("",!0),"file"===b.value?(i(),u(y,{key:1,label:"JSON 文件"},{default:g(()=>[c(B,{"before-upload":I,"show-file-list":!1,accept:".json",drag:""},{tip:g(()=>n[15]||(n[15]=[a("div",{class:"el-upload__tip"}," 仅支持 .json 格式的服务账号文件 ",-1)])),default:g(()=>[c(j,{class:"el-icon--upload"},{default:g(()=>[c(_(N))]),_:1}),n[16]||(n[16]=a("div",{class:"el-upload__text"},[S(" 拖拽文件到此处或 "),a("em",null,"点击上传")],-1))]),_:1}),x.value.service_account_json?(i(),u(h,{key:0,"model-value":P.value,type:"textarea",rows:3,readonly:"",style:{"margin-top":"8px"}},null,8,["model-value"])):o("",!0)]),_:1})):o("",!0),c(y,{label:"自定义模型"},{extra:g(()=>n[17]||(n[17]=[a("span",{class:"form-item-tip"}," Claude 模型必须在此配置，其他模型可自动获取 ",-1)])),default:g(()=>[c(A,{modelValue:x.value.models,"onUpdate:modelValue":n[8]||(n[8]=e=>x.value.models=e),multiple:"",filterable:"","allow-create":"",placeholder:"添加模型（可选）",style:{width:"100%"}},{default:g(()=>[c(L,{label:"gemini-2.0-flash-001",value:"gemini-2.0-flash-001"}),c(L,{label:"gemini-1.5-pro-002",value:"gemini-1.5-pro-002"}),c(L,{label:"claude-3-5-sonnet-v2@20241022",value:"claude-3-5-sonnet-v2@20241022"}),c(L,{label:"claude-3-5-haiku@20241022",value:"claude-3-5-haiku@20241022"})]),_:1},8,["modelValue"])]),_:1})],64)):o("",!0),c(p,{"content-position":"left"},{default:g(()=>n[18]||(n[18]=[S("模型配置")])),_:1}),c(Ti,{modelValue:M.value,"onUpdate:modelValue":n[9]||(n[9]=e=>M.value=e),"available-models":O.value,"show-default":!0,"show-fetch-button":!0,"fetching-models":C.value,onFetchModels:$},null,8,["modelValue","available-models","fetching-models"])]),_:1},8,["model","rules"])])]),_:1},8,["model-value","title"])}}},[["__scopeId","data-v-0a9565b9"]]),Ei={class:"card-header"},Ii={class:"preset-tags"},$i={class:"card-content"},Vi={class:"preset-header"},Ui={class:"preset-name"},Di={key:0,class:"preset-opening"},Ri={key:1,class:"preset-history"},ji={class:"history-content"},Ni={key:0,class:"more-history"},Bi={key:2,class:"preset-tools"},qi={class:"tools-list"},zi={class:"card-actions"},Hi=ve({__name:"PresetCard",props:{preset:{type:Object,required:!0},selected:{type:Boolean,default:!1}},emits:["select","edit","delete","export"],setup(e,{emit:p}){const h=e,m=p,f=e=>({"built-in":"内置",custom:"自定义"}[e]||e),v=e=>({common:"常用",recommended:"推荐",hidden:"隐藏"}[e]||e),y=e=>({system:"系统",user:"用户",assistant:"助手"}[e]||e),w=e=>{m("select",e)},b=()=>{m("edit",h.preset)},C=()=>{m("delete",h.preset)},k=()=>{m("export",h.preset)};return(p,h)=>{const m=d("el-checkbox"),x=d("el-tag"),L=d("el-avatar"),M=d("el-text"),T=d("el-button"),A=d("el-tooltip");return i(),t("div",{class:s(["preset-card",{selected:e.selected}])},[a("div",Ei,[c(m,{"model-value":e.selected,onChange:w,class:"select-checkbox"},null,8,["model-value"]),a("div",Ii,[e.preset.source?(i(),u(x,{key:0,type:(P=e.preset.source,{"built-in":"warning",custom:"success"}[P]||"primary"),size:"small",effect:"light"},{default:g(()=>[S(r(f(e.preset.source)),1)]),_:1},8,["type"])):o("",!0),e.preset.category?(i(),u(x,{key:1,type:(O=e.preset.category,{common:"primary",recommended:"danger",hidden:"info"}[O]||"primary"),size:"small",effect:"light"},{default:g(()=>[S(r(v(e.preset.category)),1)]),_:1},8,["type"])):o("",!0)])]),a("div",$i,[a("div",Vi,[e.preset.avatar?(i(),u(L,{key:0,src:e.preset.avatar,size:48,class:"preset-avatar"},null,8,["src"])):(i(),u(L,{key:1,size:48,icon:_(G),class:"preset-avatar default-avatar"},null,8,["icon"])),a("div",Ui,[a("h4",null,r(e.preset.name),1)])]),e.preset.opening?(i(),t("div",Di,[a("p",null,r(e.preset.opening),1)])):o("",!0),e.preset.history&&e.preset.history.length>0?(i(),t("div",Ri,[(i(!0),t(l,null,n(e.preset.history.slice(0,2),(e,s)=>{return i(),t("div",{class:"history-item",key:s},[c(x,{size:"small",type:(n=e.role,{system:"warning",user:"primary",assistant:"success"}[n]||"info")},{default:g(()=>[S(r(y(e.role)),1)]),_:2},1032,["type"]),a("span",ji,r((o=e.content,l=100,o?o.length<=l?o:o.substring(0,l)+"...":"")),1)]);var o,l,n}),128)),e.preset.history.length>2?(i(),t("div",Ni,[c(M,{type:"info",size:"small"},{default:g(()=>[S(" 还有 "+r(e.preset.history.length-2)+" 条消息... ",1)]),_:1})])):o("",!0)])):o("",!0),e.preset.tools&&e.preset.tools.length>0?(i(),t("div",Bi,[h[0]||(h[0]=a("div",{class:"tools-label"},"工具：",-1)),a("div",qi,[(i(!0),t(l,null,n(e.preset.tools,e=>(i(),u(x,{key:e,size:"small",type:"info",effect:"plain"},{default:g(()=>[S(r(e),1)]),_:2},1024))),128))])])):o("",!0)]),a("div",zi,[c(T,{size:"small",type:"primary",text:"",onClick:b},{default:g(()=>h[1]||(h[1]=[S(" 编辑 ")])),_:1}),c(T,{size:"small",type:"success",text:"",onClick:k},{default:g(()=>h[2]||(h[2]=[S(" 导出 ")])),_:1}),"built-in"!==e.preset.source?(i(),u(T,{key:0,size:"small",type:"danger",text:"",onClick:C},{default:g(()=>h[3]||(h[3]=[S(" 删除 ")])),_:1})):(i(),u(A,{key:1,content:"内置预设无法删除",placement:"top"},{default:g(()=>[c(T,{size:"small",type:"info",text:"",disabled:""},{default:g(()=>h[4]||(h[4]=[S(" 删除 ")])),_:1})]),_:1}))])],2);var O,P}}},[["__scopeId","data-v-aa596af6"]]),Fi={class:"cropper-container"},Gi={class:"cropper-main"},Wi=["src"],Ji={class:"preview-area"},Yi={class:"preview-container"},Ki={class:"cropper-tips"},Xi={class:"dialog-footer"},Qi=ve({__name:"ImageCropper",props:{visible:{type:Boolean,default:!1},imageSrc:{type:String,required:!0}},emits:["close","confirm"],setup(t,{emit:s}){const o=t,l=s,n=y(null),r=y(null),p=y(null),h=e({x:0,y:0,width:200,height:200,imageWidth:0,imageHeight:0,containerWidth:0,containerHeight:0}),v=e({isDragging:!1,isResizing:!1,resizeType:"",startX:0,startY:0,startCropX:0,startCropY:0,startCropWidth:0,startCropHeight:0}),w=y({left:"0px",top:"0px",width:"200px",height:"200px"}),b=()=>{E(()=>{if(!r.value||!n.value)return;const e=r.value,t=n.value;h.imageWidth=e.naturalWidth,h.imageHeight=e.naturalHeight,h.containerWidth=t.clientWidth,h.containerHeight=t.clientHeight;const a=Math.min(h.containerWidth,h.containerHeight),s=Math.min(.6*a,200);h.width=s,h.height=s,h.x=(h.containerWidth-s)/2,h.y=(h.containerHeight-s)/2,C(),_()})},C=()=>{w.value={left:h.x+"px",top:h.y+"px",width:h.width+"px",height:h.height+"px"}},_=()=>{if(!r.value||!p.value)return;const e=p.value.getContext("2d"),t=r.value,a=h.imageWidth/h.containerWidth,s=h.imageHeight/h.containerHeight,i=h.x*a,o=h.y*s,l=h.width*a,n=h.height*s;e.clearRect(0,0,120,120),e.save(),e.beginPath(),e.arc(60,60,60,0,2*Math.PI),e.clip(),e.drawImage(t,i,o,l,n,0,0,120,120),e.restore()},k=e=>{v.isResizing||(v.isDragging=!0,v.startX=e.clientX,v.startY=e.clientY,v.startCropX=h.x,v.startCropY=h.y,document.addEventListener("mousemove",x),document.addEventListener("mouseup",L),e.preventDefault())},x=e=>{if(!v.isDragging)return;const t=e.clientX-v.startX,a=e.clientY-v.startY;let s=v.startCropX+t,i=v.startCropY+a;s=Math.max(0,Math.min(s,h.containerWidth-h.width)),i=Math.max(0,Math.min(i,h.containerHeight-h.height)),h.x=s,h.y=i,C(),_()},L=()=>{v.isDragging=!1,document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",L)},M=e=>{v.isResizing=!0,v.resizeType=e,v.startX=event.clientX,v.startY=event.clientY,v.startCropX=h.x,v.startCropY=h.y,v.startCropWidth=h.width,v.startCropHeight=h.height,document.addEventListener("mousemove",T),document.addEventListener("mouseup",O),event.preventDefault()},T=e=>{if(!v.isResizing)return;const t=e.clientX-v.startX,a=e.clientY-v.startY;let s=v.startCropX,i=v.startCropY,o=v.startCropWidth,l=v.startCropHeight;switch(v.resizeType){case"nw":s=v.startCropX+t,i=v.startCropY+a,o=v.startCropWidth-t,l=v.startCropHeight-a;break;case"ne":i=v.startCropY+a,o=v.startCropWidth+t,l=v.startCropHeight-a;break;case"sw":s=v.startCropX+t,o=v.startCropWidth-t,l=v.startCropHeight+a;break;case"se":o=v.startCropWidth+t,l=v.startCropHeight+a}const n=Math.min(o,l);o=n,l=n;o<50||l<50||(s<0&&(o+=s,l=o,s=0),i<0&&(l+=i,o=l,i=0),s+o>h.containerWidth&&(o=h.containerWidth-s,l=o),i+l>h.containerHeight&&(l=h.containerHeight-i,o=l),h.x=s,h.y=i,h.width=o,h.height=l,C(),_())},O=()=>{v.isResizing=!1,document.removeEventListener("mousemove",T),document.removeEventListener("mouseup",O)};A(()=>o.imageSrc,()=>{o.visible&&o.imageSrc&&E(()=>{b()})});const P=()=>{l("close")},I=async()=>{const e=await new Promise(e=>{const t=document.createElement("canvas"),a=t.getContext("2d"),s=r.value,i=200;t.width=i,t.height=i;const o=h.imageWidth/h.containerWidth,l=h.imageHeight/h.containerHeight,n=h.x*o,c=h.y*l,d=h.width*o,u=h.height*l;a.drawImage(s,n,c,d,u,0,0,i,i),t.toBlob(t=>{e(t)},"image/jpeg",.9)});l("confirm",e)};return(e,s)=>{const o=d("el-text"),l=d("el-button"),h=d("el-dialog");return i(),u(h,{"model-value":t.visible,title:"裁剪头像",width:"600px","before-close":P,"destroy-on-close":"",class:"cropper-dialog"},{footer:g(()=>[a("div",Xi,[c(l,{onClick:P},{default:g(()=>s[8]||(s[8]=[S("取消")])),_:1}),c(l,{type:"primary",onClick:I},{default:g(()=>s[9]||(s[9]=[S("确认裁剪")])),_:1})])]),default:g(()=>[a("div",Fi,[a("div",Gi,[a("div",{class:"crop-area",ref_key:"cropAreaRef",ref:n},[a("img",{ref_key:"imageRef",ref:r,src:t.imageSrc,class:"crop-image",onLoad:b},null,40,Wi),a("div",{class:"crop-box",style:f(w.value),onMousedown:k},[s[4]||(s[4]=a("div",{class:"crop-overlay"},null,-1)),a("div",{class:"resize-handle nw",onMousedown:s[0]||(s[0]=m(e=>M("nw"),["stop"]))},null,32),a("div",{class:"resize-handle ne",onMousedown:s[1]||(s[1]=m(e=>M("ne"),["stop"]))},null,32),a("div",{class:"resize-handle sw",onMousedown:s[2]||(s[2]=m(e=>M("sw"),["stop"]))},null,32),a("div",{class:"resize-handle se",onMousedown:s[3]||(s[3]=m(e=>M("se"),["stop"]))},null,32)],36)],512),a("div",Ji,[s[5]||(s[5]=a("div",{class:"preview-title"},"预览",-1)),a("div",Yi,[a("canvas",{ref_key:"previewCanvasRef",ref:p,class:"preview-canvas",width:"120",height:"120"},null,512)]),s[6]||(s[6]=a("div",{class:"preview-size"},"120 × 120",-1))])]),a("div",Ki,[c(o,{type:"info",size:"small"},{default:g(()=>s[7]||(s[7]=[S(" 拖拽裁剪框调整位置，拖拽四角调整大小 ")])),_:1})])])]),_:1},8,["model-value"])}}},[["__scopeId","data-v-44dbf36c"]]),Zi={class:"dialog-content"},eo={class:"avatar-editor"},to={class:"avatar-preview"},ao={class:"avatar-actions"},so={class:"avatar-help"},io={class:"history-editor"},oo={class:"history-header"},lo={class:"history-list"},no={class:"item-header"},ro={key:0,class:"empty-history"},co={class:"tools-editor"},uo={class:"tools-help"},po={key:0},ho={key:1},mo={class:"dialog-footer"},go=ve({__name:"PresetEditor",props:{visible:{type:Boolean,default:!1},mode:{type:String,default:"create",validator:e=>["create","edit"].includes(e)},preset:{type:Object,default:null}},emits:["close","submit"],setup(s,{emit:p}){const h=s,m=p,f=y(null),v=y(!1),w=e({name:"",category:"common",avatar:"",opening:"",history:[],tools:[]}),C={name:[{required:!0,message:"请输入预设名称",trigger:"blur"},{min:1,max:50,message:"名称长度应在 1-50 个字符",trigger:"blur"}],category:[{required:!0,message:"请选择预设分类",trigger:"change"}],history:[{required:!0,message:"至少需要一条对话历史",trigger:"change"},{validator:(e,t,a)=>{if(Array.isArray(t)&&0!==t.length){for(let e=0;e<t.length;e++){const s=t[e];if(!s.role||!s.content)return void a(new Error(`第 ${e+1} 条消息的角色和内容不能为空`))}a()}else a(new Error("至少需要一条对话历史"))},trigger:"change"}]},k=y([]),x=y(!1),L=y(null),M=y(!1),T=y(!1),O=y(""),P={"X-Admin-Code":localStorage.getItem("admin_code")||""},I={multiple:!0,checkStrictly:!1,value:"value",label:"label",children:"children",emitPath:!1};A(()=>h.preset,e=>{e&&"edit"===h.mode&&(w.name=e.name||"",w.category=e.category||"common",w.avatar=e.avatar||"",w.opening=e.opening||"",w.history=e.history?[...e.history]:[],w.tools=e.tools?[...e.tools]:[])},{immediate:!0}),A(()=>h.visible,e=>{e&&("create"===h.mode&&$(),E(()=>{f.value?.clearValidate()}))});const $=()=>{w.name="",w.category="common",w.avatar="",w.opening="",w.history=[],w.tools=[]},V=()=>{w.history.push({role:"system",content:""})},U=()=>{v.value||m("close")},D=e=>{const t=e.raw.type.startsWith("image/"),a=e.raw.size/1024/1024<5;if(!t)return void j.error("只能上传图片文件!");if(!a)return void j.error("图片大小不能超过 5MB!");const s=new FileReader;s.onload=e=>{O.value=e.target.result,T.value=!0},s.readAsDataURL(e.raw)},R=()=>{T.value=!1,O.value=""},N=async e=>{T.value=!1,M.value=!0;try{const t=new FormData;t.append("image",e,"avatar.jpg");const a=await fetch("/api/upload/image",{method:"POST",headers:P,body:t}),s=await a.json();0===s.code&&s.data?.url?(w.avatar=s.data.url,j.success("头像上传成功")):j.error("头像上传失败: "+(s.message||"未知错误"))}catch(t){j.error("头像上传失败: "+t.message)}finally{M.value=!1}},B=()=>{w.avatar="",j.success("头像已移除")},q=async()=>{if(!v.value)try{await(f.value?.validate()),v.value=!0;const e={name:w.name.trim(),category:w.category,opening:w.opening.trim(),history:w.history.map(e=>({role:e.role,content:e.content.trim()})).filter(e=>e.content),tools:w.tools.filter(e=>e.trim())};w.avatar&&(e.avatar=w.avatar),m("submit",{data:e,mode:h.mode}),m("close")}catch(e){}finally{v.value=!1}};return b(()=>{(async()=>{if(!x.value){x.value=!0;try{const t=await qs.listPlugins();if(0!==t.code)return;const a=t.data.plugins||[],s=new Map;for(const o of a)if(o.enabled)try{const e=await qs.getPluginTools(o.name);0===e.code&&e.data.tools&&e.data.tools.forEach(e=>{e.tools.forEach(t=>{const a=t.name.split("_mid_")[0];s.has(a)||s.set(a,{value:a,label:a,fullName:t.name,description:t.description,plugin:o.displayName,group:e.group})})})}catch(e){}const i=new Map;s.forEach(e=>{i.has(e.plugin)||i.set(e.plugin,{value:e.plugin,label:e.plugin,children:new Map});const t=i.get(e.plugin);t.children.has(e.group)||t.children.set(e.group,{value:`${e.plugin}_${e.group}`,label:e.group,children:[]}),t.children.get(e.group).children.push({value:e.value,label:e.label})}),k.value=Array.from(i.values()).map(e=>({...e,children:Array.from(e.children.values())}))}catch(e){k.value=[]}finally{x.value=!1}}})()}),(e,p)=>{const h=d("el-input"),m=d("el-form-item"),y=d("el-option"),b=d("el-select"),M=d("el-avatar"),A=d("el-button"),P=d("el-upload"),E=d("el-text"),$=d("el-empty"),j=d("el-cascader"),H=d("el-form"),F=d("el-dialog");return i(),u(F,{"model-value":s.visible,title:"create"===s.mode?"创建预设":"编辑预设",width:"800px","before-close":U,"destroy-on-close":"",class:"form-dialog preset-editor-dialog"},{footer:g(()=>[a("div",mo,[c(A,{onClick:U},{default:g(()=>p[12]||(p[12]=[S("取消")])),_:1}),c(A,{type:"primary",loading:v.value,onClick:q},{default:g(()=>[S(r("create"===s.mode?"创建":"保存"),1)]),_:1},8,["loading"])])]),default:g(()=>[a("div",Zi,[c(H,{ref_key:"formRef",ref:f,model:w,rules:C,"label-width":"100px","label-position":"left"},{default:g(()=>[c(m,{label:"预设名称",prop:"name"},{default:g(()=>[c(h,{modelValue:w.name,"onUpdate:modelValue":p[0]||(p[0]=e=>w.name=e),placeholder:"请输入预设名称",maxlength:"50","show-word-limit":""},null,8,["modelValue"])]),_:1}),c(m,{label:"预设分类",prop:"category"},{default:g(()=>[c(b,{modelValue:w.category,"onUpdate:modelValue":p[1]||(p[1]=e=>w.category=e),placeholder:"请选择预设分类",style:{width:"100%"}},{default:g(()=>[c(y,{label:"常用预设",value:"common"}),c(y,{label:"推荐预设",value:"recommended"}),c(y,{label:"隐藏预设",value:"hidden"})]),_:1},8,["modelValue"])]),_:1}),c(m,{label:"预设头像",prop:"avatar"},{default:g(()=>[a("div",eo,[a("div",to,[c(M,{size:80,src:w.avatar,icon:_(G),class:"preview-avatar"},null,8,["src","icon"])]),a("div",ao,[c(P,{ref_key:"avatarUploadRef",ref:L,"auto-upload":!1,"show-file-list":!1,"on-change":D,accept:"image/*"},{default:g(()=>[c(A,{type:"primary"},{default:g(()=>p[4]||(p[4]=[S(" 选择头像 ")])),_:1})]),_:1},512),w.avatar?(i(),u(A,{key:0,type:"danger",text:"",onClick:B},{default:g(()=>p[5]||(p[5]=[S(" 移除头像 ")])),_:1})):o("",!0)]),a("div",so,[c(E,{type:"info",size:"small"},{default:g(()=>p[6]||(p[6]=[S(" 支持 JPG、PNG 等图片格式，将自动裁剪为正方形 ")])),_:1})])])]),_:1}),c(Qi,{visible:T.value,"image-src":O.value,onClose:R,onConfirm:N},null,8,["visible","image-src"]),c(m,{label:"开场白",prop:"opening"},{default:g(()=>[c(h,{modelValue:w.opening,"onUpdate:modelValue":p[2]||(p[2]=e=>w.opening=e),type:"textarea",rows:3,placeholder:"请输入开场白（可选）",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),c(m,{label:"对话历史",prop:"history"},{default:g(()=>[a("div",io,[a("div",oo,[p[8]||(p[8]=a("span",null,"消息列表",-1)),c(A,{type:"primary",size:"small",icon:_(z),onClick:V},{default:g(()=>p[7]||(p[7]=[S(" 添加消息 ")])),_:1},8,["icon"])]),a("div",lo,[(i(!0),t(l,null,n(w.history,(e,s)=>(i(),t("div",{key:s,class:"history-item"},[a("div",no,[c(b,{modelValue:e.role,"onUpdate:modelValue":t=>e.role=t,placeholder:"选择角色",style:{width:"120px"}},{default:g(()=>[c(y,{label:"系统",value:"system"}),c(y,{label:"用户",value:"user"}),c(y,{label:"助手",value:"assistant"})]),_:2},1032,["modelValue","onUpdate:modelValue"]),c(A,{type:"danger",size:"small",text:"",icon:_(W),onClick:e=>(e=>{w.history.splice(e,1)})(s)},{default:g(()=>p[9]||(p[9]=[S(" 删除 ")])),_:2},1032,["icon","onClick"])]),c(h,{modelValue:e.content,"onUpdate:modelValue":t=>e.content=t,type:"textarea",rows:4,placeholder:"请输入消息内容",maxlength:"30000","show-word-limit":""},null,8,["modelValue","onUpdate:modelValue"])]))),128)),0===w.history.length?(i(),t("div",ro,[c($,{description:"暂无消息","image-size":80},{default:g(()=>[c(A,{type:"primary",icon:_(z),onClick:V},{default:g(()=>p[10]||(p[10]=[S(" 添加第一条消息 ")])),_:1},8,["icon"])]),_:1})])):o("",!0)])])]),_:1}),c(m,{label:"工具列表",prop:"tools"},{default:g(()=>[a("div",co,[c(j,{modelValue:w.tools,"onUpdate:modelValue":p[3]||(p[3]=e=>w.tools=e),options:k.value,props:I,placeholder:"选择工具",style:{width:"100%"},clearable:"",filterable:"","show-all-levels":!1,"collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":20,loading:x.value,class:"tools-cascader"},null,8,["modelValue","options","loading"]),a("div",uo,[c(E,{type:"info",size:"small"},{default:g(()=>[p[11]||(p[11]=S(" 从插件中选择可用的工具，支持多选和搜索 ")),x.value?(i(),t("span",po,"（正在加载工具列表...）")):0===k.value.length?(i(),t("span",ho,"（暂无可用工具）")):o("",!0)]),_:1})])])]),_:1})]),_:1},8,["model"])])]),_:1},8,["model-value","title"])}}},[["__scopeId","data-v-c95bec08"]]);export{Pi as A,At as C,Ns as E,nt as F,et as I,wi as L,go as P,Tt as R,St as T,ve as _,qe as a,Us as b,fe as c,ge as d,Bs as e,za as f,mi as g,Hi as h,Oe as i,Te as j,qs as p,ce as s,zs as u};
//# sourceMappingURL=components-Z1ZItl6E.js.map
