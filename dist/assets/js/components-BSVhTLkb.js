import{r as e,c as t,a,n as s,o as i,b as o,F as n,d as l,t as r,e as c,f as d,g as u,w as p,v as h,h as m,i as g,j as f,T as v,k as y,l as w,m as b,u as C,p as _,q as S,s as k,x,y as L,z as M,A as T,B as A,C as O}from"./vendor_vue-DjqW6Aqw.js";import{R as P,_ as I}from"./vendor_editor_preview-u-Wqm63M.js";import{l as E,W as $}from"./vendor_misc-BTiB9Zt4.js";import{s as V,l as D,E as U,u as R,a as j,e as N,r as B,d as q,p as F,v as G,h as J}from"./vendor_element_plus-mpzays2Y.js";import{l as z}from"./vendor_socketio-3UEp_BzY.js";class H{constructor(){this.events={}}on(e,t,a=!0){a&&this.off(e),this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){this.events[e]&&this.events[e].forEach(e=>{e(t)})}off(e){this.events[e]&&delete this.events[e]}}function W(e){let t="";const a="0123456789";for(let s=0;s<e;s++)t+=a.charAt(Math.floor(10*Math.random()));return t}function K(e){let t="";const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<e;s++)t+=a.charAt(Math.floor(62*Math.random()));return t}class Y extends H{constructor(e,t){super(),this.available=null,this.url=this.getURL(),this.socket=null,this.code=t,this.id=e,this.requests=[],this.pendingRequests=new Set}getURL(){return new URL(window.location.href).host}initEventListeners(){this.socket&&(this.socket.off("connect"),this.socket.off("disconnect"),this.socket.off("connect_error"),this.socket.off("message"),this.socket.on("connect",()=>this.handleConnect()),this.socket.on("disconnect",e=>this.handleDisconnect(e)),this.socket.on("connect_error",e=>this.handleConnectError(e)),this.socket.on("message",e=>this.messageHandler(e)))}handleConnect(){this.available=!0,this.hasAttemptedPollingFallback=!1,this.isAttemptingWebSocket=!1;this.socket.io}handleDisconnect(e){this.available=!1}handleConnectError(e){this.emit("connect_error",e),this.isAttemptingWebSocket&&!this.hasAttemptedPollingFallback?(this.hasAttemptedPollingFallback=!0,this.isAttemptingWebSocket=!1,this.socket&&(this.socket.disconnect(),this.socket=null),setTimeout(()=>{this._connectWithTransport(["polling"])},500)):(this.isAttemptingWebSocket,this.available=!1)}_connectWithTransport(e){this.socket&&this.socket.disconnect(),this.socket=z(this.url,{path:"/socket.io",transports:e,auth:{id:this.id,token:this.code},reconnection:!0,reconnectionAttempts:Infinity,reconnectionDelay:2e3,reconnectionDelayMax:1e4,timeout:15e3,forceNew:!0}),this.initEventListeners()}async connect(){this.socket&&this.socket.connected||(this.isAttemptingWebSocket=!0,this.hasAttemptedPollingFallback=!1,this._connectWithTransport(["websocket"]))}disconnect(){this.socket&&(this.socket.disconnect(),this.available=!1)}messageHandler(e){try{const t=JSON.parse(e);"llm"===t.protocol&&(this.emit(t.request_id,t),this.emit("llm_message",t)),"onebot"===t.protocol?this.emit("onebot_message",t):"system"===t.protocol&&("login"===t.type&&this.emit("connect",t.data),this.emit("system_message",t)),this.emit(t.request_id,t),this.pendingRequests.delete(t.request_id)}catch(t){}}sendMessage(e){if(!this.socket||!this.socket.connected)return this.pendingRequests.delete(e.request_id),Promise.reject(new Error("Socket not connected"));if(this.pendingRequests.has(e.request_id))return Promise.reject(new Error(`Duplicate request_id: ${e.request_id}`));this.pendingRequests.add(e.request_id);try{return this.socket.emit("message",JSON.stringify(e)),Promise.resolve()}catch(t){return this.pendingRequests.delete(e.request_id),Promise.reject(t)}}fetch(e,t){return new Promise((a,s)=>{const i=e.split("/").filter(Boolean),o={request_id:K(16),protocol:i[1],type:i[2],id:i[3],data:t,metaData:{contactorId:this.id}},n=new Promise((e,t)=>{setTimeout(()=>{this.pendingRequests.delete(o.request_id),t("timeout")},6e4)}),l=new Promise(e=>{this.on(o.request_id,t=>{this.pendingRequests.delete(o.request_id),e(t.data)})});Promise.race([n,l]).then(a).catch(s).finally(()=>{this.off(o.request_id)}),this.sendMessage(o)})}streamCompletions(e,t){const a={request_id:K(16),protocol:"llm",type:"completions",data:e,metaData:t};this.sendMessage(a)}}class X extends H{constructor(){super()}async fetch(e,t){return await me.socket.fetch(e,t)}}class Q extends X{constructor(){super()}convertMessage(e){e.message.forEach((t,a)=>{if("image"===t.type){const s=t.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.message[a].data.file=s}else"nodes"===t.type&&t.data.messages.forEach(e=>{if("image"===e.type){const t=e.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.data.file=t}})});const t=e.message.filter(e=>"reply"===e.type),a=e.message.filter(e=>"reply"!==e.type);t.length>0&&a.unshift(t[0]);return{role:"other",time:(new Date).getTime(),content:a,id:e.message_id,status:"completed"}}async send(e,t){return(await this.fetch(`/api/onebot/message/${e}`,t)).message_id}}class Z extends X{constructor(e){super(),this.id=e.id}convertMessage(e){return{...{role:"other",time:(new Date).getTime(),content:[{type:"blank",data:{}}],status:"pending",id:W(16)},...e}}async getMessagesSummary(e){const t=`请你根据以下对话的内容\n${JSON.stringify(e)}\n，总结出一个简短的对话主题,你的回答必须只包含对话主题，不要包含任何其他内容，包括句号。`,a=he.getLLMDefaultConfig();a.base.stream=!1;const s={settings:a,messages:[{role:"user",content:t}]},i=await this.fetch("/api/llm/completions",s),{content:o}=i;return o||"未命名会话"}handleMessageEvent(e){const t=e.data,a=t.metaData.messageId;delete t.metaData;const s=(e,t)=>{this.emit(e,{...t,messageId:a})};if("update"===e.message){const t={reasoningContent:e=>s("updateReasoning",{reasoning_content:e}),content:e=>s("updateMessage",{chunk:e}),toolCall:e=>s("updateToolCall",{tool_call:e})},a=e.data,i=t[a.type];i&&i(a.content)}else if(["complete","failed"].includes(e.message)){const t={complete:()=>s("completeMessage",{}),failed:()=>s("failedMessage",{error:e.data})}[e.message];t&&t()}}async send(e,t,a){a=he.getVerifiedLLMConfig(a);const s={contactorId:this.id,messageId:t},i={settings:a,messages:e};if(!me.socket)throw new Error("WebSocket connection not established.");me.socket.streamCompletions(i,s)}}const ee="https://registry.npmmirror.com/@lobehub/icons-static-svg/latest/files/icons",te={OpenAI:"openai.svg",Cohere:"cohere-color.svg",Anthropic:"claude-color.svg",Google:"gemini-color.svg","X.AI":"grok.svg",DeepSeek:"deepseek-color.svg","智谱清言":"zhipu-color.svg","豆包":"doubao-color.svg","月之暗面 (kimi)":"moonshot.svg","科大讯飞":"spark-color.svg","通义千问":"qwen-color.svg","腾讯混元":"hunyuan-color.svg"};function ae(e){const t=function(e){return{openai:"openai.svg",gemini:"gemini-color.svg",vertex:"gemini-color.svg",onebot:"openai.svg"}[e]||"openai.svg"}(e);return`${ee}/${t}`}const se=["MODEL","CUSTOM"],ie=["MODEL","CUSTOM","SUMMARY"];class oe extends H{constructor(e,t){super(),this.platform=e,this.id=t.id,this.namePolicy=t.namePolicy||0,this.avatarPolicy=t.avatarPolicy||0,this.title=t.title,this.name=t.name,this.avatar=t.avatar,this.priority=t.priority,this.firstMessageIndex=t.firstMessageIndex||0,this.messageChain=t.messageChain||[],this.active=!1,this.lastUpdate=t.lastUpdate||Date.now(),this.createTime=t.createTime||Date.now(),this.lastMessageSummary=this.getLastMessageSummary(),this.options=this.loadOptions(t.options),this.kernel="onebot"===e?new Q(t):new Z(t),"openai"===e&&this.enableOpenaiListener()}toJSON(){return{platform:this.platform,id:this.id,options:this.options,namePolicy:this.namePolicy,avatarPolicy:this.avatarPolicy,title:this.title,name:this.name,avatar:this.avatar,priority:this.priority,messageChain:this.messageChain,active:this.active,lastUpdate:this.lastUpdate,createTime:this.createTime,lastMessageSummary:this.lastMessageSummary,firstMessageIndex:this.firstMessageIndex}}enableOpenaiListener(){this.kernel.on("updateReasoning",e=>{const{reasoning_content:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;const i=s.content.findIndex(e=>"reason"===e.type),o={type:"reason",data:{text:t,startTime:(new Date).getTime(),endTime:0}};-1!==i?(o.data.text=s.content[i].data.text+t,o.data.startTime=s.content[i].data.startTime,s.content[i]=o):"blank"===s.content[0].type?s.content[0]=o:s.content.push(o),this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("updateMessage",e=>{const{chunk:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;s.content.forEach(e=>{"reason"!=e.type||e.data.endTime||(e.data.endTime=(new Date).getTime())});const i=s.content[s.content.length-1],o=["blank","text"].includes(i.type),n={type:"text",data:{text:("text"==i.type?i.data.text:"").concat(t)}};o?s.content[s.content.length-1]=n:s.content.push(n),this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("updateToolCall",e=>{const{tool_call:t,messageId:a}=e,s=this.getMessageById(a);if(!s)return;const i=s.content[s.content.length-1],o={type:"tool_call",data:t};if("blank"==i.type)s.content[0]=o;else{const e=s.content.find(e=>e.data.id==t.id);if(e){const a=JSON.parse(JSON.stringify(e));a.data.action=t.action,a.data.result=t.result,"pending"==t.action&&(a.data.parameters+=t.parameters);const i=s.content.indexOf(e);s.content[i]=a}else s.content.push(o)}this.emit("updateMessage"),this.emit("updateMessageSummary")}),this.kernel.on("completeMessage",e=>{this.updateLastUpdate();const t=e.messageId,a=this.getMessageById(t);a&&(a.status="completed",this.emit("updateMessageSummary"),this.emit("completeMessage",{messageId:t}))}),this.kernel.on("failedMessage",e=>{if("string"==typeof e.error)try{e.error.message=JSON.parse(e.error.message)}catch(i){}const t=JSON.stringify(e.error,null,2);this.updateLastUpdate();const a=e.messageId,s=this.getMessageById(a);if(s){const e={type:"text",data:{text:"Error : LLM 响应失败！\n```json\n "+t+"\n```"}};s.content.some(e=>"blank"===e.type)?s.content[0]=e:s.content.push(e),s.status="completed",this.emit("updateMessageSummary"),this.emit("completeMessage",{messageId:a})}})}handleLLMMessageEvent(e){this.kernel.handleMessageEvent(e)}loadOptions(e){return"openai"===this.platform?he.getVerifiedLLMConfig(e):e||{}}async send(e){await this.kernel.send(e)}_getFilePrompt(e){return"\n以下是用户上传的文件：\n"+e.join("\n")}_getImagePrompt(e){return"\n以下是用户所上传的图片链接：\n"+e.map(e=>e.content).join("\n")}_getValidOpenaiMessage(e=this.firstMessageIndex,t=this.messageChain.length,a=this.options.base.max_messages_num){const s=this.messageChain.slice(e,t).slice(-a).filter(e=>"mio_system"!=e.role).map(e=>{const t=[],a=[],s=[];if(e.content.forEach(i=>{const o="tool_call"==i.type?"tool":"user"==e.role?"user":"assistant",n={role:o,content:"none",_content_type:void 0};"tool"==o?(n.role="assistant",n.content=null,n.tool_calls=[{id:i.data.id,function:{name:i.data.name,arguments:i.data.parameters},type:"function"}],s.push({...n}),delete n.tool_calls,n.role="tool",n.content=JSON.stringify(i.data.result),n.tool_call_id=i.data.id,n.name=i.data.name,s.push({...n}),n.role=o):"user"!=o&&"assistant"!=o||("image"==i.type?(n.content=i.data.file,n._content_type="image",s.push(n),a.push(i.data.file.content)):"text"==i.type?(n.content=i.data.text,n._content_type="text",s.push(n)):"file"==i.type&&t.push(i.data.file))}),t.length>0){0==s.filter(e=>"text"==e._content_type).length&&s.push({role:"user",content:this._getFilePrompt(t),_content_type:"text"})}return s});let i=[];s.forEach(e=>{const t=e.filter(e=>"text"==e._content_type),a=e.filter(e=>"image"==e._content_type),s=e.filter(e=>"file"==e._content_type),o=s.length>0?this._getFilePrompt(s):"",n=a.length>0?this._getImagePrompt(a):"";let l=null;t.length>0&&a.length>0&&"user"==a[0].role&&(l={role:"user",content:[...a.map(e=>({type:"image_url",image_url:{url:e.content}})),...t.map(e=>({type:"text",text:e.content+o+n}))]}),l?.content.length==e.length?i.push(l):(e.forEach(e=>{delete e._content_type}),i.push(...e))});const o=this.options.presetSettings.history;return o&&(i=o.concat(i)),i}updateMessageSummary(){this.lastMessageSummary=this.getLastMessageSummary()}getBaseUserContainer(){return{role:"user",time:(new Date).getTime(),status:"completed",id:W(16),content:[]}}async webSend(e,t=!0){if(this.updateLastUpdate(),this.messageChain.push(e),this.updateMessageSummary(),t)try{if("onebot"==this.platform){return await this.kernel.send(this.id,e.content)}{const e=this._getValidOpenaiMessage(),t=W(16);return await this.kernel.send(e,t,this.options),this.revMessage({id:t}),W(16)}}catch(a){throw a}}insertMessage(e,t){this.messageChain.splice(t,0,e),this.updateMessageSummary()}async retryMessage(e){const t=this.getMessageById(e);if(t){t.content=[{type:"blank"}],this.updateLastUpdate();const a=this.messageChain.indexOf(t),s=this._getValidOpenaiMessage(0,a);return this.kernel.send(s,e,this.options),!0}}as;revMessage(e){this.updateLastUpdate();const t=this.kernel.convertMessage(e);return this.active?this.emit("revMessage",t):this.messageChain.push(t),this.emit("updateMessageSummary"),t}delMessage(e){for(let t=0;t<this.messageChain.length;t++)if(this.messageChain[t].id===e&&"other"===this.messageChain[t].role)return this.active?this.emit("delMessage",t):this.acting.messageChain.splice(t,1),this.makeSystemMessage(`${this.name}撤回了一条消息`),!0;return!1}makeSystemMessage(e){const t={role:"mio_system",time:(new Date).getTime(),id:(new Date).getTime(),content:[{type:"text",data:{text:e}}]};this.active?this.emit("revMessage",t):this.messageChain.push(t)}getLastTime(){const e=this.messageChain[this.messageChain.length-1];if(!e)return"";const t=(new Date).getTime(),a=new Date(e.time),s=t-a.getTime();if(s<864e5){this.toinit=!1;return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}if(s<1728e5)return"昨天";if(s<6048e5){return`星期${["日","一","二","三","四","五","六"][a.getDay()]}`}return`${a.getFullYear()}/${(a.getMonth()+1).toString().padStart(2,"0")}/${a.getDate().toString().padStart(2,"0")}`}getShownTime(e){const t=(new Date).getTime()-e;if(t<864e5){return`${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<1728e5){return`昨天${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<6048e5){const t=["日","一","二","三","四","五","六"],a=new Date(e).getDay(),s=new Date(e).getHours().toString().padStart(2,"0"),i=new Date(e).getMinutes().toString().padStart(2,"0");return`星期${t[a]}${s}:${i}`}return`${new Date(e).getFullYear()}/${(new Date(e).getMonth()+1).toString().padStart(2,"0")}/${new Date(e).getDate().toString().padStart(2,"0")} ${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}getLastMessageSummary(e){let t=e||this.messageChain[this.messageChain.length-1];return t?(t=JSON.parse(JSON.stringify(t)),"node"===t.type&&(t=t.data),(e=>{switch(e.type){case"text":case"reason":return e.data.text;case"image":return"[图片]";case"record":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"tool_call":return`[调用工具] ${e.data.name}`;case"blank":return"正在思考中...";case"reply":return"";case"nodes":return"[转发消息]";default:return"[未知消息类型] "+e.type}})(t.content?t.content[0]:t)):""}updateFirstMessage(){this.firstMessageIndex=this.messageChain.length}updateLastUpdate(){this.lastUpdate=(new Date).getTime()}getMessageById(e){return this.messageChain.find(t=>t.id===e)}loadAvatar(){let e="/static/avatar/miobot.png";if("MODEL"==se[this.avatarPolicy]){const t=this.options.base.model;e=oe.getAvatarByModel(t)}else"CUSTOM"==se[this.avatarPolicy]&&(e=this.avatar);return"openai"==this.platform&&(this.title=this.options.base.model),this.avatar=e,e}async loadName(){let e=this.name??"未命名 Bot";if("MODEL"==ie[this.namePolicy]){e=this.options.model}else"CUSTOM"==ie[this.namePolicy]?e=this.name:"SUMMARY"==ie[this.namePolicy]&&(this.messageChain.length<2?e="新建的 Bot":2!=this.messageChain.length&&this.messageChain.length%6!=0||(e=await this.getMessagesSummary()));return this.name=e,e}getMessagesSummary(){return"openai"==this.platform?this.kernel.getMessagesSummary(this._getValidOpenaiMessage().slice(-4)):"仅支持 OpenAI Chat Bot"}static getAvatarByModel(e){return function(e){return Object.keys(te).includes(e)?`${ee}/${te[e]}`:`${ee}/openai.svg`}(he.getModelOwner(e))}}function ne(e,t){let a;return function(...s){clearTimeout(a),a=setTimeout(()=>{e.apply(this,s)},t)}}function le(e){let t=!1,a="";return navigator.share?(t=!0,a="分享成功",navigator.share({title:"从Mio Chat分享",url:e}).then(()=>{}).catch(e=>{t=!1,a="分享失败"})):navigator.clipboard&&(t=!0,a="链接已复制到剪贴板",navigator.clipboard.writeText(e).then(()=>{}).catch(e=>{t=!1,a="复制失败"})),{success:t,message:a}}function re(e){return new Worker("/assets/fileUpload-Di8XL5pf.js",{name:e?.name})}E.config({name:"mio-chat"});const ce={AUTO:"AUTO",ANY:"ANY",NONE:"NONE"},de={NONE:"BLOCK_NONE",LOW:"BLOCK_ONLY_HIGH",MEDIUM:"BLOCK_MEDIUM_AND_ABOVE",HIGH:"BLOCK_LOW_AND_ABOVE",DEFAULT:"BLOCK_NONE"},ue={HARASSMENT:"HARM_CATEGORY_HARASSMENT",HATE_SPEECH:"HARM_CATEGORY_HATE_SPEECH",SEXUALLY_EXPLICIT:"HARM_CATEGORY_SEXUALLY_EXPLICIT",DANGEROUS_CONTENT:"HARM_CATEGORY_DANGEROUS_CONTENT"},pe="app_config_v1";const he=new class{constructor(){this.localPresets=[],this.toolsConfig={},this.llmTools=[],this.onebotConfig=null,this.llmModels={},this.safetyConfig={},this.baseConfig={},this.LLMDefaultConfig={},this.baseConfigCallback=null,this._loadStrogeConfig(),this.initSafetyConfig(),this.initLLMDefaultConfig(),this.loadllmTools().catch(e=>{}),this.loadonebotConfig().catch(e=>{}),this._getLocalStorage(pe)||this._saveStrogeConfig()}_setLocalStorage(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(a){}}_getLocalStorage(e){try{const t=localStorage.getItem(e);return null==t?null:JSON.parse(t)}catch(t){return localStorage.removeItem(e),null}}_saveStrogeConfig(){const e={localPresets:this.localPresets,toolsConfig:this.toolsConfig,llmTools:this.llmTools,onebotConfig:this.onebotConfig,llmModels:this.llmModels,baseConfig:this.baseConfig,safetyConfig:this.safetyConfig,LLMDefaultConfig:this.LLMDefaultConfig};this._setLocalStorage(pe,e)}_loadStrogeConfig(){const e=this._getLocalStorage(pe);e&&(this.localPresets=e.localPresets??[],this.toolsConfig=e.toolsConfig??{},this.llmTools=e.llmTools??[],this.onebotConfig=e.onebotConfig??null,this.llmModels=e.llmModels??{},this.baseConfig=e.baseConfig??{},this.safetyConfig=e.safetyConfig??{},this.LLMDefaultConfig=e.LLMDefaultConfig??{})}_mergeDefaultsRecursive(e,t){if(!e||"object"!=typeof e||!t||"object"!=typeof t)return e;for(const a in e)Object.prototype.hasOwnProperty.call(e,a)&&(a in t||delete e[a]);for(const a in t)if(Object.prototype.hasOwnProperty.call(t,a)){const s=t[a],i=e[a];a in e?"object"!=typeof s||null===s||Array.isArray(s)||"object"!=typeof i||null===i||Array.isArray(i)||this._mergeDefaultsRecursive(i,s):"object"!=typeof s||null===s||Array.isArray(s)?Array.isArray(s)?e[a]=[...s]:e[a]=s:e[a]=this._mergeDefaultsRecursive({},s)}return e}initSafetyConfig(){const e=Object.values(ue);let t=!1;this.safetyConfig&&"object"==typeof this.safetyConfig||(this.safetyConfig={},t=!0);for(const a of e)a in this.safetyConfig||(this.safetyConfig[a]=de.DEFAULT,t=!0)}initLLMDefaultConfig(){const e=this.baseConfig?.llm_providers?.[0],t=e?.displayName??"openai",a={provider:t,base:{model:this.getDefaultModel(t)??"gpt-4o-mini",max_messages_num:10,stream:!0},chatParams:{temperature:1,top_p:1,frequency_penalty:0,presence_penalty:0,reasoning_effort:-1},toolCallSettings:{mode:ce.AUTO,tools:[]},presetSettings:{opening:"",history:[]},extraSettings:{gemini:{imageGeneration:!1,internalTools:{google_search:!1,code_execution:!1,url_context:!1},safetySettings:{[ue.HARASSMENT]:de.DEFAULT,[ue.HATE_SPEECH]:de.DEFAULT,[ue.SEXUALLY_EXPLICIT]:de.DEFAULT,[ue.DANGEROUS_CONTENT]:de.DEFAULT}}}};this.LLMDefaultConfig&&"object"==typeof this.LLMDefaultConfig||(this.LLMDefaultConfig={}),this.LLMDefaultConfig=this._mergeDefaultsRecursive(this.LLMDefaultConfig,a)}getBaseConfig(){return this.baseConfig}setBaseConfig(e){this.baseConfig={...e};const{llm_providers:t=[],default_model:a={}}=this.baseConfig;if(t.length>0){const e=t[0]?.displayName;this.updateLLMDefaultConfig(null,{provider:e}),a[e]&&this.updateLLMDefaultConfig("base",{model:a[e]})}if(this._saveStrogeConfig(),this.baseConfigCallback)try{this.baseConfigCallback(this.baseConfig)}catch(s){}}setBaseConfigCallback(e){this.baseConfigCallback=e}updateBaseConfig(e){const t={...this.baseConfig,...e};this.setBaseConfig(t)}getLLMProviders(){return(this.baseConfig?.llm_providers??[]).map(e=>({value:e.displayName,label:e.displayName,adapterType:e.adapterType}))}getProviderAdapterType(e){const t=(this.baseConfig?.llm_providers??[]).find(t=>t.displayName===e);return t?t.adapterType:null}getDefaultModel(e){return this.baseConfig?.default_model?.[e]}getToolCallModes(){return Object.entries(ce).map(([e,t])=>({value:t,label:e}))}getLlmModels(e){return e?this.llmModels?.[e]??[]:this.llmModels??{}}setLlmModels(e){this.llmModels=e,this._saveStrogeConfig()}getDefaultLLMModel(){return this.baseConfig?.default_model??{}}isModelAvailable(e,t){return(this.llmModels?.[e]??[]).some(e=>e.models.includes(t))}getModelOwner(e){for(const t in this.llmModels){const a=(this.llmModels[t]??[]).find(t=>t.models.includes(e));if(a)return a.owner}}getSafetySettingsParams(){return de}getSafetyConfig(){return this.safetyConfig}setSafetyConfig(e){this.safetyConfig={...e},this.updateLLMDefaultConfig("safetySettings",{...this.safetyConfig})}updateLLMDefaultConfig(e,t){let a=!1;if(e&&this.LLMDefaultConfig[e]&&"object"==typeof this.LLMDefaultConfig[e]){const s=JSON.stringify(this.LLMDefaultConfig[e]);this.LLMDefaultConfig[e]={...this.LLMDefaultConfig[e],...t},JSON.stringify(this.LLMDefaultConfig[e])!==s&&(a=!0)}else{if(e)return;{const e={...this.LLMDefaultConfig};this.LLMDefaultConfig={...this.LLMDefaultConfig,...t},JSON.stringify(e)!==JSON.stringify(this.LLMDefaultConfig)&&(a=!0)}}a&&this._saveStrogeConfig()}getLLMDefaultConfig(e){if(!this.LLMDefaultConfig||"object"!=typeof this.LLMDefaultConfig)return{};let t;try{t=JSON.parse(JSON.stringify(this.LLMDefaultConfig))}catch(a){return{}}if(e&&e!==t.provider){const a=this.getDefaultModel(e);a&&(t.provider=e,t.base.model=a)}return t}getValidTools(e){if(!e||!Array.isArray(e))return[];const t=new Set;"object"==typeof this.llmTools&&null!==this.llmTools&&Object.values(this.llmTools).forEach(e=>{e&&"object"==typeof e&&Object.keys(e).forEach(e=>t.add(e))});const a=e.filter(e=>t.has(e));if(a.length<e.length){e.filter(e=>!t.has(e))}return a}getVerifiedLLMConfig(e){if(!e||"object"!=typeof e)return e;let t=JSON.parse(JSON.stringify(e));return this._mergeDefaultsRecursive(t,this.LLMDefaultConfig),t.toolCallSettings&&Array.isArray(t.toolCallSettings.tools)?t.toolCallSettings.tools=this.getValidTools(t.toolCallSettings.tools):t.toolCallSettings&&(t.toolCallSettings.tools=[]),t}async loadllmTools(){try{const e=await fetch("/api/openai/tools");if(!e.ok)throw new Error(`请求 LLM 工具失败: ${e.status} ${e.statusText}`);const t=await e.json();t&&t.data&&t.data.tools?this.llmTools=t.data.tools:this.llmTools=[]}catch(e){}}async loadonebotConfig(){try{const e=await fetch("/api/onebot/plugins");if(!e.ok)throw new Error(`请求 OneBot 配置失败: ${e.status} ${e.statusText}`);const t=await e.json();t&&t.data&&t.data.options?(this.onebotConfig=t.data.options,this._saveStrogeConfig()):this.onebotConfig=null}catch(e){}}},me=new class extends H{constructor(e){super(),this.inited=!1,this.id=null,this.code=null,this.isConnected=!1,this.contactList=[],this.socket=null,this.qq=null,this.bot_qq=null,this.avatar=null,this.onPhone=null,this.title="Mio",this.name="user",this.config=e,this.setLocalStorage=ne(this.setLocalStorage.bind(this),500)}async preInit(){const e=this.config.getBaseConfig();0===Object.keys(e).length?await this.loadOriginBaseInfo():(this.loadOriginBaseInfo(),this.loadBaseInfo(e));const t=await this.getLocalStorage();t&&this.loadLocalStorage(t),this.inited=!0,this.emit("loaded")}genDefaultConctor(e){if(e.onebot_enabled){const e={id:this.genFakeId(),name:"OneBot",namePolicy:1,avatarPolicy:1,avatar:`/p/qava?q=${this.bot_qq}`,title:"云崽",priority:0,options:{},lastUpdate:-Infinity};this.addConcator("onebot",e)}const t=this.config.getLLMDefaultConfig(),a=[];for(const i in this.config.llmTools)a.push(...Object.keys(this.config.llmTools[i]));t.toolCallSettings.tools=a;const s={id:this.genFakeId(),name:"MioBot",avatar:"/p/ava/miobot.png",namePolicy:1,avatarPolicy:1,title:"chat",priority:0,lastUpdate:-Infinity,options:t};this.addConcator("openai",s)}async addConcator(t,a){const s=new oe(t,a);s.loadName(),s.loadAvatar();return e(this.contactList).push(s),await this.setLocalStorage(),s}rmContactor(t){const a=e(this.contactList),s=a.findIndex(e=>e.id==t);-1!=s&&(a.splice(s,1),this.setLocalStorage())}async loadOriginalContactors(e){const t=`/api/share?id=${e}`;let a=null;try{const e=await fetch(t),s=await e.json();return 0==s.code&&(a=s.data.contactor,this.getContactor(a.id)||this.addConcator(a.platform,a),!0)}catch(s){return!1}}async shareContactor(e){const t=await this.setOriginalContactor(e);return t||null}async setOriginalContactor(e){const t={contactor:this.getContactor(e)};try{const e=await fetch("/api/share/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();if(0==a.code)return a.data}catch(a){return null}}async reset(){E.clear(),localStorage.clear();try{await this.resetCache()}catch(e){}return!0}async resetCache(){try{navigator.serviceWorker.controller&&await new Promise((e,t)=>{const a=new MessageChannel;a.port1.onmessage=a=>{"IDB_CACHE_CLEARED"===a.data.type?e():"IDB_CACHE_CLEAR_FAILED"===a.data.type?t(a.data.error):t(new Error("Unknown message from Service Worker"))},a.port1.onerror=e=>{t(e)},navigator.serviceWorker.controller.postMessage({type:"CLEAR_IDB_CACHE"},[a.port2])});const t=await navigator.serviceWorker.getRegistrations();if(t&&t.length>0)for(const a of t)try{await a.unregister()}catch(e){}return!0}catch(e){throw e}}everLogin(){return!!localStorage.getItem("everLogin")}setEverLogin(){localStorage.setItem("everLogin",!0)}async init(){await this.preInit(),this.everLogin()&&(this.isConnected=!1,this.login(this.code))}getContactors(){return this.contactList}getContactor(e,t=null){return t?this.contactList.find(e=>"onebot"==e.platform):this.contactList.find(t=>t.id==e)}genFakeId(){const e=Date.now().toString().slice(-6);return Math.floor(100*Math.random()).toString().padStart(4,"1")+e}async getLocalStorage(){const e=await E.getItem("client");if(e){return JSON.parse(e)}return this.id=this.genFakeId(),this.code=null,null}loadLocalStorage(e){this.id=e.id,this.code=e.code,e.contactList&&0!=e.contactList.length?this.contactList=e.contactList.map(e=>new oe(e.platform,e)):this.contactList=[]}async setLocalStorage(){const e={id:this.id,code:this.code,contactList:this.contactList};await E.setItem("client",JSON.stringify(e))}async login(e){return this.code=e,new Promise((e,t)=>{const a=new Y(this.id,this.code);a.on("connect",async t=>{this.isConnected=!0,this.socket=a,this.config.setLlmModels(t.models),this.addMsgListener(),0==this.contactList.length&&this.genDefaultConctor(t),this.setEverLogin(),this.setLocalStorage(),e(t)}),a.on("connect_error",e=>{this.isConnected=!1,t(e.message)}),a.connect()})}addMsgListener(){this.socket.on("onebot_message",e=>{const t=e.data,a=t.id,s=t.content,i=t.type;if("message"==i){const e=this.getContactor(a,1e4);e&&(e.revMessage(s),this.setLocalStorage())}else if("del_msg"==i){const e=this.contactList.filter(e=>"onebot"==e.platform);for(const t of e){if(t.delMessage(s.message_id)){this.setLocalStorage();break}}}}),this.socket.on("llm_message",e=>{const t=e.data,{metaData:a}=t;if(a.contactorId){const t=this.getContactor(a.contactorId);t&&t.handleLLMMessageEvent(e)}})}async logout(){this.isConnected=!1,this.socket.disconnect(),this.socket=null,this.setLocalStorage()}async loadOriginBaseInfo(){const e=await fetch("/api/base_info"),{data:t}=await e.json();return this.config.setBaseConfig(t),this.loadBaseInfo(t),t}loadBaseInfo(e){this.admin_qq=e.admin_qq,this.bot_qq=e.bot_qq,this.avatar=`/p/qava?q=${this.admin_qq}`;const t=this.getContactor(null,1e4);t&&(t.avatar=`/p/qava?q=${this.bot_qq}`)}async uploadFile(e,t={}){const{isImage:a=!1,onProgress:s=null}=t;if(a||"string"==typeof e&&e.startsWith("data:"))return this.uploadImage(e);const i=e;return new Promise((e,t)=>{const a=1048576;let o=null;const n=async(e,t,a)=>new Promise((n,l)=>{const r=new FormData;r.append("file",e),r.append("md5",o),r.append("chunkIndex",t),r.append("totalChunks",a),r.append("filename",i.name);const c=new XMLHttpRequest;c.open("POST","/api/upload/chunk",!0),s&&(c.upload.onprogress=e=>{if(e.lengthComputable){const i=e.loaded/e.total,o=100*(t/a+1/a*i);s(Math.round(o))}}),c.onload=()=>{c.status>=200&&c.status<300?n():l(c.statusText)},c.onerror=()=>{l("Network Error")},c.send(r)}),l=async()=>{if(!i||!o)return t({error:"Invalid file or missing hash"});const s=Math.ceil(i.size/a);try{for(let e=0;e<s;e++){const t=e*a,o=Math.min(t+a,i.size),l=i.slice(t,o);await n(l,e,s)}await(async a=>{try{const t=await fetch("/api/upload/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({totalChunks:a,md5:o,filename:i.name})});if(!t.ok)throw new Error(`HTTP error ${t.status}`);const s=await t.json();e(s)}catch(s){t({error:`Finalization error: ${s.message}`})}})(s)}catch(l){t({error:`Upload error: ${l}`})}},r=new re;r.postMessage({file:i,chunkSize:a}),r.onmessage=e=>{e.data.hash?(o=e.data.hash,l()):e.data.error&&(t({error:e.data.error}),r.terminate())},r.onerror=e=>{t({error:`Worker error: ${e.message}`}),r.terminate()}})}async uploadImage(e){try{const t=await fetch("/api/upload/image",{method:"POST",body:e});if(!t.ok)throw new Error(`HTTP error ${t.status}`);return await t.json()}catch(t){throw t}}async _convertBlobToBase64(e){return new Promise((t,a)=>{const s=new FileReader;s.onloadend=()=>t(s.result),s.onerror=a,s.readAsDataURL(e)})}}(he);me.init();const ge=(e,t)=>{const a=e.__vccOpts||e;for(const[s,i]of t)a[s]=i;return a},fe="chat",ve="profile",ye="settings",we="none",be={id:"sidebar"},Ce={class:"admin-avatar"},_e=["src"],Se={id:"side",class:"options"},ke={class:"up-half"},xe={class:"down-half"};const Le=ge({data:()=>({processedImage:"/p/qava?q=1099834705",activePage:we}),computed:{isChatActive(){return this.activePage===fe},isProfileActive(){return this.activePage===ve}},watch:{$route:{handler(e){this.activePage=this.getPageStatusFromRoute(e)},immediate:!0}},mounted(){this.activePage=this.getPageStatusFromRoute();const e=me.admin_qq;e?this.loadAvatar(e):me.on("loaded",()=>{const e=me.admin_qq;this.loadAvatar(e)},!1)},methods:{processImage:async e=>new Promise((t,a)=>{const s=document.createElement("canvas"),i=s.getContext("2d"),o=new Image;o.src=e,o.onload=()=>{s.width=o.width,s.height=o.height,i.drawImage(o,0,0);let e=.8*o.width,a=.86*o.height,n=5/24*o.width;i.beginPath(),i.arc(e,a,n,0,2*Math.PI,!0),i.clip(),i.clearRect(0,0,o.width,o.height),s.toBlob(e=>{const a=URL.createObjectURL(e);t(a)},"image/png")},o.onerror=e=>{a(e)}}),async toChat(){this.activePage=fe,this.$router.push({name:"blank"})},async toProfile(){this.activePage=ve,this.$router.push({name:"contactors"})},async toConfig(){this.activePage=ye,this.$router.push({name:"settings"})},async loadAvatar(e){const t=`/p/qava?q=${e}`;try{this.processedImage=await this.processImage(t)}catch(a){}},getPageStatusFromRoute(e=this.$route){return"/"===e.path||e.path.includes("/chat/")?fe:"/contactors"===e.path||e.path.includes("/profile/")?ve:"/settings"===e.path?ye:we}}},[["render",function(e,o,n,l,r,c){return i(),t("div",be,[a("div",Ce,[o[3]||(o[3]=a("div",{class:"status"},null,-1)),a("img",{src:r.processedImage,alt:"admin-avatar"},null,8,_e)]),a("div",Se,[a("div",ke,[a("div",{class:s(["icon-back",{active:c.isChatActive}])},[a("div",{id:"chatting",onClick:o[0]||(o[0]=(...e)=>c.toChat&&c.toChat(...e))},o[4]||(o[4]=[a("i",{class:"iconfont chat"},null,-1)]))],2),a("div",{class:s(["icon-back",{active:c.isProfileActive}])},[a("div",{id:"editing",onClick:o[1]||(o[1]=(...e)=>c.toProfile&&c.toProfile(...e))},o[5]||(o[5]=[a("i",{class:"iconfont user"},null,-1)]))],2)]),a("div",xe,[o[7]||(o[7]=a("a",{href:"https://github.com/Pretend-to/mio-chat-backend",target:"_blank",class:"side-icon"},[a("i",{class:"iconfont github"})],-1)),a("div",{class:"side-icon",onClick:o[2]||(o[2]=(...e)=>c.toConfig&&c.toConfig(...e))},o[6]||(o[6]=[a("i",{class:"iconfont menu"},null,-1)]))])])])}],["__scopeId","data-v-7a5175b8"]]);let Me=null;const Te=ge({props:{fullScreen:{type:Boolean,default:!1}},emits:["set-screen","close"],data:()=>({preview:!1,isTauri:!(!window.__TAURI__&&!window.__TAURI_INTERNALS__)}),created(){"true"===new URLSearchParams(window.location.search).get("preview")&&(this.preview=!0),this.isTauri&&(Me=new $("main"))},methods:{waiting(){this.$message?this.$message({message:"此功能尚未开放",type:"warning"}):alert("此功能尚未开放")},async getMainWindow(){try{return Me||null}catch(e){return null}},async minimizeWindow(){if(this.isTauri)if(Me)try{await Me.minimize()}catch(e){this.waiting()}else this.waiting();else this.$emit("close")},configFullScreen(e){this.isTauri?(async()=>{if(Me)try{e?await Me.maximize():await Me.unmaximize(),this.$emit("set-screen",e)}catch(t){this.waiting()}else this.waiting()})():this.$emit("set-screen",e)},async closeWindow(){if(this.isTauri)if(Me)try{await Me.close()}catch(e){this.waiting()}else this.waiting();else this.$emit("close")}}},[["render",function(e,o,n,l,r,c){return i(),t("ul",{class:s({"window-controls":!0,fullscreen:n.fullScreen,preview:r.preview}),"data-tauri-drag-region":"true"},[a("li",{class:"button","data-tauri-drag-region":"",onClick:o[0]||(o[0]=(...e)=>c.minimizeWindow&&c.minimizeWindow(...e))},o[4]||(o[4]=[a("span",{class:"window-min"},"—",-1)])),n.fullScreen?(i(),t("li",{key:0,class:"button","data-tauri-drag-region":"",onClick:o[1]||(o[1]=e=>c.configFullScreen(!1))},o[5]||(o[5]=[a("span",{class:"window-inmax"},[a("i",{class:"iconfont chuangkouhua"})],-1)]))):(i(),t("li",{key:1,class:"button","data-tauri-drag-region":"",onClick:o[2]||(o[2]=e=>c.configFullScreen(!0))},o[6]||(o[6]=[a("span",{class:"window-max"},"▢",-1)]))),a("li",{id:"close",class:"button","data-tauri-drag-region":"",onClick:o[3]||(o[3]=(...e)=>c.closeWindow&&c.closeWindow(...e))},o[7]||(o[7]=[a("span",{class:"window-close"},"×",-1)]))],2)}],["__scopeId","data-v-a5e279e7"]]),Ae={id:"forward-msg-body"},Oe={id:"forward-msg-foot"},Pe={class:"forward-msg-head"},Ie={class:"body"},Ee={key:0,id:"other",class:"message-body"},$e={class:"avatar"},Ve=["src","alt"],De={class:"msg"},Ue={class:"wholename"},Re={class:"title"},je={class:"name"};const Ne=ge({name:"ForwardMsg",components:{MdRenderer:P,displayButtons:Te},props:{messages:{type:Array,default:()=>[]},contactor:{type:Object,default:()=>{}}},data:()=>({showBox:!1,onPhone:!1,mioPlugins:[{plugin:I}]}),created(){this.onPhone=window.innerWidth<600,me.on("device-change",e=>{this.onPhone="mobile"==e},!1)}},[["render",function(e,p,h,m,g,f){const v=d("displayButtons"),y=d("MdRenderer"),w=d("ForwardMsg",!0);return i(),t(n,null,[a("div",{id:"forward-msg-preview",class:s(g.onPhone?"on-phone":""),onClick:p[0]||(p[0]=e=>g.showBox=!0)},[p[2]||(p[2]=a("div",{id:"forward-msg-head"},"转发的聊天消息",-1)),a("div",Ae,[(i(!0),t(n,null,l(h.messages.slice(0,2),(e,a)=>(i(),t("div",{id:"forward-msg-summary",key:a},r(h.contactor.name)+": "+r(h.contactor.getLastMessageSummary(e)),1))),128))]),a("div",Oe,"查看"+r(h.messages.length)+"条转发消息",1)],2),g.showBox?(i(),t("div",{key:0,id:"forward-msg-box",class:s(g.onPhone?"on-phone":"")},[a("div",Pe,[p[3]||(p[3]=a("div",{class:"forward-msg-title"},"转发的聊天消息",-1)),c(v,{class:"cfg-btns",onClose:p[1]||(p[1]=e=>g.showBox=!1)})]),a("div",Ie,[(i(!0),t(n,null,l(h.messages,(s,c)=>(i(),t("div",{key:c,class:"message-container"},["node"===s.type?(i(),t("div",Ee,[a("div",$e,[a("img",{src:`/p/qava/?q=${s.data.uin}`,alt:s.data.name},null,8,Ve)]),a("div",De,[a("div",Ue,[a("div",Re,r(h.contactor.title),1),a("div",je,r(s.data.name),1)]),(i(!0),t(n,null,l(s.data.content,(s,o)=>(i(),t("div",{key:o,class:"content"},[a("div",null,["text"===s.type?(i(),u(y,{key:0,md:s.data.text,theme:"github","markdown-it-options":{breaks:!0}},null,8,["md"])):"image"===e.element.type?(i(),u(y,{md:`![image](${e.element.data.file})`,key:e.element.data.file,"custom-plugins":g.mioPlugins,theme:"github"},null,8,["md","custom-plugins"])):"nodes"===s.type?(i(),u(w,{key:2,contactor:e.activeContactor,messages:s.data.messages},null,8,["contactor","messages"])):(i(),u(y,{key:3,md:`尚未支持的消息类型：${s.type}`},null,8,["md"]))])]))),128))])])):o("",!0)]))),128))])],2)):o("",!0)],64)}],["__scopeId","data-v-fc326327"]]),Be={class:"input-bar"},qe={class:"options"},Fe={class:"bu-emoji"},Ge={class:"bu-emoji"},Je={class:"ho-emoji"},ze={class:"bu-emoji"},He={class:"bu-emoji"},We={class:"bu-emoji"},Ke={class:"bu-emoji"},Ye={class:"input-box"},Xe={class:"input-content"};const Qe=ge({props:{activeContactor:{type:Object,required:!0}},emits:["toButtom","cleanHistory","cleanScreen","setModel","stroge"],data:()=>({selectedOption:null,cursorPosition:[],showemoji:!1,openaiModels:null,onebotPresets:[],host:"",uploaded:{files:[],images:[]},isPasting:!1}),computed:{extraOptions(){return"openai"==this.activeContactor.platform?this.openaiModels:this.onebotPresets}},watch:{"$route.params.id"(){this.loadSelected()}},created(){this.loadSelected(),this.debouncedAdjustHeight=ne(this.adjustTextareaHeight,100)},mounted(){this.textareaRef=this.$refs.textarea,this.textareaRef.addEventListener("input",this.debouncedAdjustHeight),this.handleDragOver=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#e0e0e0"},this.handleDragLeave=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1"},this.handleDrop=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1";const t=e.dataTransfer.files;t.length>0&&this.handleDroppedFile(t[0])},this.textareaRef.addEventListener("dragover",this.handleDragOver),this.textareaRef.addEventListener("dragleave",this.handleDragLeave),this.textareaRef.addEventListener("drop",this.handleDrop),this.textareaRef.addEventListener("paste",this.handlePaste),this.host=window.location.origin,this.onebotPresets=he.onebotConfig.textwraper.options},unmounted(){this.textareaRef.removeEventListener("input",this.adjustTextareaHeight),this.textareaRef.removeEventListener("dragover",this.handleDragOver),this.textareaRef.removeEventListener("dragleave",this.handleDragLeave),this.textareaRef.removeEventListener("drop",this.handleDrop),this.textareaRef.removeEventListener("paste",this.handlePaste),this.textareaRef=null},methods:{unsupportedTip(){this.$message.warning("功能暂未开放")},hasInput(){const e=this.textareaRef?.innerText.trim(),t=this.textareaRef?.querySelector("img");return e||t},handleDroppedFile(e){e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadFile(e)},textToHtml:e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/  /g,"&nbsp;&nbsp;").replace(/\n/g,"<br>"),insertHtmlAtCursor(e){const t=window.getSelection();if(!t||0===t.rangeCount)return this.textareaRef.innerHTML+=e,void this.setCursorToEnd(this.textareaRef);const a=t.getRangeAt(0);a.deleteContents();const s=document.createElement("div");s.innerHTML=e;const i=document.createDocumentFragment();for(;s.firstChild;)i.appendChild(s.firstChild);a.insertNode(i),a.collapse(!1),t.removeAllRanges(),t.addRange(a)},handlePaste(e){e.preventDefault();const t=e.clipboardData||window.clipboardData,a=t.items;let s="";const i=[];for(let o=0;o<a.length;o++){const e=a[o];-1!==e.type.indexOf("image")?i.push(e.getAsFile()):"text/plain"===e.type&&(s+=t.getData("text/plain"))}if(s){const e=this.textToHtml(s);this.insertHtmlAtCursor(e)}i.length&&(this.$message.info(`检测到 ${i.length} 张图片，正在处理...`),setTimeout(()=>{this.processImageQueue(i)},0))},getemoji(e){const t=e.detail.unicode;this.insertHtmlAtCursor(this.textToHtml(t)),this.ctrlEmojiPanel()},setCursorToEnd(e){e.focus();const t=window.getSelection(),a=document.createRange();a.selectNodeContents(e),a.collapse(!1),t.removeAllRanges(),t.addRange(a)},async processImageQueue(e){for(const t of e)await this.handleUploadImage(t),await new Promise(e=>setTimeout(e,0))},handleUploadImage(e){return new Promise(t=>{const a=5242880,s=new Image,i=URL.createObjectURL(e);s.src=i,s.onload=()=>{URL.revokeObjectURL(i);const o=e.type.toLowerCase();if("image/gif"===o){if(e.size>a)return this.$message.error("GIF 图片不能超过 5MB"),void t();const s=new FormData;return s.append("image",e,e.name),void me.uploadImage(s).then(t=>{const a=t.data.url;this.uploaded.images.push(a),this.insertImageToTextarea(a,e.name),this.$message.success("上传 GIF 成功")}).catch(()=>this.$message.error("上传 GIF 失败")).finally(t)}const n=document.createElement("canvas"),l=n.getContext("2d");let r,c;n.width=s.width,n.height=s.height,l.drawImage(s,0,0),"image/png"===o?r="image/png":"image/webp"===o?(r="image/webp",c=.7):(r="image/jpeg",c=.7),n.toBlob(s=>{if(!s)return this.$message.error("图片压缩失败"),void t();if(s.size>a)return this.$message.error("压缩后仍超过 5MB，请选小点的图片"),void t();const i=new FormData;i.append("image",s,e.name),me.uploadImage(i).then(t=>{const a=t.data.url;this.uploaded.images.push(a),this.insertImageToTextarea(a,e.name),this.$message.success("上传图片成功")}).catch(()=>this.$message.error("上传失败")).finally(t)},r,c)}})},ctrlEmojiPanel(){this.showemoji=!this.showemoji;this.textareaRef.focus()},uploadFile(e){if(e instanceof File)return void this.handleFileUpload(e);const t=document.createElement("input");t.type="file",t.accept=["docx","txt","pdf","pptx","xlsx","png","jpg","jpeg","webp"].map(e=>`.${e}`).join(",");const a=async e=>{t.removeEventListener("change",a);const s=e.target.files[0];s&&this.handleFileUpload(s)};t.addEventListener("change",a),t.click()},handleFileUpload(e){e.size>52428800?this.$message.error("文件大小超过50MB，无法上传"):(this.$message.info("文件上传中..."),e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadDocumentFile(e))},async uploadDocumentFile(e){try{const t=await me.uploadFile(e);this.$message.success("文件上传成功");const a=`${t.data.url}?size=${e.size}&name=${e.name}`,s=this.activeContactor.getBaseUserContainer();s.content.push({type:"file",data:{file:this.host+a}}),this.activeContactor.webSend(s,!1)}catch(t){this.$message.error("文件上传失败，请稍后再试")}this.$emit("stroge"),this.$emit("toButtom")},insertImageToTextarea(e,t){const a=document.createElement("img");a.src=e,a.alt=t,a.style.maxWidth="10rem",a.style.maxHeight="10rem";const s=document.createRange();s.selectNodeContents(this.textareaRef),s.collapse(!1);const i=window.getSelection();i.removeAllRanges(),i.addRange(s);const o=s.createContextualFragment(`<span>${a.outerHTML}</span>`);s.insertNode(o),setTimeout(()=>{const e=document.createRange();e.selectNodeContents(this.textareaRef),e.collapse(!1);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)},0)},initLLMExtraOptions(){const e=me.config.getLlmModels();this.openaiModels=Object.entries(e).map(([e,t])=>({value:e,label:e,children:t.map(e=>({value:e.owner,label:e.owner,children:e.models.map(e=>({value:e,label:e}))}))}))},getOpenaiModelArray:e=>[me.config.getModelOwner(e),e],wrapText(e){const t=this.getOnebotPreset();if(!this.selectedOption||!t)return e;return t.replace("{xxx}",e)},getOnebotPreset(){const e=this.onebotPresets.reduce((e=[],t)=>[...e,...t.children??[t]],[]).find(e=>e.value==this.selectedOption)?.preset;return e},loadSelected(){"onebot"===this.activeContactor.platform?this.activeContactor.preset&&(this.selectedOption=this.activeContactor.preset):(this.initLLMExtraOptions(),this.selectedOption=this.activeContactor.options.base.model)},adjustTextareaHeight(){const e=this.textareaRef;e.style.height="auto",e.style.height=e.scrollHeight+"px"},getWraperName(){const e=this.getOnebotPreset();return"onebot"===this.activeContactor.platform&&e&&this.selectedOption?e.replace("#","").replace("{xxx}",""):""},updateCursorPosition(){const e=window.getSelection();if(e&&e.rangeCount>0){const t=e.getRangeAt(0);this.cursorPosition[0]=t.startOffset,this.cursorPosition[1]=t.endOffset}},presend(){this.textareaRef.focus();const e=this.textareaRef.querySelectorAll("img"),t=Array.from(e).map(e=>e.src);let a=this.getSafeText(this.textareaRef.innerText);const s="onebot"===this.activeContactor.platform?this.wrapText(a):a;this.textareaRef.innerHTML="",this.adjustTextareaHeight();const i=this.activeContactor.getBaseUserContainer();return s.trim()&&i.content.push({type:"text",data:{text:s}}),t.forEach(e=>{i.content.unshift({type:"image",data:{file:e}})}),this.repliedMessageId&&i.content.push({type:"reply",data:{id:this.repliedMessageId}}),i},async send(){if(!this.hasInput())return;this.$emit("toButtom");const e=this.presend();try{const t=await this.activeContactor.webSend(e);e.id=t,this.$emit("stroge"),this.uploaded.images=[],this.uploaded.files=[]}catch(t){this.$message.error("发送消息失败")}},getSafeText:e=>e,cleanScreen(){this.$emit("cleanScreen")},currentChange(e,t){if(3===t.level){if(!t.parent||!t.parent.parent)return;const a=[t.parent.parent.data.value,t.parent.data.value,e.value];this.$message({message:"已切换到 "+a[2]+" 模型",type:"success"});const s=a[0];s!==this.activeContactor.options?.provider&&this.$message({message:"已切换到 "+s+" 协议",type:"success"}),this.$emit("setModel",a)}else 2===t.level&&"onebot"===this.activeContactor.platform&&this.getOnebotPreset()&&!this.getOnebotPreset().includes("xxx")&&this.send()},handleKeyDown(e){"Enter"===e.key&&(e.ctrlKey?this.hasInput()?this.send():this.$message({message:"不能发送空消息",type:"warning"}):document.execCommand("insertHTML",!1,"\n")),setTimeout(()=>{this.updateCursorPosition()},0)}}},[["render",function(e,s,o,n,l,u){const f=d("el-tree-select"),v=d("el-popconfirm");return i(),t("div",Be,[a("div",qe,[a("div",Fe,[p(a("emoji-picker",{ref:"emojiPicker",onEmojiClick:s[0]||(s[0]=(...e)=>u.getemoji&&u.getemoji(...e))},null,544),[[h,l.showemoji]]),s[10]||(s[10]=a("p",{class:"ho-emoji"},"表情",-1)),a("i",{class:"iconfont smile",onClick:s[1]||(s[1]=m((...e)=>u.ctrlEmojiPanel&&u.ctrlEmojiPanel(...e),["prevent"]))})]),a("div",Ge,[a("p",Je,r("openai"==o.activeContactor.platform?"模型选择":"工具选择"),1),c(f,{id:"wraper-selector",modelValue:l.selectedOption,"onUpdate:modelValue":s[2]||(s[2]=e=>l.selectedOption=e),data:u.extraOptions,accordion:"",placement:"top-start",onNodeClick:u.currentChange},null,8,["modelValue","data","onNodeClick"]),s[11]||(s[11]=a("i",{class:"iconfont robot"},null,-1))]),a("div",ze,[s[12]||(s[12]=a("p",{class:"ho-emoji"},"重置人格",-1)),a("i",{class:"iconfont reset",onClick:s[3]||(s[3]=t=>e.$emit("cleanHistory"))})]),a("div",He,[s[13]||(s[13]=a("p",{class:"ho-emoji"},"上传",-1)),a("i",{class:"iconfont upload",onClick:s[4]||(s[4]=(...e)=>u.uploadFile&&u.uploadFile(...e))})]),a("div",We,[s[15]||(s[15]=a("p",{class:"ho-emoji"},"清除记录",-1)),c(v,{class:"box-item",title:"此操作不可撤销","confirm-button-text":"确定","cancel-button-text":"取消",placement:"top",onConfirm:s[5]||(s[5]=t=>e.$emit("cleanScreen"))},{reference:g(()=>s[14]||(s[14]=[a("i",{class:"iconfont shanchu"},null,-1)])),_:1})]),a("div",Ke,[s[16]||(s[16]=a("p",{class:"ho-emoji"},"更多",-1)),a("i",{class:"iconfont more",onClick:s[6]||(s[6]=(...e)=>u.unsupportedTip&&u.unsupportedTip(...e))})])]),a("div",Ye,[a("div",Xe,[a("div",{ref:"textarea",class:"input-area",contenteditable:"true",onKeydown:s[7]||(s[7]=(...e)=>u.handleKeyDown&&u.handleKeyDown(...e)),onClick:s[8]||(s[8]=(...e)=>u.updateCursorPosition&&u.updateCursorPosition(...e))},null,544)]),a("button",{id:"sendButton",onClick:s[9]||(s[9]=m((...e)=>u.send&&u.send(...e),["prevent"]))}," 发送"+r(u.getWraperName()?` | ${u.getWraperName()}`:""),1)])])}],["__scopeId","data-v-1b641cbc"]]),Ze={class:"file-block"},et={class:"file-block-icon"},tt={key:0},at={class:"file-block-text"},st=["title"],it={class:"file-info"};const ot=ge({props:{fileUrl:{type:String,required:!0}},data:()=>({file_name:"",file_type:"",formated_file_size:""}),computed:{iconClass(){const e=this.file_type.toLowerCase();return"pdf"===e?"file-icon-pdf":["xls","xlsx","csv"].includes(e)?"file-icon-spreadsheet":["doc","docx"].includes(e)?"file-icon-word":["ppt","pptx"].includes(e)?"file-icon-ppt":"file-icon-other"}},created(){const e=this.fileUrl.split("?"),t=new URLSearchParams(e[1]),a=t.get("size");this.file_name=t.get("name"),this.formated_file_size=this.formatFileSize(a);const s=e[0].split(".");this.file_type=s[s.length-1]},methods:{formatFileSize(e){let t=0;for(;e>=1024;)e/=1024,t++;return e.toFixed(2)+" "+["B","KB","MB"][t]}}},[["render",function(e,n,l,c,d,u){return i(),t("div",Ze,[a("div",et,[a("div",{class:s(["file-icon",u.iconClass])},[d.file_type?(i(),t("span",tt,r(d.file_type.toUpperCase()),1)):o("",!0)],2)]),a("div",at,[a("div",{class:"file-name",title:d.file_name},r(d.file_name),9,st),a("div",it,r(d.file_type.toUpperCase())+", "+r(d.formated_file_size),1)])])}],["__scopeId","data-v-f2fa73bf"]]),nt={class:"tool-call-bar"},lt={class:"status-icon"},rt={key:0,class:"call-success-icon"},ct={key:1,class:"call-fail-icon"},dt={key:2,class:"call-pend-icon"},ut={class:"tool-info"},pt={class:"tool-name"},ht={class:"tool-status"},mt={class:"extra-info"},gt={class:"extra-detail"},ft={class:"detail-params"},vt={class:"detail-title"},yt={class:"detail-content"},wt={class:"detail-result"},bt={class:"detail-title"},Ct={class:"detail-content"};const _t=ge({props:{toolCall:{type:Object,required:!0}},data:()=>({showExtraInfo:!1,teleportStyle:{},openUp:!1}),computed:{toolCallSuccess(){return"finished"===this.toolCall.action&&!this.toolCall?.result?.error},toolCallFail(){return"finished"===this.toolCall.action&&this.toolCall?.result?.error},call_status(){return"started"==this.toolCall.action?"开始运行":"pending"==this.toolCall.action?"函数构建中":"running"==this.toolCall.action?"函数运行中":this.toolCallSuccess?"函数运行成功":this.toolCallFail?"函数运行失败":"未知状态"}},mounted(){},methods:{async copyToClipboard(e){try{await navigator.clipboard.writeText(e),this.$message&&this.$message({message:"已复制到剪贴板",type:"success"})}catch(t){this.$message&&this.$message({message:"复制失败",type:"error"})}},copyParameters(){const e=this.toolCall.parameters,t="string"==typeof e?e:JSON.stringify(e,null,2);this.copyToClipboard(t)},copyResult(){const e=this.toolCall.result,t="string"==typeof e?e:JSON.stringify(e,null,2);this.copyToClipboard(t)},toggleExtraInfo(e){this.showExtraInfo=!this.showExtraInfo,this.showExtraInfo?(this.positionTeleport(),window.addEventListener("resize",this.positionTeleport),document.addEventListener("click",this.onDocClick)):(window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick))},onDocClick(e){const t=this.$el,a=this.$refs.teleportContent;t&&!t.contains(e.target)&&a&&!a.contains(e.target)&&(this.showExtraInfo=!1,window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick))},positionTeleport(){const e=this.$el;if(!e)return;const t=e.getBoundingClientRect(),a=Math.max(8,t.left),s=t.bottom+8;this.teleportStyle={position:"fixed",top:s+"px",left:a+"px",minWidth:t.width+"px",zIndex:1e4},this.$nextTick(()=>{const e=this.$refs.teleportContent;if(!e)return;const i=e.getBoundingClientRect(),o=i.height,n=i.width;let l=a;if(l+n+8>window.innerWidth&&(l=Math.max(8,window.innerWidth-n-8)),t.bottom+o+12>window.innerHeight){const e=t.top-o-8;this.openUp=!0,this.teleportStyle={position:"fixed",top:e+"px",left:l+"px",minWidth:t.width+"px",zIndex:1e4}}else this.openUp=!1,this.teleportStyle={position:"fixed",top:s+"px",left:l+"px",minWidth:t.width+"px",zIndex:1e4}})}},beforeUnmount(){window.removeEventListener("resize",this.positionTeleport),document.removeEventListener("click",this.onDocClick)}},[["render",function(e,n,l,c,d,p){return i(),t("div",nt,[a("div",lt,[p.toolCallSuccess?(i(),t("span",rt,n[4]||(n[4]=[a("div",{class:"checkmark-container"},[a("svg",{class:"checkmark",viewBox:"0 0 52 36",xmlns:"http://www.w3.org/2000/svg"},[a("polyline",{points:"1 20 15 36 51 1"})])],-1)]))):p.toolCallFail?(i(),t("span",ct,"❌")):(i(),t("span",dt))]),a("div",ut,[a("div",null,[a("span",pt,r(l.toolCall.name.split("_mid_")[0]),1)]),a("div",ht,r(p.call_status),1)]),a("div",mt,[a("button",{ref:"show-extra-info",class:s({active:d.showExtraInfo,"extra-info-button":!0}),onClick:n[0]||(n[0]=(...e)=>p.toggleExtraInfo&&p.toggleExtraInfo(...e))},n[5]||(n[5]=[a("svg",{t:"1731677922196",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5948",width:"16",height:"16"},[a("path",{d:"M778.965749 128.759549l-383.064442 383.063419 388.097062 388.096039-0.070608 0.033769c12.709463 13.137205 20.529569 31.024597 20.529569 50.731428 0 40.376593-32.736589 73.112158-73.115228 73.112158-19.705807 0-37.591153-7.819083-50.730405-20.528546l-0.034792 0.035816L241.890654 564.622498l0.035816-0.035816c-13.779841-13.281491-22.3838-31.915897-22.3838-52.585659 0-0.071631 0-0.106424 0-0.178055 0-0.072655 0-0.10847 0-0.144286 0-20.669762 8.603959-39.341007 22.3838-52.622498l-0.035816-0.034792L680.573835 20.337187l0.180102 0.179079c13.139252-12.5662 30.950919-20.313651 50.587142-20.313651 40.378639 0 73.115228 32.736589 73.115228 73.114205C804.455283 95.485725 794.567076 115.334795 778.965749 128.759549z","p-id":"5949"})],-1)]),2)]),(i(),u(v,{to:"body"},[d.showExtraInfo?(i(),t("div",{key:0,ref:"teleportContent",class:s(["extra-info-bar",{active:d.showExtraInfo,upward:d.openUp}]),style:f(d.teleportStyle),onClick:n[3]||(n[3]=m(()=>{},["stop"]))},[a("div",gt,[a("div",ft,[a("div",vt,[n[7]||(n[7]=a("span",null,"参数",-1)),a("button",{class:"copy-btn",onClick:n[1]||(n[1]=(...e)=>p.copyParameters&&p.copyParameters(...e)),title:"复制参数"},n[6]||(n[6]=[a("i",{class:"iconfont fuzhi",title:"复制参数"},null,-1)]))]),a("div",yt,r(l.toolCall.parameters),1)]),a("div",wt,[a("div",bt,[n[9]||(n[9]=a("span",null,"返回值",-1)),a("button",{class:"copy-btn",onClick:n[2]||(n[2]=(...e)=>p.copyResult&&p.copyResult(...e)),title:"复制返回值"},n[8]||(n[8]=[a("i",{class:"iconfont fuzhi",title:"复制返回值"},null,-1)]))]),a("div",Ct,r(l.toolCall.result),1)])])],6)):o("",!0)]))])}],["__scopeId","data-v-40160f25"]]),St={class:"reason-block"},kt={class:"head-bar"},xt={class:"reason-info"};const Lt=ge({props:{content:{required:!0,type:String,default:""},startTime:{required:!0,type:Number},endTime:{required:!1,type:Number,default:0}},data:()=>({show:!0,maxHeight:"auto"}),computed:{getReasonInfo(){if(this.endTime){return`已深度思考（耗时 ${((this.endTime-this.startTime)/1e3).toFixed(2)} 秒）`}return"正在深度思考......"}},mounted(){this.updateMaxHeight()},updated(){this.updateMaxHeight()},methods:{toggleShow(){this.show=!this.show,this.updateMaxHeight()},updateMaxHeight(){this.show?this.maxHeight=this.$refs.reasonContent.scrollHeight+20+"px":this.maxHeight="0px"}}},[["render",function(e,o,n,l,c,d){return i(),t("div",St,[a("div",kt,[a("div",xt,r(d.getReasonInfo),1),a("button",{class:s({active:c.show,"extra-info-button":!0}),onClick:o[0]||(o[0]=(...e)=>d.toggleShow&&d.toggleShow(...e))},o[1]||(o[1]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)]),a("div",{ref:"reasonContent",class:"reason-content",style:f({"max-height":c.maxHeight})},r(n.content),5)])}],["__scopeId","data-v-81bd691d"]]);const Mt=ge({name:"MessageMenu",props:{type:{type:String,default:"message"},message:{type:Object,default:()=>({})},seletedText:{type:String,default:""},seletedImage:{type:String,default:""}},data:()=>({isUp:!1}),emits:["close","message-option"],methods:{updateArrow(){const e=this.$el;if(!e)return;const t=e.style&&e.style.bottom&&""!==e.style.bottom;this.isUp=!!t},onWindowResize(){this.updateArrow()},async copySeletedImage(){this.$emit("close");try{await this.copyImageToClipboard(this.seletedImage)}catch(e){}},async saveSeletedImage(){this.$emit("close");try{await this.downloadImage(this.seletedImage)}catch(e){}},copyText(){let e="";this.message.content.forEach(t=>{"text"===t.type?e+=t.data.text:"image"===t.type&&(e+=`\n![图片](${t.data.file})`)}),this.copyTextToClipboard(e),this.$emit("close")},copySeletedText(){this.copyTextToClipboard(this.seletedText),this.$emit("close")},retryMessage(){this.$emit("message-option","retry"),this.$emit("close")},replyMessage(){this.$emit("message-option","reply"),this.$emit("close")},deleteMessage(){this.$emit("message-option","delete"),this.$emit("close")},enterChat(){this.$emit("message-option","enter"),this.$emit("close")},togglePriority(){this.$emit("message-option","priority"),this.$emit("close")},shareBot(){this.$emit("message-option","share"),this.$emit("close")},deleteBot(){this.$emit("message-option","delete"),this.$emit("close")},async copyTextToClipboard(e){let t;try{t=document.createElement("textarea"),t.style.position="absolute",t.style.left="-9999px",t.value=e,document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),await document.execCommand("copy"),this.$message({message:"复制成功",type:"success"})}catch(a){this.$message({message:"复制失败",type:"error"})}finally{document.body.removeChild(t)}},async copyImageToClipboard(e){try{const t=await fetch(e);if(!t.ok)throw new Error("网络错误，无法获取图片");const a=await t.blob(),s=new Image,i=URL.createObjectURL(a);s.onload=async()=>{const e=document.createElement("canvas");e.width=s.width,e.height=s.height;e.getContext("2d").drawImage(s,0,0);const t=await new Promise(t=>{e.toBlob(t,"image/png")});if(t){const e=new ClipboardItem({"image/png":t});await navigator.clipboard.write([e]),this.$message({message:"图片已复制到剪贴板",type:"success"})}else this.$message({message:"转换为 PNG 失败",type:"error"});URL.revokeObjectURL(i)},s.onerror=()=>{this.$message({message:"加载图片失败",type:"error"}),URL.revokeObjectURL(i)},s.src=i}catch(t){this.$message({message:"复制图片失败",type:"error"})}},async downloadImage(e){try{const t=document.createElement("a");t.href=e,t.download="image.png",t.click()}catch(t){this.$message({message:"保存图片失败",type:"error"})}}},mounted(){this.$nextTick(()=>{this.updateArrow()}),window.addEventListener("resize",this.onWindowResize)},updated(){this.$nextTick(()=>{this.updateArrow()})},beforeUnmount(){window.removeEventListener("resize",this.onWindowResize)}},[["render",function(e,l,c,d,u,p){return i(),t("div",{id:"message-menu",class:s({"expand-up":u.isUp,"expand-down":!u.isUp})},["friend"===c.type?(i(),t(n,{key:0},[a("div",{onClick:l[0]||(l[0]=m((...e)=>p.enterChat&&p.enterChat(...e),["stop"]))},l[11]||(l[11]=[a("i",{class:"iconfont chat"},null,-1),a("span",null,"进入对话",-1)])),a("div",{onClick:l[1]||(l[1]=m((...e)=>p.togglePriority&&p.togglePriority(...e),["stop"]))},[l[12]||(l[12]=a("i",{class:"iconfont star"},null,-1)),a("span",null,r(0===c.message.priority?"取消置顶":"置顶"),1)]),a("div",{onClick:l[2]||(l[2]=m((...e)=>p.shareBot&&p.shareBot(...e),["stop"]))},l[13]||(l[13]=[a("i",{class:"iconfont icon-share"},null,-1),a("span",null,"分享",-1)])),a("div",{onClick:l[3]||(l[3]=m((...e)=>p.deleteBot&&p.deleteBot(...e),["stop"]))},l[14]||(l[14]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除",-1)]))],64)):(i(),t(n,{key:1},[c.seletedText?(i(),t("div",{key:0,onClick:l[4]||(l[4]=m((...e)=>p.copySeletedText&&p.copySeletedText(...e),["stop"]))},l[15]||(l[15]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制选中",-1)]))):o("",!0),a("div",{onClick:l[5]||(l[5]=m((...e)=>p.copyText&&p.copyText(...e),["stop"]))},l[16]||(l[16]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制消息",-1)])),c.seletedImage?(i(),t("div",{key:1,onClick:l[6]||(l[6]=m((...e)=>p.copySeletedImage&&p.copySeletedImage(...e),["stop"]))},l[17]||(l[17]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制图片",-1)]))):o("",!0),c.seletedImage?(i(),t("div",{key:2,onClick:l[7]||(l[7]=m((...e)=>p.saveSeletedImage&&p.saveSeletedImage(...e),["stop"]))},l[18]||(l[18]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"保存图片",-1)]))):o("",!0),a("div",{onClick:l[8]||(l[8]=m((...e)=>p.retryMessage&&p.retryMessage(...e),["stop"]))},l[19]||(l[19]=[a("i",{class:"iconfont reset"},null,-1),a("span",null,"重试消息",-1)])),a("div",{onClick:l[9]||(l[9]=m((...e)=>p.replyMessage&&p.replyMessage(...e),["stop"]))},l[20]||(l[20]=[a("i",{class:"iconfont yinyong"},null,-1),a("span",null,"引用消息",-1)])),a("div",{onClick:l[10]||(l[10]=m((...e)=>p.deleteMessage&&p.deleteMessage(...e),["stop"]))},l[21]||(l[21]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除消息",-1)]))],64))],2)}],["__scopeId","data-v-35b3fda4"]]),Tt={class:"add-contactor-body"},At={class:"tabs"},Ot=["onClick"],Pt={class:"tab-content"},It={class:"adapters-view"},Et={class:"search"},$t=["src"],Vt={class:"adapter-info"},Dt={class:"adapter-header"},Ut={class:"adapter-name"},Rt={class:"adapter-desc"},jt={class:"presets-view"},Nt={class:"search"},Bt={class:"info"},qt={class:"presets-types"},Ft=["onClick"],Gt={key:0,class:"preset-avatar custom"},Jt=["src"],zt={key:1,class:"preset-avatar model"},Ht=["src"],Wt={key:2,class:"preset-avatar"},Kt={class:"preset-info"},Yt={class:"preset-name"},Xt=["title"],Qt={key:0,class:"loading"},Zt={key:1,class:"empty-list"},ea={class:"share-code-view"},ta={class:"share-input-container"},aa={__name:"AddContactor",props:{show:{type:Boolean,default:!1}},emits:["addBot","close","add-by-provider","add-by-share-code","update:show"],setup(e,{emit:m}){const v=m,k=C(),x=["推荐","最近","本地","系统"],L=["适配器","预设","分享码"],M=y(0),T=y(""),A=y(""),O=y([]),P=y([]),I=y([]),E=y([]),$=y([]),R=y(0),j=y(0),N=y(""),B=y(0),q=y("4px"),F=y(!0),G=y(!0),J=w(()=>3===B.value?F.value:0===B.value&&G.value),z=w(()=>N.value?$.value:2===B.value?I.value:1===B.value?P.value:0===B.value?O.value:3===B.value?E.value:[]),H=w(()=>he.getLLMProviders()),W=w(()=>{if(!T.value.trim())return H.value;const e=T.value.toLowerCase();return H.value.filter(t=>t.value.toLowerCase().includes(e)||t.label.toLowerCase().includes(e)||t.adapterType.toLowerCase().includes(e))}),K=()=>{v("close")},Y=e=>({openai:"OpenAI GPT 系列模型",gemini:"Google Gemini 模型",vertex:"Google Vertex AI 平台",onebot:"OneBot 协议 (QQ, etc.)"}[e]||"大语言模型适配器"),X=e=>({openai:"primary",gemini:"success",vertex:"warning",onebot:"info"}[e]||"info"),Q=e=>({openai:"#f0f9ff",gemini:"#f0f7ff",vertex:"#fffbeb",onebot:"#f0f4ff"}[e]||"#f5f5f5"),Z=()=>{if(!A.value.trim())return void U.warning("请输入分享码");const e=A.value.trim();if(/^\d+$/.test(e))return k.push(`/s/${e}`),void K();try{const t=new URL(e),a=window.location.host;if(t.host===a){return t.pathname.match(/^\/s\/(\d+)$/)?(k.push(t.pathname),void K()):void U.error("链接格式不正确，应为 /s/数字")}return void U.error("链接域名与当前网站不一致")}catch(t){return void U.error("请输入有效的分享码或分享链接")}},ee=e=>{const t=P.value.find(t=>t.name===e.name);t&&P.value.splice(P.value.indexOf(t),1),P.value.unshift(e),P.value.length>20&&P.value.pop(),localStorage.setItem("recent-presets",JSON.stringify(P.value))},te=async()=>{if(N.value){B.value=-1;const e=await fetch(`/api/openai/presets?type=search&keyword=${N.value}`).then(e=>e.json());$.value=e.data||[]}else B.value=0,ie(0)},se=async()=>{if(3===B.value&&0===E.value.length){const e=await fetch(`/api/openai/presets?type=system&start=${R.value}`).then(e=>e.json());E.value=e.data||[],R.value+=E.value.length,(!e.data||e.data.length<9)&&(F.value=!1)}else if(0===B.value&&0===O.value.length){const e=await fetch(`/api/openai/presets?type=recommended&start=${j.value}`).then(e=>e.json());O.value=e.data||[],j.value+=O.value.length,(!e.data||e.data.length<9)&&(G.value=!1)}},ie=e=>{B.value=e,q.value=`calc(${25*e}% + 4px)`,se()},ne=({scrollTop:e,scrollLeft:t})=>{const a=document.querySelector(".presets-list .el-scrollbar__wrap");if(!a||!J.value)return;a.scrollHeight-e-a.clientHeight<10&&(async()=>{if(3===B.value&&F.value){const e=(await fetch(`/api/openai/presets?type=system&start=${R.value}`).then(e=>e.json())).data||[];e.length>0?(E.value=[...E.value,...e],R.value+=e.length):F.value=!1}else if(0===B.value&&G.value){const e=(await fetch(`/api/openai/presets?type=recommended&start=${j.value}`).then(e=>e.json())).data||[];e.length>0?(O.value=[...O.value,...e],j.value+=e.length):G.value=!1}})()};return b(async()=>{(()=>{const e=localStorage.getItem("recent-presets");e&&(P.value=JSON.parse(e));const t=localStorage.getItem("local-presets");t&&(I.value=JSON.parse(t))})(),await se()}),(m,y)=>{const w=d("el-input"),b=d("el-tag"),C=d("el-button"),k=d("el-empty"),O=d("el-scrollbar"),P=d("el-icon"),I=d("el-dialog");return i(),u(I,{"model-value":e.show,title:"添加机器人",width:"500px",class:"add-contactor-dialog","onUpdate:modelValue":y[3]||(y[3]=e=>m.$emit("update:show",e)),onClose:y[4]||(y[4]=e=>m.$emit("close"))},{default:g(()=>[a("div",Tt,[a("div",At,[(i(),t(n,null,l(L,(e,t)=>a("div",{key:t,class:s(["tab-item",{active:M.value===t}]),onClick:e=>M.value=t},r(e),11,Ot)),64))]),a("div",Pt,[p(a("div",It,[a("div",Et,[c(w,{modelValue:T.value,"onUpdate:modelValue":y[0]||(y[0]=e=>T.value=e),placeholder:"搜索适配器...","prefix-icon":_(V),clearable:""},null,8,["modelValue","prefix-icon"])]),c(O,{class:"adapters-list"},{default:g(()=>[(i(!0),t(n,null,l(W.value,(e,s)=>(i(),t("div",{key:s,class:"adapter-item"},[a("div",{class:"adapter-icon",style:f({backgroundColor:Q(e.adapterType)})},[a("img",{src:_(ae)(e.adapterType),class:"adapter-icon-img"},null,8,$t)],4),a("div",Vt,[a("div",Dt,[c(b,{size:"small",type:X(e.adapterType),effect:"plain",round:""},{default:g(()=>[S(r(e.adapterType),1)]),_:2},1032,["type"]),a("div",Ut,r(e.label),1)]),a("div",Rt,r(Y(e.adapterType)),1)]),c(C,{type:"primary",size:"small",onClick:t=>(e=>{v("add-by-provider",e.value),U.success(`正在创建 ${e.label} Bot...`),K()})(e)},{default:g(()=>y[5]||(y[5]=[S("添加")])),_:2},1032,["onClick"])]))),128)),0===W.value.length?(i(),u(k,{key:0,description:"未找到相关适配器"})):o("",!0)]),_:1})],512),[[h,0===M.value]]),p(a("div",jt,[a("div",Nt,[c(w,{modelValue:N.value,"onUpdate:modelValue":y[1]||(y[1]=e=>N.value=e),placeholder:"输入搜索关键词","prefix-icon":_(V),clearable:"",onInput:te},null,8,["modelValue","prefix-icon"])]),a("div",Bt,[a("header",qt,[a("div",{style:f({left:q.value}),class:"slide-button"},null,4),(i(),t(n,null,l(x,(e,t)=>a("nav",{key:t,class:s(B.value===t?"active":""),onClick:e=>ie(t)},r(e),11,Ft)),64))]),z.value.length>0||[0,3].includes(B.value)?(i(),u(O,{key:0,class:"presets-list",onScroll:ne},{default:g(()=>[(i(!0),t(n,null,l(z.value,(e,s)=>(i(),t("div",{key:s,class:"presets-item"},[e.avatar?(i(),t("div",Gt,[a("img",{src:e.avatar},null,8,Jt)])):e.model?(i(),t("div",zt,[a("img",{src:_(oe).getAvatarByModel(e.model)},null,8,Ht)])):(i(),t("div",Wt,r(e.name.slice(0,2)),1)),a("div",Kt,[a("div",Yt,r(e.name),1),a("div",{title:e.opening,class:"preset-description"},r(e.opening),9,Xt)]),c(C,{onClick:t=>(e=>{ee(e),v("addBot",e),U.success("添加成功")})(e)},{default:g(()=>y[6]||(y[6]=[S("添加")])),_:2},1032,["onClick"])]))),128)),J.value?(i(),t("div",Qt,[c(P,{class:"is-loading"},{default:g(()=>[c(_(D))]),_:1}),y[7]||(y[7]=a("span",{style:{"margin-left":"8px"}},"加载中...",-1))])):o("",!0)]),_:1})):(i(),t("div",Zt,[c(k,{"image-size":120})]))])],512),[[h,1===M.value]]),p(a("div",ea,[a("div",ta,[y[9]||(y[9]=a("div",{class:"input-label"},"输入分享码或分享链接",-1)),c(w,{modelValue:A.value,"onUpdate:modelValue":y[2]||(y[2]=e=>A.value=e),placeholder:"粘贴分享码或链接...",clearable:"",class:"share-input"},null,8,["modelValue"]),c(C,{type:"primary",disabled:!A.value.trim(),onClick:Z,style:{width:"100%","margin-top":"16px"}},{default:g(()=>y[8]||(y[8]=[S(" 加载 Bot ")])),_:1},8,["disabled"])])],512),[[h,2===M.value]])])])]),_:1},8,["model-value"])}}},sa={id:"friendlists",ref:"friendlists"},ia={id:"friends",class:"upsidebar"},oa={class:"bu-add"},na={class:"people"},la=["id","onClick","onContextmenu"],ra=["src","alt"],ca={class:"info"},da={class:"name"},ua={id:"time",class:"msginfo"},pa={id:"msgctt",class:"msginfo"};const ha=ge({components:{AddContactor:ge(aa,[["__scopeId","data-v-4b9e8c89"]]),ContextMenu:Mt},data:()=>({contactorList:[],showAddWindow:!1,showMenu:!1,menuX:0,menuY:0,selectedFriend:null}),computed:{sortedList(){return[...this.contactorList].sort((e,t)=>t.priority<e.priority?1:t.lastUpdate-e.lastUpdate)},avaliableProvideres:()=>he.getLLMProviders().map(e=>e.value)},created(){0==me.getContactors().length?me.on("loaded",()=>{this.contactorList=me.getContactors(),this.addReactiveListener()},!1):(this.contactorList=me.getContactors(),this.addReactiveListener())},methods:{genBotByShareCode(){this.showAddWindow=!1,this.$emit("open-share-code-window")},openAddWindow(){this.showAddWindow=!0},showChat(e){"blank"==this.$route.name||"chat_view"==this.$route.name?this.$router.push({name:"chat_view",params:{id:e}}):"contactors"==this.$route.name||"profile_view"==this.$route.name?this.$router.push({name:"profile_view",params:{id:e}}):this.$router.replace({name:"chat_view",params:{id:e}})},getId(e){return this.$route.params.id==e.id?"active":0==e.priority?"important":""},async genBotByProvider(e){const t=he.getLLMDefaultConfig(e),a={id:this.genFakeId(),title:t.default_model,avatarPolicy:0,namePolicy:2,priority:1,options:t};await me.addConcator("openai",a),this.addReactiveListener()},startResize(e){this.isResizing=!0,this.startX=e.clientX,this.startWidth=this.$refs.friendlists.offsetWidth,document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.stopResize)},resize(e){if(this.isResizing){let t=this.startWidth+(e.clientX-this.startX);const a=document.documentElement.style.fontSize?parseFloat(document.documentElement.style.fontSize):16,s=20*a,i=12*a;t=t>s?s:t<i?i:t,this.$refs.friendlists.style.minWidth=t+"px",this.$refs.friendlists.style.maxWidth=t+"px"}},stopResize(){this.isResizing=!1,document.removeEventListener("mousemove",this.resize),document.removeEventListener("mouseup",this.stopResize)},genFakeId:()=>me.genFakeId(),mergeOptions(e){const t=he.getLLMDefaultConfig();if(e.history&&(t.presetSettings.history=e.history),e.tools?.length>0&&(t.toolCallSettings.tools=he.getValidTools(e.tools)),e.opening&&(t.presetSettings.opening=e.opening),e.model){const a=he.getLLMProviders().map(e=>e.value).find(t=>he.isModelAvailable(t,e.model));a?(t.provider=a,t.base.model=e.model):(t.base.model=e.model,this.$message({message:"预设模型不存在, 已使用默认模型",type:"error"}))}return t},async addPresetContactor(e){const t={id:this.genFakeId(),namePolicy:1,avatarPolicy:e.avatar?1:0,avatar:e.avatar?e.avatar:void 0,name:e.name,title:e.title,priority:1,options:this.mergeOptions(e)};await me.addConcator("openai",t),this.addReactiveListener()},showFriendContextMenu(e,t){this.selectedFriend=t,this.menuX=e.clientX,this.menuY=e.clientY,this.showMenu=!0;const a=()=>{this.showMenu=!1,document.removeEventListener("click",a)};document.addEventListener("click",a)},async handleFriendOption(e){switch(e){case"enter":this.showChat(this.selectedFriend.id);break;case"priority":this.selectedFriend.priority=0===this.selectedFriend.priority?1:0,me.setLocalStorage();break;case"share":{const e=await me.shareContactor(this.selectedFriend.id);if(e&&e.shareUrl){const{shareUrl:t}=e,{success:a,message:s}=le(t);a?this.$message({message:s,type:"success"}):this.$message({message:s,type:"error"})}break}case"delete":{let e;e=this.contactorList.findIndex(e=>e.id===this.selectedFriend.id),-1!==e&&(this.contactorList.splice(e,1),me.setLocalStorage());break}}this.showMenu=!1},addReactiveListener(){this.contactorList.map(e=>{e.on("updateMessageSummary",()=>{e.lastMessageSummary=e.getLastMessageSummary(),this.$forceUpdate()})})}}},[["render",function(e,p,h,g,v,y){const w=d("AddContactor"),b=d("ContextMenu");return i(),t("div",sa,[a("div",ia,[p[6]||(p[6]=a("div",{class:"search"},[a("i",{class:"iconfont sousuo listicon"}),a("input",{id:"main-search",type:"text",placeholder:"搜索"})],-1)),a("div",oa,[a("button",{id:"addcont",title:"Add Bot",onClick:p[0]||(p[0]=(...e)=>y.openAddWindow&&y.openAddWindow(...e))},p[5]||(p[5]=[a("i",{class:"iconfont add"},null,-1)]))])]),a("div",na,[(i(!0),t(n,null,l(y.sortedList,(e,o)=>(i(),t("div",{id:y.getId(e),key:o,class:"lists",onClick:t=>y.showChat(e.id),onContextmenu:m(t=>y.showFriendContextMenu(t,e),["prevent"])},[a("div",{class:s(["avatar",1==e.avatarPolicy?"custom":"model"])},[a("img",{src:e.avatar,alt:e.name},null,8,ra)],2),a("div",ca,[a("div",da,r(e.name),1),a("div",ua,r(e.getLastTime()),1),a("div",pa,r(e.lastMessageSummary),1)])],40,la))),128))]),a("div",{class:"resizer",onMousedown:p[1]||(p[1]=(...e)=>y.startResize&&y.startResize(...e))},null,32),c(w,{show:v.showAddWindow,"onUpdate:show":p[2]||(p[2]=e=>v.showAddWindow=e),onClose:p[3]||(p[3]=e=>v.showAddWindow=!1),onAddBot:y.addPresetContactor,onAddByProvider:y.genBotByProvider,onAddByShareCode:y.genBotByShareCode},null,8,["show","onAddBot","onAddByProvider","onAddByShareCode"]),v.showMenu?(i(),u(b,{key:0,type:"friend",message:v.selectedFriend,style:f({top:v.menuY+"px"}),onMessageOption:y.handleFriendOption,onClose:p[4]||(p[4]=e=>v.showMenu=!1)},null,8,["message","style","onMessageOption"])):o("",!0)],512)}],["__scopeId","data-v-08f7c10a"]]),ma={class:"presets-list"},ga={class:"preset-message-block"},fa=["onMouseover"],va={key:0,class:"avatar-emoji"},ya=["onBlur"],wa={class:"messages-buttons"};const ba={class:"settings-container"},Ca={key:0,class:"openai-settings"},_a={class:"settings-block"},Sa={class:"block-content"},ka={class:"block-content-item"},xa={class:"item-content"},La={class:"item-title"},Ma={class:"item-content"},Ta={class:"settings-block"},Aa={class:"block-content"},Oa={class:"block-content-item"},Pa={class:"item-content"},Ia={class:"block-content-item",style:{overflow:"hidden"}},Ea={class:"settings-block"},$a={class:"block-content"},Va={class:"block-content-item"},Da={class:"item-content"},Ua={class:"item-title"},Ra={class:"item-content"},ja=["onClick"],Na={class:"item-hidden-content plugin-tools-container"},Ba=["title"],qa={class:"item-title"},Fa={class:"item-content"},Ga={key:1,class:"settings-block"},Ja={class:"block-content"},za={class:"block-content-item"},Ha={class:"item-content"},Wa={class:"block-content-item"},Ka={class:"item-content"},Ya={class:"block-content-item",style:{overflow:"hidden"}},Xa={id:"internal-tools-settings",class:"sub-items"},Qa={class:"item-title"},Za={class:"item-content"},es={class:"block-content-item"},ts={class:"item-content"},as={class:"block-content-item",style:{overflow:"hidden"}},ss={id:"safety-settings",class:"sub-items"},is={class:"item-title"},os={class:"item-content"};const ns=ge({name:"ContactorSettings",components:{PresetsList:ge({props:{presetsHistory:{type:Array,default:()=>[]}},emits:["updatePresets"],data(){return{presetMessages:[...this.presetsHistory],hoveredIndex:void 0}},watch:{presetsHistory(e){this.presetMessages=[...e]}},methods:{delPresetMessage(){this.presetMessages.splice(this.hoveredIndex,1),this.$emit("updatePresets",this.presetMessages)},addPresetMessage(e){"system"==e&&this.presetMessages.length>0?this.$message.warning("系统消息必须是第一条消息"):(this.presetMessages.push({role:e,content:""}),this.$emit("updatePresets",this.presetMessages))},getMessageAvatar:e=>"assistant"==e?"🤖":"system"==e?"⚙️":"👤",handleMessageUpdate(e){this.presetMessages[e].content=this.$refs[`message-${e}`][0].innerText,this.$emit("updatePresets",this.presetMessages)}}},[["render",function(e,s,o,u,p,h){const m=d("el-button");return i(),t("div",ma,[(i(!0),t(n,null,l(p.presetMessages,(e,o)=>(i(),t("div",{key:o,class:"preset-message"},[a("div",ga,[a("div",{class:"message-avatar",onMouseover:e=>p.hoveredIndex=o,onMouseleave:s[1]||(s[1]=e=>p.hoveredIndex=null)},[p.hoveredIndex!=o?(i(),t("div",va,r(h.getMessageAvatar(e.role)),1)):(i(),t("div",{key:1,title:"删除消息",class:"avatar-emoji hovered",onClick:s[0]||(s[0]=(...e)=>h.delPresetMessage&&h.delPresetMessage(...e))}," 🗑️ "))],40,fa),a("div",{ref_for:!0,ref:`message-${o}`,class:"message-content",contenteditable:"true",onBlur:e=>h.handleMessageUpdate(o)},r(p.presetMessages[o].content),41,ya)])]))),128)),a("div",wa,[c(m,{title:"添加系统消息",plain:"",onClick:s[2]||(s[2]=e=>h.addPresetMessage("system"))},{default:g(()=>s[5]||(s[5]=[S("➕ ⚙️")])),_:1}),c(m,{title:"添加助手消息",plain:"",onClick:s[3]||(s[3]=e=>h.addPresetMessage("assistant"))},{default:g(()=>s[6]||(s[6]=[S("➕ 🤖")])),_:1}),c(m,{title:"添加用户消息",plain:"",onClick:s[4]||(s[4]=e=>h.addPresetMessage("user"))},{default:g(()=>s[7]||(s[7]=[S("➕ 👤")])),_:1})])])}],["__scopeId","data-v-88c48edc"]])},props:{modelValue:{type:Object,required:!0},activeContactorPlatform:{type:String,required:!0},llmProvidersList:{type:Array,required:!0},toolCallModesList:{type:Array,required:!0},allLlmToolsData:{type:Array,required:!0},safetySettingsParams:{type:Object,required:!0},safetySimpleValueOptions:{type:Array,required:!0},presetsHistoryData:{type:Array,default:()=>[]}},emits:["update:modelValue","provider-changed","update-presets"],data(){return{localLlmProvider:this.modelValue.provider,localLlmGeneralKeys:{},localLlmToolCallMode:this.modelValue.toolCallSettings?.mode,localAllLLMTools:JSON.parse(JSON.stringify(this.allLlmToolsData)),localGeminiExtraSettings:JSON.parse(JSON.stringify(this.modelValue.extraSettings.gemini)),localGeminiSafetySettings:{},showPresetsDetail:!1,showInternalTools:!1,showSafetySettings:!1,sliderTypes:{a:{min:0,max:2,step:.1},b:{min:0,max:1,step:.1},c:{min:-2,max:2,step:.1},d:{min:-1,max:3,step:1,formatter:e=>({"-1":"默认",0:"关闭思考",1:"基础思考",2:"均衡思考",3:"深度思考"}[e])}}}},computed:{isGeminiAdapter(){const e=he.getProviderAdapterType(this.localLlmProvider);return["gemini","vertex"].includes(e)}},watch:{modelValue:{handler(e){this.localLlmProvider=e.provider,this.localLlmToolCallMode=e.toolCallSettings?.mode,this.localGeminiExtraSettings=JSON.parse(JSON.stringify(e.extraSettings.gemini)),this.initializeSettings()},deep:!0},allLlmToolsData:{handler(e){this.localAllLLMTools=JSON.parse(JSON.stringify(e)),this.updateEnabledTools()},deep:!0}},created(){this.initializeSettings()},methods:{initializeSettings(){this.localLlmGeneralKeys={...this.modelValue.base,...this.modelValue.chatParams};const e=he.getProviderAdapterType(this.localLlmProvider);["gemini","vertex"].includes(e)&&(this.localGeminiSafetySettings=this.safeSimplify(this.localGeminiExtraSettings.safetySettings)),this.updateEnabledTools()},updateEnabledTools(){const e=this.modelValue.toolCallSettings?.tools||[];this.localAllLLMTools=this.localAllLLMTools.map(t=>({...t,tools:t.tools.map(t=>({...t,enabled:e.includes(t.name)}))}))},getShownKey:e=>({mode:"工具调用",model:"模型",max_messages_num:"最大历史消息数",stream:"流式响应",reasoning_effort:"思考强度",temperature:"温度",top_p:"核采样",frequency_penalty:"重复惩罚度",presence_penalty:"话题新鲜度",HARM_CATEGORY_HARASSMENT:"骚扰",HARM_CATEGORY_HATE_SPEECH:"仇恨言论",HARM_CATEGORY_SEXUALLY_EXPLICIT:"色情",HARM_CATEGORY_DANGEROUS_CONTENT:"危险内容",HARM_CATEGORY_CIVIC_INTEGRITY:"公民诚信",imageGeneration:"图像生成",google_search:"联网搜索",code_execution:"代码执行",url_context:"网页解析"}[e]||e),emitUpdate(){const e=JSON.parse(JSON.stringify(this.modelValue)),{model:t,stream:a,max_messages_num:s,temperature:i,top_p:o,frequency_penalty:n,presence_penalty:l,reasoning_effort:r}=this.localLlmGeneralKeys;e.base={model:t,max_messages_num:s,stream:a},e.chatParams={temperature:i,top_p:o,frequency_penalty:n,presence_penalty:l,reasoning_effort:r},e.provider=this.localLlmProvider,e.toolCallSettings||(e.toolCallSettings={}),e.toolCallSettings.mode=this.localLlmToolCallMode;const c=this.localAllLLMTools.flatMap(e=>e.tools.filter(e=>e.enabled).map(e=>e.name));e.toolCallSettings.tools=c,e.extraSettings||(e.extraSettings={}),e.extraSettings.gemini||(e.extraSettings.gemini={internalTools:{},safetySettings:{}}),e.extraSettings.gemini=JSON.parse(JSON.stringify(this.localGeminiExtraSettings)),this.$emit("update:modelValue",e)},updateGeneralSettings(){this.emitUpdate()},handleProviderChange(e){this.localLlmProvider=e;const t=he.getDefaultModel(e);t&&(this.localLlmGeneralKeys.model=t),this.emitUpdate(),this.$emit("provider-changed",e);const a=he.getProviderAdapterType(e);["gemini","vertex"].includes(a)&&(this.localGeminiSafetySettings=this.safeSimplify(this.localGeminiExtraSettings.safetySettings))},handleUpdatePresets(e){this.$emit("update-presets",e)},handleToolCallModeChange(){this.emitUpdate()},handleToolEnableChange(){this.emitUpdate()},handleGeminiSettingsChange(){this.emitUpdate()},safeSimplify(e){const t={},a=new Map,s=this.safetySettingsParams;return Object.keys(s).forEach(e=>{a.set(s[e],e)}),Object.keys(e||{}).forEach(s=>{t[s]=a.get(e[s])}),t},handleSafetySettingChange(e){const t=this.localGeminiSafetySettings[e],a=this.safetySettingsParams[t];this.localGeminiExtraSettings.safetySettings||(this.localGeminiExtraSettings.safetySettings={}),this.localGeminiExtraSettings.safetySettings[e]=a,this.emitUpdate()}}},[["render",function(e,m,f,v,y,w){const b=d("el-option"),C=d("el-select"),_=d("el-input"),S=d("el-input-number"),x=d("el-switch"),L=d("el-slider"),M=d("PresetsList");return i(),t("div",ba,["openai"==f.activeContactorPlatform?(i(),t("div",Ca,[a("div",_a,[m[7]||(m[7]=a("div",{class:"block-title"},"LLM 基本配置",-1)),a("div",Sa,[a("div",ka,[m[6]||(m[6]=a("div",{class:"item-title"},"来源渠道",-1)),a("div",xa,[c(C,{modelValue:y.localLlmProvider,"onUpdate:modelValue":m[0]||(m[0]=e=>y.localLlmProvider=e),style:{width:"10rem"},onChange:w.handleProviderChange},{default:g(()=>[(i(!0),t(n,null,l(f.llmProvidersList,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])])]),(i(!0),t(n,null,l(y.localLlmGeneralKeys,(e,s)=>(i(),t("div",{key:s,class:"block-content-item"},[a("div",La,r(w.getShownKey(s)),1),a("div",Ma,["model"===s?(i(),u(_,{key:0,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):"max_messages_num"===s?(i(),u(S,{key:1,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,min:1,step:1,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):["stream"].includes(s)?(i(),u(x,{key:2,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","onChange"])):["temperature"].includes(s)?(i(),u(L,{key:3,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.a.step,min:y.sliderTypes.a.min,max:y.sliderTypes.a.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["top_p"].includes(s)?(i(),u(L,{key:4,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.b.step,min:y.sliderTypes.b.min,max:y.sliderTypes.b.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["frequency_penalty","presence_penalty"].includes(s)?(i(),u(L,{key:5,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.c.step,min:y.sliderTypes.c.min,max:y.sliderTypes.c.max,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","onChange"])):["reasoning_effort"].includes(s)?(i(),u(L,{key:6,modelValue:y.localLlmGeneralKeys[s],"onUpdate:modelValue":e=>y.localLlmGeneralKeys[s]=e,step:y.sliderTypes.d.step,min:y.sliderTypes.d.min,max:y.sliderTypes.d.max,"format-tooltip":y.sliderTypes.d.formatter,onChange:w.updateGeneralSettings},null,8,["modelValue","onUpdate:modelValue","step","min","max","format-tooltip","onChange"])):o("",!0)])]))),128))])]),a("div",Ta,[m[10]||(m[10]=a("div",{class:"block-title"},"LLM 预设配置",-1)),a("div",Aa,[a("div",Oa,[m[9]||(m[9]=a("div",{class:"item-title"},"预设历史记录",-1)),a("div",Pa,[a("button",{class:s({active:y.showPresetsDetail,"extra-info-button":!0}),onClick:m[1]||(m[1]=e=>y.showPresetsDetail=!y.showPresetsDetail)},m[8]||(m[8]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(k,{name:"expand-slide"},{default:g(()=>[p(a("div",Ia,[c(M,{"presets-history":f.presetsHistoryData,onUpdatePresets:w.handleUpdatePresets},null,8,["presets-history","onUpdatePresets"])],512),[[h,y.showPresetsDetail]])]),_:1})])]),a("div",Ea,[m[13]||(m[13]=a("div",{class:"block-title"},"LLM 工具调用配置",-1)),a("div",$a,[a("div",Va,[m[11]||(m[11]=a("div",{class:"item-title"},"工具调用模式",-1)),a("div",Da,[c(C,{modelValue:y.localLlmToolCallMode,"onUpdate:modelValue":m[2]||(m[2]=e=>y.localLlmToolCallMode=e),placeholder:"AUTO",style:{width:"10rem"},onChange:w.handleToolCallModeChange},{default:g(()=>[(i(!0),t(n,null,l(f.toolCallModesList,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onChange"])])]),(i(!0),t(n,null,l(y.localAllLLMTools,(e,o)=>(i(),t("div",{key:o,class:"block-content-item parent-item"},[a("div",Ua,r(e.name),1),a("div",Ra,[a("button",{class:s({active:!e.collapsed,"extra-info-button":!0}),onClick:t=>e.collapsed=!e.collapsed},m[12]||(m[12]=[a("i",{class:"iconfont icon-return"},null,-1)]),10,ja)]),c(k,{name:"expand-slide"},{default:g(()=>[p(a("div",Na,[(i(!0),t(n,null,l(e.tools,(e,s)=>(i(),t("div",{key:s,class:"block-content-item child-item",title:e.description},[a("div",qa,r(e.name.split("_mid_")[0]),1),a("div",Fa,[c(x,{modelValue:e.enabled,"onUpdate:modelValue":t=>e.enabled=t,onChange:w.handleToolEnableChange},null,8,["modelValue","onUpdate:modelValue","onChange"])])],8,Ba))),128))],512),[[h,!e.collapsed]])]),_:2},1024)]))),128))])])])):o("",!0),w.isGeminiAdapter?(i(),t("div",Ga,[m[19]||(m[19]=a("div",{class:"block-title"},"Gemini 额外设置",-1)),a("div",Ja,[a("div",za,[m[14]||(m[14]=a("div",{class:"item-title"},"图像生成",-1)),a("div",Ha,[c(x,{modelValue:y.localGeminiExtraSettings.imageGeneration,"onUpdate:modelValue":m[3]||(m[3]=e=>y.localGeminiExtraSettings.imageGeneration=e),onChange:w.handleGeminiSettingsChange},null,8,["modelValue","onChange"])])]),a("div",Wa,[m[16]||(m[16]=a("div",{class:"item-title"},"内置工具",-1)),a("div",Ka,[a("button",{class:s({active:y.showInternalTools,"extra-info-button":!0}),onClick:m[4]||(m[4]=e=>y.showInternalTools=!y.showInternalTools)},m[15]||(m[15]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(k,{name:"expand-slide"},{default:g(()=>[p(a("div",Ya,[a("ul",Xa,[(i(!0),t(n,null,l(y.localGeminiExtraSettings.internalTools,(e,s)=>(i(),t("li",{key:s,class:"block-content-item child-item"},[a("div",Qa,r(w.getShownKey(s)),1),a("div",Za,[c(x,{modelValue:y.localGeminiExtraSettings.internalTools[s],"onUpdate:modelValue":e=>y.localGeminiExtraSettings.internalTools[s]=e,onChange:w.handleGeminiSettingsChange},null,8,["modelValue","onUpdate:modelValue","onChange"])])]))),128))])],512),[[h,y.showInternalTools]])]),_:1}),a("div",es,[m[18]||(m[18]=a("div",{class:"item-title"},"过滤等级设置",-1)),a("div",ts,[a("button",{class:s({active:y.showSafetySettings,"extra-info-button":!0}),onClick:m[5]||(m[5]=e=>y.showSafetySettings=!y.showSafetySettings)},m[17]||(m[17]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)])]),c(k,{name:"expand-slide"},{default:g(()=>[p(a("div",as,[a("ul",ss,[(i(!0),t(n,null,l(y.localGeminiSafetySettings,(e,s)=>(i(),t("li",{key:s,class:"block-content-item child-item"},[a("div",is,r(w.getShownKey(s)),1),a("div",os,[c(C,{modelValue:y.localGeminiSafetySettings[s],"onUpdate:modelValue":e=>y.localGeminiSafetySettings[s]=e,style:{width:"10rem"},onChange:e=>w.handleSafetySettingChange(s)},{default:g(()=>[(i(!0),t(n,null,l(f.safetySimpleValueOptions,e=>(i(),u(b,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])]))),128))])],512),[[h,y.showSafetySettings]])]),_:1})])])):o("",!0)])}]]);const ls=new class{constructor(){this.adminCode="",this._initialized=!1}init(){this._initialized||(this.adminCode=localStorage.getItem("admin_code")||"",this._initialized=!0)}setAdminCode(e){this.adminCode=e,localStorage.setItem("admin_code",e)}async request(e,t={}){this._initialized||this.init();const a={"X-Admin-Code":this.adminCode,"Content-Type":"application/json",...t.headers};try{const s=await fetch(e,{...t,headers:a}),i=await s.json();if(!s.ok)throw 403===s.status&&(this.adminCode="",localStorage.removeItem("admin_code")),new Error(i.message||i.error||"请求失败");if(0!==i.code&&void 0!==i.code)throw new Error(i.message||"请求失败");return i}catch(s){throw s}}async getConfig(){return this.request("/api/config")}async getConfigSection(e){return this.request(`/api/config/${e}`)}async updateConfig(e){return this.request("/api/config",{method:"PUT",body:JSON.stringify(e)})}async updateConfigSection(e,t){return this.request(`/api/config/${e}`,{method:"PUT",body:JSON.stringify(t)})}async addAdapter(e,t){return this.request(`/api/config/llm/${e}`,{method:"POST",body:JSON.stringify(t)})}async updateAdapter(e,t,a){return this.request(`/api/config/llm/${e}/${t}`,{method:"PUT",body:JSON.stringify(a)})}async deleteAdapter(e,t){return this.request(`/api/config/llm/${e}/${t}`,{method:"DELETE"})}async batchDeleteAdapters(e){const t=[...e].sort((e,t)=>t.index-e.index),a=[];for(const i of t)try{const e=await this.deleteAdapter(i.type,i.index);a.push({success:!0,adapter:i,result:e})}catch(s){a.push({success:!1,adapter:i,error:s.message})}return a}async refreshAllModels(){return this.request("/api/config/refresh-models",{method:"POST"})}async refreshAdapterModels(e,t){return this.request(`/api/config/llm/${e}/${t}/refresh-models`,{method:"POST"})}async validateConfig(e){return this.request("/api/config/validate",{method:"POST",body:JSON.stringify(e)})}async resetConfig(){return this.request("/api/config/reset",{method:"POST"})}async exportConfig(e="mio-chat-config.json"){const t=(await this.getConfig()).data,a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=e,i.click(),URL.revokeObjectURL(s)}async importConfig(e){return new Promise((t,a)=>{const s=new FileReader;s.onload=e=>{try{const a=JSON.parse(e.target.result);t(a)}catch{a(new Error("无效的 JSON 文件"))}},s.onerror=()=>{a(new Error("文件读取失败"))},s.readAsText(e)})}},rs=new class{constructor(e){this.configAPI=e}async listPlugins(){return this.configAPI.request("/api/plugins")}async getPluginDetail(e){return this.configAPI.request(`/api/plugins/${e}`)}async getPluginConfig(e){return this.configAPI.request(`/api/plugins/${e}/config`)}async updatePluginConfig(e,t){return this.configAPI.request(`/api/plugins/${e}/config`,{method:"PUT",body:JSON.stringify(t)})}async getPluginTools(e){return this.configAPI.request(`/api/plugins/${e}/tools`)}async debugTool(e,t,a,s=null){return this.configAPI.request(`/api/plugins/${e}/tools/${t}/debug`,{method:"POST",body:JSON.stringify({parameters:a,user:s})})}async reloadPlugin(e){return this.configAPI.request(`/api/plugins/${e}/reload`,{method:"POST"})}async reloadAllPlugins(){return this.configAPI.request("/api/plugins/reload-all",{method:"POST"})}async togglePlugin(e,t){return this.configAPI.request(`/api/plugins/${e}/toggle`,{method:"POST",body:JSON.stringify({enabled:t})})}}(ls),cs=x("config",()=>{const e=y(null),t=y({openai:[],gemini:[],vertex:[]}),a=y({}),s=y(!1),i=y(!1),o=y(localStorage.getItem("admin_code")||""),n=y([]),l=w(()=>{const e=[];return Object.entries(t.value).forEach(([t,a])=>{a.forEach((a,s)=>{a.enable&&e.push({type:t,index:s,...a})})}),e}),r=w(()=>Object.values(t.value).reduce((e,t)=>e+t.length,0)),c=w(()=>{let e=0;return Object.values(t.value).forEach(t=>{t.forEach(t=>{t.enable&&e++})}),e}),d=w(()=>{let e=0;return Object.values(a.value).forEach(t=>{Array.isArray(t)&&t.forEach(t=>{t.models&&Array.isArray(t.models)&&(e+=t.models.length)})}),e}),u=w(()=>!!o.value);function p(){o.value="",localStorage.removeItem("admin_code"),ls.adminCode=""}async function h(){s.value=!0;try{const s=await ls.getConfig();return e.value=s.data,t.value=s.data.llm_adapters||{openai:[],gemini:[],vertex:[]},a.value=s.data.models||{},s.data}catch(i){throw(i.message.includes("验证码")||i.message.includes("访问被拒绝"))&&p(),i}finally{s.value=!1}}async function m(e,s,i){try{const o=await ls.updateAdapter(e,s,i);return o.data.llm_adapters&&(t.value=o.data.llm_adapters),o.data.models&&(a.value=o.data.models),o.data}catch(o){throw o}}return{config:e,adapters:t,models:a,loading:s,needRestart:i,adminCode:o,selectedAdapters:n,enabledAdapters:l,totalAdapters:r,enabledAdaptersCount:c,totalModelsCount:d,isAuthenticated:u,setAdminCode:function(e){o.value=e,ls.setAdminCode(e)},clearAdminCode:p,fetchConfig:h,fetchConfigSection:async function(t){try{const a=await ls.getConfigSection(t);return e.value&&(e.value[t]=a.data),a.data}catch(a){throw a}},updateConfig:async function(e){try{const t=await ls.updateConfig(e);return i.value=!0,await h(),t.data}catch(t){throw t}},updateConfigSection:async function(t,a){try{const s=await ls.updateConfigSection(t,a);return e.value&&(e.value[t]=a),"llm_adapters"!==t&&(i.value=!0),s.data}catch(s){throw s}},addAdapter:async function(e,t){try{const s=await ls.addAdapter(e,t);return await h(),a.value=s.data.models||{},s.data}catch(s){throw s}},updateAdapter:m,deleteAdapter:async function(e,s){try{const i=await ls.deleteAdapter(e,s);return t.value[e]&&t.value[e].splice(s,1),a.value=i.data.models||{},i.data}catch(i){throw i}},batchDeleteAdapters:async function(e){try{const t=await ls.batchDeleteAdapters(e);return await h(),t}catch(t){throw t}},batchToggleAdapters:async function(e,a){const s=[];for(const o of e)try{const e={...t.value[o.type][o.index],enable:a};await m(o.type,o.index,e),s.push({success:!0,adapter:o})}catch(i){s.push({success:!1,adapter:o,error:i.message})}return s},refreshAllModels:async function(){try{const e=await ls.refreshAllModels();return a.value=e.data.models||{},e.data}catch(e){throw e}},refreshAdapterModels:async function(e,t){try{const s=await ls.refreshAdapterModels(e,t);return a.value=s.data.models||{},s.data}catch(s){throw s}},validateConfig:async function(e){try{return(await ls.validateConfig(e)).data}catch(t){throw t}},resetConfig:async function(){try{const e=await ls.resetConfig();return i.value=!0,await h(),e.data}catch(e){throw e}},exportConfig:async function(e){try{await ls.exportConfig(e)}catch(t){throw t}},importConfig:async function(e){try{return await ls.importConfig(e)}catch(t){throw t}},toggleAdapterSelection:function(e,t){const a=`${e}-${t}`,s=n.value.findIndex(e=>`${e.type}-${e.index}`===a);s>-1?n.value.splice(s,1):n.value.push({type:e,index:t})},clearAdapterSelection:function(){n.value=[]},isAdapterSelected:function(e,t){const a=`${e}-${t}`;return n.value.some(e=>`${e.type}-${e.index}`===a)}}}),ds={class:"error-boundary"},us={key:0,class:"error-container"},ps={class:"error-details"},hs=ge({__name:"ErrorBoundary",props:{fallbackTitle:{type:String,default:"出现错误"},fallbackMessage:{type:String,default:"加载此页面时发生错误，请稍后重试"},showDetails:{type:Boolean,default:!0},onError:{type:Function,default:null}},setup(e){const s=e,n=C(),l=y(!1),m=y(""),f=y(""),v=y(""),w=y(!1);L((e,t,a)=>(l.value=!0,m.value=s.fallbackTitle,f.value=e.message||s.fallbackMessage,v.value=e.stack||"",s.onError&&s.onError(e,t,a),!1));const b=()=>{l.value=!1,m.value="",f.value="",v.value="",w.value=!1,n.go(0)},_=()=>{window.history.length>1?n.back():n.push("/settings")};return(s,n)=>{const y=d("el-button"),C=d("el-space"),k=d("el-result"),x=d("el-card"),L=d("el-collapse-transition");return i(),t("div",ds,[l.value?(i(),t("div",us,[c(k,{icon:"error",title:m.value,"sub-title":f.value},{extra:g(()=>[c(C,null,{default:g(()=>[c(y,{type:"primary",onClick:b},{default:g(()=>n[1]||(n[1]=[S(" 重新加载 ")])),_:1}),c(y,{onClick:_},{default:g(()=>n[2]||(n[2]=[S(" 返回 ")])),_:1}),e.showDetails?(i(),u(y,{key:0,text:"",onClick:n[0]||(n[0]=e=>w.value=!w.value)},{default:g(()=>[S(r(w.value?"隐藏":"查看")+"详细信息 ",1)]),_:1})):o("",!0)]),_:1})]),_:1},8,["title","sub-title"]),c(L,null,{default:g(()=>[p(a("div",ps,[c(x,null,{header:g(()=>n[3]||(n[3]=[a("span",null,"错误详情",-1)])),default:g(()=>[a("pre",null,r(v.value),1)]),_:1})],512),[[h,w.value&&v.value]])]),_:1})])):M(s.$slots,"default",{key:1},void 0,!0)])}}},[["__scopeId","data-v-5bde4aa5"]]),ms={key:0,class:"skeleton-adapter-card"},gs={key:1,class:"skeleton-stat-card"},fs={key:2,class:"skeleton-list"},vs={key:3,class:"skeleton-default"},ys=ge({__name:"LoadingSkeleton",props:{type:{type:String,default:"default",validator:e=>["adapter-card","stat-card","list","default"].includes(e)},count:{type:Number,default:3},isCard:{type:Boolean,default:!1}},setup:e=>(o,r)=>(i(),t("div",{class:s(["loading-skeleton",{card:e.isCard}])},["adapter-card"===e.type?(i(),t("div",ms,r[0]||(r[0]=[T('<div class="skeleton-header" data-v-1c3500cc><div class="skeleton-checkbox" data-v-1c3500cc></div><div class="skeleton-title" data-v-1c3500cc></div><div class="skeleton-tag" data-v-1c3500cc></div></div><div class="skeleton-content" data-v-1c3500cc><div class="skeleton-line short" data-v-1c3500cc></div><div class="skeleton-line medium" data-v-1c3500cc></div><div class="skeleton-line long" data-v-1c3500cc></div></div><div class="skeleton-actions" data-v-1c3500cc><div class="skeleton-button" data-v-1c3500cc></div><div class="skeleton-button" data-v-1c3500cc></div><div class="skeleton-button" data-v-1c3500cc></div></div>',3)]))):"stat-card"===e.type?(i(),t("div",gs,r[1]||(r[1]=[a("div",{class:"skeleton-icon"},null,-1),a("div",{class:"skeleton-stat-content"},[a("div",{class:"skeleton-value"}),a("div",{class:"skeleton-label"})],-1)]))):"list"===e.type?(i(),t("div",fs,[(i(!0),t(n,null,l(e.count,e=>(i(),t("div",{key:e,class:"skeleton-list-item"},r[2]||(r[2]=[a("div",{class:"skeleton-line"},null,-1)])))),128))])):(i(),t("div",vs,r[3]||(r[3]=[a("div",{class:"skeleton-line"},null,-1),a("div",{class:"skeleton-line"},null,-1),a("div",{class:"skeleton-line short"},null,-1)])))],2))},[["__scopeId","data-v-1c3500cc"]]),ws={class:"config-compare-dialog"},bs={key:0,class:"upload-section"},Cs={key:1,class:"compare-result"},_s={class:"result-header"},Ss={key:0,class:"diff-stats"},ks={key:1,class:"diff-details"},xs={key:0,class:"no-changes"},Ls={key:1,class:"changes-list"},Ms={class:"change-path"},Ts={class:"change-values"},As={key:0,class:"old-value"},Os={key:1,class:"new-value"},Ps={class:"label"},Is={class:"dialog-footer"},Es=ge({__name:"ConfigCompare",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(e,{emit:p}){const h=e,m=p,f=cs(),v=y(h.modelValue),b=y(null),C=y("adapters");A(()=>h.modelValue,e=>{v.value=e,e||(b.value=null)}),A(v,e=>{m("update:modelValue",e)});const k=w(()=>f.config||{}),x=w(()=>{if(!b.value)return{};const e={openai:[],gemini:[],vertex:[]};return["openai","gemini","vertex"].forEach(t=>{const a=k.value.adapters?.[t]||[],s=b.value.adapters?.[t]||[],i=Math.max(a.length,s.length);for(let o=0;o<i;o++){const i=a[o],n=s[o];if(!i&&n)e[t].push({type:"added",path:`实例 ${o+1}`,newValue:n});else if(i&&!n)e[t].push({type:"removed",path:`实例 ${o+1}`,oldValue:i});else if(i&&n){new Set([...Object.keys(i),...Object.keys(n)]).forEach(a=>{JSON.stringify(i[a])!==JSON.stringify(n[a])&&e[t].push({type:"modified",path:`实例 ${o+1} - ${a}`,oldValue:i[a],newValue:n[a]})})}}}),e}),L=w(()=>{let e=0,t=0,a=0;return Object.values(x.value).forEach(s=>{s.forEach(s=>{"added"===s.type?e++:"modified"===s.type?t++:"removed"===s.type&&a++})}),{added:e,modified:t,removed:a}}),M=w(()=>L.value.added>0||L.value.modified>0||L.value.removed>0),T=e=>({openai:"OpenAI",gemini:"Gemini",vertex:"Vertex AI"}[e]||e),O=e=>({added:"success",modified:"warning",removed:"danger"}[e]||""),P=e=>({added:"新增",modified:"修改",removed:"删除"}[e]||e),I=e=>"object"==typeof e?JSON.stringify(e,null,2):String(e),E=async e=>{try{const t=await e.text(),a=JSON.parse(t),s=await f.validateConfig(a);if(!s.valid)return U.error("配置文件格式无效："+s.errors.join(", ")),!1;b.value=a,U.success("配置文件加载成功")}catch(t){U.error("加载配置文件失败："+t.message)}return!1},$=()=>{b.value=null,C.value="adapters"},V=()=>{v.value=!1},D=async()=>{try{await j.confirm("确定要应用对比配置吗？这将覆盖当前配置。","确认应用",{confirmButtonText:"应用",cancelButtonText:"取消",type:"warning"}),await f.updateConfig(b.value),U.success("配置已应用，请重启服务使配置生效"),V(),await f.fetchConfig()}catch(e){"cancel"!==e&&U.error("应用配置失败："+e.message)}},N={props:["current","compare","section"],template:'\n    <div class="config-section-compare">\n      <div v-if="!hasDiff" class="no-changes">无变化</div>\n      <div v-else class="diff-table">\n        <el-table :data="differences" border>\n          <el-table-column prop="key" label="配置项" width="200" />\n          <el-table-column label="当前值">\n            <template #default="{ row }">\n              <code>{{ row.currentValue }}</code>\n            </template>\n          </el-table-column>\n          <el-table-column label="对比值">\n            <template #default="{ row }">\n              <code>{{ row.compareValue }}</code>\n            </template>\n          </el-table-column>\n        </el-table>\n      </div>\n    </div>\n  ',computed:{differences(){const e=[];return new Set([...Object.keys(this.current||{}),...Object.keys(this.compare||{})]).forEach(t=>{const a=this.current?.[t],s=this.compare?.[t];JSON.stringify(a)!==JSON.stringify(s)&&e.push({key:t,currentValue:this.formatValue(a),compareValue:this.formatValue(s)})}),e},hasDiff(){return this.differences.length>0}},methods:{formatValue:e=>void 0===e?"-":"object"==typeof e?JSON.stringify(e):String(e)}};return(e,p)=>{const h=d("el-icon"),m=d("el-upload"),f=d("el-tag"),y=d("el-button"),w=d("el-descriptions-item"),A=d("el-descriptions"),U=d("el-tab-pane"),j=d("el-tabs"),B=d("el-empty"),q=d("el-dialog");return i(),u(q,{modelValue:v.value,"onUpdate:modelValue":p[1]||(p[1]=e=>v.value=e),title:"配置对比",width:"900px","close-on-click-modal":!1,onClose:V},{footer:g(()=>[a("div",Is,[c(y,{onClick:V},{default:g(()=>p[6]||(p[6]=[S("关闭")])),_:1}),b.value&&M.value?(i(),u(y,{key:0,type:"primary",onClick:D},{default:g(()=>p[7]||(p[7]=[S(" 应用对比配置 ")])),_:1})):o("",!0)])]),default:g(()=>[a("div",ws,[b.value?(i(),t("div",Cs,[a("div",_s,[c(f,{type:M.value?"warning":"success",size:"large"},{default:g(()=>[S(r(M.value?"发现差异":"配置相同"),1)]),_:1},8,["type"]),c(y,{onClick:$},{default:g(()=>p[4]||(p[4]=[S("重新选择")])),_:1})]),M.value?(i(),t("div",Ss,[c(A,{column:3,border:""},{default:g(()=>[c(w,{label:"新增项"},{default:g(()=>[c(f,{type:"success"},{default:g(()=>[S(r(L.value.added),1)]),_:1})]),_:1}),c(w,{label:"修改项"},{default:g(()=>[c(f,{type:"warning"},{default:g(()=>[S(r(L.value.modified),1)]),_:1})]),_:1}),c(w,{label:"删除项"},{default:g(()=>[c(f,{type:"danger"},{default:g(()=>[S(r(L.value.removed),1)]),_:1})]),_:1})]),_:1})])):o("",!0),M.value?(i(),t("div",ks,[c(j,{modelValue:C.value,"onUpdate:modelValue":p[0]||(p[0]=e=>C.value=e)},{default:g(()=>[c(U,{label:"LLM 适配器",name:"adapters"},{default:g(()=>[(i(!0),t(n,null,l(x.value,(e,d)=>(i(),t("div",{class:"diff-section",key:d},[a("h4",null,r(T(d)),1),0===e.length?(i(),t("div",xs," 无变化 ")):(i(),t("div",Ls,[(i(!0),t(n,null,l(e,(e,n)=>(i(),t("div",{key:n,class:s(["change-item",e.type])},[c(f,{type:O(e.type),size:"small"},{default:g(()=>[S(r(P(e.type)),1)]),_:2},1032,["type"]),a("span",Ms,r(e.path),1),a("div",Ts,["added"!==e.type?(i(),t("div",As,[p[5]||(p[5]=a("span",{class:"label"},"当前:",-1)),a("code",null,r(I(e.oldValue)),1)])):o("",!0),"removed"!==e.type?(i(),t("div",Os,[a("span",Ps,r("added"===e.type?"新增":"修改为")+":",1),a("code",null,r(I(e.newValue)),1)])):o("",!0)])],2))),128))]))]))),128))]),_:1}),c(U,{label:"服务器配置",name:"server"},{default:g(()=>[c(N,{current:k.value.server,compare:b.value.server,section:"server"},null,8,["current","compare"])]),_:1}),c(U,{label:"Web 配置",name:"web"},{default:g(()=>[c(N,{current:k.value.web,compare:b.value.web,section:"web"},null,8,["current","compare"])]),_:1}),c(U,{label:"OneBot 配置",name:"onebot"},{default:g(()=>[c(N,{current:k.value.onebot,compare:b.value.onebot,section:"onebot"},null,8,["current","compare"])]),_:1})]),_:1},8,["modelValue"])])):(i(),u(B,{key:2,description:"配置完全相同"}))])):(i(),t("div",bs,[c(m,{drag:"","before-upload":E,"show-file-list":!1,accept:".json"},{tip:g(()=>p[2]||(p[2]=[a("div",{class:"el-upload__tip"}," 上传 JSON 格式的配置文件以与当前配置进行对比 ",-1)])),default:g(()=>[c(h,{class:"el-icon--upload"},{default:g(()=>[c(_(R))]),_:1}),p[3]||(p[3]=a("div",{class:"el-upload__text"},[S(" 拖拽配置文件到此处，或 "),a("em",null,"点击上传")],-1))]),_:1})]))])]),_:1},8,["modelValue"])}}},[["__scopeId","data-v-fac984a2"]]),$s={class:"card-header"},Vs={class:"header-left"},Ds={class:"adapter-name"},Us={class:"card-body"},Rs={class:"info-container"},js={class:"info-item"},Ns={class:"value"},Bs={key:0,class:"info-item"},qs={class:"value"},Fs={key:1,class:"info-item"},Gs={class:"value"},Js={class:"info-item"},zs={class:"value"},Hs={class:"info-item"},Ws={class:"value model-count"},Ks={class:"card-actions"},Ys=ge({__name:"AdapterCard",props:{adapter:{type:Object,required:!0},type:{type:String,required:!0,validator:e=>["openai","gemini","vertex"].includes(e)},index:{type:Number,required:!0},models:{type:Array,default:()=>[]},selectable:{type:Boolean,default:!1},isSelected:{type:Boolean,default:!1}},emits:["edit","delete","refresh","toggle","select"],setup(e,{emit:n}){const l=e,p=n,h=y(!1),m=y(!1),f=w(()=>l.adapter.name||`${l.type}-${l.index+1}`),v=w(()=>{const e=l.adapter.api_key||"";return e?e.length<=10?"***":`${e.slice(0,6)}***${e.slice(-4)}`:"-"}),b=w(()=>{if(!l.models||!Array.isArray(l.models))return 0;let e=0;return l.models.forEach(t=>{t.models&&Array.isArray(t.models)&&(e+=t.models.length)}),e}),C=w(()=>0===b.value?"danger":b.value<5?"warning":"success"),k=()=>{p("edit",{type:l.type,index:l.index,adapter:l.adapter})},x=async()=>{try{await j.confirm(`确定要删除适配器 "${f.value}" 吗？`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),p("delete",{type:l.type,index:l.index})}catch(e){}},L=async()=>{m.value=!0;try{await p("refresh",{type:l.type,index:l.index})}finally{m.value=!1}},M=async e=>{h.value=!0;try{await p("toggle",{type:l.type,index:l.index,enable:e})}finally{h.value=!1}},T=e=>{p("select",{type:l.type,index:l.index,selected:e})};return(n,l)=>{const p=d("el-checkbox"),y=d("el-tag"),w=d("el-switch"),A=d("el-button"),O=d("el-card");return i(),u(O,{class:s(["adapter-card",{"is-selected":e.isSelected}])},{default:g(()=>[e.selectable?(i(),u(p,{key:0,"model-value":e.isSelected,onChange:T,class:"card-checkbox"},null,8,["model-value"])):o("",!0),a("div",$s,[a("div",Vs,[c(y,{type:e.adapter.enable?"success":"info",size:"small"},{default:g(()=>[S(r(e.adapter.enable?"已启用":"已禁用"),1)]),_:1},8,["type"]),a("h3",Ds,r(f.value),1)]),c(w,{"model-value":e.adapter.enable,onChange:M,loading:h.value},null,8,["model-value","loading"])]),a("div",Us,[a("div",Rs,[a("div",js,[l[0]||(l[0]=a("span",{class:"label"},"API Key",-1)),a("span",Ns,r(v.value),1)]),e.adapter.base_url?(i(),t("div",Bs,[l[1]||(l[1]=a("span",{class:"label"},"Base URL",-1)),a("span",qs,r(e.adapter.base_url),1)])):o("",!0),e.adapter.region?(i(),t("div",Fs,[l[2]||(l[2]=a("span",{class:"label"},"区域",-1)),a("span",Gs,r(e.adapter.region),1)])):o("",!0),a("div",Js,[l[3]||(l[3]=a("span",{class:"label"},"默认模型",-1)),a("span",zs,r(e.adapter.default_model||"-"),1)]),a("div",Hs,[l[4]||(l[4]=a("span",{class:"label"},"可用模型",-1)),a("span",Ws,[c(y,{size:"small",type:C.value,effect:"plain",round:""},{default:g(()=>[S(r(b.value)+" 个 ",1)]),_:1},8,["type"])])])])]),a("div",Ks,[c(A,{size:"small",icon:_(N),onClick:k},{default:g(()=>l[5]||(l[5]=[S(" 编辑 ")])),_:1},8,["icon"]),c(A,{size:"small",icon:_(B),onClick:L,loading:m.value},{default:g(()=>l[6]||(l[6]=[S(" 刷新模型 ")])),_:1},8,["icon","loading"]),c(A,{size:"small",type:"danger",icon:_(q),onClick:x},{default:g(()=>l[7]||(l[7]=[S(" 删除 ")])),_:1},8,["icon"])])]),_:1},8,["class"])}}},[["__scopeId","data-v-4e138740"]]),Xs={class:"model-selector"},Qs={class:"model-input-wrapper"},Zs={class:"form-item-tip"},ei={class:"keyword-input-wrapper"},ti={class:"keyword-tags"},ai={class:"preview-title"},si={class:"preview-models"},ii={key:0,style:{color:"#909399","font-size":"12px"}},oi=ge({__name:"ModelSelector",props:{modelValue:{type:Object,default:()=>({default:"",guest:{keywords:[],full_name:[]}})},availableModels:{type:Array,default:()=>[]},showDefault:{type:Boolean,default:!0},showFetchButton:{type:Boolean,default:!1},fetchingModels:{type:Boolean,default:!1}},emits:["update:modelValue","fetch-models"],setup(e,{emit:s}){const p=e,h=s,m=y(""),f=()=>{h("fetch-models")},v=w(()=>{const e=p.modelValue.guest?.keywords||[],t=p.modelValue.guest?.full_name||[],a=new Set(t);return e.forEach(e=>{p.availableModels.forEach(t=>{t.toLowerCase().includes(e.toLowerCase())&&a.add(t)})}),Array.from(a)}),b=e=>{h("update:modelValue",{...p.modelValue,default:e})},C=()=>{const e=m.value.trim();if(!e)return;const t=p.modelValue.guest?.keywords||[];t.includes(e)||h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,keywords:[...t,e]}}),m.value=""},k=e=>{h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,full_name:e}})};return(s,y)=>{const w=d("el-option"),x=d("el-select"),L=d("el-button"),M=d("el-form-item"),T=d("el-divider"),A=d("el-tag"),P=d("el-input"),I=d("el-alert");return i(),t("div",Xs,[e.showDefault?(i(),u(M,{key:0,label:"默认模型",required:""},{extra:g(()=>[a("span",Zs,r(e.availableModels.length>0?"为所有用户设置的默认模型":"暂无模型列表，请先获取或手动输入"),1)]),default:g(()=>[a("div",Qs,[c(x,{"model-value":e.modelValue.default,"onUpdate:modelValue":b,filterable:"","allow-create":"","default-first-option":"",placeholder:"请选择或输入默认模型",class:"model-select"},{default:g(()=>[(i(!0),t(n,null,l(e.availableModels,e=>(i(),u(w,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["model-value"]),e.showFetchButton?(i(),u(L,{key:0,type:"primary",icon:_(B),loading:e.fetchingModels,onClick:f,class:"fetch-button"},{default:g(()=>y[1]||(y[1]=[S(" 获取模型 ")])),_:1},8,["icon","loading"])):o("",!0)])]),_:1})):o("",!0),c(T,{"content-position":"left"},{default:g(()=>y[2]||(y[2]=[S("访客模型配置")])),_:1}),c(M,{label:"关键词匹配"},{extra:g(()=>y[4]||(y[4]=[a("span",{class:"form-item-tip"}," 访客可使用包含这些关键词的模型（如：gpt、4o、flash） ",-1)])),default:g(()=>[a("div",ei,[a("div",ti,[(i(!0),t(n,null,l(e.modelValue.guest?.keywords||[],e=>(i(),u(A,{key:e,closable:"",onClose:t=>(e=>{const t=p.modelValue.guest?.keywords||[];h("update:modelValue",{...p.modelValue,guest:{...p.modelValue.guest,keywords:t.filter(t=>t!==e)}})})(e),size:"default"},{default:g(()=>[S(r(e),1)]),_:2},1032,["onClose"]))),128))]),c(P,{modelValue:m.value,"onUpdate:modelValue":y[0]||(y[0]=e=>m.value=e),onKeyup:O(C,["enter"]),placeholder:"输入关键词后按回车添加",size:"default",clearable:"",style:{"margin-top":"8px"}},{append:g(()=>[c(L,{icon:_(F),onClick:C,class:"input-append-button"},{default:g(()=>y[3]||(y[3]=[S("添加")])),_:1},8,["icon"])]),_:1},8,["modelValue"])])]),_:1}),c(M,{label:"完整名称"},{extra:g(()=>y[5]||(y[5]=[a("span",{class:"form-item-tip"},"访客可使用的具体模型列表",-1)])),default:g(()=>[c(x,{"model-value":e.modelValue.guest?.full_name||[],"onUpdate:modelValue":k,multiple:"",filterable:"",placeholder:"选择访客可用的模型",style:{width:"100%"}},{default:g(()=>[(i(!0),t(n,null,l(e.availableModels,e=>(i(),u(w,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["model-value"])]),_:1}),v.value.length>0?(i(),u(I,{key:1,type:"info",closable:!1,"show-icon":"",style:{"margin-top":"16px"}},{title:g(()=>[a("div",ai,[y[6]||(y[6]=S(" 访客可用模型预览 ")),c(A,{size:"small"},{default:g(()=>[S(r(v.value.length)+" 个",1)]),_:1})])]),default:g(()=>[a("div",si,[(i(!0),t(n,null,l(v.value.slice(0,10),e=>(i(),u(A,{key:e,size:"small",style:{margin:"4px"}},{default:g(()=>[S(r(e),1)]),_:2},1024))),128)),v.value.length>10?(i(),t("span",ii," 等 "+r(v.value.length)+" 个模型 ",1)):o("",!0)])]),_:1})):o("",!0)])}}},[["__scopeId","data-v-07f09388"]]),ni={class:"dialog-footer"},li=ge({__name:"AdapterEditor",props:{visible:{type:Boolean,default:!1},mode:{type:String,default:"add",validator:e=>["add","edit"].includes(e)},type:{type:String,required:!0,validator:e=>["openai","gemini","vertex"].includes(e)},adapter:{type:Object,default:null},index:{type:Number,default:-1}},emits:["close","submit"],setup(e,{emit:s}){const l=e,p=s,h=cs(),m=y(null),f=y(!1),v=y(!1),b=y("json"),C=y(!1),k=y([]),x=y({name:"",enable:!0,api_key:"",base_url:"",region:"us-central1",service_account_json:"",models:[],default_model:"",guest_models:{keywords:[],full_name:[]}}),L=y(null),M=y({default:"",guest:{keywords:[],full_name:[]}}),T=w(()=>`${"add"===l.mode?"添加":"编辑"} ${{openai:"OpenAI",gemini:"Gemini",vertex:"Vertex AI"}[l.type]} 适配器实例`),O=w(()=>{if(k.value.length>0)return k.value;const e=new Set;return Object.values(h.models).forEach(t=>{Array.isArray(t)&&t.forEach(t=>{t.models&&Array.isArray(t.models)&&t.models.forEach(t=>e.add(t))})}),e.size>0?Array.from(e).sort():"openai"===l.type?["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"]:"gemini"===l.type?["gemini-2.0-flash","gemini-1.5-pro","gemini-1.5-flash"]:"vertex"===l.type?x.value.models.length>0?x.value.models:["gemini-2.0-flash-001","claude-3-5-sonnet-v2@20241022"]:[]}),P=w(()=>{if(!x.value.service_account_json)return"";try{const e=JSON.parse(x.value.service_account_json);return`项目: ${e.project_id}\n客户端邮箱: ${e.client_email}`}catch{return"已上传 JSON 文件"}}),I=w(()=>{const e={name:[],enable:[]};return"openai"!==l.type&&"gemini"!==l.type||(e.api_key=[{required:!0,message:"请输入 API Key",trigger:"blur"},{min:10,message:"API Key 长度不足",trigger:"blur"}],e.base_url=[{required:!0,message:"请输入 Base URL",trigger:"blur"},{type:"url",message:"请输入有效的 URL",trigger:"blur",transform:e=>e&&(e.startsWith("http://")||e.startsWith("https://"))?e:`https://${e}`}]),"vertex"===l.type&&(e.region=[{required:!0,message:"请选择区域",trigger:"change"}],e.service_account_json=[{required:!0,message:"请提供服务账号 JSON",trigger:"blur"},{validator:(e,t,a)=>{try{JSON.parse(t),a()}catch{a(new Error("JSON 格式不正确"))}},trigger:"blur"}]),e}),E=e=>{const t=new FileReader;return t.onload=e=>{try{const t=e.target.result;JSON.parse(t),x.value.service_account_json=t,U.success("JSON 文件上传成功")}catch(t){U.error("JSON 文件格式不正确")}},t.readAsText(e),!1},$=async()=>{if("openai"===l.type||"gemini"===l.type){if(!x.value.api_key)return void U.warning("请先填写 API Key");if(!x.value.base_url)return void U.warning("请先填写 Base URL")}else if("vertex"===l.type){if(!x.value.region)return void U.warning("请先选择区域");if(!x.value.service_account_json)return void U.warning("请先提供服务账号 JSON")}C.value=!0;try{const e={};"openai"===l.type||"gemini"===l.type?(e.api_key=x.value.api_key,e.base_url=x.value.base_url):"vertex"===l.type&&(e.region=x.value.region,e.service_account_json=x.value.service_account_json,x.value.models&&x.value.models.length>0&&(e.models=x.value.models));const t=await ls.request(`/api/config/llm/${l.type}/test-models`,{method:"POST",body:JSON.stringify(e)});if(t.data&&t.data.models){const e=[];Array.isArray(t.data.models)&&t.data.models.forEach(t=>{t.models&&Array.isArray(t.models)&&e.push(...t.models)}),k.value=[...new Set(e)].sort(),k.value.length>0?U.success(`成功获取 ${k.value.length} 个模型`):U.warning("获取模型列表为空")}else U.warning("获取模型列表为空")}catch(e){U.error("获取模型失败："+e.message)}finally{C.value=!1}},V=async()=>{try{let e;if(await m.value.validate(),"add"===l.mode)e={...x.value,default_model:M.value.default,guest_models:M.value.guest},"vertex"!==l.type?(delete e.region,delete e.service_account_json,delete e.models):(delete e.api_key,delete e.base_url);else{e={};const t=["name","enable","api_key","base_url","region","service_account_json","models"];for(const a of t)if(!("api_key"===a&&x.value[a]?.startsWith("***")||"service_account_json"===a&&x.value[a]?.startsWith("***")||JSON.stringify(x.value[a])===JSON.stringify(L.value?.[a]))){if("vertex"!==l.type&&["region","service_account_json","models"].includes(a))continue;if("vertex"===l.type&&["api_key","base_url"].includes(a))continue;e[a]=x.value[a]}JSON.stringify(M.value.default)!==JSON.stringify(L.value?.default_model)&&(e.default_model=M.value.default),JSON.stringify(M.value.guest)!==JSON.stringify(L.value?.guest_models)&&(e.guest_models=M.value.guest)}v.value=!0,await p("submit",{type:l.type,index:l.index,data:e,mode:l.mode}),D()}catch(e){"cancel"!==e&&U.error("表单验证失败，请检查输入")}finally{v.value=!1}},D=()=>{p("close"),setTimeout(()=>{m.value?.resetFields(),f.value=!1,k.value=[]},300)};return A(()=>l.visible,e=>{e&&(()=>{if("edit"===l.mode&&l.adapter)x.value={...l.adapter},M.value={default:l.adapter.default_model||"",guest:l.adapter.guest_models||{keywords:[],full_name:[]}},L.value=JSON.parse(JSON.stringify(l.adapter));else{const e={openai:{base_url:"https://api.openai.com/v1"},gemini:{base_url:"https://generativelanguage.googleapis.com/v1beta"},vertex:{region:"us-central1",models:[]}};x.value={name:"",enable:!0,...e[l.type],default_model:"",guest_models:{keywords:[],full_name:[]}},M.value={default:"",guest:{keywords:[],full_name:[]}}}})()},{immediate:!0}),(s,l)=>{const p=d("el-divider"),h=d("el-input"),y=d("el-form-item"),w=d("el-switch"),k=d("el-button"),L=d("el-option"),A=d("el-select"),U=d("el-radio"),j=d("el-radio-group"),N=d("el-icon"),B=d("el-upload"),q=d("el-form"),F=d("el-dialog");return i(),u(F,{"model-value":e.visible,title:T.value,onClose:D,width:"700px","close-on-click-modal":!1},{footer:g(()=>[a("div",ni,[c(k,{onClick:D},{default:g(()=>l[19]||(l[19]=[S("取消")])),_:1}),c(k,{type:"primary",loading:v.value,onClick:V},{default:g(()=>[S(r("add"===e.mode?"保存并测试连接":"保存"),1)]),_:1},8,["loading"])])]),default:g(()=>[c(q,{ref_key:"formRef",ref:m,model:x.value,rules:I.value,"label-width":"120px","label-position":"left"},{default:g(()=>[c(p,{"content-position":"left"},{default:g(()=>l[10]||(l[10]=[S("基本信息")])),_:1}),c(y,{label:"实例名称",prop:"name"},{default:g(()=>[c(h,{modelValue:x.value.name,"onUpdate:modelValue":l[0]||(l[0]=e=>x.value.name=e),placeholder:"留空自动生成",clearable:""},null,8,["modelValue"])]),_:1}),c(y,{label:"启用状态"},{default:g(()=>[c(w,{modelValue:x.value.enable,"onUpdate:modelValue":l[1]||(l[1]=e=>x.value.enable=e),"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1}),"openai"===e.type||"gemini"===e.type?(i(),t(n,{key:0},[c(p,{"content-position":"left"},{default:g(()=>l[11]||(l[11]=[S("认证信息")])),_:1}),c(y,{label:"API Key",prop:"api_key"},{default:g(()=>[c(h,{modelValue:x.value.api_key,"onUpdate:modelValue":l[3]||(l[3]=e=>x.value.api_key=e),type:f.value?"text":"password",placeholder:"请输入 API Key",clearable:""},{append:g(()=>[c(k,{icon:f.value?_(G):_(J),onClick:l[2]||(l[2]=e=>f.value=!f.value),class:"input-append-button"},null,8,["icon"])]),_:1},8,["modelValue","type"])]),_:1}),c(y,{label:"Base URL",prop:"base_url"},{default:g(()=>[c(h,{modelValue:x.value.base_url,"onUpdate:modelValue":l[4]||(l[4]=e=>x.value.base_url=e),placeholder:"API 基础 URL",clearable:""},null,8,["modelValue"])]),_:1})],64)):o("",!0),"vertex"===e.type?(i(),t(n,{key:1},[c(p,{"content-position":"left"},{default:g(()=>l[12]||(l[12]=[S("认证信息")])),_:1}),c(y,{label:"区域",prop:"region"},{default:g(()=>[c(A,{modelValue:x.value.region,"onUpdate:modelValue":l[5]||(l[5]=e=>x.value.region=e),placeholder:"选择 Vertex AI 区域",filterable:"",style:{width:"100%"}},{default:g(()=>[c(L,{label:"us-central1 (美国中部)",value:"us-central1"}),c(L,{label:"us-east4 (美国东部)",value:"us-east4"}),c(L,{label:"asia-northeast1 (日本东京)",value:"asia-northeast1"}),c(L,{label:"asia-southeast1 (新加坡)",value:"asia-southeast1"}),c(L,{label:"europe-west4 (荷兰)",value:"europe-west4"}),c(L,{label:"europe-west1 (比利时)",value:"europe-west1"})]),_:1},8,["modelValue"])]),_:1}),c(y,{label:"认证方式"},{default:g(()=>[c(j,{modelValue:b.value,"onUpdate:modelValue":l[6]||(l[6]=e=>b.value=e)},{default:g(()=>[c(U,{value:"json"},{default:g(()=>l[13]||(l[13]=[S("粘贴 JSON")])),_:1}),c(U,{value:"file"},{default:g(()=>l[14]||(l[14]=[S("上传文件")])),_:1})]),_:1},8,["modelValue"])]),_:1}),"json"===b.value?(i(),u(y,{key:0,label:"服务账号 JSON",prop:"service_account_json"},{default:g(()=>[c(h,{modelValue:x.value.service_account_json,"onUpdate:modelValue":l[7]||(l[7]=e=>x.value.service_account_json=e),type:"textarea",rows:6,placeholder:'{"type": "service_account", "project_id": "...", ...}'},null,8,["modelValue"])]),_:1})):o("",!0),"file"===b.value?(i(),u(y,{key:1,label:"JSON 文件"},{default:g(()=>[c(B,{"before-upload":E,"show-file-list":!1,accept:".json",drag:""},{tip:g(()=>l[15]||(l[15]=[a("div",{class:"el-upload__tip"}," 仅支持 .json 格式的服务账号文件 ",-1)])),default:g(()=>[c(N,{class:"el-icon--upload"},{default:g(()=>[c(_(R))]),_:1}),l[16]||(l[16]=a("div",{class:"el-upload__text"},[S(" 拖拽文件到此处或 "),a("em",null,"点击上传")],-1))]),_:1}),x.value.service_account_json?(i(),u(h,{key:0,"model-value":P.value,type:"textarea",rows:3,readonly:"",style:{"margin-top":"8px"}},null,8,["model-value"])):o("",!0)]),_:1})):o("",!0),c(y,{label:"自定义模型"},{extra:g(()=>l[17]||(l[17]=[a("span",{class:"form-item-tip"}," Claude 模型必须在此配置，其他模型可自动获取 ",-1)])),default:g(()=>[c(A,{modelValue:x.value.models,"onUpdate:modelValue":l[8]||(l[8]=e=>x.value.models=e),multiple:"",filterable:"","allow-create":"",placeholder:"添加模型（可选）",style:{width:"100%"}},{default:g(()=>[c(L,{label:"gemini-2.0-flash-001",value:"gemini-2.0-flash-001"}),c(L,{label:"gemini-1.5-pro-002",value:"gemini-1.5-pro-002"}),c(L,{label:"claude-3-5-sonnet-v2@20241022",value:"claude-3-5-sonnet-v2@20241022"}),c(L,{label:"claude-3-5-haiku@20241022",value:"claude-3-5-haiku@20241022"})]),_:1},8,["modelValue"])]),_:1})],64)):o("",!0),c(p,{"content-position":"left"},{default:g(()=>l[18]||(l[18]=[S("模型配置")])),_:1}),c(oi,{modelValue:M.value,"onUpdate:modelValue":l[9]||(l[9]=e=>M.value=e),"available-models":O.value,"show-default":!0,"show-fetch-button":!0,"fetching-models":C.value,onFetchModels:$},null,8,["modelValue","available-models","fetching-models"])]),_:1},8,["model","rules"])]),_:1},8,["model-value","title"])}}},[["__scopeId","data-v-ec583ad3"]]);export{li as A,Mt as C,hs as E,ot as F,Qe as I,ys as L,Lt as R,_t as T,ge as _,Ne as a,ns as b,me as c,he as d,Es as e,ha as f,Ys as g,Te as h,Le as i,rs as p,le as s,cs as u};
//# sourceMappingURL=components-BSVhTLkb.js.map
