var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),r=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,l=(e,t)=>{for(var s in t||(t={}))a.call(t,s)&&r(e,s,t[s]);if(i)for(var s of i(t))n.call(t,s)&&r(e,s,t[s]);return e},c=(e,i)=>t(e,s(i)),d=(e,t,s)=>new Promise(((i,a)=>{var n=e=>{try{r(s.next(e))}catch(t){a(t)}},o=e=>{try{r(s.throw(e))}catch(t){a(t)}},r=e=>e.done?i(e.value):Promise.resolve(e.value).then(n,o);r((s=s.apply(e,t)).next())})),h=function(e,t){this[0]=e,this[1]=t};import{r as u,o as p,c as m,a as g,n as f,p as v,b as y,M as w,d as P,F as b,e as S,t as x,f as C,g as _,w as M,v as k,h as I,i as $,j as L,k as T,l as O,m as D}from"./vue-vendor-cI-vLX1f.js";import{l as j}from"./vendor-Ce7tLmFI.js";class A{constructor(){this.events={}}on(e,t,s=!0){s&&this.off(e),this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){this.events[e]&&this.events[e].forEach((e=>{e(t)}))}off(e){this.events[e]&&delete this.events[e]}}class q extends A{constructor(e,t){super(),this.available=null,this.url=this.getURL(),this.socket=null,this.code=t,this.id=e,this.requests=[],this.heartBeat=null,this.delay=null}getURL(){const e=new URL(window.location.href),t=e.host;return"https:"===e.protocol?`wss://${t}/api/gateway`:`ws://${t}/api/gateway`}connect(){return d(this,null,(function*(){const e={"mio-chat-id":this.id,"mio-chat-token":this.code},t=`${this.url}?${new URLSearchParams(e).toString()}`;this.socket=new WebSocket(t),this.socket.onopen=()=>{this.available=!0,this.heartBeat=setInterval((()=>d(this,null,(function*(){if(this.socket.readyState===WebSocket.OPEN){const e=yield this.fetch("/api/system/heartbeat",{timestamp:Date.now()}),t=e.revTime,s=Date.now(),i=e.delay,a=s-t;this.delay=i+a}}))),3e3)},this.socket.onclose=()=>{this.available=!1,this.disconnect(),setTimeout((()=>this.connect()),5e3)},this.socket.onerror=e=>{},this.socket.onmessage=e=>{this.messageHandler(e.data)}}))}disconnect(){this.socket&&(this.socket.close(),this.socket=null,this.available=!1,clearInterval(this.heartBeat))}send(e){this.available&&this.socket.send(e)}messageHandler(e){try{const t=JSON.parse(e);this.emit(t.request_id,t),"onebot"==t.protocol?this.emit("onebot_message",t):"system"==t.protocol&&("login"==t.type&&this.emit("connect",t.data),this.emit("system_message",t))}catch(t){}}sendObject(e){this.available&&this.socket.send(JSON.stringify(e))}genRequestID(){return Date.now().toString(36)+crypto.getRandomValues(new Uint32Array(1))[0].toString(36).substring(0,5)}fetch(e,t){return new Promise(((s,i)=>{const a=e.split("/").filter(Boolean),n=a[1],o=a[2],r=a[3];let l=this.genRequestID();const c={request_id:l,protocol:n,type:o,id:r,data:t};this.requests.push(l);const d=new Promise((e=>{setTimeout((()=>{e("timeout")}),6e4)})),h=new Promise((e=>{this.on(l,(t=>{this.requests.splice(this.requests.indexOf(l),1),e(t.data)}))}));Promise.race([d,h]).then((e=>{s(e)})).catch((e=>{i(e)})),this.sendObject(c)}))}streamCompletions(e){return s=(e,i,a,n)=>{try{var o=t[e](i),r=(i=o.value)instanceof h,l=o.done;Promise.resolve(r?i[0]:i).then((t=>r?s("return"===e?e:"next",i[1]?{done:t.done,value:t.value}:t,a,n):a({value:t,done:l}))).catch((e=>s("throw",e,a,n)))}catch(c){n(c)}},i=e=>a[e]=t=>new Promise(((i,a)=>s(e,t,i,a))),a={},t=(t=function*(){const t={request_id:this.genRequestID(),protocol:"openai",type:"completions",data:e};let s,i;this.requests.push(t.request_id),this.sendObject(t);let a=new Promise(((e,t)=>{s=e,i=t}));this.on(t.request_id,(e=>{"update"===e.message?(s(e),a=new Promise(((e,t)=>{s=e,i=t}))):"completed"!==e.message&&"failed"!==e.message||(this.off(t.request_id),i({done:!0,data:e}))}));try{for(;;){const e=yield new h(a);yield e}}catch(n){if(n.done)return void(yield n.data);throw n}}).apply(this,null),a[o("asyncIterator")]=()=>a,i("next"),i("throw"),i("return"),a;var t,s,i,a}}class R extends A{constructor(){super()}fetch(e,t){return d(this,null,(function*(){return yield V.socket.fetch(e,t)}))}}class B extends R{constructor(){super()}convertMessage(e){e.message.forEach(((t,s)=>{if("image"===t.type){const i=t.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.message[s].data.file=i}else"nodes"===t.type&&t.data.messages.forEach((e=>{if("image"===e.type){const t=e.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.data.file=t}}))}));const t=e.message.filter((e=>"reply"===e.type)),s=e.message.filter((e=>"reply"!==e.type));t.length>0&&s.push(t[0]);return{role:"other",time:(new Date).getTime(),content:s,id:e.message_id,status:"completed"}}send(e,t){return d(this,null,(function*(){return(yield this.fetch(`/api/onebot/message/${e}`,t)).message_id}))}}class E extends R{constructor(e){super(),this.settings=e.settings||{}}convertMessage(){return{role:"other",time:(new Date).getTime(),content:[{type:"blank",data:{}}],status:"pending",id:this.genRequestID()}}genRequestID(){return Math.random().toString(36).substr(2,9)}getMessagesSummary(e){return d(this,null,(function*(){const t=`请你根据以下对话的内容\n${JSON.stringify(e)}\n，总结出一个简短的对话主题,不得超出10个字。`,s={model:J.openaiDefaultConfig.model,messages:[{role:"user",content:t}]},i=yield this.fetch("/api/openai/completions",s),{chunk:a}=i;return a}))}send(e,t,s){return d(this,null,(function*(){const i=c(l({},s),{messages:e});try{for(var a,n,r,d=((e,t,s)=>(t=e[o("asyncIterator")])?t.call(e):(e=e[o("iterator")](),t={},(s=(s,i)=>(i=e[s])&&(t[s]=t=>new Promise(((s,a,n)=>(t=i.call(e,t),n=t.done,Promise.resolve(t.value).then((e=>s({value:e,done:n})),a))))))("next"),s("return"),t))(V.socket.streamCompletions(i));a=!(n=yield d.next()).done;a=!1){const e=n.value;e.data.chunk?this.emit("updateMessage",{chunk:e.data.chunk,index:t}):e.data.tool_call?this.emit("updateToolCall",{tool_call:e.data.tool_call,index:t}):"completed"==e.message?this.emit("completeMessage",{index:t}):"failed"==e.message&&this.emit("failedMessage",{error:e.data.error,index:t})}}catch(n){r=[n]}finally{try{a&&(n=d.return)&&(yield n.call(d))}finally{if(r)throw r[0]}}}))}updateSettings(e){this.settings=e}}const W="https://registry.npmmirror.com/@lobehub/icons-static-svg/latest/files/icons",z={"gpt-":"openai.svg",o3:"openai.svg",o1:"openai.svg",moon:"moonshot.svg",deepseek:"deepseek-color.svg",glm:"zhipu-color.svg",gemini:"gemini-color.svg",command:"cohere-color.svg",claude:"claude-color.svg",spark:"spark-color.svg",qwen:"qwen-color.svg",hunyuan:"hunyuan-color.svg"},U=["MODEL","CUSTOM"],F=["MODEL","CUSTOM","SUMMARY"];class H extends A{constructor(e,t){super(),this.platform=e,this.id=t.id,this.options=t.options,this.namePolicy=t.namePolicy||0,this.avatarPolicy=t.avatarPolicy||0,this.title=t.title,this.name=t.name,this.avatar=t.avatar,this.priority=t.priority,this.firstMessageIndex=0,this.messageChain=t.messageChain||[],this.active=!1,this.lastUpdate=t.lastUpdate||(new Date).getTime(),this.createTime=t.createTime||(new Date).getTime(),this.lastMessageSummary=this.getLastMessageSummary(),this.kernel="onebot"==this.platform?new B(t):new E(t),"openai"==this.platform&&this.enableOpenaiListener()}enableOpenaiListener(){this.kernel.on("updateMessage",(e=>{const{chunk:t,index:s}=e,i=this.messageChain[s];if(!i)return;const a=i.content[i.content.length-1],n=["blank","text"].includes(a.type),o={type:"text",data:{text:("text"==a.type?a.data.text:"").concat(t)}};n?i.content[i.content.length-1]=o:i.content.push(o),this.emit("updateMessage"),this.emit("updateMessageSummary")})),this.kernel.on("updateToolCall",(e=>{const{tool_call:t,index:s}=e,i=this.messageChain[s];if(!i)return;const a=i.content[i.content.length-1],n=["blank","tool_call"].includes(a.type),o="tool_call"==a.type&&a.data.id!==t.id,r={type:"tool_call",data:c(l({},t),{params:"pending"==t.action?a.data.params+=t.params:t.params})};n&&!o?i.content[i.content.length-1]=r:i.content.push(r),this.emit("updateMessage"),this.emit("updateMessageSummary")})),this.kernel.on("completeMessage",(e=>{this.updateLastUpdate();const t=e.index;this.messageChain[t]&&(this.emit("updateMessageSummary"),this.emit("completeMessage",{index:t}))})),this.kernel.on("failedMessage",(e=>{this.updateLastUpdate();const t=e.index;this.messageChain[t]&&(this.emit("updateMessageSummary"),this.emit("completeMessage",{text:"请求发生错误！\n```json\n"+e.error+"\n```\n",index:t,error:!0}))}))}send(e){return d(this,null,(function*(){yield this.kernel.send(e)}))}_getFilePrompt(e){return"以下是用户上传的文件：\n"+e.join("\n")}_getValidOpenaiMessage(){const e=this.messageChain.slice(this.firstMessageIndex,this.firstMessageIndex+this.options.max_messages_num).filter((e=>"mio_system"!=e.role)).map((e=>{const t=[],s=[];if(e.content.forEach((i=>{const a="tool_call"==i.type?"tool":"user"==e.role?"user":"assistant",n={role:a,content:void 0,_content_type:void 0};"tool"==a?(n.role="assistant",n.content=null,n.tool_calls=[{id:i.data.id,function:{name:i.data.name,arguments:i.data.params},type:"function"}],s.push(l({},n)),delete n.tool_calls,n.role="tool",n.content=JSON.stringify(i.data.result),n.tool_call_id=i.data.id,s.push(l({},n)),n.role=a):"user"!=a&&"assistant"!=a||("text"==i.type?(n.content=i.data.text,n._content_type="text",s.push(n)):"image"==i.type?(n.content=i.data.file,n._content_type="image",s.push(n)):"file"==i.type&&t.push(i.data.file))})),t.length>0){const e=s.filter((e=>"text"==e._content_type));e[0].content=e[0].content+this._getFilePrompt(t)}return s}));let t=[];return e.forEach((e=>{const s=e.filter((e=>"text"==e._content_type)),i=e.filter((e=>"image"==e._content_type)),a=e.filter((e=>"file"==e._content_type)),n=a.length>0?this._getFilePrompt(a):"";let o=null;s.length>0&&i.length>0&&"user"==i[0].role&&(o={role:"user",content:[...s.map((e=>({type:"text",text:e.content+n}))),...i.map((e=>({type:"image_url",image_url:{url:e.content}})))]}),(null==o?void 0:o.content.length)==e.length?t.push(o):(e.forEach((e=>{delete e._content_type})),t.push(...e))})),this.options.history&&(t=this.options.history.concat(t)),t}webSend(e){return d(this,null,(function*(){if(this.updateLastUpdate(),this.messageChain.push(e),"onebot"==this.platform)return yield this.kernel.send(this.id,e.content);{const e=this._getValidOpenaiMessage();this.revMessage({content:[]});const t=this.messageChain.length-1;return this.kernel.send(e,t,this.options),Math.floor(1e8*Math.random()).toString().padStart(8,"0")}}))}revMessage(e){this.updateLastUpdate();const t=this.kernel.convertMessage(e);return this.active?this.emit("revMessage",t):this.messageChain.push(t),this.emit("updateMessageSummary"),t}delMessage(e){for(let t=0;t<this.messageChain.length;t++)if(this.messageChain[t].id===e)return this.active?this.emit("delMessage",t):this.acting.messageChain.splice(t,1),this.makeSystemMessage(`${this.name}撤回了一条消息`),!0;return!1}makeSystemMessage(e){const t={role:"mio_system",time:(new Date).getTime(),id:(new Date).getTime(),content:[{type:"text",data:{text:e}}]};this.active?this.emit("revMessage",t):this.messageChain.push(t)}getLastTime(){const e=this.messageChain[this.messageChain.length-1];if(!e)return"";const t=(new Date).getTime(),s=new Date(e.time),i=t-s.getTime();if(i<864e5){this.toinit=!1;return`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`}if(i<1728e5)return"昨天";if(i<6048e5){return`星期${["日","一","二","三","四","五","六"][s.getDay()]}`}return`${s.getFullYear()}/${(s.getMonth()+1).toString().padStart(2,"0")}/${s.getDate().toString().padStart(2,"0")}`}getShownTime(e){const t=(new Date).getTime()-e;if(t<864e5){return`${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<1728e5){return`昨天${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<6048e5){const t=["日","一","二","三","四","五","六"],s=new Date(e).getDay(),i=new Date(e).getHours().toString().padStart(2,"0"),a=new Date(e).getMinutes().toString().padStart(2,"0");return`星期${t[s]}${i}:${a}`}return`${new Date(e).getFullYear()}/${(new Date(e).getMonth()+1).toString().padStart(2,"0")}/${new Date(e).getDate().toString().padStart(2,"0")} ${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}setOpenaiPresets(e){this.options.history=e}getLastMessageSummary(e){const t=e||this.messageChain[this.messageChain.length-1];return t?(e=>{switch(e.type){case"text":return e.data.text;case"image":return"[图片]";case"record":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"tool_call":return`[调用工具] ${e.data.name}`;case"blank":return"正在思考中...";case"reply":return"";default:return"[未知消息类型] "+e.type}})(t.content?t.content[0]:t):""}updateFirstMessage(){this.firstMessageIndex=this.messageChain.length}updateLastUpdate(){this.lastUpdate=(new Date).getTime()}loadAvatar(){let e="/static/avatar/miobot.png";if("MODEL"==U[this.avatarPolicy]){const t=this.options.model;e=this.getAvatarByModel(t)}else"CUSTOM"==U[this.avatarPolicy]&&(e=this.avatar);return this.avatar=e,e}loadName(){return d(this,null,(function*(){var e;let t=null!=(e=this.name)?e:"未命名 Bot";if("MODEL"==F[this.namePolicy]){t=this.options.model}else"CUSTOM"==F[this.namePolicy]?t=this.name:"SUMMARY"==F[this.namePolicy]&&(this.messageChain.length<2?t="新建的 Bot":2!=this.messageChain.length&&this.messageChain.length%6!=0||(t=yield this.getMessagesSummary()));return this.name=t,t}))}getMessagesSummary(){return"openai"==this.platform?this.kernel.getMessagesSummary(this._getValidOpenaiMessage().slice(-4)):"仅支持 OpenAI Chat Bot"}getAvatarByModel(e){const t=e.toLowerCase();for(const s in z)if(t.includes(s))return`${W}/${z[s]}`;return`${W}/openai.svg`}}function N(e){return new Worker("/assets/fileUpload-D5ijkYl9.js",{name:null==e?void 0:e.name})}j.config({name:"mio-chat"});const J=new class{constructor(){this.localPresets=[],this.openaiDefaultConfig={model:"gpt-4o-mini",stream:!0,temperature:1,top_p:1,frequency_penalty:0,presence_penalty:0,history:[],tools:[],enable_tool_call:!1,opening:"",max_messages_num:10},this.openaiTools=[],this.onebotDefaultConfig=null,this.displayConfig={},this.loadOpenaiTools(),this._loadStrogeConfig()}setDisplayConfig(e){this.displayConfig=e,localStorage.setItem("display_config",JSON.stringify(e))}updateDisplayConfig(e){this.displayConfig=l(l({},this.displayConfig),e),localStorage.setItem("display_config",JSON.stringify(this.displayConfig))}getDisplayConfig(){const e=localStorage.getItem("display_config");if(e)return JSON.parse(e)}updateOpenaiDefaultConfig(e){this.openaiDefaultConfig=l(l({},this.openaiDefaultConfig),e),this._saveStrogeConfig()}loadOpenaiTools(){return d(this,null,(function*(){const e=yield fetch("/api/openai/tools"),t=yield e.json();this.openaiTools=Object.values(t.data.tools),this._saveStrogeConfig()}))}loadOnebotDefaultConfig(){return d(this,null,(function*(){const e=yield fetch("/api/onebot/plugins"),t=yield e.json();this.onebotDefaultConfig=t.data.options,this._saveStrogeConfig()}))}_loadStrogeConfig(){const e=localStorage.getItem("config");e?Object.assign(this,JSON.parse(e)):this._saveStrogeConfig()}_saveStrogeConfig(){localStorage.setItem("config",JSON.stringify(this))}},V=new class extends A{constructor(e){super(),this.everLogin=!1,this.id=null,this.code=null,this.isConnected=!1,this.contactList=[],this.socket=null,this.qq=null,this.botqq=null,this.avatar=null,this.onPhone=null,this.models=[],this.title="Mio",this.name="user",this.displaySettings=null,this.config=e}beforeInit(){return d(this,null,(function*(){yield this.setDisplayInfo();const e=yield this.getLocalStorage();yield this.config.loadOnebotDefaultConfig(),e?(e.isConnected=!1,this.loadLocalStorage(e)):(this.id=this.genFakeId(),this.code=null),this.emit("loaded")}))}genDefaultConctor(){return d(this,null,(function*(){const e={id:this.genFakeId(),name:"OneBot",namePolicy:1,avatarPolicy:1,avatar:`/api/qava?q=${this.botqq}`,title:"云崽",priority:0,options:this.config.onebotDefaultConfig,lastUpdate:-1/0};this.addConcator("onebot",e);this.models.map((e=>({value:e.owner,label:e.owner,children:e.models.map((e=>({value:e,label:e})))})));this.config.updateOpenaiDefaultConfig({model:this.default_model});const t={id:this.genFakeId(),name:"MioBot",avatar:"/static/avatar/miobot.png",namePolicy:1,avatarPolicy:1,title:"chat",priority:0,lastUpdate:-1/0,options:l({},this.config.openaiDefaultConfig)};t.options.tools=this.config.openaiTools.map((e=>e.name)),t.options.enable_tool_call=!0,this.addConcator("openai",t)}))}addConcator(e,t){return d(this,null,(function*(){const s=new H(e,t);s.loadName(),s.loadAvatar();return u(this.contactList).push(s),yield this.setLocalStorage(),s}))}rmContactor(e){const t=u(this.contactList),s=t.findIndex((t=>t.id==e));-1!=s&&(t.splice(s,1),this.setLocalStorage())}reset(){j.clear(),localStorage.clear(),window.location.reload()}init(){return d(this,null,(function*(){this.everLogin&&(this.isConnected=!1,yield this.login(this.code))}))}getContactors(){return this.contactList}genFakeId(){if(this.id){const e=Math.floor(1e3+9e3*Math.random());return parseInt(`${this.id}${e}`)}{const e=Math.floor(1e3+9e3*Math.random());return parseInt(`1${e}`)}}getLocalStorage(){return d(this,null,(function*(){const e=yield j.getItem("client");return!!e&&JSON.parse(e)}))}loadLocalStorage(e){this.everLogin=e.everLogin,this.id=e.id,this.code=e.code,this.avatar=e.avatar,this.models=e.models,e.contactList&&0!=e.contactList.length?this.contactList=e.contactList.map((e=>new H(e.platform,e))):this.contactList=[]}setLocalStorage(){return d(this,null,(function*(){yield j.setItem("client",JSON.stringify(this))}))}login(e){return d(this,null,(function*(){return this.code=e,new Promise((e=>{const t=new q(this.id,this.code);t.on("connect",(s=>d(this,null,(function*(){this.qq=s.admin_qq,this.avatar=`/api/qava?q=${this.qq}`,this.botqq=s.bot_qq,this.default_model=s.default_model,this.models=s.models,this.everLogin=!0,this.isConnected=!0,this.socket=t,this.addMsgListener(),0==this.contactList.length&&(yield this.genDefaultConctor()),this.setLocalStorage(),e(s)})))),t.connect()}))}))}addMsgListener(){this.socket.on("onebot_message",(e=>{const t=e.data,s=t.id,i=t.content,a=t.type;if("message"==a){const e=this.getContactor(s);e&&(e.revMessage(i),this.setLocalStorage())}else if("del_msg"==a){const e=this.contactList.filter((e=>"onebot"==e.platform));for(const t of e){if(t.delMessage(i.message_id)){this.setLocalStorage();break}}}}))}logout(){return d(this,null,(function*(){this.isConnected=!1,this.socket.disconnect(),this.socket=null,this.setLocalStorage()}))}getContactor(e){var t;return null!=(t=this.contactList.find((t=>t.id==e)))?t:this.contactList[0]}setDisplayInfo(){return d(this,null,(function*(){const e=yield fetch("/api/base_info"),{data:t}=yield e.json();this.config.getDisplayConfig()||this.config.setDisplayConfig(t),this.admin_qq=t.admin_qq,this.bot_qq=t.bot_qq,this.displaySettings=t;this.onPhone=window.innerWidth<600;window.addEventListener("resize",(()=>{window.innerWidth<600&&!this.onPhone?(this.emit("device-change","mobile"),this.onPhone=!0):window.innerWidth>=600&&this.onPhone&&(this.emit("device-change","desktop"),this.onPhone=!1)}))}))}getDisplaySettings(){return this.displaySettings}getLoginHistory(){return d(this,null,(function*(){return(yield this.getLocalStorage()).everLogin}))}uploadFile(e){return d(this,arguments,(function*(e,t={}){const{isImage:s=!1,onProgress:i=null}=t;if(s||"string"==typeof e&&e.startsWith("data:"))return this.uploadImage(e);const a=e;return new Promise(((e,t)=>{const s=1048576;let n=null;const o=s=>d(this,null,(function*(){try{const t=yield fetch("/api/upload/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({totalChunks:s,md5:n,filename:a.name})});if(!t.ok)throw new Error(`HTTP error ${t.status}`);const i=yield t.json();e(i)}catch(i){t({error:`Finalization error: ${i.message}`})}})),r=(e,t,s)=>d(this,null,(function*(){return new Promise(((o,r)=>{const l=new FormData;l.append("file",e),l.append("md5",n),l.append("chunkIndex",t),l.append("totalChunks",s),l.append("filename",a.name);const c=new XMLHttpRequest;c.open("POST","/api/upload/chunk",!0),i&&(c.upload.onprogress=e=>{if(e.lengthComputable){const a=e.loaded/e.total,n=100*(t/s+1/s*a);i(Math.round(n))}}),c.onload=()=>{c.status>=200&&c.status<300?o():r(c.statusText)},c.onerror=()=>{r("Network Error")},c.send(l)}))})),l=()=>d(this,null,(function*(){if(!a||!n)return t({error:"Invalid file or missing hash"});const e=Math.ceil(a.size/s);try{for(let t=0;t<e;t++){const i=t*s,n=Math.min(i+s,a.size),o=a.slice(i,n);yield r(o,t,e)}yield o(e)}catch(i){t({error:`Upload error: ${i}`})}})),c=new N;c.postMessage({file:a,chunkSize:s}),c.onmessage=e=>{e.data.hash?(n=e.data.hash,l()):e.data.error&&(t({error:e.data.error}),c.terminate())},c.onerror=e=>{t({error:`Worker error: ${e.message}`}),c.terminate()}}))}))}uploadImage(e){return d(this,null,(function*(){const t={image:"string"==typeof e?e:yield this._convertBlobToBase64(e)};try{const e=yield fetch("/api/upload/image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok)throw new Error(`HTTP error ${e.status}`);return yield e.json()}catch(s){throw s}}))}_convertBlobToBase64(e){return d(this,null,(function*(){return new Promise(((t,s)=>{const i=new FileReader;i.onloadend=()=>t(i.result),i.onerror=s,i.readAsDataURL(e)}))}))}}(J),K=(e,t)=>{const s=e.__vccOpts||e;for(const[i,a]of t)s[i]=a;return s},X="chat",Y="profile",G="settings",Q="none",Z={data:()=>({defaultAvatar:"/api/qava?q=1099834705",processedImage:"",activePage:Q,adminAvatar:""}),computed:{isChatActive(){return this.activePage===X},isProfileActive(){return this.activePage===Y}},methods:{processImage(e){return d(this,null,(function*(){return new Promise(((t,s)=>{const i=document.createElement("canvas"),a=i.getContext("2d"),n=new Image;n.crossOrigin="anonymous",n.src=e,n.onload=()=>{i.width=n.width,i.height=n.height,a.drawImage(n,0,0);let e=.8*n.width,s=.86*n.height,o=5/24*n.width;a.beginPath(),a.arc(e,s,o,0,2*Math.PI,!0),a.clip(),a.clearRect(0,0,n.width,n.height),i.toBlob((e=>{const s=URL.createObjectURL(e);t(s)}),"image/png")},n.onerror=e=>s(e)}))}))},toChat(){return d(this,null,(function*(){this.activePage=X,this.$router.push({name:"blank"})}))},toProfile(){return d(this,null,(function*(){this.activePage=Y,this.$router.push({name:"contactors"})}))},toConfig(){return d(this,null,(function*(){this.activePage=G,this.$router.push({name:"settings"})}))},loadAvatar(e){return d(this,null,(function*(){this.adminAvatar=`/api/qava?q=${e}`;try{this.processedImage=yield this.processImage(this.adminAvatar)}catch(t){}}))},getPageStatusFromRoute(e=this.$route){return"/"===e.path||e.path.includes("/chat/")?X:"/contactors"===e.path||e.path.includes("/profile/")?Y:"/settings"===e.path?G:Q}},mounted(){this.activePage=this.getPageStatusFromRoute();const e=V.admin_qq;e?this.loadAvatar(e):V.on("loaded",(()=>{const e=V.admin_qq;this.loadAvatar(e)}),!1)},watch:{$route:{handler(e){this.activePage=this.getPageStatusFromRoute(e)},immediate:!0}}},ee=e=>(v("data-v-37e08bd5"),e=e(),y(),e),te={id:"sidebar"},se={class:"admin-avatar"},ie=ee((()=>g("div",{class:"status"},null,-1))),ae=["src"],ne={class:"options",id:"side"},oe={class:"up-half"},re=[ee((()=>g("svg",{t:"1695149921092",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"6286"},[g("path",{d:"M512 64c259.2 0 469.333333 200.576 469.333333 448s-210.133333 448-469.333333 448a484.48 484.48 0 0 1-232.725333-58.88l-116.394667 50.645333a42.666667 42.666667 0 0 1-58.517333-49.002666l29.76-125.013334C76.629333 703.402667 42.666667 611.477333 42.666667 512 42.666667 264.576 252.8 64 512 64z m0 64C287.488 128 106.666667 300.586667 106.666667 512c0 79.573333 25.557333 155.434667 72.554666 219.285333l5.525334 7.317334 18.709333 24.192-26.965333 113.237333 105.984-46.08 27.477333 15.018667C370.858667 878.229333 439.978667 896 512 896c224.512 0 405.333333-172.586667 405.333333-384S736.512 128 512 128z m-157.696 341.333333a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z m159.018667 0a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z m158.997333 0a42.666667 42.666667 0 1 1 0 85.333334 42.666667 42.666667 0 0 1 0-85.333334z","p-id":"6287"})],-1)))],le=[ee((()=>g("svg",{t:"1695150310032",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"11383"},[g("path",{d:"M800 384c0-160-128-288-288-288S224 224 224 384c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 16 6.4 35.2 25.6 38.4h6.4c16 0 28.8-9.6 32-25.6C224 784 355.2 675.2 508.8 672h6.4C672 672 800 544 800 384z m-512 0c0-124.8 99.2-224 224-224s224 99.2 224 224c0 121.6-99.2 220.8-220.8 224h-9.6C384 604.8 288 505.6 288 384z m435.2 291.2c-16-9.6-35.2-6.4-44.8 9.6-9.6 16-6.4 35.2 9.6 44.8 73.6 51.2 124.8 121.6 140.8 204.8 3.2 16 16 25.6 32 25.6h6.4c16-3.2 28.8-19.2 25.6-38.4-19.2-99.2-80-185.6-169.6-246.4z","p-id":"11384"})],-1)))],ce={class:"down-half"},de=ee((()=>g("a",{href:"https://github.com/Pretend-to/mio-chat-backend",target:"_blank",class:"side-icon"},[g("svg",{t:"1695150961459",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"16393"},[g("path",{d:"M512 42.666667A464.64 464.64 0 0 0 42.666667 502.186667 460.373333 460.373333 0 0 0 363.52 938.666667c23.466667 4.266667 32-9.813333 32-22.186667v-78.08c-130.56 27.733333-158.293333-61.44-158.293333-61.44a122.026667 122.026667 0 0 0-52.053334-67.413333c-42.666667-28.16 3.413333-27.733333 3.413334-27.733334a98.56 98.56 0 0 1 71.68 47.36 101.12 101.12 0 0 0 136.533333 37.973334 99.413333 99.413333 0 0 1 29.866667-61.44c-104.106667-11.52-213.333333-50.773333-213.333334-226.986667a177.066667 177.066667 0 0 1 47.36-124.16 161.28 161.28 0 0 1 4.693334-121.173333s39.68-12.373333 128 46.933333a455.68 455.68 0 0 1 234.666666 0c89.6-59.306667 128-46.933333 128-46.933333a161.28 161.28 0 0 1 4.693334 121.173333A177.066667 177.066667 0 0 1 810.666667 477.866667c0 176.64-110.08 215.466667-213.333334 226.986666a106.666667 106.666667 0 0 1 32 85.333334v125.866666c0 14.933333 8.533333 26.88 32 22.186667A460.8 460.8 0 0 0 981.333333 502.186667 464.64 464.64 0 0 0 512 42.666667","p-id":"16394"})])],-1))),he=[ee((()=>g("svg",{t:"1695150463577",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"15301"},[g("path",{d:"M904.533333 422.4l-85.333333-14.933333-17.066667-38.4 49.066667-70.4c14.933333-21.333333 12.8-49.066667-6.4-68.266667l-53.333333-53.333333c-19.2-19.2-46.933333-21.333333-68.266667-6.4l-70.4 49.066666-38.4-17.066666-14.933333-85.333334c-2.133333-23.466667-23.466667-42.666667-49.066667-42.666666h-74.666667c-25.6 0-46.933333 19.2-53.333333 44.8l-14.933333 85.333333-38.4 17.066667L296.533333 170.666667c-21.333333-14.933333-49.066667-12.8-68.266666 6.4l-53.333334 53.333333c-19.2 19.2-21.333333 46.933333-6.4 68.266667l49.066667 70.4-17.066667 38.4-85.333333 14.933333c-21.333333 4.266667-40.533333 25.6-40.533333 51.2v74.666667c0 25.6 19.2 46.933333 44.8 53.333333l85.333333 14.933333 17.066667 38.4L170.666667 727.466667c-14.933333 21.333333-12.8 49.066667 6.4 68.266666l53.333333 53.333334c19.2 19.2 46.933333 21.333333 68.266667 6.4l70.4-49.066667 38.4 17.066667 14.933333 85.333333c4.266667 25.6 25.6 44.8 53.333333 44.8h74.666667c25.6 0 46.933333-19.2 53.333333-44.8l14.933334-85.333333 38.4-17.066667 70.4 49.066667c21.333333 14.933333 49.066667 12.8 68.266666-6.4l53.333334-53.333334c19.2-19.2 21.333333-46.933333 6.4-68.266666l-49.066667-70.4 17.066667-38.4 85.333333-14.933334c25.6-4.266667 44.8-25.6 44.8-53.333333v-74.666667c-4.266667-27.733333-23.466667-49.066667-49.066667-53.333333z m-19.2 117.333333l-93.866666 17.066667c-10.666667 2.133333-19.2 8.533333-23.466667 19.2l-29.866667 70.4c-4.266667 10.666667-2.133333 21.333333 4.266667 29.866667l53.333333 76.8-40.533333 40.533333-76.8-53.333333c-8.533333-6.4-21.333333-8.533333-29.866667-4.266667L576 768c-10.666667 4.266667-17.066667 12.8-19.2 23.466667l-17.066667 93.866666h-57.6l-17.066666-93.866666c-2.133333-10.666667-8.533333-19.2-19.2-23.466667l-70.4-29.866667c-10.666667-4.266667-21.333333-2.133333-29.866667 4.266667l-76.8 53.333333-40.533333-40.533333 53.333333-76.8c6.4-8.533333 8.533333-21.333333 4.266667-29.866667L256 576c-4.266667-10.666667-12.8-17.066667-23.466667-19.2l-93.866666-17.066667v-57.6l93.866666-17.066666c10.666667-2.133333 19.2-8.533333 23.466667-19.2l29.866667-70.4c4.266667-10.666667 2.133333-21.333333-4.266667-29.866667l-53.333333-76.8 40.533333-40.533333 76.8 53.333333c8.533333 6.4 21.333333 8.533333 29.866667 4.266667L448 256c10.666667-4.266667 17.066667-12.8 19.2-23.466667l17.066667-93.866666h57.6l17.066666 93.866666c2.133333 10.666667 8.533333 19.2 19.2 23.466667l70.4 29.866667c10.666667 4.266667 21.333333 2.133333 29.866667-4.266667l76.8-53.333333 40.533333 40.533333-53.333333 76.8c-6.4 8.533333-8.533333 21.333333-4.266667 29.866667L768 448c4.266667 10.666667 12.8 17.066667 23.466667 19.2l93.866666 17.066667v55.466666z","p-id":"15302"}),g("path",{d:"M512 394.666667c-64 0-117.333333 53.333333-117.333333 117.333333s53.333333 117.333333 117.333333 117.333333 117.333333-53.333333 117.333333-117.333333-53.333333-117.333333-117.333333-117.333333z m0 170.666666c-29.866667 0-53.333333-23.466667-53.333333-53.333333s23.466667-53.333333 53.333333-53.333333 53.333333 23.466667 53.333333 53.333333-23.466667 53.333333-53.333333 53.333333z","p-id":"15303"})],-1)))];const ue=K(Z,[["render",function(e,t,s,i,a,n){return p(),m("div",te,[g("div",se,[ie,g("img",{src:a.processedImage,alt:"admin-avatar"},null,8,ae)]),g("div",ne,[g("div",oe,[g("div",{class:f(["icon-back",{active:n.isChatActive}])},[g("div",{onClick:t[0]||(t[0]=(...e)=>n.toChat&&n.toChat(...e)),id:"chatting"},re)],2),g("div",{class:f(["icon-back",{active:n.isProfileActive}])},[g("div",{onClick:t[1]||(t[1]=(...e)=>n.toProfile&&n.toProfile(...e)),id:"editing"},le)],2)]),g("div",ce,[de,g("div",{class:"side-icon",onClick:t[2]||(t[2]=(...e)=>n.toConfig&&n.toConfig(...e))},he)])])])}],["__scopeId","data-v-37e08bd5"]]),pe={props:{fullScreen:{type:Boolean,default:!1}},methods:{waiting(){this.$message({message:"此功能尚未开放",type:"warning"})},configFullScreen(e){this.$emit("full-screen",e)}}},me=e=>(v("data-v-a0e887d1"),e=e(),y(),e),ge=[me((()=>g("span",{class:"window-min"},"—",-1)))],fe=[me((()=>g("span",{class:"window-inmax"},[g("i",{class:"iconfont chuangkouhua"})],-1)))],ve=[me((()=>g("span",{class:"window-max"},"▢",-1)))],ye=[me((()=>g("span",{class:"window-close"},"×",-1)))];const we=K(pe,[["render",function(e,t,s,i,a,n){return p(),m("ul",{class:f({"window-controls":!0,fullscreen:s.fullScreen})},[g("li",{class:"button",onClick:t[0]||(t[0]=e=>n.waiting())},ge),s.fullScreen?(p(),m("li",{key:0,class:"button",onClick:t[1]||(t[1]=e=>n.configFullScreen(!1))},fe)):(p(),m("li",{key:1,class:"button",onClick:t[2]||(t[2]=e=>n.configFullScreen(!0))},ve)),g("li",{class:"button",onClick:t[3]||(t[3]=e=>n.waiting()),id:"close"},ye)],2)}],["__scopeId","data-v-a0e887d1"]]),Pe={data:()=>({showBox:!1,onPhone:!1}),props:{messages:Array,contactor:Object},mounted(){},components:{MdPreview:w},created(){window.innerWidth<600?this.onPhone=!0:window.innerWidth>=600&&(this.onPhone=!1),window.addEventListener("resize",(()=>{window.innerWidth<600?this.onPhone=!0:window.innerWidth>=600&&(this.onPhone=!1)}))}},be=g("div",{id:"forward-msg-head"}," 转发的聊天消息 ",-1),Se={id:"forward-msg-body"},xe={id:"forward-msg-foot"},Ce={class:"head"},_e=g("span",null,"转发消息",-1),Me={class:"body"},ke={class:"message-body",id:"other"},Ie={class:"avatar"},$e=["src","alt"],Le={class:"msg"},Te={class:"wholename"},Oe={class:"title"},De={class:"name"},je={class:"content"};const Ae=K(Pe,[["render",function(e,t,s,i,a,n){const o=P("MdPreview"),r=P("el-image");return p(),m(b,null,[g("div",{onClick:t[0]||(t[0]=e=>a.showBox=!0),class:f(a.onPhone?"on-phone":""),id:"forward-msg-preview"},[be,g("div",Se,[(p(!0),m(b,null,S(s.messages,((e,t)=>(p(),m("div",{id:"forward-msg-summary",key:t},x(s.contactor.name)+": "+x(s.contactor.getLastMessageSummary(e)),1)))),128))]),g("div",xe," 查看"+x(s.messages.length)+"条转发消息 ",1)],2),a.showBox?(p(),m("div",{key:0,id:"forward-msg-box",class:f(a.onPhone?"on-phone":"")},[g("div",Ce,[_e,g("span",{class:"close",onClick:t[1]||(t[1]=e=>a.showBox=!1)},"×")]),g("div",Me,[(p(!0),m(b,null,S(s.messages,((e,t)=>(p(),m("div",{key:t,class:"message-container"},[g("div",ke,[g("div",Ie,[g("img",{src:s.contactor.avatar,alt:s.contactor.name},null,8,$e)]),g("div",Le,[g("div",Te,[g("div",Oe,x(s.contactor.title),1),g("div",De,x(s.contactor.name),1)]),g("div",je,[g("div",null,["text"===e.type?(p(),C(o,{key:0,previewTheme:"github",editorId:"preview-only",modelValue:e.data.text},null,8,["modelValue"])):"image"===e.type?(p(),C(r,{style:{margin:"8px 0","max-width":"20rem","border-radius":"1rem"},src:e.data.file,"zoom-rate":1.2,"preview-teleported":!0,"max-scale":7,"min-scale":.2,"preview-src-list":[e.data.file],"initial-index":4,key:t,fit:"cover"},null,8,["src","preview-src-list"])):(p(),C(o,{key:2,previewTheme:"github",editorId:"preview-only",modelValue:`尚未支持的消息类型：${e.type}`},null,8,["modelValue"]))])])])])])))),128))])],2)):_("",!0)],64)}]]),qe={data:()=>({userInput:"",selectedWraper:null,selectedModel:null,selectedOptions:null,cursorPosition:[],showemoji:!1,openaiModels:null,onebotPresets:null,host:"",uploaded:{files:[],images:[]},isPasting:!1}),props:{activeContactor:{type:Object,required:!0}},computed:{extraOptions(){return"openai"==this.activeContactor.platform?this.openaiModels:this.onebotPresets}},methods:{ctrlEmojiPanel(){this.showemoji=!this.showemoji;this.$refs.textarea.focus()},uploadFile(){const e=["png","jpg","jpeg"],t=["docx","pdf","pptx","xlsx"],s=document.createElement("input");s.type="file",s.accept="";for(const i of[...t,...e])s.accept+=`.${i},`;s.click(),s.onchange=e=>d(this,null,(function*(){const t=e.target.files[0];if(t)if(t.size<=52428800){if(this.$message({message:"文件上传中...",type:"info"}),t.type.startsWith("image/"))this.handelUploadImage(t);else{const e=yield V.uploadFile(t,{onProgress:e=>{}});this.uploaded.files.push(`${e.data.url}?size=${t.size}&name=${t.name}`)}this.$message({message:"文件上传成功",type:"success"})}else this.$message({message:"文件大小超过50MB，无法上传",type:"error"})}))},handelUploadImage(e){const t=new FileReader;t.onload=t=>d(this,null,(function*(){const s=t.target.result,i=(yield V.uploadImage(s)).data.url,a=document.createElement("img");a.src=i,a.alt=e.name,a.style.maxWidth="10rem";const n=document.createRange();n.selectNodeContents(this.$refs.textarea),n.collapse(!1);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);const r=n.createContextualFragment(`<span>${a.outerHTML}</span>`);n.insertNode(r),setTimeout((()=>{const e=document.createRange();e.selectNodeContents(this.$refs.textarea),e.collapse(!1);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}),0)})),t.readAsDataURL(e)},setModel(){this.selectedModel=[...this.selectedOptions],this.$emit("setModel",this.selectedModel[1])},initExtraOptions(){this.openaiModels=V.models.map((e=>({value:e.owner,label:e.owner,children:e.models.map((e=>({value:e,label:e})))}))),this.onebotPresets=J.onebotDefaultConfig.textwraper.options,this.loadSelectedArray()},loadSelectedArray(){"openai"==this.activeContactor.platform?(this.selectedModel=this.getOpenaiModelArray(this.activeContactor.options.model),this.selectedOptions=[...this.selectedModel]):(this.selectedWraper=[""],this.selectedOptions=[...this.selectedWraper])},getOpenaiModelArray:e=>[V.models.find((t=>t.models.includes(e))).owner,e],wrapText(e){if(!this.selectedWraper)return e;if(!this.selectedWraper[this.selectedWraper.length-1])return e;return this.onebotPresets.find((e=>e.value==this.selectedWraper[0])).children.find((e=>e.value==this.selectedWraper[1])).preset.replace("{xxx}",e)},adjustTextareaHeight(){const e=this.$refs.textarea;e.style.height="auto",e.style.height=e.scrollHeight+"px"},getWraperName(){if("onebot"===this.activeContactor.platform){if(!this.selectedWraper)return"";if(!this.selectedWraper[this.selectedWraper.length-1])return"";return this.onebotPresets.find((e=>e.value==this.selectedWraper[0])).children.find((e=>e.value==this.selectedWraper[1])).preset.replace("#","").replace("{xxx}","")}return""},waiting(){this.$message({message:"此功能尚未开放",type:"warning"})},getemoji(e){const t=this.$refs.textarea;t.focus();const s=document.createRange(),i=window.getSelection();if(!i)return;const a=e.detail.unicode,n=this.cursorPosition[0],o=this.cursorPosition[1],r=this.userInput.substring(0,n),l=this.userInput.substring(o);this.userInput=r+a+l,t.innerHTML=this.userInput,setTimeout((()=>{s.setStart(t.firstChild,n+a.length),s.setEnd(t.firstChild,n+a.length),i.removeAllRanges(),i.addRange(s)}),0),this.ctrlEmojiPanel()},updateCursorPosition(){const e=window.getSelection();if(e&&e.rangeCount>0){const t=e.getRangeAt(0);this.cursorPosition[0]=t.startOffset,this.cursorPosition[1]=t.endOffset}},presend(){this.$refs.textarea.focus();const e=this.$refs.textarea.querySelectorAll("img"),t=Array.from(e).map((e=>e.src));let s=this.getSafeText(this.userInput);const i="onebot"===this.activeContactor.platform?this.wrapText(s):s;this.userInput=this.$refs.textarea.innerHTML="",this.adjustTextareaHeight();const a={role:"user",time:(new Date).getTime(),status:"completed",content:[{type:"text",data:{text:i}}]};if(t.forEach((e=>{a.content.push({type:"image",data:{file:e}})})),this.uploaded.files.forEach((e=>{a.content.push({type:"file",data:{file:this.host+e}})})),this.repliedMessage){const e={type:"reply",data:{id:this.repliedMessage.id}};a.content.push(e)}return a},send(){return d(this,null,(function*(){this.$emit("sendMessage");const e=this.presend();this.userInput="";const t=yield this.activeContactor.webSend(e);this.activeContactor.emit("updateMessageSummary"),e.id=t,this.$emit("stroge"),this.uploaded.images=[],this.uploaded.files=[]}))},getSafeText:e=>e,cleanScreen(){this.$emit("cleanScreen")},activeBotTools(){return d(this,null,(function*(){if(this.selectedWraper=[...this.selectedOptions],"onebot"===this.activeContactor.platform){const e="text",t="test",s=this.wrapText(e);this.wrapText(t)===s&&(this.userInput=this.textareaRef.value=s,yield this.send())}else this.setModel(),this.$message({message:"已切换到 "+this.selectedModel[1]+" 模型",type:"success"})}))},isValidInput:e=>e.trim().length>0,handleKeyDown(e){"Enter"===e.key&&(e.ctrlKey?this.userInput&&this.isValidInput(this.userInput)?this.send():this.$message({message:"不能发送空消息",type:"warning"}):this.userInput+="\n"),setTimeout((()=>{this.updateCursorPosition()}),0)},handleInput(){this.isPasting||(this.userInput=this.$refs.textarea.innerText)}},created(){this.initExtraOptions()},mounted(){this.textareaRef=this.$refs.textarea,this.textareaRef.addEventListener("input",this.adjustTextareaHeight),this.handlePaste=e=>{e.preventDefault(),this.isPasting=!0;for(var t=(e.clipboardData||window.clipboardData).items,s=0;s<t.length;s++)if(-1!==t[s].type.indexOf("image")){var i=t[s].getAsFile();this.handelUploadImage(i)}else if("text/plain"===t[s].type){var a=(e.originalEvent||e).clipboardData.getData("text/plain");document.execCommand("insertText",!1,a),this.userInput=this.$refs.textarea.innerText}this.isPasting=!1},document.addEventListener("paste",this.handlePaste),this.host=window.location.origin},unmounted(){this.textareaRef.removeEventListener("input",this.adjustTextareaHeight),this.textareaRef=null,document.removeEventListener("paste",this.handlePaste)},watch:{"$route.params.id"(){this.loadSelectedArray()}}},Re=e=>(v("data-v-f30fa2f4"),e=e(),y(),e),Be={class:"input-bar"},Ee={class:"options"},We={class:"bu-emoji"},ze=Re((()=>g("p",{id:"ho-emoji"},"表情",-1))),Ue={class:"bu-emoji"},Fe=Re((()=>g("p",{id:"ho-emoji"},"滑到底部",-1))),He={class:"bu-emoji"},Ne=Re((()=>g("p",{id:"ho-emoji"},"重置人格",-1))),Je={class:"bu-emoji"},Ve=Re((()=>g("p",{id:"ho-emoji"},"清除记录",-1))),Ke={class:"bu-emoji"},Xe=Re((()=>g("p",{id:"ho-emoji"},"上传",-1))),Ye={class:"bu-emoji"},Ge={id:"ho-emoji"},Qe=Re((()=>g("i",{class:"iconfont robot"},null,-1))),Ze={class:"input-box"},et={class:"input-content"},tt=["v-html"],st=["disabled"];const it=K(qe,[["render",function(e,t,s,i,a,n){const o=P("el-cascader");return p(),m("div",Be,[g("div",Ee,[g("div",We,[M(g("emoji-picker",{ref:"emojiPicker",onEmojiClick:t[0]||(t[0]=(...e)=>n.getemoji&&n.getemoji(...e))},null,544),[[k,a.showemoji]]),ze,g("i",{onClick:t[1]||(t[1]=I(((...e)=>n.ctrlEmojiPanel&&n.ctrlEmojiPanel(...e)),["prevent"])),class:"iconfont smile"})]),g("div",Ue,[Fe,g("i",{onClick:t[2]||(t[2]=t=>e.$emit("toButtom",1)),class:"iconfont download"})]),g("div",He,[Ne,g("i",{onClick:t[3]||(t[3]=t=>e.$emit("cleanHistory")),class:"iconfont reset"})]),g("div",Je,[Ve,g("i",{onClick:t[4]||(t[4]=t=>e.$emit("cleanScreen")),class:"iconfont shanchu"})]),g("div",Ke,[Xe,g("i",{onClick:t[5]||(t[5]=(...e)=>n.uploadFile&&n.uploadFile(...e)),class:"iconfont upload"})]),g("div",Ye,[g("p",Ge,x("openai"==s.activeContactor.platform?"模型选择":"工具选择"),1),$(o,{modelValue:a.selectedOptions,"onUpdate:modelValue":t[6]||(t[6]=e=>a.selectedOptions=e),options:n.extraOptions,id:"wraper-selector",onChange:n.activeBotTools},null,8,["modelValue","options","onChange"]),Qe])]),g("div",Ze,[g("div",et,[g("div",{onKeydown:t[7]||(t[7]=(...e)=>n.handleKeyDown&&n.handleKeyDown(...e)),onInput:t[8]||(t[8]=(...e)=>n.handleInput&&n.handleInput(...e)),class:"input-area",ref:"textarea","v-html":a.userInput,contenteditable:"true",placeholder:"按 Ctrl + Enter 以发送消息",onClick:t[9]||(t[9]=(...e)=>n.updateCursorPosition&&n.updateCursorPosition(...e))},null,40,tt)]),g("button",{onClick:t[10]||(t[10]=I(((...e)=>n.send&&n.send(...e)),["prevent"])),disabled:!a.userInput||!n.isValidInput(a.userInput),id:"sendButton"}," 发送"+x(n.getWraperName()?` | ${n.getWraperName()}`:""),9,st)])])}],["__scopeId","data-v-f30fa2f4"]]),at={class:"file-block"},nt={class:"file-block-icon"},ot={class:"file-icon"},rt={key:0},lt={class:"file-block-text"},ct=["title"],dt={class:"file-info"};const ht=K({data:()=>({file_name:"",file_type:"",formated_file_size:""}),props:{file_url:{type:String,required:!0}},created(){const e=this.file_url.split("?"),t=new URLSearchParams(e[1]),s=t.get("size");this.file_name=t.get("name"),this.formated_file_size=this.formatFileSize(s);const i=e[0].split(".");this.file_type=i[i.length-1]},methods:{formatFileSize(e){let t=0;for(;e>=1024;)e/=1024,t++;return e.toFixed(2)+" "+["B","KB","MB"][t]}}},[["render",function(e,t,s,i,a,n){return p(),m("div",at,[g("div",nt,[g("div",ot,[a.file_type?(p(),m("span",rt,x(a.file_type.toUpperCase()),1)):_("",!0)])]),g("div",lt,[g("div",{class:"file-name",title:a.file_name},x(a.file_name),9,ct),g("div",dt,x(a.file_type.toUpperCase())+", "+x(a.formated_file_size),1)])])}],["__scopeId","data-v-cf1d860e"]]),ut={data:()=>({showExtraInfo:!1}),computed:{tool_call_success(){var e,t;return"finished"===this.tool_call.action&&null===(null==(t=null==(e=this.tool_call)?void 0:e.result)?void 0:t.error)},tool_call_fail(){var e,t;return"finished"===this.tool_call.action&&null!==!(null==(t=null==(e=this.tool_call)?void 0:e.result)?void 0:t.error)},call_status(){return"started"==this.tool_call.action?"开始运行":"pending"==this.tool_call.action?"函数构建中":"running"==this.tool_call.action?"函数运行中":this.tool_call_success?"函数运行成功":this.tool_call_fail?"函数运行失败":"未知状态"}},props:{tool_call:{type:Object}},mounted(){}},pt=e=>(v("data-v-316bff27"),e=e(),y(),e),mt={class:"tool-call-bar"},gt={class:"status-icon"},ft={key:0,class:"call-success-icon"},vt=[pt((()=>g("div",{class:"checkmark-container"},[g("svg",{class:"checkmark",viewBox:"0 0 52 36",xmlns:"http://www.w3.org/2000/svg"},[g("polyline",{points:"1 20 15 36 51 1"})])],-1)))],yt={key:1,class:"call-fail-icon"},wt={key:2,class:"call-pend-icon"},Pt={class:"tool-info"},bt={class:"tool-name"},St={class:"tool-status"},xt={class:"extra-info"},Ct=[pt((()=>g("svg",{t:"1731677922196",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5948",width:"16",height:"16"},[g("path",{d:"M778.965749 128.759549l-383.064442 383.063419 388.097062 388.096039-0.070608 0.033769c12.709463 13.137205 20.529569 31.024597 20.529569 50.731428 0 40.376593-32.736589 73.112158-73.115228 73.112158-19.705807 0-37.591153-7.819083-50.730405-20.528546l-0.034792 0.035816L241.890654 564.622498l0.035816-0.035816c-13.779841-13.281491-22.3838-31.915897-22.3838-52.585659 0-0.071631 0-0.106424 0-0.178055 0-0.072655 0-0.10847 0-0.144286 0-20.669762 8.603959-39.341007 22.3838-52.622498l-0.035816-0.034792L680.573835 20.337187l0.180102 0.179079c13.139252-12.5662 30.950919-20.313651 50.587142-20.313651 40.378639 0 73.115228 32.736589 73.115228 73.114205C804.455283 95.485725 794.567076 115.334795 778.965749 128.759549z","p-id":"5949"})],-1)))],_t={class:"extra-detail"},Mt={class:"detail-params"},kt=pt((()=>g("div",{class:"detail-title"},"参数",-1))),It={class:"detail-content"},$t={class:"detail-result"},Lt=pt((()=>g("div",{class:"detail-title"},"返回值",-1))),Tt={class:"detail-content"};const Ot=K(ut,[["render",function(e,t,s,i,a,n){return p(),m("div",mt,[g("div",gt,[n.tool_call_success?(p(),m("span",ft,vt)):n.tool_call_fail?(p(),m("span",yt,"❌")):(p(),m("span",wt))]),g("div",Pt,[g("div",null,[g("span",bt,x(s.tool_call.name),1)]),g("div",St,x(n.call_status),1)]),g("div",xt,[g("button",{class:f({active:a.showExtraInfo,"extra-info-button":!0}),onClick:t[0]||(t[0]=e=>a.showExtraInfo=!a.showExtraInfo),ref:"show-extra-info"},Ct,2)]),g("div",{class:f({active:a.showExtraInfo,"extra-info-bar":!0})},[g("div",_t,[g("div",Mt,[kt,g("div",It,x(s.tool_call.params),1)]),g("div",$t,[Lt,g("div",Tt,x(s.tool_call.result),1)])])],2)])}],["__scopeId","data-v-316bff27"]]),Dt={data:()=>({show:!1,presetsList:[],recommendPresets:[],recentPresets:[],localPresets:[],systemPresets:[],searchPresets:[],systemShownNum:0,recommendShownNum:0,keyWord:"",activeTypeIndex:0,buttonTranslate:0,avaliablePresetTypes:["推荐","最近","本地","系统"],moreSystemPresets:!0,moreRecommendPresets:!0,observer:null}),computed:{showPresetsLoader(){return 3==this.activeTypeIndex?this.moreSystemPresets:0==this.activeTypeIndex&&this.moreRecommendPresets},shownPrestsList(){return this.keyWord?this.searchPresets:2===this.activeTypeIndex?this.localPresets:1===this.activeTypeIndex?this.recentPresets:0===this.activeTypeIndex?this.recommendPresets:3===this.activeTypeIndex?this.systemPresets:null}},methods:{addBot(e){return d(this,null,(function*(){this.strogeAddHistory(e),this.$emit("addBot",e)}))},strogeAddHistory(e){const t=this.recentPresets.find((t=>t.name===e.name));t&&this.recentPresets.splice(this.recentPresets.indexOf(t),1),this.recentPresets.unshift(e),this.recentPresets.length>6&&this.recentPresets.pop(),localStorage.setItem("addHistory",JSON.stringify(this.recentPresets))},getAddHistory(){const e=localStorage.getItem("addHistory");e&&(this.recentPresets=JSON.parse(e))},changeShownType(e){return d(this,null,(function*(){this.activeTypeIndex=e,this.buttonTranslate=49.6*e+"px",yield this.loadSpecificType()}))},close(){this.$emit("close")},loadSpecificType(){return d(this,null,(function*(){const e=this.avaliablePresetTypes[this.activeTypeIndex];this.presetsList=yield this.getPresetList(e)}))},getPresetList(e){return d(this,null,(function*(){return"系统"===e?yield this.loadSystemPresets():"推荐"===e?yield this.loadRecommendedPresets():"最近"===e?this.recentPresets:"本地"===e?this.localPresets:void 0}))},loadRecommendedPresets(){return d(this,null,(function*(){const e=yield fetch(`/api/openai/presets?type=recommended&start=${this.recommendShownNum}`).then((e=>e.json()));for(let t=0;t<e.data.length;t++)this.recommendPresets.push(e.data[t]);return this.recommendShownNum+=e.data.length,e.data.length<9&&(this.moreRecommendPresets=!1),this.recommendPresets}))},loadSystemPresets(){return d(this,null,(function*(){const e=yield fetch(`/api/openai/presets?type=system&start=${this.systemShownNum}`).then((e=>e.json()));for(let t=0;t<e.data.length;t++)this.systemPresets.push(e.data[t]);return this.systemShownNum+=e.data.length,e.data.length<9&&(this.moreSystemPresets=!1),this.systemPresets}))},loadSerachPresets(){return d(this,null,(function*(){const e=()=>d(this,null,(function*(){const e=yield fetch(`/api/openai/presets?type=search&keyword=${this.keyWord}`).then((e=>e.json()));this.searchPresets=e.data}));this.searchTimer&&clearTimeout(this.searchTimer),this.searchTimer=setTimeout((()=>{e()}),500)}))},loadMoreData(){this.showPresetsLoader&&3===this.activeTypeIndex?this.loadSystemPresets():this.showPresetsLoader&&0===this.activeTypeIndex&&this.loadRecommendedPresets()},handleScroll(){const e=this.$refs.loader;if(!e)return;const t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)&&this.loadMoreData()}},mounted(){if(this.getAddHistory(),"IntersectionObserver"in window){const e=e=>{e.forEach((e=>{e.isIntersecting&&this.loadMoreData()}))};this.observer=new IntersectionObserver(e);const t=this.$refs.loader;t&&this.observer.observe(t)}else window.addEventListener("scroll",this.handleScroll)},beforeUnmount(){this.observer?this.observer.disconnect():window.removeEventListener("scroll",this.handleScroll)}},jt=e=>(v("data-v-ac99ef6d"),e=e(),y(),e),At={class:"add-contactor"},qt={class:"head"},Rt=jt((()=>g("div",{class:"title"},"添加机器人",-1))),Bt={class:"body"},Et={class:"search"},Wt=jt((()=>g("i",{class:"iconfont sousuo listicon"},null,-1))),zt={class:"info"},Ut={class:"presets-types"},Ft=["onClick"],Ht={key:0,class:"presets-list"},Nt={class:"preset-avatar"},Jt={class:"preset-info"},Vt={class:"preset-name"},Kt=["title"],Xt={ref:"loader",class:"loading"},Yt=[jt((()=>g("div",null,null,-1))),jt((()=>g("div",null,null,-1))),jt((()=>g("div",null,null,-1))),jt((()=>g("div",null,null,-1))),jt((()=>g("div",null,null,-1)))],Gt={key:1,class:"empty-list"},Qt=jt((()=>g("div",{class:"options"},null,-1)));const Zt=K(Dt,[["render",function(e,t,s,i,a,n){const o=P("el-button"),r=P("el-empty");return p(),m("div",At,[g("div",qt,[Rt,g("div",{class:"close-icon",onClick:t[0]||(t[0]=(...e)=>n.close&&n.close(...e))},"✕")]),g("div",Bt,[g("div",Et,[Wt,M(g("input",{type:"text",placeholder:"输入搜索关键词",onInput:t[1]||(t[1]=(...e)=>n.loadSerachPresets&&n.loadSerachPresets(...e)),"onUpdate:modelValue":t[2]||(t[2]=e=>a.keyWord=e)},null,544),[[L,a.keyWord]])]),g("div",zt,[g("header",Ut,[(p(!0),m(b,null,S(a.avaliablePresetTypes,((e,t)=>(p(),m("nav",{key:t,onClick:e=>n.changeShownType(t),class:f(a.activeTypeIndex===t?"active":"")},x(e),11,Ft)))),128))]),g("div",{style:T({left:a.buttonTranslate}),class:"slide-button"},null,4),n.shownPrestsList.length>0||[0,3].includes(a.activeTypeIndex)?(p(),m("div",Ht,[(p(!0),m(b,null,S(n.shownPrestsList,((e,t)=>(p(),m("div",{class:"presets-item",key:t},[g("div",Nt,x(e.name.slice(0,2)),1),g("div",Jt,[g("div",Vt,x(e.name),1),g("div",{title:e.opening,class:"preset-description"},x(e.opening),9,Kt)]),$(o,{onClick:t=>n.addBot(e)},{default:O((()=>[D("添加")])),_:2},1032,["onClick"])])))),128)),M(g("div",Xt,Yt,512),[[k,n.showPresetsLoader]])])):(p(),m("div",Gt,[$(r,{"image-size":200})]))]),Qt])])}],["__scopeId","data-v-ac99ef6d"]]),es={data(){let e=V.getContactors();return{onPhone:window.innerWidth<600,contactorList:e,showAddOptions:!1,showAddWindow:!1}},methods:{genBotByPreset(){this.showAddOptions=!1,this.showAddWindow=!0},showChat(e){"blank"==this.$route.name||"chat_view"==this.$route.name?this.$router.push({name:"chat_view",params:{id:e}}):"contactors"==this.$route.name||"profile_view"==this.$route.name?this.$router.push({name:"profile_view",params:{id:e}}):this.$router.replace({name:"chat_view",params:{id:e}})},getId(e){return this.$route.params.id==e.id?"active":0==e.priority?"important":""},genBlankBot(){return d(this,null,(function*(){const e=l({},J.openaiDefaultConfig),t={id:this.genFakeId(),title:e.default_model,avatarPolicy:0,namePolicy:2,priority:1,options:e};this.showAddOptions=!1,yield V.addConcator("openai",t),this.addReactiveListener()}))},startResize(e){this.isResizing=!0,this.startX=e.clientX,this.startWidth=this.$refs.friendlists.offsetWidth,document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.stopResize)},resize(e){if(this.isResizing){let t=this.startWidth+(e.clientX-this.startX);const s=500,i=176;t=t>s?s:t<i?i:t,this.$refs.friendlists.style.flexBasis=t+"px"}},stopResize(){this.isResizing=!1,document.removeEventListener("mousemove",this.resize),document.removeEventListener("mouseup",this.stopResize)},genFakeId(){const e=`1${Math.floor(1e3+9e3*Math.random())}`;if(this.id){const e=Math.floor(1e3+9e3*Math.random()),t=`${this.id}${e}`;return parseInt(t)}return parseInt(e)},addPresetContactor(e){var t;const s={id:this.genFakeId(),namePolicy:1,avatarPolicy:e.customAvatar?1:0,avatar:e.customAvatar?e.customAvatar:void 0,name:e.name,title:e.title,priority:1,options:c(l({},J.openaiDefaultConfig),{model:null!=(t=e.recommendedModel)?t:V.default_model,opening:e.opening,history:e.history,textWrapper:e.textWrapper,tools:e.tools,enable_tool_call:!!e.tools})};V.addConcator("openai",s),this.addReactiveListener()},addReactiveListener(){this.contactorList.map((e=>{e.on("updateMessageSummary",(()=>{e.lastMessageSummary=e.getLastMessageSummary()}))}))}},components:{AddContactor:Zt},computed:{sortedList(){return[...this.contactorList].sort(((e,t)=>t.priority-e.priority==-1?1:t.lastUpdate-e.lastUpdate))}},mounted(){this.addReactiveListener(),setInterval((()=>{this.$message("App: "+(this.onPhone?"true":"false"))}))},beforeCreate(){0==V.getContactors().length&&V.on("loaded",(()=>{this.contactorList=V.getContactors()}),!1)}},ts={class:"upsidebar",id:"friends"},ss=(e=>(v("data-v-d16dceb4"),e=e(),y(),e))((()=>g("div",{class:"search"},[g("i",{class:"iconfont sousuo listicon"}),g("input",{type:"text",id:"tosearch",placeholder:"搜索"})],-1))),is={class:"bu-add"},as={class:"people"},ns=["onClick","id"],os=["src","alt"],rs={class:"info"},ls={class:"name"},cs={class:"msginfo",id:"time"},ds={class:"msginfo",id:"msgctt"};const hs=K(es,[["render",function(e,t,s,i,a,n){const o=P("AddContactor");return p(),m("div",{id:"friendlists",ref:"friendlists",class:f(a.onPhone?"mobile":"")},[g("div",ts,[ss,g("div",is,[g("button",{id:"addcont",onClick:t[0]||(t[0]=e=>a.showAddOptions=!a.showAddOptions)}," + "),M(g("div",{style:T({left:a.onPhone?"-6rem":"0px"}),id:"add-options"},[g("ul",null,[g("li",null,[g("button",{onClick:t[1]||(t[1]=(...e)=>n.genBlankBot&&n.genBlankBot(...e))},"新建空白Bot")]),g("li",null,[g("button",{onClick:t[2]||(t[2]=(...e)=>n.genBotByPreset&&n.genBotByPreset(...e))},"从预设新建Bot")])])],4),[[k,a.showAddOptions]])])]),g("div",as,[(p(!0),m(b,null,S(n.sortedList,((e,t)=>(p(),m("div",{onClick:t=>n.showChat(e.id),key:t,class:"lists",id:n.getId(e)},[g("div",{class:f(["avatar",1==e.avatarPolicy?"custom":"model"])},[g("img",{src:e.avatar,alt:e.name},null,8,os)],2),g("div",rs,[g("div",ls,x(e.name),1),g("div",cs,x(e.getLastTime()),1),g("div",ds,x(e.lastMessageSummary),1)])],8,ns)))),128))]),g("div",{class:"resizer",onMousedown:t[3]||(t[3]=(...e)=>n.startResize&&n.startResize(...e))},null,32),a.showAddWindow?(p(),C(o,{key:0,onClose:t[4]||(t[4]=e=>a.showAddWindow=!1),onAddBot:n.addPresetContactor},null,8,["onAddBot"])):_("",!0)],2)}],["__scopeId","data-v-d16dceb4"]]),us={class:"presets-list"},ps={class:"preset-message-block"},ms=["onMouseover"],gs={key:0,class:"avatar-emoji"},fs=["onInput"],vs={class:"messages-buttons"};const ys=K({data(){return{presetMessages:[...this.presetsHistory],hoveredIndex:void 0}},methods:{delPresetMessage(){this.presetMessages.splice(this.hoveredIndex,1),this.$emit("updatePresetsHistory",this.presetMessages)},addPresetMessage(e){"system"==e&&this.presetMessages.length>0?this.$message.warning("系统消息必须是第一条消息"):(this.presetMessages.push({role:e,content:""}),this.$emit("updatePresetsHistory",this.presetMessages))},getMessageAvatar:e=>"assistant"==e?"🤖":"system"==e?"⚙️":"👤",handleMessageUpdate(e){this.presetMessages[e].content=this.$refs[`message-${e}`][0].innerText,this.$emit("updatePresetsHistory",this.presetMessages)}},props:{presetsHistory:{type:Array,default:()=>[]}},watch:{presetsHistory(e){this.presetMessages=[...e]}}},[["render",function(e,t,s,i,a,n){const o=P("el-button");return p(),m("div",us,[(p(!0),m(b,null,S(a.presetMessages,((e,s)=>(p(),m("div",{key:s,class:"preset-message"},[g("div",ps,[g("div",{class:"message-avatar",onMouseover:e=>a.hoveredIndex=s,onMouseleave:t[1]||(t[1]=e=>a.hoveredIndex=null)},[a.hoveredIndex!=s?(p(),m("div",gs,x(n.getMessageAvatar(e.role)),1)):(p(),m("div",{key:1,onClick:t[0]||(t[0]=(...e)=>n.delPresetMessage&&n.delPresetMessage(...e)),title:"删除消息",class:"avatar-emoji hovered"},"🗑️"))],40,ms),g("div",{class:"message-content",ref_for:!0,ref:`message-${s}`,onInput:e=>n.handleMessageUpdate(s),contenteditable:"true"},x(a.presetMessages[s].content),41,fs)])])))),128)),g("div",vs,[$(o,{onClick:t[2]||(t[2]=e=>n.addPresetMessage("system")),title:"添加系统消息",plain:""},{default:O((()=>[D("➕ ⚙️")])),_:1}),$(o,{onClick:t[3]||(t[3]=e=>n.addPresetMessage("assistant")),title:"添加助手消息",plain:""},{default:O((()=>[D("➕ 🤖")])),_:1}),$(o,{onClick:t[4]||(t[4]=e=>n.addPresetMessage("user")),title:"添加用户消息",plain:""},{default:O((()=>[D("➕ 👤")])),_:1})])])}],["__scopeId","data-v-ea322baa"]]);export{Ae as F,it as I,ys as P,Ot as T,K as _,ht as a,J as b,V as c,we as d,hs as f,ue as s};
