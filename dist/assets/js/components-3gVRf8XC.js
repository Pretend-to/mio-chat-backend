import{r as e,o as t,c as s,a,n as i,M as n,b as o,F as r,d as l,t as c,e as d,f as h,w as m,v as g,g as p,h as u,i as f,j as y,k as v,l as w}from"./vue-vendor-C9tKH67p.js";import{l as C}from"./vendor-BDDHlY_N.js";class b{constructor(){this.events={}}on(e,t,s=!0){s&&this.off(e),this.events[e]||(this.events[e]=[]),this.events[e].push(t)}emit(e,t){this.events[e]&&this.events[e].forEach((e=>{e(t)}))}off(e){this.events[e]&&delete this.events[e]}}function M(e){let t="";const s="0123456789";for(let a=0;a<e;a++)t+=s.charAt(Math.floor(10*Math.random()));return t}function S(e){let t="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let a=0;a<e;a++)t+=s.charAt(Math.floor(62*Math.random()));return t}class x{constructor(e={}){this.maxRetries=e.maxRetries||10,this.baseDelay=e.baseDelay||1e3,this.maxDelay=e.maxDelay||3e4,this.retryCount=0,this.timer=null}getNextDelay(){return Math.min(this.maxDelay,this.baseDelay*Math.pow(2,this.retryCount))+1e3*Math.random()}reset(){this.retryCount=0,this.timer&&(clearTimeout(this.timer),this.timer=null)}canRetry(){return this.retryCount<this.maxRetries}async retry(e){if(!this.canRetry())throw new Error("已达到最大重试次数");const t=this.getNextDelay();return this.retryCount++,await new Promise((e=>{this.timer=setTimeout(e,t)})),e()}}class k extends b{constructor(e,t){super(),this.available=null,this.url=this.getURL(),this.socket=null,this.code=t,this.id=e,this.requests=[],this.heartBeat=null,this.delay=null,this.retryManager=new x({maxRetries:10,baseDelay:1e3,maxDelay:3e4}),this.connectionState="disconnected",this.hasSuccessfulWebSocket=!1}getURL(){return new URL(window.location.href).host}initEventListeners(){this.socket.on("connect",(()=>this.handleConnect())),this.socket.on("disconnect",(()=>this.handleDisconnect())),this.socket.on("connect_error",(e=>this.handleConnectError(e))),this.socket.on("message",(e=>this.messageHandler(e)))}handleConnect(){this.available=!0,this.connectionState="connected","websocket"===this.socket?.io?.engine?.transport?.name&&(this.hasSuccessfulWebSocket=!0),this.retryManager.reset(),this.startHeartbeat()}handleDisconnect(){this.available=!1,this.connectionState="disconnected",this.stopHeartbeat(),this.attemptReconnect()}handleConnectError(e){"websocket"===this.socket?.io?.engine?.transport?.name?this.hasSuccessfulWebSocket?this.attemptReconnect():this.switchToPolling():(this.connectionState="failed",this.disconnect())}switchToPolling(){this.disconnect();const e=io(this.url,{path:"/socket.io",transports:["polling"],auth:{id:this.id,token:this.code}});this.socket=e,this.initEventListeners()}async attemptReconnect(){if("reconnecting"!==this.connectionState){this.connectionState="reconnecting";try{await this.retryManager.retry((()=>this.connect()))}catch(e){this.connectionState="failed",this.emit("reconnect_failed")}}}async connect(){this.socket=io(this.url,{path:"/socket.io",transports:["websocket","polling"],auth:{id:this.id,token:this.code},reconnectionAttempts:0}),this.initEventListeners()}startHeartbeat(){this.heartBeat=setInterval((async()=>{if(this.socket?.connected)try{const e=await this.fetch("/api/system/heartbeat",{timestamp:Date.now()});this.updateDelay(e)}catch(e){this.connectionState}}),3e3)}updateDelay(e){const t=e.revTime,s=Date.now(),a=e.delay,i=s-t;this.delay=a+i}stopHeartbeat(){this.heartBeat&&(clearInterval(this.heartBeat),this.heartBeat=null)}disconnect(){this.socket&&(this.socket.close(),this.socket=null,this.available=!1,this.stopHeartbeat())}messageHandler(e){try{const t=JSON.parse(e);"llm"===t.protocol&&this.emit(t.request_id,t),"onebot"===t.protocol?this.emit("onebot_message",t):"system"===t.protocol&&("login"===t.type&&this.emit("connect",t.data),this.emit("system_message",t))}catch(t){}}sendMessage(e){this.available&&this.socket.emit("message",JSON.stringify(e))}fetch(e,t){return new Promise(((s,a)=>{const i=e.split("/").filter(Boolean),n={request_id:S(16),protocol:i[1],type:i[2],id:i[3],data:t};this.requests.push(n.request_id);const o=new Promise(((e,t)=>{setTimeout((()=>t("timeout")),6e4)})),r=new Promise((e=>{this.on(n.request_id,(t=>{this.requests.splice(this.requests.indexOf(n.request_id),1),e(t.data)}))}));Promise.race([o,r]).then(s).catch(a),this.sendMessage(n)}))}async*streamCompletions(e){const t={request_id:S(16),protocol:"llm",type:"completions",data:e};this.requests.push(t.request_id),this.sendMessage(t);try{for(;;){const e=await new Promise(((e,s)=>{this.on(t.request_id,(a=>{"update"===a.message?e(a):"complete"!==a.message&&"failed"!==a.message||(this.off(t.request_id),s({done:!0,data:a}))}))}));yield e}}catch(s){if(s.done)return void(yield s.data);throw s}}}class P extends b{constructor(){super()}async fetch(e,t){return await H.socket.fetch(e,t)}}class I extends P{constructor(){super()}convertMessage(e){e.message.forEach(((t,s)=>{if("image"===t.type){const a=t.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.message[s].data.file=a}else"nodes"===t.type&&t.data.messages.forEach((e=>{if("image"===e.type){const t=e.data.file.replace(/^base64:\/\//,"data:image/jpeg;base64,");e.data.file=t}}))}));const t=e.message.filter((e=>"reply"===e.type)),s=e.message.filter((e=>"reply"!==e.type));t.length>0&&s.push(t[0]);return{role:"other",time:(new Date).getTime(),content:s,id:e.message_id,status:"completed"}}async send(e,t){return(await this.fetch(`/api/onebot/message/${e}`,t)).message_id}}class L extends P{constructor(e){super(),this.settings=e.settings||{}}convertMessage(e){return{...{role:"other",time:(new Date).getTime(),content:[{type:"blank",data:{}}],status:"pending",id:M(16)},...e}}async getMessagesSummary(e){const t=`请你根据以下对话的内容\n${JSON.stringify(e)}\n，总结出一个简短的对话主题,不得超出10个字。`,s={model:F.LLMDefaultConfig.model,messages:[{role:"user",content:t}]},a=await this.fetch("/api/llm/completions",s),{content:i}=a;return i}async send(e,t,s){const a=(e,s)=>{this.emit(e,{...s,messageId:t})},i=e=>{const t={reasoningContent:e=>a("updateReasoning",{reasoning_content:e}),content:e=>a("updateMessage",{chunk:e}),toolCall:e=>a("updateToolCall",{tool_call:e})},s=e.data,i=t[s.type];i&&i(s.content)},n=e=>{const t={complete:()=>a("completeMessage",{}),failed:()=>a("failedMessage",{error:e.data})}[e.message];t&&t()},o=e=>{const t=["top_p","temperature","stream","model","frequency_penalty","presence_penalty"],s=["tools","provider"];return e?Object.fromEntries(Object.entries(e).filter((([e])=>t.includes(e)||s.includes(e)))):{}};try{const t={...o(s||{}),messages:e};s?.enable_tool_call||(t.tools=[]);for await(const e of H.socket.streamCompletions(t))if("update"===e.message)i(e);else if(["complete","failed"].includes(e.message)){n(e);break}}catch(r){a("failedMessage",{error:"Stream processing error"})}}updateSettings(e){this.settings=e}}const _="https://registry.npmmirror.com/@lobehub/icons-static-svg/latest/files/icons",T={OpenAI:"openai.svg",Cohere:"cohere-color.svg",Anthropic:"claude-color.svg",Google:"gemini-color.svg","X.AI":"grok.svg",DeepSeek:"deepseek-color.svg","智谱清言":"zhipu-color.svg","豆包":"doubao-color.svg","月之暗面 (kimi)":"moonshot.svg","科大讯飞":"spark-color.svg","通义千问":"qwen-color.svg","腾讯混元":"hunyuan-color.svg"},$=["MODEL","CUSTOM"],O=["MODEL","CUSTOM","SUMMARY"];class R extends b{constructor(e,t){super(),this.platform=e,this.id=t.id,this.options=t.options,this.namePolicy=t.namePolicy||0,this.avatarPolicy=t.avatarPolicy||0,this.title=t.title,this.name=t.name,this.avatar=t.avatar,this.priority=t.priority,this.firstMessageIndex=0,this.messageChain=t.messageChain||[],this.active=!1,this.lastUpdate=t.lastUpdate||(new Date).getTime(),this.createTime=t.createTime||(new Date).getTime(),this.lastMessageSummary=this.getLastMessageSummary(),this.kernel="onebot"==this.platform?new I(t):new L(t),"openai"==this.platform&&this.enableOpenaiListener()}toJSON(){return{platform:this.platform,id:this.id,options:this.options,namePolicy:this.namePolicy,avatarPolicy:this.avatarPolicy,title:this.title,name:this.name,avatar:this.avatar,priority:this.priority,messageChain:this.messageChain,active:this.active,lastUpdate:this.lastUpdate,createTime:this.createTime,lastMessageSummary:this.lastMessageSummary}}enableOpenaiListener(){this.kernel.on("updateReasoning",(e=>{const{reasoning_content:t,messageId:s}=e,a=this.getMessageById(s);if(!a)return;const i=a.content.findIndex((e=>"reason"===e.type)),n={type:"reason",data:{text:t,startTime:(new Date).getTime(),endTime:0}};-1!==i?(n.data.text=a.content[i].data.text+t,n.data.startTime=a.content[i].data.startTime,a.content[i]=n):"blank"===a.content[0].type?a.content[0]=n:a.content.push(n),this.emit("updateMessage"),this.emit("updateMessageSummary")})),this.kernel.on("updateMessage",(e=>{const{chunk:t,messageId:s}=e,a=this.getMessageById(s);if(!a)return;a.content.forEach((e=>{"reason"!=e.type||e.data.endTime||(e.data.endTime=(new Date).getTime())}));const i=a.content[a.content.length-1],n=["blank","text"].includes(i.type),o={type:"text",data:{text:("text"==i.type?i.data.text:"").concat(t)}};n?a.content[a.content.length-1]=o:a.content.push(o),this.emit("updateMessage"),this.emit("updateMessageSummary")})),this.kernel.on("updateToolCall",(e=>{const{tool_call:t,messageId:s}=e,a=this.getMessageById(s);if(!a)return;const i=a.content[a.content.length-1],n={type:"tool_call",data:t};if("blank"==i.type)a.content[0]=n;else{const e=a.content.find((e=>e.data.id==t.id));e?(e.data=t,"pending"==t.action&&(e.data.params+=t.params)):a.content.push(n)}this.emit("updateMessage"),this.emit("updateMessageSummary")})),this.kernel.on("completeMessage",(e=>{this.updateLastUpdate();const t=e.messageId;this.getMessageById(t)&&(this.emit("updateMessageSummary"),this.emit("completeMessage",{messageId:t}))})),this.kernel.on("failedMessage",(e=>{this.updateLastUpdate();const t=e.messageId;this.getMessageById(t)&&(this.emit("updateMessageSummary"),this.emit("completeMessage",{text:"请求发生错误！\n```json\n"+e.error+"\n```\n",messageId:t,error:!0}))}))}async send(e){await this.kernel.send(e)}_getFilePrompt(e){return"以下是用户上传的文件：\n"+e.join("\n")}_getValidOpenaiMessage(e=this.firstMessageIndex,t=this.messageChain.length,s=this.options.max_messages_num){const a=this.messageChain.slice(e,t).slice(-s).filter((e=>"mio_system"!=e.role)).map((e=>{const t=[],s=[];if(e.content.forEach((a=>{const i="tool_call"==a.type?"tool":"user"==e.role?"user":"assistant",n={role:i,content:"none",_content_type:void 0};"tool"==i?(n.role="assistant",n.content=null,n.tool_calls=[{id:a.data.id,function:{name:a.data.name,arguments:a.data.params},type:"function"}],s.push({...n}),delete n.tool_calls,n.role="tool",n.content=JSON.stringify(a.data.result),n.tool_call_id=a.data.id,s.push({...n}),n.role=i):"user"!=i&&"assistant"!=i||("text"==a.type?(n.content=a.data.text,n._content_type="text",s.push(n)):"image"==a.type?(n.content=a.data.file,n._content_type="image",s.push(n)):"file"==a.type&&t.push(a.data.file))})),t.length>0){const e=s.filter((e=>"text"==e._content_type));e[0].content=e[0].content+this._getFilePrompt(t)}return s}));let i=[];return a.forEach((e=>{const t=e.filter((e=>"text"==e._content_type)),s=e.filter((e=>"image"==e._content_type)),a=e.filter((e=>"file"==e._content_type)),n=a.length>0?this._getFilePrompt(a):"";let o=null;t.length>0&&s.length>0&&"user"==s[0].role&&(o={role:"user",content:[...t.map((e=>({type:"text",text:e.content+n}))),...s.map((e=>({type:"image_url",image_url:{url:e.content}})))]}),o?.content.length==e.length?i.push(o):(e.forEach((e=>{delete e._content_type})),i.push(...e))})),this.options.history&&(i=this.options.history.concat(i)),i}updateMessageSummary(){this.lastMessageSummary=this.getLastMessageSummary()}async webSend(e){if(this.updateLastUpdate(),this.messageChain.push(e),this.updateMessageSummary(),"onebot"==this.platform){return await this.kernel.send(this.id,e.content)}{const e=this._getValidOpenaiMessage(),t=M(16);return this.revMessage({id:t}),this.kernel.send(e,t,this.options),M(16)}}async retryMessage(e){const t=this.getMessageById(e);if(t){t.content=[{type:"blank"}],this.updateLastUpdate();const s=this.messageChain.indexOf(t),a=this._getValidOpenaiMessage(0,s);return this.kernel.send(a,e,this.options),!0}}revMessage(e){this.updateLastUpdate();const t=this.kernel.convertMessage(e);return this.active?this.emit("revMessage",t):this.messageChain.push(t),this.emit("updateMessageSummary"),t}delMessage(e){for(let t=0;t<this.messageChain.length;t++)if(this.messageChain[t].id===e)return this.active?this.emit("delMessage",t):this.acting.messageChain.splice(t,1),this.makeSystemMessage(`${this.name}撤回了一条消息`),!0;return!1}makeSystemMessage(e){const t={role:"mio_system",time:(new Date).getTime(),id:(new Date).getTime(),content:[{type:"text",data:{text:e}}]};this.active?this.emit("revMessage",t):this.messageChain.push(t)}getLastTime(){const e=this.messageChain[this.messageChain.length-1];if(!e)return"";const t=(new Date).getTime(),s=new Date(e.time),a=t-s.getTime();if(a<864e5){this.toinit=!1;return`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`}if(a<1728e5)return"昨天";if(a<6048e5){return`星期${["日","一","二","三","四","五","六"][s.getDay()]}`}return`${s.getFullYear()}/${(s.getMonth()+1).toString().padStart(2,"0")}/${s.getDate().toString().padStart(2,"0")}`}getShownTime(e){const t=(new Date).getTime()-e;if(t<864e5){return`${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<1728e5){return`昨天${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}if(t<6048e5){const t=["日","一","二","三","四","五","六"],s=new Date(e).getDay(),a=new Date(e).getHours().toString().padStart(2,"0"),i=new Date(e).getMinutes().toString().padStart(2,"0");return`星期${t[s]}${a}:${i}`}return`${new Date(e).getFullYear()}/${(new Date(e).getMonth()+1).toString().padStart(2,"0")}/${new Date(e).getDate().toString().padStart(2,"0")} ${new Date(e).getHours().toString().padStart(2,"0")}:${new Date(e).getMinutes().toString().padStart(2,"0")}`}getLastMessageSummary(e){const t=e||this.messageChain[this.messageChain.length-1];return t?(e=>{switch(e.type){case"text":case"reason":return e.data.text;case"image":return"[图片]";case"record":return"[语音]";case"video":return"[视频]";case"file":return"[文件]";case"tool_call":return`[调用工具] ${e.data.name}`;case"blank":return"正在思考中...";case"reply":return"";case"nodes":return"[转发消息]";default:return"[未知消息类型] "+e.type}})(t.content?t.content[0]:t):""}updateFirstMessage(){this.firstMessageIndex=this.messageChain.length}updateLastUpdate(){this.lastUpdate=(new Date).getTime()}getMessageById(e){return this.messageChain.find((t=>t.id===e))}loadAvatar(){let e="/static/avatar/miobot.png";if("MODEL"==$[this.avatarPolicy]){const t=this.options.model;e=R.getAvatarByModel(t)}else"CUSTOM"==$[this.avatarPolicy]&&(e=this.avatar);return this.avatar=e,e}async loadName(){let e=this.name??"未命名 Bot";if("MODEL"==O[this.namePolicy]){e=this.options.model}else"CUSTOM"==O[this.namePolicy]?e=this.name:"SUMMARY"==O[this.namePolicy]&&(this.messageChain.length<2?e="新建的 Bot":2!=this.messageChain.length&&this.messageChain.length%6!=0||(e=await this.getMessagesSummary()));return this.name=e,e}getMessagesSummary(){return"openai"==this.platform?this.kernel.getMessagesSummary(this._getValidOpenaiMessage().slice(-4)):"仅支持 OpenAI Chat Bot"}static getAvatarByModel(e){const t=F.getModelOwner(e);return Object.keys(T).includes(t)?`${_}/${T[t]}`:`${_}/openai.svg`}}function D(e){return new Worker("/assets/fileUpload-D5ijkYl9.js",{name:e?.name})}C.config({name:"mio-chat"});const E="auto",B="HARM_BLOCK_THRESHOLD_UNSPECIFIED",A={HARASSMENT:"HARM_CATEGORY_HARASSMENT",HATE_SPEECH:"HARM_CATEGORY_HATE_SPEECH",SEXUALLY_EXPLICIT:"HARM_CATEGORY_SEXUALLY_EXPLICIT",DANGEROUS_CONTENT:"HARM_CATEGORY_DANGEROUS_CONTENT",CIVIC_INTEGRITY:"HARM_CATEGORY_CIVIC_INTEGRITY"},j="config";const F=new class{constructor(){this.localPresets=[],this.toolsConfig={},this.llmTools=[],this.onebotConfig=null,this.llmModels=[],this.safetyConfig={},this.baseConfig={},this.LLMDefaultConfig={},this.initSafetyConfig(),this.initLLMDefaultConfig(),this._loadStrogeConfig(),this.loadllmTools(),this.loadonebotConfig()}_setLocalStorage(e,t){localStorage.setItem(e,JSON.stringify(t))}_getLocalStorage(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}_saveStrogeConfig(){const e={localPresets:this.localPresets,toolsConfig:this.toolsConfig,llmTools:this.llmTools,onebotConfig:this.onebotConfig,llmModels:this.llmModels,baseConfig:this.baseConfig,safetyConfig:this.safetyConfig,LLMDefaultConfig:this.LLMDefaultConfig};this._setLocalStorage(j,e)}_loadStrogeConfig(){const e=this._getLocalStorage(j);e?Object.assign(this,e):this._saveStrogeConfig()}setBaseConfig(e){this.baseConfig=e,this._saveStrogeConfig()}updateBaseConfig(e){this.baseConfig={...this.displayConfig,...e},this._saveStrogeConfig()}getBaseConfig(){return this.baseConfig}setLlmModels(e){this.llmModels=e,this._saveStrogeConfig()}getLlmModels(){return this.llmModels}getModelOwner(e){const t=this.llmModels.find((t=>t.models.includes(e)));return t?.owner}initSafetyConfig(){if(0===Object.keys(this.safetyConfig).length){this.safetyConfig={};for(const e in A)this.safetyConfig[A[e]]=B}}setSafetyConfig(e){this.safetyConfig=e,this._saveStrogeConfig()}getSafetyConfig(){return this.safetyConfig}initLLMDefaultConfig(){0===Object.keys(this.LLMDefaultConfig).length&&(this.LLMDefaultConfig={provider:"openai",base:{model:"gpt-4o-mini",max_messages_num:10,stream:!0},chatParams:{temperature:1,top_p:1,frequency_penalty:0,presence_penalty:0},toolCallSettings:{mode:E,avaliable:[]},presetSettings:{opening:"",history:[]},safetySettings:{...this.safetyConfig}})}updateLLMDefaultConfig(e){this.LLMDefaultConfig={...this.LLMDefaultConfig,...e},this._saveStrogeConfig()}getLLMDefaultConfig(){return JSON.parse(JSON.stringify(this.LLMDefaultConfig))}async loadllmTools(){const e=await fetch("/api/openai/tools"),t=await e.json();this.llmTools=Object.values(t.data.tools),this._saveStrogeConfig()}async loadonebotConfig(){const e=await fetch("/api/onebot/plugins"),t=await e.json();this.onebotConfig=t.data.options,this._saveStrogeConfig()}},H=new class extends b{constructor(e){super(),this.inited=!1,this.id=null,this.code=null,this.isConnected=!1,this.contactList=[],this.socket=null,this.qq=null,this.bot_qq=null,this.avatar=null,this.onPhone=null,this.title="Mio",this.name="user",this.config=e}async preInit(){const e=this.config.getBaseConfig();0===Object.keys(e).length?await this.loadOriginBaseInfo():(this.loadOriginBaseInfo(),this.loadBaseInfo(e));const t=await this.getLocalStorage();t&&this.loadLocalStorage(t),this.inited=!0,this.emit("loaded")}genDefaultConctor(){const e={id:this.genFakeId(),name:"OneBot",namePolicy:1,avatarPolicy:1,avatar:`/p/qava?q=${this.bot_qq}`,title:"云崽",priority:0,options:{},lastUpdate:-Infinity};this.addConcator("onebot",e),this.config.updateLLMDefaultConfig({model:this.default_model});const t={id:this.genFakeId(),name:"MioBot",avatar:"/static/avatar/miobot.png",namePolicy:1,avatarPolicy:1,title:"chat",priority:0,lastUpdate:-Infinity,options:{...this.config.LLMDefaultConfig}};t.options.tools=this.config.llmTools.map((e=>e.name)),t.options.enable_tool_call=!0,this.addConcator("openai",t)}async addConcator(t,s){const a=new R(t,s);a.loadName(),a.loadAvatar();return e(this.contactList).push(a),await this.setLocalStorage(),a}rmContactor(t){const s=e(this.contactList),a=s.findIndex((e=>e.id==t));-1!=a&&(s.splice(a,1),this.setLocalStorage())}async loadOriginalContactors(e){const t=`/api/share?id=${e}`;let s=null;try{const e=await fetch(t),a=await e.json();return 0==a.code&&(s=a.data.contactor,this.getContactor(s.id)||this.addConcator(s.platform,s)),!0}catch(a){return!1}}async shareContactor(e){const t=await this.setOriginalContactor(e);if(t){const{previewImage:e,shareUrl:s}=t,a=document.location.origin,i=navigator.clipboard;return i&&i.writeText(a+s),t}return null}async setOriginalContactor(e){const t={contactor:this.getContactor(e)};try{const e=await fetch("/api/share/set",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),s=await e.json();if(0==s.code)return s.data}catch(s){return null}}reset(){C.clear(),localStorage.clear(),window.location.reload()}everLogin(){return!!localStorage.getItem("everLogin")}setEverLogin(){localStorage.setItem("everLogin",!0)}async init(){await this.preInit(),this.everLogin()&&(this.isConnected=!1,this.login(this.code))}getContactors(){return this.contactList}getContactor(e,t=null){return t?this.contactList.find((e=>"onebot"==e.platform)):this.contactList.find((t=>t.id==e))}genFakeId(){if(this.id){const e=Math.floor(1e3+9e3*Math.random());return parseInt(`${this.id}${e}`)}{const e=Math.floor(1e3+9e3*Math.random());return parseInt(`1${e}`)}}async getLocalStorage(){const e=await C.getItem("client");if(e){return JSON.parse(e)}return this.id=this.genFakeId(),this.code=null,null}loadLocalStorage(e){this.id=e.id,this.code=e.code,e.contactList&&0!=e.contactList.length?this.contactList=e.contactList.map((e=>new R(e.platform,e))):this.contactList=[]}async setLocalStorage(){const e={id:this.id,code:this.code,contactList:this.contactList};await C.setItem("client",JSON.stringify(e))}async login(e){return this.code=e,new Promise((e=>{const t=new k(this.id,this.code);t.on("connect",(async s=>{this.default_model=s.default_model,this.isConnected=!0,this.socket=t,this.config.setLlmModels(s.models),this.addMsgListener(),this.config.updateLLMDefaultConfig({model:s.default_model}),0==this.contactList.length&&this.genDefaultConctor(),this.setEverLogin(),this.setLocalStorage(),e(s)})),t.connect()}))}addMsgListener(){this.socket.on("onebot_message",(e=>{const t=e.data,s=t.id,a=t.content,i=t.type;if("message"==i){const e=this.getContactor(s,1e4);e&&(e.revMessage(a),this.setLocalStorage())}else if("del_msg"==i){const e=this.contactList.filter((e=>"onebot"==e.platform));for(const t of e){if(t.delMessage(a.message_id)){this.setLocalStorage();break}}}}))}async logout(){this.isConnected=!1,this.socket.disconnect(),this.socket=null,this.setLocalStorage()}async loadOriginBaseInfo(){const e=await fetch("/api/base_info"),{data:t}=await e.json();return this.config.setBaseConfig(t),this.loadBaseInfo(t),t}loadBaseInfo(e){this.admin_qq=e.admin_qq,this.bot_qq=e.bot_qq,this.avatar=`/p/qava?q=${this.admin_qq}`;const t=this.getContactor(null,1e4);t&&(t.avatar=`/p/qava?q=${this.bot_qq}`)}async uploadFile(e,t={}){const{isImage:s=!1,onProgress:a=null}=t;if(s||"string"==typeof e&&e.startsWith("data:"))return this.uploadImage(e);const i=e;return new Promise(((e,t)=>{const s=1048576;let n=null;const o=async(e,t,s)=>new Promise(((o,r)=>{const l=new FormData;l.append("file",e),l.append("md5",n),l.append("chunkIndex",t),l.append("totalChunks",s),l.append("filename",i.name);const c=new XMLHttpRequest;c.open("POST","/api/upload/chunk",!0),a&&(c.upload.onprogress=e=>{if(e.lengthComputable){const i=e.loaded/e.total,n=100*(t/s+1/s*i);a(Math.round(n))}}),c.onload=()=>{c.status>=200&&c.status<300?o():r(c.statusText)},c.onerror=()=>{r("Network Error")},c.send(l)})),r=async()=>{if(!i||!n)return t({error:"Invalid file or missing hash"});const a=Math.ceil(i.size/s);try{for(let e=0;e<a;e++){const t=e*s,n=Math.min(t+s,i.size),r=i.slice(t,n);await o(r,e,a)}await(async s=>{try{const t=await fetch("/api/upload/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({totalChunks:s,md5:n,filename:i.name})});if(!t.ok)throw new Error(`HTTP error ${t.status}`);const a=await t.json();e(a)}catch(a){t({error:`Finalization error: ${a.message}`})}})(a)}catch(r){t({error:`Upload error: ${r}`})}},l=new D;l.postMessage({file:i,chunkSize:s}),l.onmessage=e=>{e.data.hash?(n=e.data.hash,r()):e.data.error&&(t({error:e.data.error}),l.terminate())},l.onerror=e=>{t({error:`Worker error: ${e.message}`}),l.terminate()}}))}async uploadImage(e){try{const t=await fetch("/api/upload/image",{method:"POST",body:e});if(!t.ok)throw new Error(`HTTP error ${t.status}`);return await t.json()}catch(t){throw t}}async _convertBlobToBase64(e){return new Promise(((t,s)=>{const a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=s,a.readAsDataURL(e)}))}}(F);H.init();const U=(e,t)=>{const s=e.__vccOpts||e;for(const[a,i]of t)s[a]=i;return s},q="chat",N="profile",z="settings",W="none",Y={id:"sidebar"},J={class:"admin-avatar"},X=["src"],V={id:"side",class:"options"},G={class:"up-half"},K={class:"down-half"};const Q=U({data:()=>({processedImage:"/p/qava?q=1099834705",activePage:W}),computed:{isChatActive(){return this.activePage===q},isProfileActive(){return this.activePage===N}},watch:{$route:{handler(e){this.activePage=this.getPageStatusFromRoute(e)},immediate:!0}},mounted(){this.activePage=this.getPageStatusFromRoute();const e=H.admin_qq;e?this.loadAvatar(e):H.on("loaded",(()=>{const e=H.admin_qq;this.loadAvatar(e)}),!1)},methods:{processImage:async e=>new Promise(((t,s)=>{const a=document.createElement("canvas"),i=a.getContext("2d"),n=new Image;n.src=e,n.onload=()=>{a.width=n.width,a.height=n.height,i.drawImage(n,0,0);let e=.8*n.width,s=.86*n.height,o=5/24*n.width;i.beginPath(),i.arc(e,s,o,0,2*Math.PI,!0),i.clip(),i.clearRect(0,0,n.width,n.height),a.toBlob((e=>{const s=URL.createObjectURL(e);t(s)}),"image/png")},n.onerror=e=>{s(e)}})),async toChat(){this.activePage=q,this.$router.push({name:"blank"})},async toProfile(){this.activePage=N,this.$router.push({name:"contactors"})},async toConfig(){this.activePage=z,this.$router.push({name:"settings"})},async loadAvatar(e){const t=`/p/qava?q=${e}`;try{this.processedImage=await this.processImage(t)}catch(s){}},getPageStatusFromRoute(e=this.$route){return"/"===e.path||e.path.includes("/chat/")?q:"/contactors"===e.path||e.path.includes("/profile/")?N:"/settings"===e.path?z:W}}},[["render",function(e,n,o,r,l,c){return t(),s("div",Y,[a("div",J,[n[3]||(n[3]=a("div",{class:"status"},null,-1)),a("img",{src:l.processedImage,alt:"admin-avatar"},null,8,X)]),a("div",V,[a("div",G,[a("div",{class:i(["icon-back",{active:c.isChatActive}])},[a("div",{id:"chatting",onClick:n[0]||(n[0]=(...e)=>c.toChat&&c.toChat(...e))},n[4]||(n[4]=[a("i",{class:"iconfont chat"},null,-1)]))],2),a("div",{class:i(["icon-back",{active:c.isProfileActive}])},[a("div",{id:"editing",onClick:n[1]||(n[1]=(...e)=>c.toProfile&&c.toProfile(...e))},n[5]||(n[5]=[a("i",{class:"iconfont user"},null,-1)]))],2)]),a("div",K,[n[7]||(n[7]=a("a",{href:"https://github.com/Pretend-to/mio-chat-backend",target:"_blank",class:"side-icon"},[a("i",{class:"iconfont github"})],-1)),a("div",{class:"side-icon",onClick:n[2]||(n[2]=(...e)=>c.toConfig&&c.toConfig(...e))},n[6]||(n[6]=[a("i",{class:"iconfont menu"},null,-1)]))])])])}],["__scopeId","data-v-c36f5866"]]);const Z=U({props:{fullScreen:{type:Boolean,default:!1}},emits:["set-screen"],data:()=>({preview:!1}),created(){"true"===new URLSearchParams(window.location.search).get("preview")&&(this.preview=!0)},methods:{waiting(){this.$message({message:"此功能尚未开放",type:"warning"})},configFullScreen(e){this.$emit("set-screen",e)}}},[["render",function(e,n,o,r,l,c){return t(),s("ul",{class:i({"window-controls":!0,fullscreen:o.fullScreen,preview:l.preview})},[a("li",{class:"button",onClick:n[0]||(n[0]=e=>c.waiting())},n[4]||(n[4]=[a("span",{class:"window-min"},"—",-1)])),o.fullScreen?(t(),s("li",{key:0,class:"button",onClick:n[1]||(n[1]=e=>c.configFullScreen(!1))},n[5]||(n[5]=[a("span",{class:"window-inmax"},[a("i",{class:"iconfont chuangkouhua"})],-1)]))):(t(),s("li",{key:1,class:"button",onClick:n[2]||(n[2]=e=>c.configFullScreen(!0))},n[6]||(n[6]=[a("span",{class:"window-max"},"▢",-1)]))),a("li",{id:"close",class:"button",onClick:n[3]||(n[3]=e=>c.waiting())},n[7]||(n[7]=[a("span",{class:"window-close"},"×",-1)]))],2)}],["__scopeId","data-v-b59f7c48"]]),ee={id:"forward-msg-body"},te={id:"forward-msg-foot"},se={class:"head"},ae={class:"body"},ie={id:"other",class:"message-body"},ne={class:"avatar"},oe=["src","alt"],re={class:"msg"},le={class:"wholename"},ce={class:"title"},de={class:"name"},he={class:"content"};const me=U({components:{MdPreview:n},props:{messages:{type:Array,default:()=>[]},contactor:{type:Object,default:()=>{}}},data:()=>({showBox:!1,onPhone:!1}),created(){this.onPhone=window.innerWidth<600,H.on("device-change",(e=>{this.onPhone="mobile"==e}),!1)}},[["render",function(e,n,m,g,p,u){const f=o("MdPreview"),y=o("el-image");return t(),s(r,null,[a("div",{id:"forward-msg-preview",class:i(p.onPhone?"on-phone":""),onClick:n[0]||(n[0]=e=>p.showBox=!0)},[n[2]||(n[2]=a("div",{id:"forward-msg-head"},"转发的聊天消息",-1)),a("div",ee,[(t(!0),s(r,null,l(m.messages,((e,a)=>(t(),s("div",{id:"forward-msg-summary",key:a},c(m.contactor.name)+": "+c(m.contactor.getLastMessageSummary(e)),1)))),128))]),a("div",te,"查看"+c(m.messages.length)+"条转发消息",1)],2),p.showBox?(t(),s("div",{key:0,id:"forward-msg-box",class:i(p.onPhone?"on-phone":"")},[a("div",se,[n[3]||(n[3]=a("span",null,"转发消息",-1)),a("span",{class:"close",onClick:n[1]||(n[1]=e=>p.showBox=!1)},"×")]),a("div",ae,[(t(!0),s(r,null,l(m.messages,((e,i)=>(t(),s("div",{key:i,class:"message-container"},[a("div",ie,[a("div",ne,[a("img",{src:m.contactor.avatar,alt:m.contactor.name},null,8,oe)]),a("div",re,[a("div",le,[a("div",ce,c(m.contactor.title),1),a("div",de,c(m.contactor.name),1)]),a("div",he,[a("div",null,["text"===e.type?(t(),d(f,{key:0,"preview-theme":"github","editor-id":"preview-only","model-value":e.data.text},null,8,["model-value"])):"image"===e.type?(t(),d(y,{key:i,style:{margin:"8px 0","max-width":"20rem","border-radius":"1rem"},src:e.data.file,"zoom-rate":1.2,"preview-teleported":!0,"max-scale":7,"min-scale":.2,"preview-src-list":[e.data.file],"initial-index":4,fit:"cover"},null,8,["src","preview-src-list"])):(t(),d(f,{key:2,"preview-theme":"github","editor-id":"preview-only","model-value":`尚未支持的消息类型：${e.type}`},null,8,["model-value"]))])])])])])))),128))])],2)):h("",!0)],64)}]]),ge={class:"input-bar"},pe={class:"options"},ue={class:"bu-emoji"},fe={class:"bu-emoji"},ye={class:"ho-emoji"},ve={class:"bu-emoji"},we={class:"bu-emoji"},Ce={class:"bu-emoji"},be={class:"bu-emoji"},Me={class:"input-box"},Se={class:"input-content"},xe=["v-html"],ke=["disabled"];const Pe=U({props:{activeContactor:{type:Object,required:!0}},emits:["toButtom","cleanHistory","cleanScreen","setModel","stroge"],data:()=>({userInput:"",selectedOption:null,cursorPosition:[],showemoji:!1,openaiModels:null,onebotPresets:null,host:"",uploaded:{files:[],images:[]},isPasting:!1}),computed:{extraOptions(){return"openai"==this.activeContactor.platform?this.openaiModels:this.onebotPresets}},watch:{"$route.params.id"(){this.loadSelected()}},created(){this.initExtraOptions()},mounted(){this.textareaRef=this.$refs.textarea,this.textareaRef.addEventListener("input",this.adjustTextareaHeight),this.handleDragOver=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#e0e0e0"},this.handleDragLeave=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1"},this.handleDrop=e=>{e.preventDefault(),this.textareaRef.style.backgroundColor="#f1f1f1";const t=e.dataTransfer.files;t.length>0&&this.handleDroppedFile(t[0])},this.textareaRef.addEventListener("dragover",this.handleDragOver),this.textareaRef.addEventListener("dragleave",this.handleDragLeave),this.textareaRef.addEventListener("drop",this.handleDrop),this.handlePaste=e=>{e.preventDefault(),this.isPasting=!0;for(var t=(e.clipboardData||window.clipboardData).items,s=0;s<t.length;s++)if(-1!==t[s].type.indexOf("image")){var a=t[s].getAsFile();this.handleUploadImage(a)}else if("text/plain"===t[s].type){var i=(e.originalEvent||e).clipboardData.getData("text/plain");document.execCommand("insertText",!1,i),this.userInput=this.textareaRef.innerText}this.isPasting=!1},this.textareaRef.addEventListener("paste",this.handlePaste),this.host=window.location.origin},unmounted(){this.textareaRef.removeEventListener("input",this.adjustTextareaHeight),this.textareaRef.removeEventListener("dragover",this.handleDragOver),this.textareaRef.removeEventListener("dragleave",this.handleDragLeave),this.textareaRef.removeEventListener("drop",this.handleDrop),this.textareaRef.removeEventListener("paste",this.handlePaste),this.textareaRef=null},methods:{handleDroppedFile(e){e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadFile(e)},ctrlEmojiPanel(){this.showemoji=!this.showemoji;this.textareaRef.focus()},uploadFile(e){if(e instanceof File)return void this.handleFileUpload(e);const t=document.createElement("input");t.type="file",t.accept=["docx","txt","pdf","pptx","xlsx","png","jpg","jpeg","webp","gif","bmp"].map((e=>`.${e}`)).join(",");const s=async e=>{t.removeEventListener("change",s);const a=e.target.files[0];a&&this.handleFileUpload(a)};t.addEventListener("change",s),t.click()},handleFileUpload(e){e.size>52428800?this.$message.error("文件大小超过50MB，无法上传"):(this.$message.info("文件上传中..."),e.type.startsWith("image/")?this.handleUploadImage(e):this.uploadDocumentFile(e))},async uploadDocumentFile(e){try{const t=await H.uploadFile(e);this.$message.success("文件上传成功"),this.uploaded.files.push(`${t.data.url}?size=${e.size}&name=${e.name}`)}catch(t){this.$message.error("文件上传失败，请稍后再试")}},handleUploadImage(e){const t=5242880,s=new Image,a=new FileReader;a.onload=e=>{s.src=e.target.result},s.onload=()=>{const a=e.type.toLowerCase();if("image/gif"===a){if(e.size>t)return void this.$message.error("图片大小不能超过 5MB");const s=new FormData;return s.append("image",e,e.name),void H.uploadImage(s).then((t=>{const s=t.data.url;this.uploaded.images.push(s),this.insertImageToTextarea(s,e.name),this.$message.success("上传图片成功")})).catch((e=>{this.$message.error("上传图片失败")}))}const i=document.createElement("canvas"),n=i.getContext("2d");let o,r;i.width=s.width,i.height=s.height,n.drawImage(s,0,0),"image/png"===a?(o="image/png",r=void 0):"image/webp"===a?(o="image/webp",r=.7):(o="image/jpeg",r=.7),i.toBlob((s=>{if(s.size>t)return void this.$message.error("图片压缩后仍然超过 5MB，请选择更小的图片");const a=new FormData;a.append("image",s,e.name),H.uploadImage(a).then((t=>{const s=t.data.url;this.uploaded.images.push(s),this.insertImageToTextarea(s,e.name),this.$message.success("上传图片成功")})).catch((e=>{this.$message.error("上传图片失败")}))}),o,r)},a.readAsDataURL(e)},insertImageToTextarea(e,t){const s=document.createElement("img");s.src=e,s.alt=t,s.style.maxWidth="10rem",s.style.maxHeight="10rem";const a=document.createRange();a.selectNodeContents(this.textareaRef),a.collapse(!1);const i=window.getSelection();i.removeAllRanges(),i.addRange(a);const n=a.createContextualFragment(`<span>${s.outerHTML}</span>`);a.insertNode(n),setTimeout((()=>{const e=document.createRange();e.selectNodeContents(this.textareaRef),e.collapse(!1);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}),0)},initExtraOptions(){const e=H.config.getLlmModels();this.openaiModels=e.map((e=>({value:e.owner,label:e.owner,children:e.models.map((e=>({value:e,label:e})))}))),this.onebotPresets=F.onebotConfig.textwraper.options,this.loadSelected()},getOpenaiModelArray:e=>[H.config.getModelOwner(e),e],wrapText(e){const t=this.getOnebotPreset();if(!this.selectedOption||!t)return e;return t.replace("{xxx}",e)},getOnebotPreset(){const e=this.onebotPresets.reduce(((e=[],t)=>[...e,...t.children??[t]]),[]).find((e=>e.value==this.selectedOption))?.preset;return e},loadSelected(){"onebot"===this.activeContactor.platform?this.activeContactor.preset&&(this.selectedOption=this.activeContactor.preset):this.selectedOption=this.activeContactor.options.model},adjustTextareaHeight(){const e=this.textareaRef;e.style.height="auto",e.style.height=e.scrollHeight+"px"},getWraperName(){const e=this.getOnebotPreset();if("onebot"===this.activeContactor.platform&&e){if(!this.selectedOption)return"";return e.replace("#","").replace("{xxx}","")}return""},waiting(){this.$message({message:"此功能尚未开放",type:"warning"})},getemoji(e){const t=this.textareaRef;t.focus();const s=document.createRange(),a=window.getSelection();if(!a)return;const i=e.detail.unicode,n=this.cursorPosition[0],o=this.cursorPosition[1],r=this.userInput.substring(0,n),l=this.userInput.substring(o);this.userInput=r+i+l,t.innerHTML=this.userInput,setTimeout((()=>{s.setStart(t.firstChild,n+i.length),s.setEnd(t.firstChild,n+i.length),a.removeAllRanges(),a.addRange(s)}),0),this.ctrlEmojiPanel()},updateCursorPosition(){const e=window.getSelection();if(e&&e.rangeCount>0){const t=e.getRangeAt(0);this.cursorPosition[0]=t.startOffset,this.cursorPosition[1]=t.endOffset}},presend(){this.textareaRef.focus();const e=this.textareaRef.querySelectorAll("img"),t=Array.from(e).map((e=>e.src));let s=this.getSafeText(this.userInput);const a="onebot"===this.activeContactor.platform?this.wrapText(s):s;this.userInput=this.textareaRef.innerHTML="",this.adjustTextareaHeight();const i={role:"user",time:(new Date).getTime(),status:"completed",content:[{type:"text",data:{text:a}}]};if(t.forEach((e=>{i.content.push({type:"image",data:{file:e}})})),this.uploaded.files.forEach((e=>{i.content.push({type:"file",data:{file:this.host+e}})})),this.repliedMessageId){const e={type:"reply",data:{id:this.repliedMessageId}};i.content.push(e)}return i},async send(){this.$emit("toButtom");const e=this.presend(),t=await this.activeContactor.webSend(e);e.id=t,this.$emit("stroge"),this.uploaded.images=[],this.uploaded.files=[]},getSafeText:e=>e,cleanScreen(){this.$emit("cleanScreen")},activeBotTools(){"onebot"===this.activeContactor.platform?this.getOnebotPreset()&&!this.getOnebotPreset().includes("xxx")&&this.send():(this.$emit("setModel",this.selectedOption),this.$message({message:"已切换到 "+this.selectedOption+" 模型",type:"success"}))},isValidInput:e=>e.trim().length>0,handleKeyDown(e){"Enter"===e.key&&(e.ctrlKey?this.userInput&&this.isValidInput(this.userInput)?this.send():this.$message({message:"不能发送空消息",type:"warning"}):this.userInput+="\n"),setTimeout((()=>{this.updateCursorPosition()}),0)},handleInput(){this.isPasting||(this.userInput=this.textareaRef.innerText)}}},[["render",function(e,i,n,r,l,d){const h=o("el-tree-select");return t(),s("div",ge,[a("div",pe,[a("div",ue,[m(a("emoji-picker",{ref:"emojiPicker",onEmojiClick:i[0]||(i[0]=(...e)=>d.getemoji&&d.getemoji(...e))},null,544),[[g,l.showemoji]]),i[11]||(i[11]=a("p",{class:"ho-emoji"},"表情",-1)),a("i",{class:"iconfont smile",onClick:i[1]||(i[1]=p(((...e)=>d.ctrlEmojiPanel&&d.ctrlEmojiPanel(...e)),["prevent"]))})]),a("div",fe,[a("p",ye,c("openai"==n.activeContactor.platform?"模型选择":"工具选择"),1),u(h,{id:"wraper-selector",modelValue:l.selectedOption,"onUpdate:modelValue":i[2]||(i[2]=e=>l.selectedOption=e),data:d.extraOptions,onChange:d.activeBotTools},null,8,["modelValue","data","onChange"]),i[12]||(i[12]=a("i",{class:"iconfont robot"},null,-1))]),a("div",ve,[i[13]||(i[13]=a("p",{class:"ho-emoji"},"重置人格",-1)),a("i",{class:"iconfont reset",onClick:i[3]||(i[3]=t=>e.$emit("cleanHistory"))})]),a("div",we,[i[14]||(i[14]=a("p",{class:"ho-emoji"},"清除记录",-1)),a("i",{class:"iconfont shanchu",onClick:i[4]||(i[4]=t=>e.$emit("cleanScreen"))})]),a("div",Ce,[i[15]||(i[15]=a("p",{class:"ho-emoji"},"上传",-1)),a("i",{class:"iconfont upload",onClick:i[5]||(i[5]=(...e)=>d.uploadFile&&d.uploadFile(...e))})]),a("div",be,[i[16]||(i[16]=a("p",{class:"ho-emoji"},"滑到底部",-1)),a("i",{class:"iconfont down",onClick:i[6]||(i[6]=t=>e.$emit("toButtom",1))})])]),a("div",Me,[a("div",Se,[a("div",{ref:"textarea",class:"input-area","v-html":l.userInput,contenteditable:"true",placeholder:"按 Ctrl + Enter 以发送消息",onKeydown:i[7]||(i[7]=(...e)=>d.handleKeyDown&&d.handleKeyDown(...e)),onInput:i[8]||(i[8]=(...e)=>d.handleInput&&d.handleInput(...e)),onClick:i[9]||(i[9]=(...e)=>d.updateCursorPosition&&d.updateCursorPosition(...e))},null,40,xe)]),a("button",{id:"sendButton",disabled:!l.userInput||!d.isValidInput(l.userInput),onClick:i[10]||(i[10]=p(((...e)=>d.send&&d.send(...e)),["prevent"]))}," 发送"+c(d.getWraperName()?` | ${d.getWraperName()}`:""),9,ke)])])}],["__scopeId","data-v-64dbb31e"]]),Ie={class:"file-block"},Le={class:"file-block-icon"},_e={key:0},Te={class:"file-block-text"},$e=["title"],Oe={class:"file-info"};const Re=U({props:{fileUrl:{type:String,required:!0}},data:()=>({file_name:"",file_type:"",formated_file_size:""}),computed:{iconClass(){const e=this.file_type.toLowerCase();return"pdf"===e?"file-icon-pdf":["xls","xlsx","csv"].includes(e)?"file-icon-spreadsheet":["doc","docx"].includes(e)?"file-icon-word":["ppt","pptx"].includes(e)?"file-icon-ppt":"file-icon-other"}},created(){const e=this.fileUrl.split("?"),t=new URLSearchParams(e[1]),s=t.get("size");this.file_name=t.get("name"),this.formated_file_size=this.formatFileSize(s);const a=e[0].split(".");this.file_type=a[a.length-1]},methods:{formatFileSize(e){let t=0;for(;e>=1024;)e/=1024,t++;return e.toFixed(2)+" "+["B","KB","MB"][t]}}},[["render",function(e,n,o,r,l,d){return t(),s("div",Ie,[a("div",Le,[a("div",{class:i(["file-icon",d.iconClass])},[l.file_type?(t(),s("span",_e,c(l.file_type.toUpperCase()),1)):h("",!0)],2)]),a("div",Te,[a("div",{class:"file-name",title:l.file_name},c(l.file_name),9,$e),a("div",Oe,c(l.file_type.toUpperCase())+", "+c(l.formated_file_size),1)])])}],["__scopeId","data-v-6b139d06"]]),De={class:"tool-call-bar"},Ee={class:"status-icon"},Be={key:0,class:"call-success-icon"},Ae={key:1,class:"call-fail-icon"},je={key:2,class:"call-pend-icon"},Fe={class:"tool-info"},He={class:"tool-name"},Ue={class:"tool-status"},qe={class:"extra-info"},Ne={class:"extra-detail"},ze={class:"detail-params"},We={class:"detail-content"},Ye={class:"detail-result"},Je={class:"detail-content"};const Xe=U({props:{toolCall:{type:Object,required:!0}},data:()=>({showExtraInfo:!1}),computed:{toolCallSuccess(){return"finished"===this.toolCall.action&&null===this.toolCall?.result?.error},toolCallFail(){return"finished"===this.toolCall.action&&null!==!this.toolCall?.result?.error},call_status(){return"started"==this.toolCall.action?"开始运行":"pending"==this.toolCall.action?"函数构建中":"running"==this.toolCall.action?"函数运行中":this.toolCallSuccess?"函数运行成功":this.toolCallFail?"函数运行失败":"未知状态"}},mounted(){}},[["render",function(e,n,o,r,l,d){return t(),s("div",De,[a("div",Ee,[d.toolCallSuccess?(t(),s("span",Be,n[1]||(n[1]=[a("div",{class:"checkmark-container"},[a("svg",{class:"checkmark",viewBox:"0 0 52 36",xmlns:"http://www.w3.org/2000/svg"},[a("polyline",{points:"1 20 15 36 51 1"})])],-1)]))):d.toolCallFail?(t(),s("span",Ae,"❌")):(t(),s("span",je))]),a("div",Fe,[a("div",null,[a("span",He,c(o.toolCall.name),1)]),a("div",Ue,c(d.call_status),1)]),a("div",qe,[a("button",{ref:"show-extra-info",class:i({active:l.showExtraInfo,"extra-info-button":!0}),onClick:n[0]||(n[0]=e=>l.showExtraInfo=!l.showExtraInfo)},n[2]||(n[2]=[a("svg",{t:"1731677922196",class:"icon",viewBox:"0 0 1024 1024",version:"1.1",xmlns:"http://www.w3.org/2000/svg","p-id":"5948",width:"16",height:"16"},[a("path",{d:"M778.965749 128.759549l-383.064442 383.063419 388.097062 388.096039-0.070608 0.033769c12.709463 13.137205 20.529569 31.024597 20.529569 50.731428 0 40.376593-32.736589 73.112158-73.115228 73.112158-19.705807 0-37.591153-7.819083-50.730405-20.528546l-0.034792 0.035816L241.890654 564.622498l0.035816-0.035816c-13.779841-13.281491-22.3838-31.915897-22.3838-52.585659 0-0.071631 0-0.106424 0-0.178055 0-0.072655 0-0.10847 0-0.144286 0-20.669762 8.603959-39.341007 22.3838-52.622498l-0.035816-0.034792L680.573835 20.337187l0.180102 0.179079c13.139252-12.5662 30.950919-20.313651 50.587142-20.313651 40.378639 0 73.115228 32.736589 73.115228 73.114205C804.455283 95.485725 794.567076 115.334795 778.965749 128.759549z","p-id":"5949"})],-1)]),2)]),a("div",{class:i({active:l.showExtraInfo,"extra-info-bar":!0})},[a("div",Ne,[a("div",ze,[n[3]||(n[3]=a("div",{class:"detail-title"},"参数",-1)),a("div",We,c(o.toolCall.params),1)]),a("div",Ye,[n[4]||(n[4]=a("div",{class:"detail-title"},"返回值",-1)),a("div",Je,c(o.toolCall.result),1)])])],2)])}],["__scopeId","data-v-5bf9a968"]]),Ve={class:"reason-block"},Ge={class:"head-bar"},Ke={class:"reason-info"};const Qe=U({props:{content:{required:!0,type:String,default:""},startTime:{required:!0,type:Number},endTime:{required:!1,type:Number,default:0}},data:()=>({show:!0,maxHeight:"auto"}),computed:{getReasonInfo(){if(this.endTime){return`已深度思考（耗时 ${((this.endTime-this.startTime)/1e3).toFixed(2)} 秒）`}return"正在深度思考......"}},mounted(){this.updateMaxHeight()},updated(){this.updateMaxHeight()},methods:{toggleShow(){this.show=!this.show,this.updateMaxHeight()},updateMaxHeight(){this.show?this.maxHeight=this.$refs.reasonContent.scrollHeight+20+"px":this.maxHeight="0px"}}},[["render",function(e,n,o,r,l,d){return t(),s("div",Ve,[a("div",Ge,[a("div",Ke,c(d.getReasonInfo),1),a("button",{class:i({active:l.show,"extra-info-button":!0}),onClick:n[0]||(n[0]=(...e)=>d.toggleShow&&d.toggleShow(...e))},n[1]||(n[1]=[a("i",{class:"iconfont icon-return"},null,-1)]),2)]),a("div",{ref:"reasonContent",class:"reason-content",style:f({"max-height":l.maxHeight})},c(o.content),5)])}],["__scopeId","data-v-81bd691d"]]),Ze={id:"message-menu"};const et=U({name:"MessageMenu",props:{type:{type:String,default:"message"},message:{type:Object,default:()=>({})},seletedText:{type:String,default:""},seletedImage:{type:String,default:""}},emits:["close","message-option"],methods:{async copySeletedImage(){this.$emit("close");try{await this.copyImageToClipboard(this.seletedImage)}catch(e){}},async saveSeletedImage(){this.$emit("close");try{await this.downloadImage(this.seletedImage)}catch(e){}},copyText(){let e="";this.message.content.forEach((t=>{"text"===t.type?e+=t.data.text:"image"===t.type&&(e+=`\n![图片](${t.data.file})`)})),this.copyTextToClipboard(e),this.$emit("close")},copySeletedText(){this.copyTextToClipboard(this.seletedText),this.$emit("close")},retryMessage(){this.$emit("message-option","retry"),this.$emit("close")},replyMessage(){this.$emit("message-option","reply"),this.$emit("close")},deleteMessage(){this.$emit("message-option","delete"),this.$emit("close")},enterChat(){this.$emit("message-option","enter"),this.$emit("close")},togglePriority(){this.$emit("message-option","priority"),this.$emit("close")},shareBot(){this.$emit("message-option","share"),this.$emit("close")},deleteBot(){this.$emit("message-option","delete"),this.$emit("close")},async copyTextToClipboard(e){let t;try{t=document.createElement("textarea"),t.style.position="absolute",t.style.left="-9999px",t.value=e,document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),await document.execCommand("copy"),this.$message({message:"复制成功",type:"success"})}catch(s){this.$message({message:"复制失败",type:"error"})}finally{document.body.removeChild(t)}},async copyImageToClipboard(e){try{const t=await fetch(e);if(!t.ok)throw new Error("网络错误，无法获取图片");const s=await t.blob(),a=new Image,i=URL.createObjectURL(s);a.onload=async()=>{const e=document.createElement("canvas");e.width=a.width,e.height=a.height;e.getContext("2d").drawImage(a,0,0);const t=await new Promise((t=>{e.toBlob(t,"image/png")}));if(t){const e=new ClipboardItem({"image/png":t});await navigator.clipboard.write([e]),this.$message({message:"图片已复制到剪贴板",type:"success"})}else this.$message({message:"转换为 PNG 失败",type:"error"});URL.revokeObjectURL(i)},a.onerror=()=>{this.$message({message:"加载图片失败",type:"error"}),URL.revokeObjectURL(i)},a.src=i}catch(t){this.$message({message:"复制图片失败",type:"error"})}},async downloadImage(e){try{const t=document.createElement("a");t.href=e,t.download="image.png",t.click()}catch(t){this.$message({message:"保存图片失败",type:"error"})}}}},[["render",function(e,i,n,o,l,d){return t(),s("div",Ze,["friend"===n.type?(t(),s(r,{key:0},[a("div",{onClick:i[0]||(i[0]=p(((...e)=>d.enterChat&&d.enterChat(...e)),["stop"]))},i[11]||(i[11]=[a("i",{class:"iconfont chat"},null,-1),a("span",null,"进入对话",-1)])),a("div",{onClick:i[1]||(i[1]=p(((...e)=>d.togglePriority&&d.togglePriority(...e)),["stop"]))},[i[12]||(i[12]=a("i",{class:"iconfont star"},null,-1)),a("span",null,c(0===n.message.priority?"取消置顶":"置顶"),1)]),a("div",{onClick:i[2]||(i[2]=p(((...e)=>d.shareBot&&d.shareBot(...e)),["stop"]))},i[13]||(i[13]=[a("i",{class:"iconfont icon-share"},null,-1),a("span",null,"分享",-1)])),a("div",{onClick:i[3]||(i[3]=p(((...e)=>d.deleteBot&&d.deleteBot(...e)),["stop"]))},i[14]||(i[14]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除",-1)]))],64)):(t(),s(r,{key:1},[n.seletedText?(t(),s("div",{key:0,onClick:i[4]||(i[4]=p(((...e)=>d.copySeletedText&&d.copySeletedText(...e)),["stop"]))},i[15]||(i[15]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制选中",-1)]))):h("",!0),a("div",{onClick:i[5]||(i[5]=p(((...e)=>d.copyText&&d.copyText(...e)),["stop"]))},i[16]||(i[16]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制消息",-1)])),n.seletedImage?(t(),s("div",{key:1,onClick:i[6]||(i[6]=p(((...e)=>d.copySeletedImage&&d.copySeletedImage(...e)),["stop"]))},i[17]||(i[17]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"复制图片",-1)]))):h("",!0),n.seletedImage?(t(),s("div",{key:2,onClick:i[7]||(i[7]=p(((...e)=>d.saveSeletedImage&&d.saveSeletedImage(...e)),["stop"]))},i[18]||(i[18]=[a("i",{class:"iconfont fuzhi"},null,-1),a("span",null,"保存图片",-1)]))):h("",!0),a("div",{onClick:i[8]||(i[8]=p(((...e)=>d.retryMessage&&d.retryMessage(...e)),["stop"]))},i[19]||(i[19]=[a("i",{class:"iconfont reset"},null,-1),a("span",null,"重试消息",-1)])),a("div",{onClick:i[9]||(i[9]=p(((...e)=>d.replyMessage&&d.replyMessage(...e)),["stop"]))},i[20]||(i[20]=[a("i",{class:"iconfont yinyong"},null,-1),a("span",null,"引用消息",-1)])),a("div",{onClick:i[10]||(i[10]=p(((...e)=>d.deleteMessage&&d.deleteMessage(...e)),["stop"]))},i[21]||(i[21]=[a("i",{class:"iconfont shanchu"},null,-1),a("span",null,"删除消息",-1)]))],64))])}],["__scopeId","data-v-0fc9e519"]]),tt={class:"add-contactor"},st={class:"head"},at={class:"body"},it={class:"search"},nt={class:"info"},ot={class:"presets-types"},rt=["onClick"],lt={key:0,class:"presets-list"},ct={key:0,class:"preset-avatar custom"},dt=["src"],ht={key:1,class:"preset-avatar model"},mt=["src"],gt={key:2,class:"preset-avatar"},pt={class:"preset-info"},ut={class:"preset-name"},ft=["title"],yt={ref:"loader",class:"loading"},vt={key:1,class:"empty-list"};const wt={id:"friends",class:"upsidebar"},Ct={class:"bu-add"},bt={class:"people"},Mt=["id","onClick","onContextmenu"],St=["src","alt"],xt={class:"info"},kt={class:"name"},Pt={id:"time",class:"msginfo"},It={id:"msgctt",class:"msginfo"};const Lt=U({components:{AddContactor:U({emits:["addBot","close"],data:()=>({show:!1,presetsList:[],recommendPresets:[],recentPresets:[],localPresets:[],systemPresets:[],searchPresets:[],systemShownNum:0,recommendShownNum:0,keyWord:"",activeTypeIndex:0,buttonTranslate:0,avaliablePresetTypes:["推荐","最近","本地","系统"],moreSystemPresets:!0,moreRecommendPresets:!0,observer:null,Contactor:R}),computed:{showPresetsLoader(){return 3==this.activeTypeIndex?this.moreSystemPresets:0==this.activeTypeIndex&&this.moreRecommendPresets},shownPrestsList(){return this.keyWord?this.searchPresets:2===this.activeTypeIndex?this.localPresets:1===this.activeTypeIndex?this.recentPresets:0===this.activeTypeIndex?this.recommendPresets:3===this.activeTypeIndex?this.systemPresets:null}},async mounted(){if(this.getAddHistory(),await this.loadSpecificType(),"IntersectionObserver"in window){const e=e=>{e.forEach((e=>{e.isIntersecting&&this.loadMoreData()}))};this.observer=new IntersectionObserver(e);const t=this.$refs.loader;t&&this.observer.observe(t)}else window.addEventListener("scroll",this.handleScroll)},beforeUnmount(){this.observer?this.observer.disconnect():window.removeEventListener("scroll",this.handleScroll)},methods:{async addBot(e){this.strogeAddHistory(e),this.$emit("addBot",e),this.$message.success("添加成功")},strogeAddHistory(e){const t=this.recentPresets.find((t=>t.name===e.name));t&&this.recentPresets.splice(this.recentPresets.indexOf(t),1),this.recentPresets.unshift(e),this.recentPresets.length>6&&this.recentPresets.pop(),localStorage.setItem("addHistory",JSON.stringify(this.recentPresets))},getAddHistory(){const e=localStorage.getItem("addHistory");e&&(this.recentPresets=JSON.parse(e))},async changeShownType(e){this.activeTypeIndex=e,this.buttonTranslate=49.6*e+"px",await this.loadSpecificType()},close(){this.$emit("close")},async loadSpecificType(){const e=this.avaliablePresetTypes[this.activeTypeIndex];this.presetsList=await this.getPresetList(e)},async getPresetList(e){return"系统"===e?await this.loadSystemPresets():"推荐"===e?await this.loadRecommendedPresets():"最近"===e?this.recentPresets:"本地"===e?this.localPresets:void 0},async loadRecommendedPresets(){const e=await fetch(`/api/openai/presets?type=recommended&start=${this.recommendShownNum}`).then((e=>e.json()));for(let t=0;t<e.data.length;t++)this.recommendPresets.push(e.data[t]);return this.recommendShownNum+=e.data.length,e.data.length<9&&(this.moreRecommendPresets=!1),this.recommendPresets},async loadSystemPresets(){const e=await fetch(`/api/openai/presets?type=system&start=${this.systemShownNum}`).then((e=>e.json()));for(let t=0;t<e.data.length;t++)this.systemPresets.push(e.data[t]);return this.systemShownNum+=e.data.length,e.data.length<9&&(this.moreSystemPresets=!1),this.systemPresets},async loadSerachPresets(){const e=async()=>{const e=await fetch(`/api/openai/presets?type=search&keyword=${this.keyWord}`).then((e=>e.json()));this.searchPresets=e.data};this.searchTimer&&clearTimeout(this.searchTimer),this.searchTimer=setTimeout((()=>{e()}),500)},loadMoreData(){this.showPresetsLoader&&3===this.activeTypeIndex?this.loadSystemPresets():this.showPresetsLoader&&0===this.activeTypeIndex&&this.loadRecommendedPresets()},handleScroll(){const e=this.$refs.loader;if(!e)return;const t=e.getBoundingClientRect();t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)&&this.loadMoreData()}}},[["render",function(e,n,d,h,p,C){const b=o("el-button"),M=o("el-empty");return t(),s("div",tt,[a("div",st,[n[3]||(n[3]=a("div",{class:"title"},"添加机器人",-1)),a("div",{class:"close-icon",onClick:n[0]||(n[0]=(...e)=>C.close&&C.close(...e))},"✕")]),a("div",at,[a("div",it,[n[4]||(n[4]=a("i",{class:"iconfont sousuo listicon"},null,-1)),m(a("input",{"onUpdate:modelValue":n[1]||(n[1]=e=>p.keyWord=e),type:"text",placeholder:"输入搜索关键词",onInput:n[2]||(n[2]=(...e)=>C.loadSerachPresets&&C.loadSerachPresets(...e))},null,544),[[y,p.keyWord]])]),a("div",nt,[a("header",ot,[(t(!0),s(r,null,l(p.avaliablePresetTypes,((e,a)=>(t(),s("nav",{key:a,class:i(p.activeTypeIndex===a?"active":""),onClick:e=>C.changeShownType(a)},c(e),11,rt)))),128))]),a("div",{style:f({left:p.buttonTranslate}),class:"slide-button"},null,4),C.shownPrestsList.length>0||[0,3].includes(p.activeTypeIndex)?(t(),s("div",lt,[(t(!0),s(r,null,l(C.shownPrestsList,((e,i)=>(t(),s("div",{key:i,class:"presets-item"},[e.avatar?(t(),s("div",ct,[a("img",{src:e.avatar},null,8,dt)])):e.model?(t(),s("div",ht,[a("img",{src:p.Contactor.getAvatarByModel(e.model)},null,8,mt)])):(t(),s("div",gt,c(e.name.slice(0,2)),1)),a("div",pt,[a("div",ut,c(e.name),1),a("div",{title:e.opening,class:"preset-description"},c(e.opening),9,ft)]),u(b,{onClick:t=>C.addBot(e)},{default:v((()=>n[5]||(n[5]=[w("添加")]))),_:2},1032,["onClick"])])))),128)),m(a("div",yt,n[6]||(n[6]=[a("div",null,null,-1),a("div",null,null,-1),a("div",null,null,-1),a("div",null,null,-1),a("div",null,null,-1)]),512),[[g,C.showPresetsLoader]])])):(t(),s("div",vt,[u(M,{"image-size":200})]))]),n[7]||(n[7]=a("div",{class:"options"},null,-1))])])}],["__scopeId","data-v-e256b26c"]]),ContextMenu:et},data(){let e=H.getContactors();return{onPhone:window.innerWidth<600,contactorList:e,showAddOptions:!1,showAddWindow:!1,showMenu:!1,menuX:0,menuY:0,selectedFriend:null}},computed:{sortedList(){return[...this.contactorList].sort(((e,t)=>t.priority-e.priority==-1?1:t.lastUpdate-e.lastUpdate))}},mounted(){this.addReactiveListener()},beforeCreate(){0==H.getContactors().length&&H.on("loaded",(()=>{this.contactorList=H.getContactors()}),!1)},methods:{genBotByPreset(){this.showAddOptions=!1,this.showAddWindow=!0},showChat(e){"blank"==this.$route.name||"chat_view"==this.$route.name?this.$router.push({name:"chat_view",params:{id:e}}):"contactors"==this.$route.name||"profile_view"==this.$route.name?this.$router.push({name:"profile_view",params:{id:e}}):this.$router.replace({name:"chat_view",params:{id:e}})},getId(e){return this.$route.params.id==e.id?"active":0==e.priority?"important":""},async genBlankBot(){const e=F.getLLMDefaultConfig(),t={id:this.genFakeId(),title:e.default_model,avatarPolicy:0,namePolicy:2,priority:1,options:e};this.showAddOptions=!1,await H.addConcator("openai",t),this.addReactiveListener()},startResize(e){this.isResizing=!0,this.startX=e.clientX,this.startWidth=this.$refs.friendlists.offsetWidth,document.addEventListener("mousemove",this.resize),document.addEventListener("mouseup",this.stopResize)},resize(e){if(this.isResizing){let t=this.startWidth+(e.clientX-this.startX);const s=document.documentElement.style.fontSize?parseFloat(document.documentElement.style.fontSize):16,a=20*s,i=12*s;t=t>a?a:t<i?i:t,this.$refs.friendlists.style.minWidth=t+"px",this.$refs.friendlists.style.maxWidth=t+"px"}},stopResize(){this.isResizing=!1,document.removeEventListener("mousemove",this.resize),document.removeEventListener("mouseup",this.stopResize)},genFakeId(){const e=`1${Math.floor(1e3+9e3*Math.random())}`;if(this.id){const e=Math.floor(1e3+9e3*Math.random()),t=`${this.id}${e}`;return parseInt(t)}return parseInt(e)},mergeOptions(e){let t={};const s=F.LLMDefaultConfig;for(const a in s)if(void 0===e[a]){if("enable_tool_call"==a){e.tools&&(t[a]=!0);continue}t[a]=s[a]}else t[a]=e[a];return t},async addPresetContactor(e){const t={id:this.genFakeId(),namePolicy:1,avatarPolicy:e.avatar?1:0,avatar:e.avatar?e.avatar:void 0,name:e.name,title:e.title,priority:1,options:this.mergeOptions(e)};await H.addConcator("openai",t),this.addReactiveListener()},showFriendContextMenu(e,t){this.selectedFriend=t,this.menuX=e.clientX,this.menuY=e.clientY,this.showMenu=!0;const s=()=>{this.showMenu=!1,document.removeEventListener("click",s)};document.addEventListener("click",s)},async handleFriendOption(e){switch(e){case"enter":this.showChat(this.selectedFriend.id);break;case"priority":this.selectedFriend.priority=0===this.selectedFriend.priority?1:0,H.setLocalStorage();break;case"share":await H.shareContactor(this.selectedFriend.id)?this.$message({message:"分享链接已复制",type:"success"}):this.$message({message:"分享失败",type:"error"});break;case"delete":{let e;e=this.contactorList.findIndex((e=>e.id===this.selectedFriend.id)),-1!==e&&(this.contactorList.splice(e,1),H.setLocalStorage());break}}this.showMenu=!1},addReactiveListener(){this.contactorList.map((e=>{e.on("updateMessageSummary",(()=>{e.updateMessageSummary()}))}))}}},[["render",function(e,n,u,y,v,w){const C=o("AddContactor"),b=o("ContextMenu");return t(),s("div",{id:"friendlists",ref:"friendlists",class:i(v.onPhone?"mobile":"")},[a("div",wt,[n[7]||(n[7]=a("div",{class:"search"},[a("i",{class:"iconfont sousuo listicon"}),a("input",{id:"main-search",type:"text",placeholder:"搜索"})],-1)),a("div",Ct,[a("button",{id:"addcont",title:"Add Bot",onClick:n[0]||(n[0]=e=>v.showAddOptions=!v.showAddOptions)},n[6]||(n[6]=[a("i",{class:"iconfont add"},null,-1)])),m(a("div",{id:"add-options",style:f({left:v.onPhone?"-6rem":"0px"})},[a("ul",null,[a("li",null,[a("button",{onClick:n[1]||(n[1]=(...e)=>w.genBlankBot&&w.genBlankBot(...e))},"新建空白Bot")]),a("li",null,[a("button",{onClick:n[2]||(n[2]=(...e)=>w.genBotByPreset&&w.genBotByPreset(...e))},"从预设新建Bot")])])],4),[[g,v.showAddOptions]])])]),a("div",bt,[(t(!0),s(r,null,l(w.sortedList,((e,n)=>(t(),s("div",{id:w.getId(e),key:n,class:"lists",onClick:t=>w.showChat(e.id),onContextmenu:p((t=>w.showFriendContextMenu(t,e)),["prevent"])},[a("div",{class:i(["avatar",1==e.avatarPolicy?"custom":"model"])},[a("img",{src:e.avatar,alt:e.name},null,8,St)],2),a("div",xt,[a("div",kt,c(e.name),1),a("div",Pt,c(e.getLastTime()),1),a("div",It,c(e.lastMessageSummary),1)])],40,Mt)))),128))]),a("div",{class:"resizer",onMousedown:n[3]||(n[3]=(...e)=>w.startResize&&w.startResize(...e))},null,32),v.showAddWindow?(t(),d(C,{key:0,onClose:n[4]||(n[4]=e=>v.showAddWindow=!1),onAddBot:w.addPresetContactor},null,8,["onAddBot"])):h("",!0),v.showMenu?(t(),d(b,{key:1,type:"friend",message:v.selectedFriend,style:f({position:"fixed",left:v.menuX+"px",top:v.menuY+"px"}),onMessageOption:w.handleFriendOption,onClose:n[5]||(n[5]=e=>v.showMenu=!1)},null,8,["message","style","onMessageOption"])):h("",!0)],2)}],["__scopeId","data-v-a54c136f"]]),_t={class:"presets-list"},Tt={class:"preset-message-block"},$t=["onMouseover"],Ot={key:0,class:"avatar-emoji"},Rt=["onBlur"],Dt={class:"messages-buttons"};const Et=U({props:{presetsHistory:{type:Array,default:()=>[]}},emits:["updatePresets"],data(){return{presetMessages:[...this.presetsHistory],hoveredIndex:void 0}},watch:{presetsHistory(e){this.presetMessages=[...e]}},methods:{delPresetMessage(){this.presetMessages.splice(this.hoveredIndex,1),this.$emit("updatePresets",this.presetMessages)},addPresetMessage(e){"system"==e&&this.presetMessages.length>0?this.$message.warning("系统消息必须是第一条消息"):(this.presetMessages.push({role:e,content:""}),this.$emit("updatePresets",this.presetMessages))},getMessageAvatar:e=>"assistant"==e?"🤖":"system"==e?"⚙️":"👤",handleMessageUpdate(e){this.presetMessages[e].content=this.$refs[`message-${e}`][0].innerText,this.$emit("updatePresets",this.presetMessages)}}},[["render",function(e,i,n,d,h,m){const g=o("el-button");return t(),s("div",_t,[(t(!0),s(r,null,l(h.presetMessages,((e,n)=>(t(),s("div",{key:n,class:"preset-message"},[a("div",Tt,[a("div",{class:"message-avatar",onMouseover:e=>h.hoveredIndex=n,onMouseleave:i[1]||(i[1]=e=>h.hoveredIndex=null)},[h.hoveredIndex!=n?(t(),s("div",Ot,c(m.getMessageAvatar(e.role)),1)):(t(),s("div",{key:1,title:"删除消息",class:"avatar-emoji hovered",onClick:i[0]||(i[0]=(...e)=>m.delPresetMessage&&m.delPresetMessage(...e))}," 🗑️ "))],40,$t),a("div",{ref_for:!0,ref:`message-${n}`,class:"message-content",contenteditable:"true",onBlur:e=>m.handleMessageUpdate(n)},c(h.presetMessages[n].content),41,Rt)])])))),128)),a("div",Dt,[u(g,{title:"添加系统消息",plain:"",onClick:i[2]||(i[2]=e=>m.addPresetMessage("system"))},{default:v((()=>i[5]||(i[5]=[w("➕ ⚙️")]))),_:1}),u(g,{title:"添加助手消息",plain:"",onClick:i[3]||(i[3]=e=>m.addPresetMessage("assistant"))},{default:v((()=>i[6]||(i[6]=[w("➕ 🤖")]))),_:1}),u(g,{title:"添加用户消息",plain:"",onClick:i[4]||(i[4]=e=>m.addPresetMessage("user"))},{default:v((()=>i[7]||(i[7]=[w("➕ 👤")]))),_:1})])])}],["__scopeId","data-v-88c48edc"]]);export{et as C,me as F,Pe as I,Et as P,Qe as R,Xe as T,U as _,Re as a,F as b,H as c,Z as d,Lt as f,Q as s};
//# sourceMappingURL=components-3gVRf8XC.js.map
