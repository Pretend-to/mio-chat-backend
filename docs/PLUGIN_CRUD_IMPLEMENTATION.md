# æ’ä»¶ CRUD ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ“¦ äº¤ä»˜å†…å®¹

æœ¬æ¬¡å®ç°ä¸º Mio-Chat-Backend æ·»åŠ äº†å®Œæ•´çš„**æ’ä»¶ CRUD ç®¡ç†ç³»ç»Ÿ**,ä¸ç°æœ‰çš„ LLM é€‚é…å™¨ CRUD å½¢æˆé…å¥—çš„çƒ­æ›´æ–°æ¶æ„ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. æ’ä»¶ç®¡ç† APIï¼ˆ9ä¸ªæ¥å£ï¼‰

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|------|------|------|------|
| `/api/plugins` | GET | åˆ—å‡ºæ‰€æœ‰æ’ä»¶ | åŒ…å«å…ƒæ•°æ®ã€å·¥å…·æ•°é‡ã€å¯ç”¨çŠ¶æ€ |
| `/api/plugins/:name` | GET | è·å–æ’ä»¶è¯¦æƒ… | é…ç½®ã€å·¥å…·åˆ—è¡¨ã€è·¯å¾„ä¿¡æ¯ |
| `/api/plugins/:name/config` | GET | è·å–æ’ä»¶é…ç½® | è¿”å›å½“å‰é…ç½® JSON |
| `/api/plugins/:name/config` | PUT | æ›´æ–°æ’ä»¶é…ç½® | çƒ­æ›´æ–°é…ç½®æ–‡ä»¶ |
| `/api/plugins/:name/tools` | GET | è·å–å·¥å…·åˆ—è¡¨ | åˆ†ç»„æ˜¾ç¤ºæ‰€æœ‰å·¥å…· |
| `/api/plugins/:name/tools/:toolName/debug` | POST | è°ƒè¯•å·¥å…·æ‰§è¡Œ | éªŒè¯ schema å¹¶æ‰§è¡Œå·¥å…· |
| `/api/plugins/:name/reload` | POST | é‡è½½å•ä¸ªæ’ä»¶ | é‡æ–°åŠ è½½å·¥å…·å’Œåˆå§‹åŒ– |
| `/api/plugins/:name/toggle` | POST | å¯ç”¨/ç¦ç”¨æ’ä»¶ | åŠ¨æ€åˆ‡æ¢æ’ä»¶çŠ¶æ€ |
| `/api/plugins/reload-all` | POST | é‡è½½æ‰€æœ‰æ’ä»¶ | æ‰¹é‡é‡è½½ |

### 2. ä¸­é—´ä»¶çƒ­æ›´æ–°æ–¹æ³•

åœ¨ `lib/middleware.js` æ·»åŠ ï¼š

```javascript
async reloadAllPlugins()  // é‡è½½æ‰€æœ‰æ’ä»¶
async reloadPlugin(name)   // é‡è½½å•ä¸ªæ’ä»¶
```

ä¸ç°æœ‰çš„ `reloadLLMAdapters()` å½¢æˆç»Ÿä¸€çš„çƒ­æ›´æ–°æ¥å£ã€‚

### 3. æ§åˆ¶å™¨å±‚

æ–°å»º `lib/server/http/controllers/pluginController.js`:
- 8ä¸ª API å¤„ç†å‡½æ•°
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- æ ‡å‡†åŒ–å“åº”æ ¼å¼ï¼ˆä¸ configController ä¸€è‡´ï¼‰

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é…ç½®&æ’ä»¶çƒ­æ›´æ–°æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  HTTP API Layer                                 â”‚
â”‚  â”œâ”€â”€ /api/config/*    (LLMé€‚é…å™¨CRUD)           â”‚
â”‚  â””â”€â”€ /api/plugins/*   (æ’ä»¶CRUD) âœ¨ NEW         â”‚
â”‚                                                 â”‚
â”‚  Middleware Layer                               â”‚
â”‚  â”œâ”€â”€ reloadLLMAdapters()   (LLMçƒ­æ›´æ–°)         â”‚
â”‚  â”œâ”€â”€ reloadAllPlugins()    (æ’ä»¶çƒ­æ›´æ–°) âœ¨ NEW  â”‚
â”‚  â””â”€â”€ reloadPlugin(name)    (å•æ’ä»¶çƒ­æ›´æ–°) âœ¨     â”‚
â”‚                                                 â”‚
â”‚  Core Layer                                     â”‚
â”‚  â”œâ”€â”€ config.reload()       (é…ç½®æ–‡ä»¶é‡è½½)       â”‚
â”‚  â”œâ”€â”€ plugin.loadTools()    (å·¥å…·é‡è½½)           â”‚
â”‚  â””â”€â”€ plugin.loadConfig()   (æ’ä»¶é…ç½®é‡è½½)       â”‚
â”‚                                                 â”‚
â”‚  File Watcher (chokidar)                        â”‚
â”‚  â”œâ”€â”€ config.yaml          (é…ç½®ç›‘å¬)            â”‚
â”‚  â”œâ”€â”€ plugins/*/tools/*.js (å·¥å…·æ–‡ä»¶ç›‘å¬)        â”‚
â”‚  â””â”€â”€ plugins/*.json       (æ’ä»¶é…ç½®ç›‘å¬)        â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çƒ­æ›´æ–°æµç¨‹

```
ç”¨æˆ·æ“ä½œ
   â†“
PUT /api/plugins/:name/config
   â†“
å†™å…¥é…ç½®æ–‡ä»¶ (config/plugins/<name>.json)
   â†“
chokidar æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
   â†“
è§¦å‘ plugin.loadConfig() (600ms é˜²æŠ–)
   â†“
ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨ POST /api/plugins/:name/reload
   â†“
plugin.loadTools() + plugin.initialize()
   â†“
æ›´æ–° global.middleware.llm.setPlugins()
   â†“
æ–°å·¥å…·ç«‹å³å¯ç”¨
```

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **æ ¸å¿ƒä»£ç **
   - `lib/server/http/controllers/pluginController.js` - æ’ä»¶ç®¡ç†æ§åˆ¶å™¨

2. **æ–‡æ¡£**
   - `docs/plugin-api.md` - å®Œæ•´APIæ–‡æ¡£ï¼ˆ600+ è¡Œï¼‰
   - `PLUGIN_CRUD_GUIDE.md` - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

3. **å·¥å…·**
   - `scripts/test-plugin-api.js` - æµ‹è¯•è„šæœ¬

### ä¿®æ”¹æ–‡ä»¶

1. `lib/middleware.js`
   - æ·»åŠ  `reloadAllPlugins()` æ–¹æ³•
   - æ·»åŠ  `reloadPlugin(name)` æ–¹æ³•

2. `lib/server/http/index.js`
   - å¯¼å…¥ `pluginController`
   - æ·»åŠ  8 æ¡æ’ä»¶ç®¡ç†è·¯ç”±

3. `README.md`
   - æ›´æ–° API æ–‡æ¡£é“¾æ¥éƒ¨åˆ†

---

## ğŸ”¥ æŠ€æœ¯äº®ç‚¹

### 1. ä¸ LLM é€‚é…å™¨ CRUD å¯¹é½

| ç‰¹æ€§ | LLM é€‚é…å™¨ | æ’ä»¶ç³»ç»Ÿ |
|------|-----------|---------|
| åˆ—è¡¨æŸ¥è¯¢ | âœ… GET /api/config | âœ… GET /api/plugins |
| è¯¦æƒ…æŸ¥è¯¢ | âœ… GET /api/config/:section | âœ… GET /api/plugins/:name |
| é…ç½®æ›´æ–° | âœ… PUT /api/config | âœ… PUT /api/plugins/:name/config |
| çƒ­é‡è½½ | âœ… POST /api/config/refresh-models | âœ… POST /api/plugins/:name/reload |
| æ‰¹é‡é‡è½½ | âœ… reloadLLMAdapters() | âœ… reloadAllPlugins() |
| å¯ç”¨/ç¦ç”¨ | âœ… é€šè¿‡é…ç½® | âœ… POST /api/plugins/:name/toggle |

### 2. é›¶åœæœºæ›´æ–°

- æ‰€æœ‰æ“ä½œéƒ½ä¸éœ€è¦é‡å¯æœåŠ¡
- chokidar ç›‘å¬ + é˜²æŠ–å¤„ç†
- åŠ¨æ€ import() æ”¯æŒä»£ç çƒ­æ›¿æ¢

### 3. å·¥å…·æ•°é‡è¿½è¸ª

æ¯æ¬¡é‡è½½éƒ½ä¼šè®¡ç®—å·¥å…·æ•°é‡,æ–¹ä¾¿ç›‘æ§:

```javascript
{
  "results": [
    {"name": "mcp-plugin", "toolCount": 5},
    {"name": "web-plugin", "toolCount": 3}
  ]
}
```

### 4. é”™è¯¯éš”ç¦»

å•ä¸ªæ’ä»¶é‡è½½å¤±è´¥ä¸å½±å“å…¶ä»–æ’ä»¶:

```javascript
{
  "successCount": 2,
  "totalCount": 3,
  "results": [
    {"name": "mcp-plugin", "success": true},
    {"name": "web-plugin", "success": true},
    {"name": "custom", "success": false, "error": "å·¥å…·ç›®å½•ä¸å­˜åœ¨"}
  ]
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡**
```bash
node app.js
```

2. **è¿è¡Œæµ‹è¯•è„šæœ¬**
```bash
node scripts/test-plugin-api.js your_admin_code
```

3. **éªŒè¯åŠŸèƒ½**
   - âœ… åˆ—å‡ºæ’ä»¶
   - âœ… æŸ¥çœ‹è¯¦æƒ…
   - âœ… æ›´æ–°é…ç½®
   - âœ… é‡è½½æ’ä»¶
   - âœ… å¯ç”¨/ç¦ç”¨
   - âœ… æ‰¹é‡é‡è½½

### API æµ‹è¯•ç¤ºä¾‹

```bash
# 1. åˆ—å‡ºæ‰€æœ‰æ’ä»¶
curl "http://localhost:3000/api/plugins?admin_code=admin123"

# 2. è·å– mcp-plugin è¯¦æƒ…
curl "http://localhost:3000/api/plugins/mcp-plugin?admin_code=admin123"

# 3. æ›´æ–°é…ç½®
curl -X PUT "http://localhost:3000/api/plugins/mcp-plugin/config?admin_code=admin123" \
  -H "Content-Type: application/json" \
  -d '{"enabled": true, "mcpServers": {}}'

# 4. é‡è½½æ’ä»¶
curl -X POST "http://localhost:3000/api/plugins/mcp-plugin/reload?admin_code=admin123"
```

---

## ğŸ“– ä½¿ç”¨æ–‡æ¡£

### ç»™ç”¨æˆ·çš„æ–‡æ¡£

1. **[plugin-api.md](./docs/plugin-api.md)** - å®Œæ•´çš„ API å‚è€ƒæ‰‹å†Œ
   - æ‰€æœ‰æ¥å£çš„è¯¦ç»†è¯´æ˜
   - è¯·æ±‚/å“åº”ç¤ºä¾‹
   - é”™è¯¯ç è¯´æ˜
   - JavaScript å®¢æˆ·ç«¯ç¤ºä¾‹

2. **[PLUGIN_CRUD_GUIDE.md](./PLUGIN_CRUD_GUIDE.md)** - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
   - æ ¸å¿ƒæ¦‚å¿µè§£é‡Š
   - å¸¸è§åœºæ™¯ç¤ºä¾‹
   - å‰ç«¯é›†æˆç¤ºä¾‹
   - å®‰å…¨æ³¨æ„äº‹é¡¹
   - å¸¸è§é—®é¢˜è§£ç­”

3. **README.md æ›´æ–°** - æ·»åŠ  API æ–‡æ¡£é“¾æ¥

---

## ğŸ”® æœªæ¥å¢å¼ºæ–¹å‘

### çŸ­æœŸï¼ˆå¯ç«‹å³å®ç°ï¼‰

1. **æ’ä»¶ä¾èµ–ç®¡ç†**
   - æ£€æµ‹æ’ä»¶é—´ä¾èµ–å…³ç³»
   - æŒ‰ä¾èµ–é¡ºåºåŠ è½½/é‡è½½

2. **æ’ä»¶ç‰ˆæœ¬ç®¡ç†**
   - ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
   - é™çº§/å‡çº§æ”¯æŒ

3. **é…ç½®éªŒè¯**
   - JSON Schema éªŒè¯
   - é…ç½®é”™è¯¯æç¤º

### ä¸­æœŸï¼ˆéœ€è¦è®¾è®¡ï¼‰

1. **åœ¨çº¿å®‰è£…æ’ä»¶**
   ```bash
   POST /api/plugins/install
   {
     "source": "npm",
     "package": "@modelcontextprotocol/server-filesystem"
   }
   ```

2. **æ’ä»¶å¸‚åœºé›†æˆ**
   - ä» awesome-miochat-plugins ä»“åº“æ‹‰å–
   - ä¸€é”®å®‰è£…ã€æ›´æ–°ã€å¸è½½

3. **æ’ä»¶æ²™ç®±**
   - é™åˆ¶æ’ä»¶æƒé™
   - èµ„æºä½¿ç”¨ç›‘æ§

### é•¿æœŸï¼ˆæ¶æ„å‡çº§ï¼‰

1. **æ’ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­**
   ```javascript
   class MyPlugin {
     onEnable() {}
     onDisable() {}
     onUninstall() {}
   }
   ```

2. **æ’ä»¶é—´é€šä¿¡**
   - äº‹ä»¶æ€»çº¿
   - å…±äº«æ•°æ®å­˜å‚¨

3. **æ’ä»¶å¯è§†åŒ–ç¼–è¾‘å™¨**
   - æ‹–æ‹½å¼å·¥å…·ç¼–æ’
   - ä½ä»£ç é…ç½®

---

## âœ… éªŒæ”¶æ¸…å•

- [x] 8 ä¸ªæ’ä»¶ç®¡ç† API æ¥å£æ­£å¸¸å·¥ä½œ
- [x] é…ç½®çƒ­æ›´æ–°åŠŸèƒ½æ­£å¸¸
- [x] å·¥å…·çƒ­é‡è½½åŠŸèƒ½æ­£å¸¸
- [x] å¯ç”¨/ç¦ç”¨åŠŸèƒ½æ­£å¸¸
- [x] æ‰¹é‡é‡è½½åŠŸèƒ½æ­£å¸¸
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] è®¤è¯æœºåˆ¶é›†æˆï¼ˆauthConfigAPIï¼‰
- [x] æ ‡å‡†åŒ–å“åº”æ ¼å¼ï¼ˆmakeStandardResponseï¼‰
- [x] å®Œæ•´çš„ API æ–‡æ¡£
- [x] å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- [x] æµ‹è¯•è„šæœ¬
- [x] README æ›´æ–°

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å®ç°ä¸º Mio-Chat-Backend æ·»åŠ äº†**ä¼ä¸šçº§æ’ä»¶ç®¡ç†èƒ½åŠ›**,ä¸ç°æœ‰çš„ LLM é€‚é…å™¨ CRUD å½¢æˆå®Œæ•´çš„çƒ­æ›´æ–°ä½“ç³»ã€‚ä¸»è¦ç‰¹ç‚¹:

1. **æ¶æ„å¯¹é½** - API è®¾è®¡ä¸ LLM é€‚é…å™¨ä¿æŒä¸€è‡´
2. **é›¶åœæœº** - æ‰€æœ‰æ“ä½œéƒ½æ”¯æŒçƒ­æ›´æ–°
3. **æ–‡æ¡£å®Œå–„** - æä¾›è¯¦ç»†çš„ API æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—
4. **æ˜“äºæ‰©å±•** - ä¸ºæœªæ¥çš„æ’ä»¶å¸‚åœºã€åœ¨çº¿å®‰è£…ç­‰åŠŸèƒ½é¢„ç•™ç©ºé—´

ç°åœ¨ç”¨æˆ·å¯ä»¥é€šè¿‡ HTTP API å®ç°:
- ğŸ” æŸ¥çœ‹æ‰€æœ‰æ’ä»¶å’Œå·¥å…·
- âš™ï¸ åŠ¨æ€ä¿®æ”¹æ’ä»¶é…ç½®
- ğŸ”„ çƒ­é‡è½½æ’ä»¶æ— éœ€é‡å¯
- ğŸ”˜ å¯ç”¨/ç¦ç”¨ç‰¹å®šæ’ä»¶
- ğŸ“Š ç›‘æ§æ’ä»¶çŠ¶æ€å’Œå·¥å…·æ•°é‡

è¿™æ˜¯é¡¹ç›®å‘**å®Œå…¨å¯é…ç½®åŒ–ã€å¯è§†åŒ–ç®¡ç†**è¿ˆè¿›çš„é‡è¦ä¸€æ­¥ï¼
