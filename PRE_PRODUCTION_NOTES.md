# 预生产分支说明

## 🎯 分支目的

`pre-production` 分支是从 `production` 分支创建的预生产环境分支，用于在正式发布到生产环境之前进行最后的测试和验证。

## 📋 主要变更

### 1. 数据库迁移到 SQLite
- ✅ 完全移除配置文件依赖
- ✅ 使用 Prisma + SQLite 管理所有配置
- ✅ 实现自动迁移检测和执行

### 2. 自动迁移功能
- ✅ 检测老版本配置文件
- ✅ 自动执行无感迁移
- ✅ 迁移失败时提供清晰的错误提示

### 3. 项目结构优化
- ✅ 整理 scripts 目录（核心脚本、测试脚本、临时脚本分离）
- ✅ 整理文档目录（技术文档移至 docs/）
- ✅ 添加完整的文档索引

### 4. 配置优化
- ✅ OneBot 配置默认值优化
- ✅ 修复 API 接口问题
- ✅ 完善初始化流程

## 🚀 使用说明

### 新用户
```bash
# 1. 安装依赖
pnpm install

# 2. 快速启动（自动初始化）
pnpm run quick-start
```

### 老用户（从配置文件迁移）
```bash
# 1. 安装依赖
pnpm install

# 2. 启动应用（自动检测并迁移）
pnpm start

# 或手动执行迁移
pnpm run migrate
```

## ⚠️ 重要提示

### 自动迁移
- 应用启动时会自动检测老版本配置文件
- 如果检测到配置文件且数据库为空，会自动执行迁移
- 迁移过程会自动备份原配置文件

### 配置文件
- **不再支持配置文件**，所有配置存储在数据库中
- 老版本的 `config/` 目录配置会被自动迁移
- 迁移后可以安全删除 `config/` 目录（建议保留备份）

### 数据库
- 数据库文件位置：`prisma/data/app.db`
- 已添加到 `.gitignore`，不会被提交
- 包含所有配置、预设、插件设置

## 🧪 测试清单

### 功能测试
- [x] 新用户安装测试 ✅ 通过
- [x] 老用户自动迁移测试 ✅ 通过 (16项配置成功迁移)
- [x] 配置管理 API 测试 ✅ 通过
- [x] 插件系统测试 ✅ 通过 (7个工具加载成功)
- [x] LLM 适配器测试 ✅ 通过 (适配器正常加载)
- [x] OneBot 协议测试 ✅ 通过 (WebSocket连接成功)

### 性能测试
- [x] 启动时间测试 ✅ 通过 (~4秒完成启动)
- [x] 配置加载性能 ✅ 通过 (数据库配置加载快速)
- [ ] API 响应时间
- [ ] 内存使用情况

### 兼容性测试
- [ ] Docker 部署测试
- [ ] PM2 部署测试
- [ ] 不同 Node.js 版本测试
- [ ] 前端兼容性测试

## 📝 待办事项

- [x] 完成核心功能测试 ✅
- [x] 自动迁移功能验证 ✅
- [x] 应用启动流程测试 ✅
- [ ] 性能优化和压力测试
- [ ] 文档完善和审核
- [ ] 准备发布说明
- [ ] 创建迁移指南视频

## ✅ 测试结果总结

### 自动迁移测试 (2025-12-18)
- **测试状态**: 全部通过 ✅
- **迁移检测**: 正确识别老版本配置文件
- **迁移执行**: 成功迁移16项配置 (11个系统设置 + 5个插件配置)
- **结果验证**: 数据完整性验证通过
- **后续检测**: 迁移后正确识别无需再次迁移

### 应用启动测试 (2025-12-18)
- **启动时间**: ~4秒 (包含数据库初始化和配置加载)
- **配置加载**: 从数据库成功加载所有配置
- **服务初始化**: 所有服务正常启动
- **插件系统**: 成功加载7个工具
- **协议连接**: OneBot WebSocket连接正常
- **API服务**: HTTP服务正常启动 (端口3080)

## 🔄 合并到 Master

测试通过后，执行以下步骤：

```bash
# 1. 确保所有测试通过
pnpm test

# 2. 切换到 master 分支
git checkout master

# 3. 合并 pre-production 分支
git merge pre-production

# 4. 推送到远程
git push origin master

# 5. 打标签
git tag -a v2.0.0 -m "Release v2.0.0: SQLite Migration"
git push origin v2.0.0
```

## 📞 联系方式

如有问题，请联系开发团队或在 GitHub 上提 Issue。